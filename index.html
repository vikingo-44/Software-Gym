<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <title>Vikingo Strength Hub - Peak Fit</title>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000;
            background-image: linear-gradient(rgba(0, 0, 0, 0.94), rgba(0, 0, 0, 0.94)), url('https://images.unsplash.com/photo-1534438327276-14e5300c3a48?q=80&w=2070&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: #ffffff;
            overflow: hidden;
        }
        
        .viking-red { color: #FF0000; }
        .viking-bg-red { background-color: #FF0000; }
        .glass-sidebar {
            background: rgba(8, 8, 8, 0.98);
            backdrop-filter: blur(40px);
            border-right: 1px solid rgba(255, 0, 0, 0.15);
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.06);
            transition: all 0.3s ease;
        }
        .glass-card:hover { border-color: rgba(255, 0, 0, 0.3); background: rgba(255, 255, 255, 0.05); }

        .logo-viking-glow {
            filter: drop-shadow(0 0 15px rgba(255, 0, 0, 0.6));
            animation: pulse-glow 3s infinite alternate;
        }
        @keyframes pulse-glow {
            from { filter: drop-shadow(0 0 5px rgba(255, 0, 0, 0.4)); transform: scale(1); }
            to { filter: drop-shadow(0 0 25px rgba(255, 0, 0, 0.8)); transform: scale(1.05); }
        }

        .nav-item { 
            display: flex !important;
            align-items: center !important;
            gap: 1.25rem !important; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            position: relative; 
            white-space: nowrap; 
            text-align: left !important;
        }
        .nav-item:hover, .nav-item.active { 
            color: #FF0000; 
            background: linear-gradient(90deg, rgba(255, 0, 0, 0.1) 0%, transparent 100%);
        }
        .nav-item.active::before {
            content: ''; position: absolute; left: 0; top: 25%; height: 50%; width: 4px;
            background: #FF0000; box-shadow: 0 0 15px #FF0000;
        }

        .view-content { display: none; flex-direction: column; height: 100%; }
        .view-content.active { display: flex; }

        #login-overlay {
            position: fixed; inset: 0; z-index: 1000;
            background: black; display: flex; align-items: center; justify-content: center;
            background-image: linear-gradient(rgba(0,0,0,0.85), rgba(0,0,0,0.85)), url('https://images.unsplash.com/photo-1534438327276-14e5300c3a48?q=80&w=2070&auto=format&fit=crop');
            background-size: cover;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #FF0000; border-radius: 10px; }

        .viking-table-row { border-bottom: 1px solid rgba(255, 255, 255, 0.03); transition: background 0.2s; }
        .viking-table-row:hover { background: rgba(255, 0, 0, 0.02); }

        .calendar-container {
            display: grid; grid-template-columns: 50px repeat(6, 1fr);
            background: rgba(255, 255, 255, 0.02); border-radius: 24px; overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        /* Cabeceras de los días con letra más grande */
		.cal-header { 
			background: rgba(255,0,0,0.15); 
			padding: 12px 4px; 
			text-align: center; 
			font-weight: 900; 
			font-size: 13px; /* Antes era 8px */
			border-right: 1px solid rgba(255,255,255,0.1); 
			text-transform: uppercase;
			letter-spacing: 1px;
		}
        /* Celdas más altas para que quepa el Profesor */
		.cal-cell { 
			border-right: 1px solid rgba(255,255,255,0.1); 
			border-bottom: 1px solid rgba(255,255,255,0.1); 
			height: 50px; /* La mitad de lo anterior */
			position: relative; 
		}
        .cal-cell-closed {
            background: repeating-linear-gradient(45deg, rgba(255,255,255,0.02), rgba(255,255,255,0.02) 10px, rgba(255,255,255,0.05) 10px, rgba(255,255,255,0.05) 20px);
            opacity: 0.5;
        }

        .sidebar-collapsed { width: 80px !important; }
        .sidebar-collapsed .brand-text, 
        .sidebar-collapsed .user-details, 
        .sidebar-collapsed .nav-text, 
        .sidebar-collapsed .nav-section-title,
        .sidebar-collapsed .chevron-icon { display: none; }
        .sidebar-collapsed .nav-item { justify-content: center !important; padding-left: 0; padding-right: 0; gap: 0 !important; }
        
        .viking-input {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            padding: 0.85rem 1.25rem;
            width: 100%;
            outline: none;
            font-weight: 700;
            font-size: 0.95rem;
            color: white;
            transition: all 0.2s;
        }
        .viking-input:focus { border-color: #FF0000; box-shadow: 0 0 10px rgba(255, 0, 0, 0.1); }
        select.viking-input option { background: #0a0a0a; color: white; }

        .viking-modal {
            position: fixed; inset: 0; z-index: 1000;
            background: rgba(0,0,0,0.9); backdrop-filter: blur(15px);
            display: none; align-items: center; justify-content: center;
            padding: 20px;
        }

        /* El recuadro de la clase con diseño más "lindo" y redondeado */
		.class-badge {
			color: black; 
			font-weight: 900;
			padding: 4px; 
			text-transform: uppercase; 
			font-style: italic;
			cursor: pointer;
			display: flex; 
			flex-direction: column; 
			justify-content: center; 
			align-items: center;
			text-align: center; 
			
			/* MAGIA: Ocupa el 200% de la celda + 1px del borde */
			height: calc(200% + 1px); 
			width: calc(100% - 4px);
			margin: 2px;
			
			border-radius: 14px; /* Un poco menos para que encaje mejor */
			border: 1px solid rgba(255,255,255,0.3);
			box-shadow: 0 4px 12px rgba(0,0,0,0.4);
			
			position: absolute;
			top: 0; 
			left: 0; 
			z-index: 20; /* Por encima de las líneas */
			transition: all 0.2s;
		}

        .class-badge:hover { transform: scale(0.97); z-index: 20; }

        .filter-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #999;
            padding: 8px 16px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 900;
            text-transform: uppercase;
            font-style: italic;
            transition: all 0.3s;
        }
        .filter-btn.active {
            background: #FF0000;
            color: #000;
            border-color: #FF0000;
        }

        .payment-method-btn {
            border: 1px solid rgba(255, 255, 255, 0.05);
            background: rgba(255, 255, 255, 0.02);
            transition: all 0.2s;
        }
        .payment-method-btn.active {
            border-color: #FF0000;
            background: rgba(255, 0, 0, 0.1);
            color: #FF0000;
        }

        .cobrar-tab {
            padding: 12px 24px;
            font-weight: 900;
            font-size: 11px;
            text-transform: uppercase;
            font-style: italic;
            border-bottom: 2px solid transparent;
            color: #666;
            transition: all 0.3s;
        }
        .cobrar-tab.active {
            border-bottom-color: #FF0000;
            color: #FF0000;
        }

        .notification-toast {
            position: fixed; bottom: 30px; right: 30px;
            background: #FF0000; color: black;
            padding: 20px 40px; border-radius: 20px;
            font-weight: 900; text-transform: uppercase; font-style: italic;
            z-index: 2000; transform: translateY(150%);
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 10px 40px rgba(255, 0, 0, 0.4);
        }
        .notification-toast.show { transform: translateY(0); }

        .restricted-action { display: none !important; }

        .multi-select-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 15px;
            max-height: 150px;
            overflow-y: auto;
        }
        .multi-option {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 10px;
            font-weight: 900;
            text-transform: uppercase;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.05);
        }
        .multi-option input { display: none; }
        .multi-option:has(input:checked) {
            border-color: #FF0000;
            background: rgba(255,0,0,0.1);
            color: #FF0000;
        }
        #cl-schedule-container {
            border-top: 1px solid rgba(255,255,255,0.05);
            padding-top: 15px;
            margin-top: 10px;
        }
        .schedule-slot-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            margin-bottom: 8px;
        }
        /* Estilos para el Editor de Rutinas Mejorado */
        .rutina-dia-card {
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.05);
            padding: 1.5rem;
            border-radius: 1.5rem;
            position: relative;
        }
        /* Definición Estricta de la Grilla de Ejercicios para Alineación */
        .exercise-grid {
            display: grid;
            grid-template-columns: 2.5fr 0.8fr 0.8fr 0.8fr 1fr 40px;
            gap: 12px;
            align-items: center;
        }
        .exercise-results-list div:hover {
            background: #FF0000;
            color: black;
            cursor: pointer;
        }
		
		/* Asegura que el contenedor del avatar se achique proporcionalmente */
		.sidebar-collapsed #user-avatar-container {
			width: 40px !important;
			height: 40px !important;
			margin-bottom: 10px !important;
		}

		.sidebar-collapsed #user-initials {
			font-size: 14px !important;
		}

		/* Ocultar nombre y rol al colapsar */
		.sidebar-collapsed #side-user-name,
		.sidebar-collapsed #side-user-role {
			display: none !important;
		}

		/* Centrar el bloque de perfil al colapsar */
		.sidebar-collapsed .user-profile-block {
			padding-left: 0 !important;
			padding-right: 0 !important;
			display: flex;
			flex-direction: column;
			align-items: center;
		}
    </style>
</head>
<body class="flex h-screen w-screen overflow-hidden text-left">

    <div id="viking-toast" class="notification-toast">¡Acción Completada!</div>

    <div id="login-overlay">
        <div class="glass-card p-12 rounded-[3rem] w-full max-w-md border-red-600/20 text-center mx-4">
            <div class="w-32 h-32 mx-auto mb-8 logo-viking-glow bg-black rounded-full flex items-center justify-center overflow-hidden">
                <img src="https://github.com/vikingo-44/Software-Gym/blob/main/logo.png?raw=true" alt="Vikingo Logo" class="w-full h-full object-cover" onerror="this.src='https://via.placeholder.com/150/FF0000/000000?text=VIKINGO'">
            </div>
            <h1 class="text-4xl font-black italic uppercase mb-2">Vikingo <span class="viking-red">Hub</span></h1>
            <p class="text-[11px] tracking-[0.5em] text-gray-500 uppercase mb-10">Acceso al Sistema</p>
            
            <form onsubmit="handleLogin(event)" class="space-y-4">
                <input type="text" id="login-dni" placeholder="DNI" required class="viking-input">
                <input type="password" id="login-pass" placeholder="Contraseña" required class="viking-input">
                <button type="submit" id="login-button" class="w-full viking-bg-red text-black py-5 rounded-2xl font-black uppercase italic tracking-widest hover:scale-[1.02] active:scale-95 transition-all shadow-[0_0_20px_rgba(255,0,0,0.3)]">Entrar al Valhalla</button>
            </form>
            <div id="login-error" class="mt-4 text-[12px] text-red-600 font-bold uppercase hidden">Error en credenciales</div>
        </div>
    </div>

    <aside id="sidebar" class="w-72 h-full glass-sidebar flex flex-col hidden z-50">
        <div class="p-8 flex items-center gap-4">
            <img src="https://github.com/vikingo-44/Software-Gym/blob/main/logo.png?raw=true" alt="Vikingo Hub" class="w-10 h-10 object-contain logo-viking-glow brand-text" onerror="this.style.display='none'">
            <h1 class="brand-text text-xl font-black italic uppercase leading-none">
                VIKINGO<br><span class="viking-red text-xs tracking-[0.4em] font-bold">STRENGTH HUB</span>
            </h1>
            <!-- <button onclick="toggleSidebar()" class="p-2 hover:bg-white/5 rounded-lg transition-colors ml-auto">
                <i data-lucide="menu" class="w-5 h-5 viking-red"></i>
            </button> -->
        </div>

        <div class="px-6 mb-8">
            <div class="glass-card p-4 rounded-3xl flex items-center gap-4">
                <div class="w-12 h-12 rounded-2xl viking-bg-red flex items-center justify-center font-black text-black text-xl italic shadow-lg shrink-0" id="user-initials">??</div>
                <div class="user-details text-left overflow-hidden">
                    <p class="text-[12px] font-black uppercase truncate" id="side-user-name">Usuario Vikingo</p>
                    <p class="text-[9px] text-red-600 font-bold uppercase tracking-widest" id="side-user-role">Cargando...</p>
                </div>
            </div>
        </div>

        <nav class="flex-1 px-4 space-y-1 overflow-y-auto custom-scrollbar pb-10">
		<!-- SECCIÓN ADMINISTRACIÓN -->
		<div id="nav-section-admin">
			<p class="nav-section-title text-[10px] font-black text-gray-600 uppercase tracking-widest px-6 mb-2 mt-4">
				<span class="nav-text">Administración</span>
			</p>
			
			<button onclick="switchView('dashboard')" id="nav-dashboard" class="nav-btn w-full nav-item active px-6 py-4 rounded-2xl font-black uppercase text-[11px] italic flex items-center gap-3">
				<i data-lucide="layout-grid" class="w-4 h-4"></i> 
				<span class="nav-text">Dashboard</span>
			</button>
			
			<button onclick="switchView('perfil')" id="nav-perfil" class="nav-btn w-full nav-item px-6 py-4 rounded-2xl font-black uppercase text-[11px] italic flex items-center gap-3">
				<i data-lucide="user-cog" class="w-4 h-4"></i> 
				<span class="nav-text">Mi Perfil</span>
			</button>
			
			<button onclick="switchView('alumnos')" id="nav-alumnos" class="nav-btn w-full nav-item px-6 py-4 rounded-2xl font-black uppercase text-[11px] italic flex items-center gap-3">
				<i data-lucide="users" class="w-4 h-4"></i> 
				<span class="nav-text">Alumnos</span>
			</button>

			<!-- STAFF (Corregido: gap-3 y nav-btn) -->
			<div id="nav-section-staff" class="relative">
				<button onclick="toggleSub('sub-staff')" class="nav-btn w-full flex items-center justify-between px-6 py-4 rounded-2xl font-black uppercase text-[11px] italic group">
					<div class="flex items-center gap-3"> <!-- Gap-3 clave para la alineación -->
						<i data-lucide="shield-check" class="w-4 h-4"></i> 
						<span class="nav-text">Staff</span>
					</div>
					<span class="nav-text">
						<i data-lucide="chevron-down" class="w-3 h-3 chevron-icon opacity-50"></i>
					</span>
				</button>
				<div id="sub-staff" class="hidden pl-12 space-y-3 pb-4 mt-1">
					<button onclick="switchView('profesores')" id="nav-profesores" class="block w-full text-left text-[10px] font-black uppercase text-gray-500 hover:text-red-600 transition-colors tracking-widest">• Profesores</button>
					<button onclick="switchView('administrativos')" id="nav-administrativos" class="block w-full text-left text-[10px] font-black uppercase text-gray-500 hover:text-red-600 transition-colors tracking-widest">• Administrativos</button>
				</div>
			</div>
		</div>

		<!-- SECCIÓN OPERATIVA -->
		<div id="nav-section-operativa">
			<p class="nav-section-title text-[10px] font-black text-gray-600 uppercase tracking-widest px-6 mb-2 mt-8">
				<span class="nav-text">Operativa</span>
			</p>
			
			<div class="relative">
				<button id="btn-facturacion" onclick="toggleSub('sub-facturacion')" class="nav-btn w-full flex items-center justify-between px-6 py-4 rounded-2xl font-black uppercase text-[11px] italic group">
					<div class="flex items-center gap-3">
						<i data-lucide="wallet" class="w-4 h-4"></i> 
						<span class="nav-text">Facturación</span>
					</div>
					<span class="nav-text">
						<i data-lucide="chevron-down" class="w-3 h-3 chevron-icon opacity-50"></i>
					</span>
				</button>
				<div id="sub-facturacion" class="hidden pl-12 space-y-3 pb-4 mt-1">
					<button onclick="switchView('cobrar')" id="nav-cobrar" class="block w-full text-left text-[10px] font-black uppercase text-gray-500 hover:text-red-600 transition-colors tracking-widest">• Cobrar</button>
					<button onclick="switchView('caja')" id="nav-caja" class="block w-full text-left text-[10px] font-black uppercase text-gray-500 hover:text-red-600 transition-colors tracking-widest">• Caja</button>
					<button onclick="switchView('stock')" id="nav-stock" class="block w-full text-left text-[10px] font-black uppercase text-gray-500 hover:text-red-600 transition-colors tracking-widest">• Stock</button>
				</div>
			</div>
		</div>

		<!-- SECCIÓN GESTIÓN -->
		<div id="nav-section-gestion">
			<p class="nav-section-title text-[10px] font-black text-gray-600 uppercase tracking-widest px-6 mb-2 mt-8">
				<span class="nav-text">Gestión</span>
			</p>
			<button onclick="switchView('planes')" id="nav-planes" class="nav-btn w-full nav-item px-6 py-4 rounded-2xl font-black uppercase text-[11px] italic flex items-center gap-3">
				<i data-lucide="clipboard-list" class="w-4 h-4"></i> <span class="nav-text">Planes</span>
			</button>
			<button onclick="switchView('clases')" id="nav-clases" class="nav-btn w-full nav-item px-6 py-4 rounded-2xl font-black uppercase text-[11px] italic flex items-center gap-3">
				<i data-lucide="presentation" class="w-4 h-4"></i> <span class="nav-text">Clases</span>
			</button>
			<button onclick="switchView('calendario')" id="nav-calendario" class="nav-btn w-full nav-item px-6 py-4 rounded-2xl font-black uppercase text-[11px] italic flex items-center gap-3">
				<i data-lucide="calendar" class="w-4 h-4"></i> <span class="nav-text">Calendario</span>
			</button>
			<button id="nav-rutinas" onclick="switchView('rutinas')" class="nav-btn w-full nav-item px-6 py-4 rounded-2xl font-black uppercase text-[11px] italic flex items-center gap-3">
				<i data-lucide="dumbbell" class="w-4 h-4"></i> <span class="nav-text">Rutinas Musc.</span>
			</button>
		</div>

		<!-- SECCIÓN SEGURIDAD -->
		<div id="nav-section-virtual">
			<p class="nav-section-title text-[10px] font-black text-gray-600 uppercase tracking-widest px-6 mb-2 mt-8">
				<span class="nav-text">Seguridad</span>
			</p>
			<button onclick="switchView('acceso-virtual')" id="nav-acceso-virtual" class="nav-btn w-full nav-item px-6 py-4 rounded-2xl font-black uppercase text-[11px] italic flex items-center gap-3">
				<i data-lucide="qr-code" class="w-4 h-4"></i> 
				<span class="nav-text">Acceso Virtual</span>
			</button>
		</div>
	</nav>

        <div class="p-8">
            <button onclick="location.reload()" class="w-full flex items-center justify-center gap-3 py-4 border border-white/5 rounded-2xl text-gray-600 hover:text-red-600 transition-all font-black uppercase text-[11px] italic">
                <i data-lucide="log-out" class="w-4 h-4"></i> <span class="nav-text">Salir</span>
            </button>
        </div>
    </aside>

    <main id="main-content" class="flex-1 h-full overflow-y-auto hidden relative">
        <header class="h-24 border-b border-white/5 px-12 flex items-center justify-between sticky top-0 bg-black/70 backdrop-blur-2xl z-40">
            <div>
                <p id="breadcrumb" class="text-[10px] font-black text-red-600 uppercase tracking-[0.4em] italic">Vikingo Strength Hub</p>
                <h2 id="view-title" class="text-2xl font-black uppercase italic tracking-tighter">Dashboard</h2>
            </div>
            <div class="flex items-center gap-6">
                <div id="sync-status" class="flex items-center gap-3 bg-red-600/10 px-4 py-2 rounded-xl border border-red-600/20 text-white">
                    <span class="w-2 h-2 rounded-full bg-red-600 animate-pulse"></span>
                    <span class="text-[10px] font-black uppercase tracking-widest italic">Hub Sincronizado</span>
                </div>
            </div>
        </header>

        <div id="views-container" class="p-10">
            <!-- DASHBOARD -->
            <div id="view-dashboard" class="view-content active">
                <div id="admin-dashboard-layout">
                    <div class="grid grid-cols-1 lg:grid-cols-4 gap-8 mb-10">
                        <div class="glass-card p-8 rounded-[2.5rem]">
                            <h4 class="text-[11px] font-black uppercase italic text-red-600 mb-6 tracking-widest">Últimos Check-ins</h4>
                            <div id="dash-checkins" class="space-y-4"></div>
                        </div>
                        <div class="glass-card p-8 rounded-[2.5rem]">
                            <h4 class="text-[11px] font-black uppercase italic text-red-600 mb-6 tracking-widest">Resumen</h4>
                            <div id="dash-summary" class="space-y-4">
                                <div class="flex items-center justify-between p-4 bg-white/5 rounded-2xl border border-white/5">
                                    <span class="text-[11px] font-black italic">INGRESOS HOY</span>
                                    <span class="text-[10px] text-green-600 font-bold italic" id="dash-ingresos">$ 0</span>
                                </div>
                            </div>
                        </div>
                        <div class="glass-card p-8 rounded-[2.5rem]">
                            <h4 class="text-[11px] font-black uppercase italic text-red-600 mb-6 tracking-widest">Frecuencia Horaria</h4>
                            <div id="dash-stats-bars" class="flex items-end justify-between h-32 px-2">
                                <div class="w-4 viking-bg-red/20 h-[35%] rounded-t-lg"></div>
                                <div class="w-4 viking-bg-red/40 h-[65%] rounded-t-lg"></div>
                                <div class="w-4 viking-bg-red h-[95%] rounded-t-lg"></div>
                                <div class="w-4 viking-bg-red/60 h-[75%] rounded-t-lg"></div>
                                <div class="w-4 viking-bg-red/30 h-[45%] rounded-t-lg"></div>
                            </div>
                        </div>
                        <div class="glass-card p-8 rounded-[2.5rem]">
                            <h4 class="text-[11px] font-black uppercase italic text-red-600 mb-6 tracking-widest">Top 5 Clases</h4>
                            <div id="dash-top-clases" class="space-y-3"></div>
                        </div>
                    </div>

                    <div class="glass-card p-10 rounded-[3rem]">
                        <div class="flex justify-between items-center mb-8">
                            <h3 class="text-sm font-black uppercase italic border-l-4 border-red-600 pl-4 tracking-widest">Vista Rápida Alumnos (A-Z)</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead>
                                    <tr class="text-[10px] font-black uppercase text-gray-500 italic border-b border-white/5">
                                        <th class="pb-5">Nombre Completo</th>
                                        <th class="pb-5">DNI</th>
                                        <th class="pb-5">Email</th>
                                        <th class="pb-5">Plan</th>
                                        <th class="pb-5">Status</th>
                                        <th class="pb-5">Renovación</th>
                                        <th class="pb-5">Vencimiento</th>
                                        <th class="pb-5 text-right action-col">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="dash-table-alumnos-mini" class="text-[12px] font-black uppercase italic"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="alumno-dashboard-layout" class="hidden">
				<!-- SECCIÓN SUPERIOR: DATOS Y MÉTRICAS -->
				<div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
					
					<!-- TARJETA PRINCIPAL: DATOS PERSONALES -->
					<div class="glass-card p-8 rounded-[3rem] lg:col-span-2">
						<div class="flex items-center gap-6 mb-8">
							<div class="w-20 h-20 rounded-[1.5rem] viking-bg-red flex items-center justify-center font-black text-black text-3xl italic shadow-2xl" id="al-dash-initials">??</div>
							<div>
								<h3 class="text-3xl font-black uppercase italic leading-none" id="al-dash-name">-</h3>
								<p class="text-red-600 text-[11px] font-black uppercase tracking-widest mt-1">Guerrero Vikingo en Formación</p>
							</div>
						</div>
						<div class="grid grid-cols-2 md:grid-cols-4 gap-6">
							<div class="bg-white/5 p-4 rounded-2xl border border-white/5">
								<p class="text-[9px] text-gray-500 font-black uppercase italic mb-1">DNI / Usuario</p>
								<p class="text-xs font-black italic" id="al-dash-dni">-</p>
							</div>
							<div class="bg-white/5 p-4 rounded-2xl border border-white/5">
								<p class="text-[9px] text-gray-500 font-black uppercase italic mb-1">Email</p>
								<p class="text-xs font-black italic truncate" id="al-dash-email">-</p>
							</div>
							<div class="bg-white/5 p-4 rounded-2xl border border-white/5">
								<p class="text-[9px] text-gray-500 font-black uppercase italic mb-1">Plan Actual</p>
								<p class="text-xs font-black italic viking-red uppercase" id="al-dash-plan">-</p>
							</div>
							<div class="bg-white/5 p-4 rounded-2xl border border-white/5">
								<p class="text-[9px] text-gray-500 font-black uppercase italic mb-1">Vencimiento</p>
								<p class="text-xs font-black italic" id="al-dash-vencimiento">-</p>
							</div>
							<!-- Agregamos Renovación que estaba en tu código original -->
							<div class="bg-white/5 p-4 rounded-2xl border border-white/5 md:col-span-4 lg:col-span-4 xl:col-span-4">
								<p class="text-[9px] text-gray-500 font-black uppercase italic mb-1">Última Renovación</p>
								<p class="text-xs font-black italic" id="al-dash-renovacion">-</p>
							</div>
						</div>
					</div>

					<!-- TARJETA LATERAL: ESTADÍSTICAS FÍSICAS Y MEMBRESÍA -->
					<div class="glass-card p-8 rounded-[3rem] flex flex-col justify-center">
						<!-- Físico -->
						<h4 class="text-[11px] font-black uppercase italic text-red-600 mb-6 tracking-widest border-b border-white/5 pb-4">Métricas Físicas</h4>
						<div class="grid grid-cols-3 gap-2 text-center mb-6">
							<div>
								<p class="text-2xl font-black italic mb-1" id="al-dash-peso">0</p>
								<p class="text-[9px] text-gray-500 font-black uppercase">Peso (kg)</p>
							</div>
							<div>
								<p class="text-2xl font-black italic mb-1" id="al-dash-altura">0</p>
								<p class="text-[9px] text-gray-500 font-black uppercase">Altura (m)</p>
							</div>
							<div>
								<p class="text-2xl font-black italic mb-1 viking-red" id="al-dash-imc">0</p>
								<p class="text-[9px] text-gray-500 font-black uppercase">IMC</p>
							</div>
						</div>

						<!-- Membresía (AGREGADO PARA QUE FUNCIONE EL JS DE CRÉDITOS) -->
						 <h4 class="text-[11px] font-black uppercase italic text-red-600 mb-6 tracking-widest border-b border-white/5 pb-4 pt-2">Estado Membresía</h4>
						<div class="grid grid-cols-2 gap-4 text-center">
							 <div>
								<p class="text-2xl font-black italic mb-1" id="al-dash-usadas">-</p>
								<p class="text-[9px] text-gray-500 font-black uppercase">Usadas</p>
							</div>
							<div>
								<p class="text-2xl font-black italic mb-1 text-white" id="al-dash-creditos">-</p>
								<p class="text-[9px] text-gray-500 font-black uppercase">Créditos</p>
							</div>
						</div>
					</div>
				</div>
				
				<!-- SECCIÓN INTERMEDIA: RUTINA (AGREGADO PARA QUE FUNCIONE EL RESUMEN DE RUTINA) -->
				<div id="al-dash-rutina-summary" class="glass-card p-6 rounded-[2rem] mb-8 hidden border-l-4 border-red-600 flex items-center justify-between">
					 <div class="flex items-center gap-6">
						 <div class="p-4 bg-red-600/20 rounded-2xl text-red-500"><i data-lucide="notebook-pen" class="w-6 h-6"></i></div>
						 <div id="al-dash-rutina-content"></div>
					 </div>
					 <button onclick="switchView('rutinas')" class="px-6 py-3 bg-white/5 rounded-xl text-[10px] font-black uppercase hover:bg-white/10 transition italic">Ver Rutina</button>
				</div>

				<!-- SECCIÓN INFERIOR: CLASES E HISTORIAL -->
				<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
					<div class="glass-card p-10 rounded-[3rem]">
						<h3 class="text-sm font-black uppercase italic border-l-4 border-red-600 pl-4 tracking-widest mb-8">Mis Próximas Clases</h3>
						<div id="al-dash-upcoming" class="space-y-4">
							<p class="text-gray-500 italic text-[11px]">No tienes reservas próximas. ¡Ve al calendario!</p>
						</div>
					</div>
					<div class="glass-card p-10 rounded-[3rem]">
						<h3 class="text-sm font-black uppercase italic border-l-4 border-gray-600 pl-4 tracking-widest mb-8 text-gray-500">Historial</h3>
						<div id="al-dash-history" class="space-y-4 opacity-60">
							<p class="text-gray-500 italic text-[11px]">Sin historial registrado.</p>
						</div>
					</div>
				</div>
			</div>
            </div>

            <div id="view-cobrar" class="view-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-10 h-full">
                    <div class="lg:col-span-2 space-y-6">
                        <div class="flex justify-between items-center mb-4">
                            <div class="flex border-b border-white/5">
                                <button onclick="setCobrarTab('mercaderia')" id="tab-mercaderia" class="cobrar-tab active">Mercadería</button>
                                <button onclick="setCobrarTab('planes')" id="tab-planes" class="cobrar-tab">Planes</button>
                            </div>
                            <div class="relative w-64">
                                <i data-lucide="search" class="absolute left-4 top-3.5 w-4 h-4 text-gray-500"></i>
                                <input type="text" placeholder="Buscar..." class="viking-input pl-12 py-3" id="cobrar-search">
                            </div>
                        </div>
                        <div id="cobrar-display-area">
                             <div class="grid grid-cols-2 md:grid-cols-4 gap-4 overflow-y-auto max-h-[600px] pr-2 custom-scrollbar" id="cobrar-catalogo"></div>
                        </div>
                    </div>

                    <div class="glass-card p-10 rounded-[3rem] border-red-600/10 flex flex-col h-fit">
                        <h4 class="text-xs font-black uppercase italic text-red-600 mb-6 tracking-widest border-b border-white/5 pb-4">Carrito de Cobro</h4>
                        <div class="flex-1 space-y-4 mb-8 overflow-y-auto max-h-64 custom-scrollbar" id="cobrar-lista-carrito">
                            <p class="text-center text-gray-500 text-[11px] italic py-10">Sin ítems seleccionados</p>
                        </div>
                        <div class="space-y-4 border-t border-white/5 pt-6 mb-8">
                            <div class="flex justify-between text-[11px] font-black italic">
                                <span class="text-gray-500">SUBTOTAL</span>
                                <span id="cobrar-subtotal">$ 0</span>
                            </div>
                            <div class="flex justify-between text-xl font-black italic">
                                <span>TOTAL</span>
                                <span class="viking-red" id="cobrar-total">$ 0</span>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <p class="text-[10px] font-black uppercase text-gray-500 italic mb-2 tracking-widest">Método de Pago</p>
                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="setPaymentMethod('MercadoPago')" class="payment-method-btn py-3 rounded-xl text-[10px] font-black uppercase italic">MercadoPago</button>
                                <button onclick="setPaymentMethod('Transferencia')" class="payment-method-btn py-3 rounded-xl text-[10px] font-black uppercase italic">Transferencia</button>
                                <button onclick="setPaymentMethod('Efectivo')" class="payment-method-btn py-3 rounded-xl text-[10px] font-black uppercase italic">Efectivo</button>
                                <button onclick="setPaymentMethod('Tarjeta')" class="payment-method-btn py-3 rounded-xl text-[10px] font-black uppercase italic">Tarjeta</button>
                            </div>
                        </div>
                        <button id="btn-finalizar-pago" onclick="finalizarVenta()" class="w-full mt-8 viking-bg-red text-black py-5 rounded-2xl font-black uppercase italic tracking-widest hover:scale-[1.02] active:scale-95 transition-all shadow-xl">Procesar Pago</button>
                    </div>
                </div>
            </div>

            <div id="view-perfil" class="view-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-10">
                    <div class="glass-card p-10 rounded-[3rem] flex flex-col items-center">
                        <div class="w-32 h-32 rounded-[2.5rem] viking-bg-red flex items-center justify-center font-black text-black text-4xl italic shadow-2xl mb-6" id="prof-initials-view">??</div>
                        <h3 class="text-xl font-black uppercase italic text-center" id="prof-name">Cargando...</h3>
                        <p class="text-red-600 text-xs font-black uppercase tracking-widest mb-8" id="prof-role">Rol</p>
                        <div id="plan-alumno-info" class="w-full space-y-2 mt-4 hidden">
                            <p class="text-[10px] font-black uppercase text-gray-500 italic text-center">Plan Actual</p>
                            <div class="bg-white/5 p-4 rounded-2xl border border-white/5 text-center">
                                <p class="text-sm font-black viking-red uppercase" id="perfil-plan-nombre">-</p>
                                <p class="text-[10px] text-gray-500 font-bold" id="perfil-vencimiento">Vence: -</p>
                            </div>
                        </div>
                    </div>
                    <div class="lg:col-span-2 glass-card p-10 rounded-[3rem]">
                        <h3 class="text-sm font-black uppercase italic border-l-4 border-red-600 pl-4 tracking-widest mb-10">Mis Datos</h3>
                        <form id="form-perfil" onsubmit="handleProfileUpdate(event)" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-2">
                                <label class="text-[10px] font-black uppercase text-gray-500 italic">Nombre Completo</label>
                                <input type="text" id="prof-input-name" class="viking-input" required>
                            </div>
                            <div class="space-y-2">
                                <label class="text-[10px] font-black uppercase text-gray-500 italic">DNI / Usuario</label>
                                <input type="text" id="prof-input-dni" readonly class="viking-input opacity-50">
                            </div>
                            <div class="space-y-2">
                                <label class="text-[10px] font-black uppercase text-gray-500 italic">Correo Electrónico</label>
                                <input type="email" id="prof-input-email" class="viking-input">
                            </div>
                            
                            <div id="perfil-datos-fisicos" class="md:col-span-2 grid grid-cols-3 gap-4 border-t border-white/5 pt-6 mt-4 hidden">
                                <div class="space-y-2">
                                    <label class="text-[10px] font-black uppercase text-gray-500 italic">Peso (kg)</label>
                                    <input type="number" step="0.1" id="prof-input-peso" class="viking-input" oninput="calculateIMCProfile()">
                                </div>
                                <div class="space-y-2">
                                    <label class="text-[10px] font-black uppercase text-gray-500 italic">Altura (cm)</label>
                                    <input type="number" step="0.1" id="prof-input-altura" class="viking-input" oninput="calculateIMCProfile()">
                                </div>
                                <div class="space-y-2">
                                    <label class="text-[10px] font-black uppercase text-red-600 italic">IMC</label>
                                    <input type="text" id="prof-input-imc" readonly class="viking-input opacity-50">
                                </div>
                            </div>

                            <div class="space-y-2 md:col-span-2">
                                <label class="text-[10px] font-black uppercase text-gray-500 italic">Nueva Contraseña</label>
                                <input type="password" id="prof-input-pass" placeholder="Dejar vacío para no cambiar" class="viking-input">
                            </div>
                            <div class="md:col-span-2 pt-6 text-left">
                                <button type="submit" id="btn-save-profile" class="px-10 py-4 viking-bg-red text-black rounded-2xl font-black uppercase italic tracking-widest hover:scale-105 transition-transform shadow-lg shadow-red-600/20">Guardar Cambios</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div id="view-alumnos" class="view-content">
			<!-- CABECERA PRINCIPAL -->
			<div class="flex justify-between items-center mb-8">
				<div>
					<h3 class="text-3xl font-black italic uppercase">Gestión de Alumnos</h3>
					<p class="text-[10px] text-gray-500 font-bold uppercase tracking-[0.2em] mt-1 italic">Panel de control y seguimiento de guerreros</p>
				</div>
				<button id="btn-nuevo-alumno" onclick="openModalAlumno()" class="viking-bg-red text-black px-8 py-4 rounded-2xl font-black uppercase italic text-[12px] shadow-xl flex items-center gap-3 hover:scale-105 transition-all">
					<i data-lucide="user-plus" class="w-4 h-4"></i> Nuevo Alumno
				</button>
			</div>

			<!-- BARRA DE HERRAMIENTAS (BUSCADOR Y FILTROS) -->
			<div class="flex flex-col md:flex-row gap-4 mb-8">
				<!-- BUSCADOR -->
				<div class="flex-1 relative">
					<i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-500"></i>
					<input type="text" 
						   placeholder="Buscar Guerrero por nombre o DNI..." 
						   oninput="handleAlumnosSearch(this.value)"
						   class="viking-input pl-12 bg-white/5 border-white/10 text-white rounded-2xl focus:border-red-600 transition-all">
				</div>

				<!-- FILTRO DE ESTADO VIKINGO -->
				<div class="flex bg-white/5 p-1 rounded-2xl border border-white/5 h-[52px]">
					<button onclick="handleAlumnosStatusFilter('todos')" id="filter-todos" class="filter-btn px-6 rounded-xl text-[10px] font-black uppercase italic transition-all bg-red-600 text-black">Todos</button>
					<button onclick="handleAlumnosStatusFilter('activos')" id="filter-activos" class="filter-btn px-6 rounded-xl text-[10px] font-black uppercase italic transition-all text-gray-500 hover:text-white">Activos</button>
					<button onclick="handleAlumnosStatusFilter('vencidos')" id="filter-vencidos" class="filter-btn px-6 rounded-xl text-[10px] font-black uppercase italic transition-all text-gray-500 hover:text-white">Vencidos</button>
				</div>
			</div>

			<!-- LISTADO DE ALUMNOS (REEMPLAZA A LA TABLA) -->
			<div id="alumnos-list-view" class="space-y-3 min-h-[400px]">
				<!-- Aquí se inyectan las tarjetas mediante renderAlumnos() -->
			</div>

			<!-- PAGINACIÓN -->
			<div id="alumnos-pagination" class="flex items-center justify-between mt-8 px-8 py-5 glass-card rounded-[2rem] border-white/5">
				<!-- Se genera dinámicamente -->
			</div>
		</div>

            <div id="view-profesores" class="view-content">
                <div class="flex justify-between items-center mb-8">
                    <h3 class="text-3xl font-black italic uppercase">Personal de Profesores</h3>
                    <button id="btn-nuevo-prof" onclick="openModalStaff('Profesor')" class="viking-bg-red text-black px-8 py-4 rounded-2xl font-black uppercase italic text-[12px] shadow-xl flex items-center gap-3">
                        <i data-lucide="user-plus" class="w-4 h-4"></i> Alta Profesor
                    </button>
                </div>
                <div class="glass-card p-10 rounded-[3rem]">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="text-[10px] font-black uppercase text-gray-500 italic border-b border-white/5">
                                    <th class="pb-5">Nombre</th>
                                    <th class="pb-5">DNI (Usuario)</th>
                                    <th class="pb-5">Especialidad</th>
                                    <th class="pb-5 text-right action-col">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="table-profesores" class="text-[11px] font-black uppercase italic"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-administrativos" class="view-content">
                <div class="flex justify-between items-center mb-8">
                    <h3 class="text-3xl font-black italic uppercase">Personal Administrativo</h3>
                    <button id="btn-nuevo-adm" onclick="openModalStaff('Administracion')" class="viking-bg-red text-black px-8 py-4 rounded-2xl font-black uppercase italic text-[12px] shadow-xl flex items-center gap-3">
                        <i data-lucide="shield-plus" class="w-4 h-4"></i> Alta Administrativo
                    </button>
                </div>
                <div class="glass-card p-10 rounded-[3rem]">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="text-[10px] font-black uppercase text-gray-500 italic border-b border-white/5">
                                    <th class="pb-5">Nombre</th>
                                    <th class="pb-5">DNI (Usuario)</th>
                                    <th class="pb-5">Email</th>
                                    <th class="pb-5 text-right action-col">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="table-administrativos" class="text-[11px] font-black uppercase italic"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-caja" class="view-content">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-10">
                    <div class="glass-card p-8 rounded-[2.5rem] border-green-500/20">
                        <p class="text-[11px] font-black text-gray-500 uppercase italic mb-2">Total Ingresos</p>
                        <h4 class="text-3xl font-black italic text-green-500" id="caja-ingresos">$ 0,00</h4>
                    </div>
                    <div class="glass-card p-8 rounded-[2.5rem] border-red-500/20">
                        <p class="text-[11px] font-black text-gray-500 uppercase italic mb-2">Total Gastos</p>
                        <h4 class="text-3xl font-black italic text-red-500" id="caja-gastos">$ 0,00</h4>
                    </div>
                    <div class="glass-card p-8 rounded-[2.5rem] border-viking-red/20">
                        <p class="text-[11px] font-black text-red-600 uppercase italic mb-2">Balance Neto</p>
                        <h4 class="text-3xl font-black italic" id="caja-balance">$ 0,00</h4>
                    </div>
                </div>
                <div class="glass-card p-10 rounded-[3rem]">
                    <div class="flex justify-between items-center mb-8">
                        <h3 class="text-sm font-black uppercase italic border-l-4 border-red-600 pl-4 tracking-widest">Flujo Diario de Caja</h3>
                        <button id="btn-nuevo-mov" onclick="openModal('modal-movimiento')" class="viking-bg-red text-black px-6 py-3 rounded-xl font-black uppercase italic text-[11px]">Cargar Movimiento</button>
                    </div>
                    <table class="w-full text-left">
                        <thead>
                            <tr class="text-[10px] font-black uppercase text-gray-500 italic border-b border-white/5">
                                <th class="pb-5">Tipo</th>
                                <th class="pb-5">Descripción</th>
                                <th class="pb-5 text-right">Monto</th>
                            </tr>
                        </thead>
                        <tbody id="table-caja" class="text-[12px] font-black italic uppercase"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-stock" class="view-content">
                <div class="flex justify-between items-center mb-8">
                    <h3 class="text-3xl font-black italic uppercase">Control de Stock</h3>
                    <button id="btn-nuevo-stock" onclick="openModalStock()" class="viking-bg-red text-black px-8 py-4 rounded-2xl font-black uppercase italic text-[12px] shadow-xl flex items-center gap-3">
                        <i data-lucide="package-plus" class="w-4 h-4"></i> Crear Mercadería
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-8" id="stock-container"></div>
            </div>

            <div id="view-planes" class="view-content">
                <div class="flex justify-between items-center mb-8">
                    <h3 class="text-3xl font-black italic uppercase">Planes de Entrenamiento</h3>
                    <button id="btn-nuevo-plan" onclick="openModalPlan()" class="viking-bg-red text-black px-8 py-4 rounded-2xl font-black uppercase italic text-[12px] shadow-xl flex items-center gap-3">
                        <i data-lucide="plus" class="w-4 h-4"></i> Alta de Plan
                    </button>
                </div>
                <div class="flex gap-2 mb-10 overflow-x-auto pb-2 custom-scrollbar" id="planes-filter-container"></div>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-8" id="planes-container"></div>
            </div>

            <div id="view-clases" class="view-content">
                <div class="flex justify-between items-center mb-8">
                    <h3 class="text-3xl font-black italic uppercase">Gestión de Clases</h3>
                    <button id="btn-nueva-clase" onclick="openModalClase()" class="viking-bg-red text-black px-8 py-4 rounded-2xl font-black uppercase italic text-[12px] shadow-xl flex items-center gap-3">
                        <i data-lucide="presentation" class="w-4 h-4"></i> Alta de Clase
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8" id="clases-container"></div>
            </div>

            <div id="view-calendario" class="view-content">
                <div class="flex justify-between items-center mb-10">
                    <h3 class="text-3xl font-black italic uppercase text-left">Agenda Vikinga</h3>
                    <div class="flex gap-4">
                        <div class="flex bg-white/5 p-1 rounded-2xl border border-white/5">
                            <button class="px-6 py-2 bg-red-600 text-black rounded-xl text-[11px] font-black uppercase italic">Semana Actual</button>
                        </div>
                    </div>
                </div>
                <div class="calendar-container h-[700px] overflow-y-auto custom-scrollbar" id="calendar-grid"></div>
            </div>

            <div id="view-rutinas" class="view-content">
                <h3 class="text-3xl font-black italic uppercase mb-8" id="rutina-title">Rutinas de Alumnos</h3>
                <div class="glass-card p-10 rounded-[3rem]">
                    <div id="musculacion-student-view" class="hidden space-y-8">
                        <div class="bg-red-600/10 p-6 rounded-3xl border border-red-600/20" id="student-plan-header">
                            <h4 class="text-xl font-black italic uppercase mb-2">MI RUTINA DEL VALHALLA</h4>
                            <p class="text-[11px] text-gray-400 font-bold uppercase tracking-widest" id="al-rutina-objetivo">Cargando objetivo...</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="student-routine-exercises">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="rutinas-lista"></div>
                </div>
            </div>
			<!-- Vista de Acceso Virtual -->
			<div id="view-acceso-virtual" class="view-content">
				<div class="flex justify-between items-center mb-8">
					<div>
						<h3 class="text-3xl font-black italic uppercase">Accesos al Valhalla</h3>
						<p class="text-[10px] text-gray-500 font-bold uppercase tracking-widest mt-1 italic">Control de Molinetes y QR en Tiempo Real</p>
					</div>
					<!-- Botón para pruebas manuales o simulación -->
					<button onclick="simularAcceso()" class="viking-bg-red text-black px-6 py-3 rounded-xl font-black uppercase italic text-[11px] shadow-lg hover:scale-105 transition-transform flex items-center gap-2">
						<i data-lucide="refresh-cw" class="w-4 h-4"></i> Simular Ingreso
					</button>
				</div>

				<div class="glass-card p-6 rounded-[2.5rem] border-white/5">
					<!-- Cabecera de columnas -->
					<div class="grid grid-cols-5 gap-4 px-6 mb-4 opacity-50 text-[10px] font-black uppercase italic tracking-widest">
						<span>Guerrero / Alumno</span>
						<span>DNI / Usuario</span>
						<span>Fecha y Hora</span>
						<span>Método</span>
						<span class="text-right">Estado</span>
					</div>
					<!-- Lista dinámica de ingresos -->
					<div id="acceso-list-view" class="flex flex-col gap-2 max-h-[600px] overflow-y-auto custom-scrollbar pr-2">
						<p class="text-center text-gray-600 italic py-10">Esperando registros de entrada...</p>
					</div>
				</div>
			</div>
        </div>
    </main>

    <!-- MODAL EDITAR RUTINA (OPTIMIZADO CON BUSCADOR Y ALINEACIÓN) -->
    <div id="modal-rutina-editor" class="viking-modal">
        <div class="glass-card p-10 rounded-[3rem] w-full max-w-5xl text-left overflow-y-auto max-h-[95vh] custom-scrollbar">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h3 class="text-2xl font-black uppercase italic mb-1">Gestionar Rutina de Musculación</h3>
                    <p id="rutina-editor-alumno" class="text-red-600 font-black uppercase italic text-sm"></p>
                </div>
                <button onclick="openModalNewExercise()" class="viking-bg-red text-black px-4 py-2 rounded-xl font-black uppercase italic text-[10px] shadow-lg">+ Crear Nuevo Ejercicio</button>
            </div>
            
            <form id="form-rutina-editor" class="space-y-6">
                <input type="hidden" id="rutina-editor-alumno-id">
                
                <div class="grid grid-cols-2 gap-6 mb-8">
                    <div class="space-y-1">
                        <label class="text-[10px] font-black uppercase text-gray-500 italic">Objetivo del Plan</label>
                        <input type="text" id="rutina-objetivo" placeholder="Ej: Hipertrofia, Fuerza, Definición" class="viking-input" required>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-black uppercase text-gray-500 italic">Vencimiento de Rutina</label>
                        <input type="date" id="rutina-vencimiento" class="viking-input" required>
                    </div>
                </div>

                <div id="rutina-editor-container" class="space-y-10">
                    <!-- Los días se agregan aquí dinámicamente -->
                </div>
                
                <button type="button" onclick="addRoutineDay()" class="w-full py-4 border border-dashed border-white/20 rounded-2xl text-gray-500 hover:text-red-600 hover:border-red-600 transition-all font-black uppercase italic text-[12px]">
                    + Agregar Día de Entrenamiento (A, B, C...)
                </button>

                <div class="flex gap-4 pt-6 border-t border-white/5">
                    <button type="button" onclick="closeModal('modal-rutina-editor')" class="flex-1 py-4 bg-white/5 rounded-2xl font-black uppercase italic text-[11px]">Cancelar</button>
                    <button type="submit" class="flex-1 py-4 viking-bg-red text-black rounded-2xl font-black uppercase italic text-[11px] shadow-xl">Guardar Plan Completo</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL PARA CREAR NUEVO EJERCICIO EN LIBRERÍA -->
    <div id="modal-nuevo-ejercicio" class="viking-modal">
        <div class="glass-card p-10 rounded-[3rem] w-full max-w-md text-left">
            <h3 class="text-xl font-black uppercase italic mb-6">Nuevo Ejercicio en Librería</h3>
            <form id="form-nuevo-ejercicio-lib" class="space-y-4">
                <input type="text" id="lib-ex-nombre" placeholder="Nombre del Ejercicio (ej: Sentadilla)" required class="viking-input">
                <select id="lib-ex-grupo" required class="viking-input">
                    <option value="">Seleccionar Grupo Muscular</option>
                </select>
                <div class="flex gap-4 pt-4">
                    <button type="button" onclick="closeModal('modal-nuevo-ejercicio')" class="flex-1 py-3 bg-white/5 rounded-xl font-black uppercase italic text-[10px]">Cancelar</button>
                    <button type="submit" class="flex-1 py-3 viking-bg-red text-black rounded-xl font-black uppercase italic text-[10px]">Crear Ejercicio</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL CLASE -->
	<div id="modal-clase" class="viking-modal">
		<div class="glass-card p-10 rounded-[3rem] w-full max-w-lg border-red-600/30">
			<h3 id="modal-clase-title" class="text-2xl font-black italic uppercase mb-6">Configurar Clase</h3>
			<form id="form-clase" class="space-y-4">
				<input type="hidden" id="cl-id">
				<div class="w-full">
					<input type="text" id="cl-nombre" placeholder="Nombre de Clase" class="viking-input" required>
					<!-- El selector de coach global se elimina visualmente porque elegiremos coach por turno -->
					<input type="hidden" id="cl-coach-select" value="Staff"> 
				</div>
				<div class="grid grid-cols-2 gap-4">
					<input type="number" id="cl-cupo" placeholder="Cupo Máximo" class="viking-input" required>
					<input type="color" id="cl-color" value="#FF0000" class="viking-input h-[52px] cursor-pointer p-1">
				</div>

				<div class="mt-6">
					<div class="flex items-center justify-between mb-2">
						<p class="text-[10px] font-black text-gray-500 uppercase tracking-widest italic">Configuración de Turnos</p>
						<button type="button" onclick="addNewScheduleSlot()" class="text-[9px] font-black text-red-500 uppercase border border-red-500/30 px-3 py-1 rounded-full hover:bg-red-500 hover:text-black transition-all">
							+ Añadir Turno
						</button>
					</div>
					<!-- Contenedor dinámico donde se inyectarán los días y horas -->
					<div id="cl-schedule-slots" class="max-h-60 overflow-y-auto custom-scrollbar space-y-2 pr-2 border-t border-white/5 pt-4">
						<p class="text-[9px] text-gray-600 italic py-4 text-center">No hay horarios definidos</p>
					</div>
				</div>

				<div class="flex gap-4 pt-6">
					<button type="button" onclick="closeModal('modal-clase')" class="flex-1 py-4 border border-white/10 rounded-2xl font-black uppercase italic text-[11px] hover:bg-white/5 transition-all">Cancelar</button>
					<button type="submit" class="flex-1 py-4 viking-bg-red text-black rounded-2xl font-black uppercase italic text-[11px] shadow-lg">Guardar Configuración</button>
				</div>
				<button type="button" id="btn-delete-clase" class="w-full text-[10px] text-red-600 font-bold uppercase mt-4 hidden">Eliminar Clase Permanentemente</button>
			</form>
		</div>
	</div>

    <!-- Otros Modales -->
    <!-- MODAL: FICHA TÉCNICA -->
    <div id="modal-ficha-tecnica" class="viking-modal hidden fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
        <div class="glass-card p-10 rounded-[3rem] w-full max-w-2xl text-left overflow-y-auto max-h-[90vh] custom-scrollbar bg-zinc-950 border border-white/5 shadow-2xl">
            <!-- Encabezado y Datos de Membresía -->
            <div class="flex justify-between items-start mb-8">
                <div>
                    <h3 class="text-2xl font-black uppercase italic" id="ficha-nombre">-</h3>
                    <p class="text-[11px] viking-red font-black uppercase" id="ficha-dni">DNI: -</p>
                </div>
                <div class="text-right">
                    <p class="text-[10px] text-gray-500 font-black uppercase italic" id="ficha-plan">Plan: -</p>
                    <p class="text-[10px] text-gray-500 font-black uppercase italic" id="ficha-cuenta">Estado: -</p>
                </div>
            </div>
            
            <!-- Grid de Datos Antropométricos -->
            <div class="grid grid-cols-3 gap-4 mb-8">
                <div class="bg-white/5 p-4 rounded-2xl border border-white/5 text-center">
                    <p class="text-[9px] text-gray-500 font-black uppercase italic mb-1">Peso</p>
                    <p class="text-lg font-black italic" id="ficha-peso">0 kg</p>
                </div>
                <div class="bg-white/5 p-4 rounded-2xl border border-white/5 text-center">
                    <p class="text-[9px] text-gray-500 font-black uppercase italic mb-1">Altura</p>
                    <p class="text-lg font-black italic" id="ficha-altura">0 cm</p>
                </div>
                <div class="bg-white/5 p-4 rounded-2xl border border-white/5 text-center">
                    <p class="text-[9px] text-gray-500 font-black uppercase italic mb-1">IMC</p>
                    <p class="text-lg font-black italic viking-red" id="ficha-imc">0</p>
                </div>
            </div>

            <!-- Sección de Rutina Personalizada -->
            <div class="space-y-4">
                <div class="flex items-center justify-between border-l-4 border-red-600 pl-4 mb-2">
                    <h4 class="text-sm font-black uppercase italic tracking-widest">Plan de Entrenamiento</h4>
                </div>
                
                <!-- Este es el contenedor donde se inyecta la rutina agrupada y los días desplegables -->
                <div id="ficha-rutina-container" class="flex flex-col gap-2">
                    <p class="text-[10px] text-gray-600 italic text-center py-4">Cargando rutina...</p>
                </div>
            </div>

            <!-- Botón de Cierre -->
            <div class="flex gap-4 pt-10">
                <button onclick="closeModal('modal-ficha-tecnica')" class="w-full py-4 viking-bg-red text-black rounded-2xl font-black uppercase italic text-[12px] shadow-lg hover:scale-[1.02] transition-transform">
                    Cerrar Ficha del Guerrero
                </button>
            </div>
        </div>
    </div>

    <div id="modal-alumno" class="viking-modal">
        <div class="glass-card p-10 rounded-[3rem] w-full max-w-lg text-left">
            <h3 class="text-2xl font-black uppercase italic mb-8" id="modal-alumno-title">Alumno</h3>
            <form id="form-alumno" class="space-y-4">
                <input type="hidden" id="al-id">
                <input type="text" id="al-nombre" placeholder="Nombre Completo" required class="viking-input">
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="al-dni" placeholder="DNI / Usuario" required class="viking-input">
                    <input type="email" id="al-email" placeholder="Email" required class="viking-input">
                </div>
                <div class="grid grid-cols-3 gap-4">
                    <div class="space-y-1">
                        <label class="text-[9px] font-black text-gray-500 uppercase italic">Peso (kg)</label>
                        <input type="number" step="0.01" id="al-peso" placeholder="0.00" class="viking-input" oninput="calculateIMC()">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[9px] font-black text-gray-500 uppercase italic">Altura (cm)</label>
                        <input type="number" step="0.01" id="al-altura" placeholder="0.00" class="viking-input" oninput="calculateIMC()">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[9px] font-black text-red-600 uppercase italic">IMC</label>
                        <input type="text" id="al-imc" placeholder="-" readonly class="viking-input opacity-60">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-[9px] font-black text-gray-500 uppercase italic">Fecha Renovación</label>
                        <input type="date" id="al-fecha-renovacion" class="viking-input" onchange="autoCalculateExpiry()">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[9px] font-black text-gray-500 uppercase italic">Fecha Vencimiento</label>
                        <input type="date" id="al-fecha-vencimiento" class="viking-input">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <select id="al-plan" class="viking-input" required onchange="autoCalculateExpiry()"></select>
                    <input type="password" id="al-pass" placeholder="Contraseña de Acceso" class="viking-input">
                </div>
                <div class="flex gap-4 pt-4">
                    <button type="button" onclick="closeModal('modal-alumno')" class="flex-1 py-4 bg-white/5 rounded-2xl font-black uppercase italic text-[11px]">Cancelar</button>
                    <button type="button" id="btn-delete-alumno" class="hidden py-4 px-4 bg-red-900/40 rounded-2xl font-black uppercase italic text-[11px] text-red-500">Eliminar</button>
                    <button type="submit" id="btn-save-alumno-modal" class="flex-1 py-4 viking-bg-red text-black rounded-2xl font-black uppercase italic text-[11px]">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-movimiento" class="viking-modal">
        <div class="glass-card p-10 rounded-[3rem] w-full max-w-lg text-left">
            <h3 class="text-2xl font-black uppercase italic mb-8">Nuevo Movimiento</h3>
            <form id="form-movimiento" class="space-y-4">
                <select id="mov-tipo" class="viking-input" required>
                    <option value="Ingreso">Ingreso</option>
                    <option value="Egreso">Egreso</option>
                </select>
                <input type="number" id="mov-monto" placeholder="Monto ($)" required class="viking-input">
                <input type="text" id="mov-desc" placeholder="Descripción" required class="viking-input">
                <div class="flex gap-4 pt-4">
                    <button type="button" onclick="closeModal('modal-movimiento')" class="flex-1 py-4 bg-white/5 rounded-2xl font-black uppercase italic text-[11px]">Cancelar</button>
                    <button type="submit" id="btn-save-mov-modal" class="flex-1 py-4 viking-bg-red text-black rounded-2xl font-black uppercase italic text-[11px]">Cargar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-staff" class="viking-modal">
        <div class="glass-card p-10 rounded-[3rem] w-full max-w-lg text-left">
            <h3 class="text-2xl font-black uppercase italic mb-4" id="modal-staff-title">Personal</h3>
            <form id="form-staff" class="space-y-4">
                <input type="hidden" id="stf-id">
                <input type="hidden" id="stf-rol">
                <input type="text" id="stf-nombre" placeholder="Nombre Completo" required class="viking-input">
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="stf-dni" placeholder="DNI / Usuario" required class="viking-input">
                    <input type="text" id="stf-esp" placeholder="Especialidad / Cargo" class="viking-input">
                </div>
                <div class="space-y-4">
                    <label class="text-[10px] font-black text-red-600 uppercase italic">Seguridad</label>
                    <input type="password" id="stf-pass" placeholder="Nueva Contraseña" class="viking-input">
                </div>
                <div class="flex gap-4 pt-6">
                    <button type="button" onclick="closeModal('modal-staff')" class="flex-1 py-4 bg-white/5 rounded-2xl font-black uppercase italic text-[11px]">Cancelar</button>
                    <button type="button" id="btn-delete-staff" class="hidden py-4 px-4 bg-red-900/40 rounded-2xl font-black uppercase italic text-[11px] text-red-500">Eliminar</button>
                    <button type="submit" id="btn-save-staff-modal" class="flex-1 py-4 viking-bg-red text-black rounded-2xl font-black uppercase italic text-[11px]">Guardar Staff</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-stock" class="viking-modal">
        <div class="glass-card p-10 rounded-[3rem] w-full max-w-lg text-left">
            <h3 class="text-2xl font-black uppercase italic mb-8" id="modal-stock-title">Mercadería</h3>
            <form id="form-stock" class="space-y-4">
                <input type="hidden" id="stock-id">
                <input type="text" id="stock-nombre" placeholder="Nombre del Producto" required class="viking-input">
                <div class="grid grid-cols-2 gap-4">
                    <input type="number" id="stock-cant" placeholder="Stock" required class="viking-input">
                    <input type="number" id="stock-precio" placeholder="Precio Unidad ($)" required class="viking-input">
                </div>
                <div class="flex gap-4 pt-4">
                    <button type="button" onclick="closeModal('modal-stock')" class="flex-1 py-4 bg-white/5 rounded-2xl font-black uppercase italic text-[11px]">Cancelar</button>
                    <button type="button" id="btn-delete-stock" class="hidden py-4 px-4 bg-red-900/40 rounded-2xl font-black uppercase italic text-[11px] text-red-500">Eliminar</button>
                    <button type="submit" id="btn-save-stock-modal" class="flex-1 py-4 viking-bg-red text-black rounded-2xl font-black uppercase italic text-[11px]">Guardar Mercadería</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-plan" class="viking-modal">
        <div class="glass-card p-10 rounded-[3rem] w-full max-w-lg text-left">
            <h3 class="text-2xl font-black uppercase italic mb-8" id="modal-plan-title">Plan</h3>
            <form id="form-plan" class="space-y-4">
                <input type="hidden" id="plan-id">
                <input type="text" id="plan-nombre" placeholder="Nombre del Plan" required class="viking-input">
                <div class="grid grid-cols-2 gap-4">
                    <select id="plan-tipo" class="viking-input" required></select>
                    <input type="number" id="plan-precio" placeholder="Precio ($)" required class="viking-input">
                </div>
                <div class="flex gap-4 pt-4">
                    <button type="button" onclick="closeModal('modal-plan')" class="flex-1 py-4 bg-white/5 rounded-2xl font-black uppercase italic text-[11px]">Cancelar</button>
                    <button type="button" id="btn-delete-plan" class="hidden py-4 px-4 bg-red-900/40 rounded-2xl font-black uppercase italic text-[11px] text-red-500">Eliminar</button>
                    <button type="submit" id="btn-save-plan-modal" class="flex-1 py-4 viking-bg-red text-black rounded-2xl font-black uppercase italic text-[11px]">Guardar Plan</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-inscriptos" class="viking-modal">
        <div class="glass-card p-10 rounded-[3rem] w-full max-w-lg text-left">
            <h3 class="text-2xl font-black uppercase italic mb-6">Alumnos Inscriptos</h3>
            <div id="inscriptos-lista" class="space-y-3 max-h-96 overflow-y-auto custom-scrollbar mb-8"></div>
            <button onclick="closeModal('modal-inscriptos')" class="w-full py-4 viking-bg-red text-black rounded-2xl font-black uppercase italic text-[11px]">Cerrar</button>
        </div>
    </div>

    <script>
        const PRODUCTION_URL = "/api"; 
        const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' || window.location.protocol === 'file:'
            ? (PRODUCTION_URL === "/api" ? "http://localhost:8000/api" : PRODUCTION_URL)
            : "/api";

        let state = { 
            alumnos: [], planes: [], stock: [], clases: [], user: null, 
            profesores: [], administrativos: [], tiposPlanes: [],
            reservas: [], 
            cart: [], currentPaymentMethod: '',
            cobrarTab: 'mercaderia',
            gruposMusculares: [], ejerciciosLibreria: [],
			accesos: []
        };

        function showVikingToast(msg, error = false) {
            const toast = document.getElementById('viking-toast');
            toast.innerText = msg;
            toast.style.background = error ? '#660000' : '#FF0000';
            toast.style.color = error ? '#FF0000' : 'black';
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

		function applyPermissions() {
			if (!state.user) return;
			const rol = state.user.rol_nombre || "";
			const isAlumno = rol === "Alumno";
			const isAdmin = rol === "Administrador" || rol === "Supervisor";
			const isStaffAutorizado = rol === "Administrador" || rol === "Supervisor" || rol === "Administracion";
			
			// Layout Dashboard
			const adminDash = document.getElementById('admin-dashboard-layout');
			const aluDash = document.getElementById('alumno-dashboard-layout');
			if(adminDash) adminDash.style.display = isAlumno ? 'none' : 'block';
			if(aluDash) aluDash.style.display = isAlumno ? 'block' : 'none';

			const navVirtual = document.getElementById('nav-section-virtual');
			if (navVirtual) {
				// Usamos setProperty para forzar el estilo si el CSS es muy estricto
				navVirtual.style.setProperty('display', isStaffAutorizado ? 'block' : 'none', 'important');
			}

			// Elementos de Navegación (Usamos setProperty para forzar sobre el CSS)
			const navAlumnos = document.getElementById('nav-alumnos');
			const navPlanes = document.getElementById('nav-planes');
			const navClases = document.getElementById('nav-clases');
			const navStaff = document.getElementById('nav-section-staff');
			const navOperativa = document.getElementById('nav-section-operativa');

			if (isAlumno) {
				// OCULTAR ESTRICTAMENTE PARA ALUMNOS
				if(navAlumnos) navAlumnos.style.setProperty('display', 'none', 'important');
				if(navPlanes) navPlanes.style.setProperty('display', 'none', 'important');
				if(navClases) navClases.style.setProperty('display', 'none', 'important');
				if(navStaff) navStaff.style.setProperty('display', 'none', 'important');
				if(navOperativa) navOperativa.style.setProperty('display', 'none', 'important');
				
				// Ocultar columnas de acciones en tablas
				document.querySelectorAll('.action-col').forEach(el => el.style.setProperty('display', 'none', 'important'));
				
				// Ocultar botones de "Crear Nuevo"
				['btn-nuevo-alumno', 'btn-nuevo-plan', 'btn-nueva-clase', 'btn-nuevo-stock', 'btn-nuevo-prof', 'btn-nuevo-adm'].forEach(id => { 
					const b = document.getElementById(id); 
					if(b) b.style.setProperty('display', 'none', 'important'); 
				});
			} else {
				// MOSTRAR PARA STAFF
				if(navAlumnos) navAlumnos.style.display = 'flex';
				if(navPlanes) navPlanes.style.display = 'flex';
				if(navClases) navClases.style.display = 'flex';
				
				if(navStaff) navStaff.style.display = (isAdmin) ? 'block' : 'none';
				if(navOperativa) navOperativa.style.display = (isAdmin || rol === "Administracion") ? 'block' : 'none';
				
				document.querySelectorAll('.action-col').forEach(el => el.style.display = 'table-cell');
			}
			
			
			
			if(window.lucide) lucide.createIcons();
		}

		async function renderStudentDashboard() {
			const u = state.user; if (!u) return;
			
			// 1. Cargar Datos básicos (Tu código original intacto)
			document.getElementById('al-dash-name').innerText = u.nombre_completo;
			document.getElementById('al-dash-dni').innerText = u.dni;
			document.getElementById('al-dash-plan').innerText = u.plan?.nombre || 'SIN PLAN';
			document.getElementById('al-dash-vencimiento').innerText = u.fecha_vencimiento || '-';
			document.getElementById('al-dash-renovacion').innerText = u.fecha_ultima_renovacion || '-';
			
			const initials = u.nombre_completo ? u.nombre_completo.split(' ').filter(n=>n).map(n=>n[0]).join('').toUpperCase() : "??";
			document.getElementById('al-dash-initials').innerText = initials;
			
			// Mantenemos Peso, Altura e IMC (Como pediste)
			document.getElementById('al-dash-peso').innerText = u.peso || '0';
			document.getElementById('al-dash-altura').innerText = u.altura || '0';
			document.getElementById('al-dash-imc').innerText = u.imc || '0';

			// --- NUEVA LÓGICA: CRÉDITOS MENSUALES ---
			const limite = u.plan?.clases_mensuales || 0;
			const esFull = limite > 100; // Si es más de 100, asumimos ilimitado (Plan Full)

			// Recargamos reservas para asegurar el conteo exacto al momento
			const allReservas = await apiFetch('/reservas');
			if (!allReservas.error && Array.isArray(allReservas)) {
				state.reservas = allReservas; 
			}
			
			// Filtramos reservas de ESTE ALUMNO en ESTE MES
			const hoy = new Date();
			const reservasMes = state.reservas.filter(r => {
				// Aseguramos compatibilidad de fechas
				const fecha = new Date(r.fecha_clase || r.fecha_reserva || r.fecha); 
				return (r.alumno_dni === u.dni || r.usuario_id === u.id) && 
					   fecha.getMonth() === hoy.getMonth() &&
					   fecha.getFullYear() === hoy.getFullYear();
			});

			const usadas = reservasMes.length;
			const restantes = esFull ? "∞" : Math.max(0, limite - usadas);

			// Actualizamos los elementos de Créditos (Solo si agregaste el HTML nuevo, si no, no rompe nada)
			const elUsadas = document.getElementById('al-dash-usadas');
			if(elUsadas) elUsadas.innerText = usadas;
			
			const elCreditos = document.getElementById('al-dash-creditos');
			if(elCreditos) {
				elCreditos.innerHTML = esFull ? 
				`<span class="text-2xl">∞</span>` : 
				`<span class="${restantes <= 2 ? 'text-red-500' : 'text-white'}">${restantes}</span>`;
			}
			// ----------------------------------------

			// Resumen de Rutina (Tu código original)
			let res = await apiFetch(`/rutinas/usuario/${u.id}`);
			let rutina = null;
			if (Array.isArray(res) && res.length > 0) rutina = res[0]; 
			else if (res && !res.error && res.id) rutina = res;

			const summaryContainer = document.getElementById('al-dash-rutina-summary'); 
			const contentContainer = document.getElementById('al-dash-rutina-content');

			if (summaryContainer && contentContainer) {
				if (rutina) {
					summaryContainer.classList.remove('hidden');
					contentContainer.innerHTML = `
						<p class="text-[12px] font-black italic text-white mb-1">${rutina.objetivo || 'Rutina Personalizada'}</p>
						<p class="text-[10px] text-gray-500 uppercase font-bold">${(rutina.dias||[]).length} Días de Entrenamiento</p>
					`;
				} else {
					summaryContainer.classList.add('hidden');
				}
			}
			
			// Próximas Clases (Tu código original, mejorado el filtro)
			const upcoming = document.getElementById('al-dash-upcoming');
			const misR = state.reservas.filter(r => r.alumno_dni === u.dni || r.usuario_id === u.id);
			
			// Ordenar por fecha para mostrar las más cercanas primero
			misR.sort((a, b) => new Date(a.fecha_clase) - new Date(b.fecha_clase));

			if (upcoming) {
				upcoming.innerHTML = misR.length ? misR.map(r => `
					<div class="flex items-center justify-between p-3 bg-white/5 rounded-xl border border-red-600/10 mb-2">
						<div>
							<p class="text-[10px] font-black uppercase italic text-white">${r.clase_nombre}</p>
							<p class="text-[9px] text-gray-500 font-bold">${r.dia_nombre || 'Fecha'} - ${r.horario || ''}hs</p>
						</div>
						<button onclick="cancelBooking(${r.id})" class="text-[9px] text-red-500 hover:text-white">X</button>
					</div>
				`).join('') : '<p class="text-gray-500 italic text-[11px]">Sin reservas próximas.</p>';
			}
		}
		
		// 1. Dibuja una fila de horario (Día + Hora + Coach)
			function addNewScheduleSlot(data = { dia: 1, horario: 7, coach: "" }) {
				const container = document.getElementById('cl-schedule-slots');
				if (container.querySelector('p.italic')) container.innerHTML = "";

				const row = document.createElement('div');
				row.className = "schedule-slot-row flex flex-col gap-2 bg-white/5 p-3 rounded-2xl border border-white/5 mb-2";
				
				const diasMap = {1: 'Lunes', 2: 'Martes', 3: 'Miércoles', 4: 'Jueves', 5: 'Viernes', 6: 'Sábado'};
				
				// Opciones de Días
				let diasOptions = "";
				for(let d=1; d<=6; d++) diasOptions += `<option value="${d}" ${data.dia == d ? 'selected' : ''}>${diasMap[d]}</option>`;

				// Opciones de Horas
				let horasOptions = "";
				for(let i=7; i<=21.5; i+=0.5) {
					const label = i % 1 === 0 ? `${i}:00` : `${Math.floor(i)}:30`;
					horasOptions += `<option value="${i}" ${data.horario == i ? 'selected' : ''}>${label} HS</option>`;
				}

				row.innerHTML = `
					<div class="flex items-center justify-between gap-2">
						<select class="viking-input py-1 h-9 text-[10px] flex-1 slot-dia">${diasOptions}</select>
						<select class="viking-input py-1 h-9 text-[10px] flex-1 slot-hora">${horasOptions}</select>
						<button type="button" onclick="this.closest('.schedule-slot-row').remove()" class="text-red-500 p-1">
							<i data-lucide="x" class="w-4 h-4"></i>
						</button>
					</div>
				`;
				container.appendChild(row);
				if(window.lucide) lucide.createIcons();
			}

			// 2. Reemplaza tu función de guardado de clase
			async function saveClaseVikinga(e) {
				if(e) e.preventDefault();
				const id = document.getElementById('cl-id').value;
				const slotRows = document.querySelectorAll('.schedule-slot-row');
				
				const horarios_detalle = [];
				slotRows.forEach(row => {
					horarios_detalle.push({
						dia: parseInt(row.querySelector('.slot-dia').value),
						horario: parseFloat(row.querySelector('.slot-hora').value)
					});
				});

				const payload = {
					nombre: document.getElementById('cl-nombre').value,
					coach: document.getElementById('cl-coach-select').value,
					color: document.getElementById('cl-color').value,
					capacidad_max: parseInt(document.getElementById('cl-cupo').value),
					horarios_detalle: horarios_detalle
				};

				const method = id ? 'PUT' : 'POST';
				const res = await apiFetch(id ? `/clases/${id}` : '/clases', method, payload);
				if(!res.error) {
					closeModal('modal-clase');
					loadClases();
					showVikingToast("Operación exitosa");
				}
			}

        async function fetchReservas() {
			const data = await apiFetch('/reservas');
			if (!data.error) {
				// Guardamos las reservas en el estado global para que el calendario las vea
				state.reservas = Array.isArray(data) ? data : [];
				return state.reservas;
			} else {
				console.error("Error cargando reservas:", data.error);
				return [];
			}
		}

        async function bookClass(claseId) {
            if (state.user.rol_nombre !== "Alumno") return;
            const clase = state.clases.find(c => c.id === claseId);
            if (!clase) return;

            const cupoMax = clase.capacidad_max || 40; 
            const cupoActual = state.reservas.filter(r => r.clase_id === claseId).length;

            if (cupoActual >= cupoMax) {
                showVikingToast("¡Clase Llena! No hay más cupos.", true);
                return;
            }

            const yaReservado = state.reservas.find(r => r.clase_id === claseId && r.alumno_dni === state.user.dni);
            if (yaReservado) {
                showVikingToast("Ya estás anotado en esta clase.", true);
                return;
            }

            const data = { usuario_id: parseInt(state.user.id), clase_id: parseInt(clase.id) };
            const res = await apiFetch('/reservas', 'POST', data);
            if (!res.error) {
                showVikingToast("¡Reserva confirmada!");
                await fetchReservas();
                renderCalendar();
                renderStudentDashboard();
            } else {
                showVikingToast("Error al reservar: " + res.error, true);
            }
        }

        async function cancelBooking(id) {
            const res = await apiFetch(`/reservas/${id}`, 'DELETE');
            if (!res.error) {
                showVikingToast("Reserva Cancelada.");
                await fetchReservas();
                renderCalendar();
                renderStudentDashboard();
            }
        }

        function openInscriptos(claseId) {
            const inscriptos = state.reservas.filter(r => r.clase_id === claseId);
            const listaDiv = document.getElementById('inscriptos-lista');
            listaDiv.innerHTML = inscriptos.length ? inscriptos.map(r => {
                return `
                <div class="flex items-center justify-between p-4 bg-white/5 rounded-2xl border border-white/5">
                    <div>
                        <p class="text-[12px] font-black uppercase italic text-left">${r.alumno_dni}</p>
                        <p class="text-[9px] text-gray-500 font-bold">Reserva #${r.id}</p>
                    </div>
                    <button onclick="deleteBookingAdmin(${r.id}, ${claseId})" class="text-red-600 hover:text-white"><i data-lucide="user-minus" class="w-4 h-4"></i></button>
                </div>`;
            }).join('') : '<p class="text-center text-gray-500 italic py-10">No hay alumnos anotados aún.</p>';
            lucide.createIcons();
            openModal('modal-inscriptos');
        }

        async function deleteBookingAdmin(reservaId, claseId) {
            if(!confirm("¿Quitar alumno de la clase?")) return;
            const res = await apiFetch(`/reservas/${reservaId}`, 'DELETE');
            if(!res.error) {
                await fetchReservas();
                openInscriptos(claseId);
                renderCalendar();
                showVikingToast("Alumno removido del cupo.");
            }
        }

		/**
		 * RENDERIZADO DEL CALENDARIO VIKINGO (VERSIÓN FINAL)
		 * Incluye: Drag & Drop funcional, Contador de Cupos Real y Estética de 1 Hora.
		 */
		function renderCalendar() {
			const cal = document.getElementById('calendar-grid'); 
			if (!cal) return;

			const isAdmin = (state.user?.rol_nombre === "Administrador" || state.user?.rol_nombre === "Supervisor");
			const esAlumno = (state.user?.rol_nombre === "Alumno");

			// 1. Limpiar y crear cabeceras (Solo una vez al inicio)
			cal.innerHTML = `
				<div class="cal-header">HORA</div>
				<div class="cal-header">LUNES</div>
				<div class="cal-header">MARTES</div>
				<div class="cal-header">MIÉRCOLES</div>
				<div class="cal-header">JUEVES</div>
				<div class="cal-header">VIERNES</div>
				<div class="cal-header">SÁBADO</div>
			`;

			// 2. Generar grilla de tiempo (7hs a 21:30hs)
			for(let h=7; h<=21.5; h+=0.5) {
				const label = h % 1 === 0 ? `${h}:00` : `${Math.floor(h)}:30`;
				
				// Creamos el label de la hora como elemento DOM para no usar innerHTML +=
				const hourLabel = document.createElement('div');
				hourLabel.className = "cal-cell flex items-center justify-center font-black text-[9px] text-white/40 bg-white/5 border-r border-white/20";
				hourLabel.innerText = label;
				cal.appendChild(hourLabel);
				
				for(let d=1; d<=6; d++) {
					const isSat = d === 6; 
					const isClosed = isSat && (h < 10 || h > 13);
					const cellId = `cell-${d}-${h.toString().replace('.','_')}`;
					
					const cell = document.createElement('div');
					cell.id = cellId;
					cell.className = `cal-cell ${isClosed ? 'cal-cell-closed' : ''}`;
					
					if (isAdmin && !isClosed) {
						// Evento crucial: preventDefault() permite que la celda acepte el drop
						cell.ondragover = (e) => {
							e.preventDefault(); 
							e.dataTransfer.dropEffect = "move"; // Cambia el cursor a "mover"
							cell.classList.add('bg-red-600/10');
						};
						
						cell.ondragleave = () => cell.classList.remove('bg-red-600/10');
						
						cell.ondrop = async (e) => {
							e.preventDefault();
							cell.classList.remove('bg-red-600/10');
							
							const claseId = e.dataTransfer.getData("claseId");
							const oldDia = e.dataTransfer.getData("oldDia");
							const oldHorario = e.dataTransfer.getData("oldHorario");
							
							if (!claseId) return;

							const parts = cell.id.split('-');
							const newDia = parseInt(parts[1]);
							const newHorario = parseFloat(parts[2].replace('_', '.'));

							if (oldDia == newDia && oldHorario == newHorario) return;

							const res = await apiFetch(`/clases/${claseId}/move`, 'PUT', {
								old_dia: parseInt(oldDia),
								old_horario: parseFloat(oldHorario),
								new_dia: newDia,
								new_horario: newHorario
							});

							if (!res.error) {
								showVikingToast("¡Turno Reubicado!");
								await loadClases(); 
							} else {
								showVikingToast("Error al mover: " + res.error, true);
							}
						};
					}
					cal.appendChild(cell);
				}
			}

			// 3. Renderizado de Clases
			state.clases.forEach(c => {
				const horarios = Array.isArray(c.horarios_detalle) ? c.horarios_detalle : [];
				
				horarios.forEach(slot => {
					const hKey = slot.horario.toString().replace('.', '_');
					const cell = document.getElementById(`cell-${slot.dia}-${hKey}`);
					
					if (cell) {
						const reservasArray = Array.isArray(state.reservas) ? state.reservas : [];
						const cupoMax = c.capacidad_max || 40;
						
						const cupoActual = reservasArray.filter(r => 
							String(r.clase_id) === String(c.id) && 
							Number(r.dia_semana) === Number(slot.dia) && 
							Number(r.horario) === Number(slot.horario)
						).length;
						
						const estaLleno = cupoActual >= cupoMax;

						const badge = document.createElement('div');
						badge.className = "class-badge group transition-all hover:scale-105 active:scale-95 shadow-lg"; 
						badge.style.backgroundColor = c.color || '#FF0000';
						
						if (isAdmin) {
							badge.draggable = true; 
							badge.ondragstart = (e) => {
								e.dataTransfer.setData("claseId", c.id);
								e.dataTransfer.setData("oldDia", slot.dia);
								e.dataTransfer.setData("oldHorario", slot.horario);
								badge.classList.add('opacity-40');
							};
							badge.ondragend = () => badge.classList.remove('opacity-40');
						}

						badge.innerHTML = `
							<div class="flex flex-col items-center justify-center h-full w-full px-1">
								<span class="text-[11px] leading-none mb-1 font-black uppercase italic text-black">
									${c.nombre}
								</span>
								<span class="text-[9px] font-extrabold text-black/70 mb-1 lowercase italic leading-none">
									${slot.coach || 'staff'}
								</span>
								<div class="bg-black/15 px-2 py-0.5 rounded-full text-[8px] font-black ${estaLleno ? 'text-red-700 animate-pulse' : 'text-black/60'}">
									${cupoActual}/${cupoMax}
								</div>
							</div>
						`;
						
						badge.onclick = (e) => {
							e.stopPropagation();
							if (esAlumno) {
								if (estaLleno) showVikingToast("Cupo lleno para este turno", true);
								else confirmarReservaVikinga(c, slot.dia, slot.horario);
							} else {
								if (typeof openInscriptos === 'function') openInscriptos(c.id, slot.dia, slot.horario);
							}
						};

						cell.appendChild(badge);
					}
				});
			});

			if (window.lucide) lucide.createIcons();
		}
		
		/**
		 * FUNCIÓN DE RESERVA CORREGIDA
		 * Evita el error de "Vanhala" manejando fallos internos sin crashear.
		 */
		async function confirmarReservaVikinga(clase, dia, horario) {
			const diasMap = {1: 'Lunes', 2: 'Martes', 3: 'Miércoles', 4: 'Jueves', 5: 'Viernes', 6: 'Sábado'};
			const horaLabel = horario % 1 === 0 ? `${horario}:00` : `${Math.floor(horario)}:30`;
			
			showVikingToast(`Procesando reserva...`);

			const payload = {
				usuario_id: state.user.id,
				clase_id: clase.id,
				dia_semana: dia,
				horario: horario
			};

			try {
				const res = await apiFetch('/reservas', 'POST', payload);
				
				if (!res.error) {
					showVikingToast(`¡Reserva confirmada! ${diasMap[dia]} ${horaLabel}hs`);
					
					// INTENTO DE ACTUALIZACIÓN PROTEGIDO:
					// Si una función falla, no queremos que salte al 'catch' de conexión.
					try {
						// 1. Refrescar reservas (Intentamos con el nombre que tengas)
						if (typeof fetchReservas === 'function') {
							await fetchReservas(); 
						} else if (typeof loadReservas === 'function') {
							await loadReservas();
						} else {
							// Si no hay función, pedimos los datos manualmente para actualizar el estado
							const manualData = await apiFetch('/reservas');
							if (!manualData.error) state.reservas = manualData;
						}

						// 2. Redibujar calendario
						renderCalendar(); 
						
						// 3. Redibujar dashboard
						if (typeof renderStudentDashboard === 'function') {
							renderStudentDashboard();
						}
					} catch (innerError) {
						console.warn("Reserva exitosa pero fallo el refresco visual:", innerError);
					}

				} else {
					// Error del servidor (ej: sin créditos)
					let errorMsg = res.error || "No se pudo procesar";
					if (typeof res.error === 'string' && res.error.startsWith('{')) {
						try { errorMsg = JSON.parse(res.error).detail || errorMsg; } catch(e){}
					}
					showVikingToast(errorMsg, true);
				}
			} catch (err) {
				console.error("Error crítico en Reserva:", err);
				showVikingToast("Error de sincronización con el Valhalla", true);
			}
		}

		/**
		 * PROCESO DE RESERVA
		 * Separada de renderCalendar para evitar errores de scope y cierres.
		 */
		async function confirmarReservaVikinga(clase, dia, horario) {
			const diasMap = {1: 'Lunes', 2: 'Martes', 3: 'Miércoles', 4: 'Jueves', 5: 'Viernes', 6: 'Sábado'};
			const horaLabel = horario % 1 === 0 ? `${horario}:00` : `${Math.floor(horario)}:30`;
			
			showVikingToast(`Procesando reserva para ${clase.nombre}...`);

			const payload = {
				usuario_id: state.user.id,
				clase_id: clase.id,
				dia_semana: dia,
				horario: horario
			};

			try {
				const res = await apiFetch('/reservas', 'POST', payload);
				
				if (!res.error) {
					showVikingToast(`¡Victoria! Reserva confirmada: ${diasMap[dia]} ${horaLabel}hs`);
					
					// Sincronización completa de datos
					await fetchReservas(); // El nombre correcto según tu código
					
					// Actualización visual inmediata
					renderCalendar(); 
					if (typeof renderStudentDashboard === 'function') {
						renderStudentDashboard();
					}
				} else {
					let errorMsg = res.error || "No se pudo procesar la reserva";
					// Si el error viene como JSON string, lo parseamos
					if (typeof res.error === 'string' && res.error.startsWith('{')) {
						try { errorMsg = JSON.parse(res.error).detail || errorMsg; } catch(e){}
					}
					showVikingToast(errorMsg, true);
				}
			} catch (err) {
				console.error("Error en Reserva:", err);
				showVikingToast("Error de sincronización con el Valhalla", true);
			}
		}

        function setCobrarTab(tab) {
            state.cobrarTab = tab;
            document.querySelectorAll('.cobrar-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
            renderCobrar();
        }

        function renderCobrar() {
            const displayArea = document.getElementById('cobrar-display-area');
            const searchVal = document.getElementById('cobrar-search').value.toLowerCase();
            if (state.cobrarTab === 'mercaderia') {
                const filtered = state.stock.filter(s => s.nombre_producto.toLowerCase().includes(searchVal));
                displayArea.innerHTML = `<div class="grid grid-cols-2 md:grid-cols-4 gap-4 overflow-y-auto max-h-[600px] pr-2 custom-scrollbar" id="cobrar-catalogo"></div>`;
                const catalog = document.getElementById('cobrar-catalogo');
                catalog.innerHTML = filtered.map(s => `
                    <div class="glass-card p-4 rounded-3xl relative group cursor-pointer hover:border-red-600/50" onclick="addToCart(${s.id}, 'stock')">
                        <div class="w-full h-20 viking-bg-red/10 rounded-2xl mb-3 flex items-center justify-center"><i data-lucide="package" class="w-6 h-6 opacity-20 text-white"></i></div>
                        <h4 class="text-[10px] font-black uppercase italic mb-1 truncate">${s.nombre_producto}</h4>
                        <div class="flex items-center justify-between"><p class="text-[12px] font-black italic">$ ${s.precio_venta.toLocaleString()}</p><span class="text-[9px] font-bold ${s.stock_actual < 5 ? 'text-red-500' : 'text-gray-500'}">S: ${s.stock_actual}</span></div>
                    </div>`).join('');
            } else {
                const filteredAl = state.alumnos.filter(a => a.nombre_completo.toLowerCase().includes(searchVal) || a.dni.includes(searchVal));
                displayArea.innerHTML = `<div class="glass-card p-8 rounded-[2.5rem] h-[600px] flex flex-col"><h4 class="text-[11px] font-black uppercase italic text-red-600 mb-6 tracking-widest">Alumnos para Renovación</h4><div class="overflow-y-auto custom-scrollbar flex-1 space-y-3">${filteredAl.map(a => `<div class="flex flex-col gap-2 p-4 bg-white/5 rounded-2xl border border-white/5 hover:border-red-600/30 text-left"><div class="flex justify-between items-start"><div><p class="text-[12px] font-black italic uppercase leading-tight">${a.nombre_completo}</p><p class="text-[9px] text-gray-500">DNI: ${a.dni}</p></div></div><div class="flex gap-2 items-center mt-1"><select id="plan-select-${a.id}" class="viking-input py-1 text-[10px] h-8 bg-black/40 border-white/10 flex-1">${state.planes.map(p => `<option value="${p.id}" ${p.id === a.plan_id ? 'selected' : ''}>${p.nombre} ($${p.precio})</option>`).join('')}</select><button onclick="preparePlanCharge(${a.id})" class="px-4 py-2 rounded-xl text-[10px] font-black italic bg-green-600/20 text-green-500 hover:bg-green-600 hover:text-black transition-all">Cobrar</button></div></div>`).join('')}</div></div>`;
            }
            lucide.createIcons();
            updateCartUI();
        }

        document.getElementById('cobrar-search').oninput = renderCobrar;

        function addToCart(id, type) {
            if (type === 'stock') {
                const product = state.stock.find(s => s.id === id);
                if (!product || product.stock_actual <= 0) return;
                const existing = state.cart.find(c => c.id === id && c.type === 'stock');
                if (existing) { if (existing.qty < product.stock_actual) existing.qty++; }
                else state.cart.push({ ...product, qty: 1, type: 'stock' });
            }
            updateCartUI();
        }

        function preparePlanCharge(alumnoId) {
            const al = state.alumnos.find(a => a.id === alumnoId);
            if (!al) return;
            const selectedPlanId = parseInt(document.getElementById(`plan-select-${alumnoId}`).value);
            const plan = state.planes.find(p => p.id === selectedPlanId);
            if (!plan) return;
            state.cart = state.cart.filter(c => c.type !== 'plan');
            state.cart.push({ id: `plan-${al.id}`, nombre_producto: `RENOV: ${al.nombre_completo} (${plan.nombre})`, precio_venta: plan.precio, qty: 1, type: 'plan', alumno_id: al.id, plan_id_cobrado: plan.id });
            updateCartUI();
        }

        function updateCartUI() {
            const list = document.getElementById('cobrar-lista-carrito');
            if (state.cart.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-500 text-[11px] italic py-10">Sin ítems seleccionados</p>';
                document.getElementById('cobrar-subtotal').innerText = '$ 0';
                document.getElementById('cobrar-total').innerText = '$ 0';
                return;
            }
            list.innerHTML = state.cart.map((c, idx) => `<div class="flex items-center justify-between bg-white/5 p-3 rounded-xl border border-white/5"><div class="overflow-hidden text-left"><p class="text-[11px] font-black uppercase italic truncate">${c.nombre_producto}</p><p class="text-[10px] text-gray-500 font-bold">VALOR: $ ${c.precio_venta.toLocaleString()}</p></div><button onclick="removeFromCart(${idx})" class="text-red-600 hover:text-white"><i data-lucide="trash-2" class="w-3 h-3"></i></button></div>`).join('');
            const total = state.cart.reduce((acc, c) => acc + (c.qty * c.precio_venta), 0);
            document.getElementById('cobrar-subtotal').innerText = `$ ${total.toLocaleString()}`;
            document.getElementById('cobrar-total').innerText = `$ ${total.toLocaleString()}`;
            lucide.createIcons();
        }

        function removeFromCart(i) { state.cart.splice(i, 1); updateCartUI(); }
        function setPaymentMethod(m) {
            state.currentPaymentMethod = m;
            document.querySelectorAll('.payment-method-btn').forEach(b => b.classList.toggle('active', b.innerText.includes(m)));
        }

        async function finalizarVenta() {
            if (state.cart.length === 0 || !state.currentPaymentMethod) return;
            const total = state.cart.reduce((acc, c) => acc + (c.qty * c.precio_venta), 0);
            const desc = `Venta (${state.currentPaymentMethod}): ${state.cart.map(c => c.nombre_producto).join(', ')}`;
            const res = await apiFetch('/caja/movimiento', 'POST', { tipo: "Ingreso", monto: total, descripcion: desc });
            if (!res.error) {
                for (let item of state.cart) {
                    if (item.type === 'plan' && item.alumno_id) {
                        const hoy = new Date().toISOString().split('T')[0];
                        await apiFetch(`/alumnos/${item.alumno_id}`, 'PUT', { plan_id: item.plan_id_cobrado, fecha_ultima_renovacion: hoy, nombre_completo: "Actualizado", dni: "Actualizado" });
                    }
                }
                state.cart = []; state.currentPaymentMethod = '';
                showVikingToast("Pago Procesado con Éxito");
                await initApp();
                renderCobrar();
                switchView('caja');
            }
        }

		// --- REEMPLAZA TU FUNCIÓN openFichaTecnica POR ESTA VERSIÓN CON DISEÑO DE FILAS ---
		async function openFichaTecnica(alumnoId) {
			const rutinaContainer = document.getElementById('ficha-rutina-container');

			// Estado de carga visual
			rutinaContainer.innerHTML = `
				<div class="col-span-2 py-10 flex flex-col items-center justify-center space-y-4">
					<div class="w-8 h-8 border-4 border-red-600 border-t-transparent rounded-full animate-spin"></div>
					<p class="text-[10px] text-gray-500 italic uppercase tracking-widest animate-pulse text-center">Cargando datos del alumno...</p>
				</div>
			`;

			// 1. Obtener datos del alumno
			const res = await apiFetch(`/alumnos/${alumnoId}/ficha`);
			if (res.error) {
				showVikingToast("Error al conectar con el servidor", true);
				return;
			}

			// Llenar cabecera del modal
			if (document.getElementById('ficha-nombre')) document.getElementById('ficha-nombre').innerText = res.nombre_completo || 'Sin Nombre';
			if (document.getElementById('ficha-dni')) document.getElementById('ficha-dni').innerText = "DNI: " + (res.dni || '---');
			if (document.getElementById('ficha-plan')) document.getElementById('ficha-plan').innerText = "Plan: " + (res.plan || 'Sin Plan Activo');
			if (document.getElementById('ficha-cuenta')) document.getElementById('ficha-cuenta').innerText = "Estado: " + (res.estado_cuenta || 'Inactivo');
			if (document.getElementById('ficha-peso')) document.getElementById('ficha-peso').innerText = (res.peso || 0) + " kg";
			if (document.getElementById('ficha-altura')) document.getElementById('ficha-altura').innerText = (res.altura || 0) + " cm";
			if (document.getElementById('ficha-imc')) document.getElementById('ficha-imc').innerText = res.imc || 0;

			// 2. Obtener Rutina
			let rutinaData = await apiFetch(`/rutinas/usuario/${alumnoId}`);
			const rutinas = Array.isArray(rutinaData) ? rutinaData : (rutinaData && !rutinaData.error ? [rutinaData] : []);

			if (rutinas.length > 0) {
				const hoy = new Date();
				hoy.setHours(0, 0, 0, 0);

				const mainHTML = rutinas.map((rutina, rIdx) => {
					const objetivoId = `obj-group-${rIdx}`;
					const fechaVenc = rutina.fecha_vencimiento ? new Date(rutina.fecha_vencimiento + 'T23:59:59') : null;
					const esActiva = fechaVenc ? hoy <= fechaVenc : true;

					const statusBadge = esActiva 
						? `<span class="bg-green-600/20 text-green-500 border border-green-500/30 px-3 py-1 rounded-full text-[8px] font-black uppercase tracking-widest animate-pulse">Activa</span>`
						: `<span class="bg-red-600/20 text-red-500 border border-red-500/30 px-3 py-1 rounded-full text-[8px] font-black uppercase tracking-widest">Vencida</span>`;

					const diasHTML = (rutina.dias || []).map((d, dIdx) => {
						const diaId = `ficha-dia-${rIdx}-${dIdx}`;
						return `
						<div class="glass-card rounded-2xl border-white/5 overflow-hidden mb-2 transition-all">
							<!-- Cabecera del Día (Acordeón) -->
							<button onclick="toggleFichaElement('${diaId}')" class="w-full flex items-center justify-between p-4 bg-white/2 hover:bg-white/5 transition-colors group text-left">
								<div class="flex items-center gap-3">
									<div class="w-2 h-2 rounded-full ${esActiva ? 'bg-green-600 shadow-[0_0_8px_#16a34a]' : 'bg-red-600 shadow-[0_0_8px_#dc2626]'}"></div>
									<span class="text-[11px] font-black italic uppercase tracking-wider text-gray-300 group-hover:text-red-500 transition-colors">${d.nombre_dia}</span>
								</div>
								<i data-lucide="chevron-down" class="w-4 h-4 text-gray-600 transition-transform duration-500" id="icon-${diaId}"></i>
							</button>
							
							<!-- Contenido de Ejercicios del Día -->
							<div id="${diaId}" class="hidden p-4 space-y-4 bg-black/20 border-t border-white/5">
								${(d.ejercicios || d.ejercicios_list || []).map(ex => {
									const nombreEjercicio = ex.ejercicio_obj?.nombre || ex.nombre || ex.ejercicio?.nombre || "Ejercicio Sin Nombre";
									const series = ex.series_detalle || ex.series || [];
									
									return `
										<div class="flex flex-col border-l-2 border-red-600/40 pl-4 py-1.5 hover:bg-white/5 rounded-r-xl transition-all mb-4">
											<p class="text-[11px] font-black uppercase italic text-white tracking-tight mb-3">${nombreEjercicio}</p>
											
											<!-- CAMBIO CLAVE: Cabecera de columnas para las series -->
											<div class="grid grid-cols-4 gap-2 mb-2 px-2 opacity-50">
												<span class="text-[8px] font-bold uppercase text-red-600 tracking-wider">Serie</span>
												<span class="text-[8px] font-bold uppercase text-gray-400 text-center tracking-wider">Reps</span>
												<span class="text-[8px] font-bold uppercase text-gray-400 text-center tracking-wider">Peso</span>
												<span class="text-[8px] font-bold uppercase text-gray-400 text-right tracking-wider">Pausa</span>
											</div>

											<!-- CAMBIO CLAVE: Lista de Series en Filas (Rows) -->
											<div class="flex flex-col gap-1">
												${series
													.sort((a, b) => (a.numero_serie || 0) - (b.numero_serie || 0))
													.map(s => `
														<div class="grid grid-cols-4 items-center bg-white/5 px-3 py-2 rounded-lg border border-white/5 hover:border-red-600/30 transition-colors">
															<!-- Nro Serie -->
															<span class="text-[9px] font-black text-white uppercase">#${s.numero_serie}</span>
															
															<!-- Reps -->
															<div class="text-center">
																<span class="text-[11px] font-black text-white">${s.repeticiones}</span>
															</div>
															
															<!-- Peso -->
															<div class="text-center">
																<span class="text-[11px] font-black text-white">${s.peso}</span> <span class="text-[8px] text-gray-500">kg</span>
															</div>
															
															<!-- Descanso -->
															<div class="text-right">
																<span class="text-[9px] text-gray-400 italic">${s.descanso || '-'}</span>
															</div>
														</div>
													`).join('')}
											</div>

											${ex.comentario ? `
												<div class="mt-3 bg-black/40 p-2 rounded-lg border border-white/5 flex gap-2">
													<i data-lucide="info" class="w-2.5 h-2.5 text-red-600 mt-0.5 shrink-0"></i>
													<p class="text-[8px] text-gray-400 italic font-medium leading-tight">${ex.comentario}</p>
												</div>
											` : ''}
										</div>
									`;
								}).join('')}
							</div>
						</div>
						`;
					}).join('');

					// Estructura general de la tarjeta de rutina
					return `
					<div class="col-span-2 mb-4">
						<div class="bg-white/5 border border-white/10 rounded-[2rem] overflow-hidden shadow-xl">
							<button onclick="toggleFichaElement('${objetivoId}')" class="w-full flex items-center justify-between p-6 hover:bg-white/5 transition-all text-left">
								<div class="flex items-center gap-4">
									<div class="w-1 h-10 bg-red-600 rounded-full"></div>
									<div>
										<p class="text-[8px] text-gray-500 font-black uppercase tracking-[0.3em] mb-1">Plan de Entrenamiento</p>
										<h5 class="text-lg font-black italic uppercase viking-red leading-none">${rutina.objetivo || 'Rutina de Musculación'}</h5>
										<p class="text-[9px] text-gray-400 font-bold italic mt-1 flex items-center gap-1">
											<i data-lucide="calendar" class="w-3 h-3"></i> Vence: ${rutina.fecha_vencimiento || 'Indefinido'}
										</p>
									</div>
								</div>
								<div class="flex items-center gap-4">
									${statusBadge}
									<i data-lucide="chevron-down" class="w-6 h-6 text-red-600 transition-transform duration-500" id="icon-${objetivoId}"></i>
								</div>
							</button>
							<div id="${objetivoId}" class="hidden p-4 bg-black/30 border-t border-white/5">
								${diasHTML}
							</div>
						</div>
					</div>
					`;
				}).join('');

				rutinaContainer.innerHTML = mainHTML;
			} else {
				rutinaContainer.innerHTML = `
					<div class="col-span-2 p-16 border border-dashed border-white/10 rounded-[3rem] text-center bg-white/2">
						<div class="w-16 h-16 viking-bg-red/10 rounded-full flex items-center justify-center mx-auto mb-6">
							<i data-lucide="skull" class="w-8 h-8 opacity-40 text-red-600"></i>
						</div>
						<p class="text-[12px] text-gray-600 font-black uppercase italic tracking-[0.2em]">No se ha detectado un plan de batalla activo</p>
						<p class="text-[10px] text-gray-700 mt-2 font-bold">Asigna una rutina desde el gestor para ver los datos aquí.</p>
					</div>
				`;
			}

			if (window.lucide) lucide.createIcons();
			openModal('modal-ficha-tecnica');
		}

        function toggleFichaElement(id) {
            const content = document.getElementById(id);
            const icon = document.getElementById('icon-' + id);
            if (!content) return;

            const isHidden = content.classList.contains('hidden');
            
            if (isHidden) {
                content.classList.remove('hidden');
                content.classList.add('animate-in', 'fade-in', 'slide-in-from-top-2');
                if (icon) {
                    icon.style.transform = 'rotate(180deg)';
                    icon.style.color = '#FF0000'; 
                }
            } else {
                content.classList.add('hidden');
                if (icon) {
                    icon.style.transform = 'rotate(0deg)';
                    icon.style.color = id.startsWith('obj-group') ? '#dc2626' : '#6b7280';
                }
            }
        }

async function renderRutinas() {
    const rol = state.user?.rol_nombre;
    const list = document.getElementById('rutinas-lista'); // Contenedor principal
    const studentView = document.getElementById('musculacion-student-view'); // Vista detalle alumno
    
    if (rol === "Alumno") {
        // --- VISTA ALUMNO (Ve su propia rutina) ---
        if(list) list.style.display = 'none'; 
        if(studentView) studentView.classList.remove('hidden');
        document.getElementById('rutina-title').innerText = "Mi Rutina Musculación";
        
        let res = await apiFetch(`/rutinas/usuario/${state.user.id}`);
        let rutina = null;
        if (Array.isArray(res) && res.length > 0) {
            const hoy = new Date(); hoy.setHours(0,0,0,0);
            rutina = res.find(r => !r.fecha_vencimiento || new Date(r.fecha_vencimiento + 'T23:59:59') >= hoy) || res[0];
        } else if (res && !res.error && res.id) {
            rutina = res;
        }

        if (rutina) {
            document.getElementById('al-rutina-objetivo').innerText = "OBJETIVO: " + (rutina.objetivo || "Entrenamiento").toUpperCase();
            document.getElementById('student-routine-exercises').innerHTML = (rutina.dias || []).map(d => `
                <div class="glass-card p-6 rounded-2xl border-red-600/10">
                    <h5 class="font-black italic uppercase viking-red mb-4 border-b border-white/5 pb-2">${d.nombre_dia}</h5>
                    <div class="space-y-4">
                        ${(d.ejercicios || []).map(e => {
                            const exName = e.ejercicio_obj?.nombre || e.exercise_name || "Ejercicio";
                            return `
                            <div class="bg-white/5 p-4 rounded-xl border border-white/5">
                                <p class="text-[12px] font-black uppercase italic mb-2 text-white">${exName}</p>
                                <div class="space-y-1">
                                    ${(e.series_detalle || e.series || []).sort((a,b)=>a.numero_serie-b.numero_serie).map(s => `
                                        <div class="flex justify-between items-center text-[10px] bg-black/20 p-2 rounded border border-white/5">
                                            <span class="text-red-600 font-bold">Serie ${s.numero_serie}</span>
                                            <span class="text-white font-bold">${s.repeticiones} Reps</span>
                                            <span class="text-gray-400">${s.peso} Kg</span>
                                            <span class="text-gray-500 italic text-[9px]">${s.descanso || '-'}</span>
                                        </div>
                                    `).join('')}
                                </div>
                                ${e.comentario ? `<p class="text-[10px] text-gray-500 italic mt-2 border-t border-white/5 pt-1">* ${e.comentario}</p>` : ''}
                            </div>`;
                        }).join('')}
                    </div>
                </div>
            `).join('');
        } else {
            document.getElementById('al-rutina-objetivo').innerText = "SIN ASIGNAR";
            document.getElementById('student-routine-exercises').innerHTML = '<div class="col-span-2 text-center py-10"><p class="text-gray-500 italic">No tienes una rutina de musculación activa.</p></div>';
        }
    } else {
        // --- VISTA PROFESOR (Ve lista de alumnos en FILAS) ---
        if(studentView) studentView.classList.add('hidden');
        if(list) {
            list.style.display = 'flex';      // Usamos Flex
            list.style.flexDirection = 'column'; // Dirección columna para que sean filas
            list.style.gap = '10px';          // Espacio entre filas
        }
        document.getElementById('rutina-title').innerText = "Rutinas de Alumnos";
        
        // Filtro robusto (ignora mayúsculas y acentos)
        const alRutinas = state.alumnos.filter(a => {
            const planNombre = (a.plan?.nombre || "").toLowerCase();
            const normalized = planNombre.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            return normalized.includes('musculacion') || normalized.includes('completo') || normalized.includes('personalizado');
        });

        if (alRutinas.length === 0) {
            list.innerHTML = '<div class="p-10 glass-card rounded-3xl text-center"><p class="text-gray-500 italic">No se encontraron alumnos con planes de musculación.</p></div>';
        } else {
            // Renderizamos como FILAS horizontales
            list.innerHTML = alRutinas.map(a => `
                <div class="glass-card p-4 rounded-2xl border-white/5 flex items-center justify-between hover:bg-white/5 transition-colors group">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-xl viking-bg-red flex items-center justify-center font-black text-black text-sm italic">
                            ${a.nombre_completo ? a.nombre_completo[0].toUpperCase() : '?'}
                        </div>
                        <div>
                            <h4 class="text-xs font-black uppercase italic text-white group-hover:text-red-500 transition-colors">${a.nombre_completo}</h4>
                            <div class="flex gap-3 mt-1">
                                <p class="text-[9px] text-gray-500 font-bold">DNI: ${a.dni}</p>
                                <p class="text-[9px] text-red-500 font-bold uppercase tracking-wider border-l border-white/10 pl-3">${a.plan?.nombre || 'SIN PLAN'}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-2">
                        <button onclick="openFichaTecnica(${a.id})" class="px-4 py-2 border border-white/10 text-white rounded-lg text-[9px] font-black uppercase italic hover:bg-white/10 transition-colors flex items-center gap-2">
                            <i data-lucide="clipboard-list" class="w-3 h-3"></i> Ficha
                        </button>
                        <button onclick="openRoutineEditor(${a.id})" class="px-4 py-2 bg-red-600 text-black rounded-lg text-[9px] font-black uppercase italic hover:scale-105 transition-transform shadow-lg flex items-center gap-2">
                            <i data-lucide="dumbbell" class="w-3 h-3"></i> Gestionar
                        </button>
                    </div>
                </div>
            `).join('');
        }
    }
    if(window.lucide) lucide.createIcons();
}

        async function loadMusculacionMetadata() {
            const grupos = await apiFetch('/rutinas/grupos-musculares');
            const ejercicios = await apiFetch('/rutinas/ejercicios');
            state.gruposMusculares = Array.isArray(grupos) ? grupos : [];
            state.ejerciciosLibreria = Array.isArray(ejercicios) ? ejercicios : [];
            
            const selectLib = document.getElementById('lib-ex-grupo');
            if(selectLib) {
                selectLib.innerHTML = '<option value="">Seleccionar Grupo Muscular</option>' + 
                    state.gruposMusculares.map(g => `<option value="${g.id}">${g.nombre}</option>`).join('');
            }
        }

        async function openRoutineEditor(alumnoId) {
            const al = state.alumnos.find(a => a.id === alumnoId);
            if (!al) return;
            
            await loadMusculacionMetadata();
            
            document.getElementById('rutina-editor-alumno').innerText = "Alumno: " + al.nombre_completo;
            document.getElementById('rutina-editor-alumno-id').value = alumnoId;
            const container = document.getElementById('rutina-editor-container');
            container.innerHTML = "";

            const rutinaRes = await apiFetch(`/rutinas/usuario/${alumnoId}`);
            
            if (!rutinaRes.error && rutinaRes.id) {
                document.getElementById('rutina-objetivo').value = rutinaRes.objetivo;
                document.getElementById('rutina-vencimiento').value = rutinaRes.fecha_vencimiento;
                
                rutinaRes.dias.forEach(d => {
                    const ejerciciosFormateados = d.ejercicios.map(e => {
                        return {
                            ejercicio_id: e.ejercicio_id,
                            exercise_name: e.ejercicio_obj?.nombre || "Ejercicio",
                            series: e.series_detalle || [],
                            comentario: e.comentario
                        };
                    });
                    addRoutineDay(d.nombre_dia, ejerciciosFormateados);
                });
            } else {
                document.getElementById('rutina-objetivo').value = "";
                const defaultDate = new Date();
                defaultDate.setDate(defaultDate.getDate() + 30);
                document.getElementById('rutina-vencimiento').value = defaultDate.toISOString().split('T')[0];
                
                addRoutineDay("Día 1", []); 
            }

            openModal('modal-rutina-editor');
        }

        function addRoutineDay(nombre = "", ejercicios = []) {
            const container = document.getElementById('rutina-editor-container');
            const dayId = 'day-' + Math.random().toString(36).substr(2, 9);
            const dayCard = document.createElement('div');
            dayCard.className = "rutina-dia-card space-y-6";
            dayCard.dataset.dayId = dayId;
            
            dayCard.innerHTML = `
                <div class="flex justify-between items-center gap-4 border-b border-white/5 pb-4">
                    <div class="flex-1">
                        <p class="text-[9px] font-black text-gray-500 uppercase italic mb-1 tracking-widest">Nombre del Entrenamiento</p>
                        <input type="text" placeholder="Ej: Rutina A - Piernas" value="${nombre}" class="viking-input py-2 text-[14px] day-title" required>
                    </div>
                    <button type="button" onclick="this.closest('.rutina-dia-card').remove()" class="text-red-900 hover:text-red-600 transition-colors mt-4"><i data-lucide="trash-2" class="w-6 h-6"></i></button>
                </div>
                
                <div class="bg-black/40 p-5 rounded-[1.5rem] border border-red-600/10 shadow-inner">
                    <p class="text-[10px] font-black text-red-600 uppercase italic mb-3 tracking-[0.2em]">Buscar y Añadir Ejercicio</p>
                    <div class="flex gap-3">
                        <select class="viking-input py-2 text-[11px] h-10 w-1/3 search-group-filter">
                            <option value="all">Filtrar Grupo Muscular...</option>
                            ${state.gruposMusculares.map(g => `<option value="${g.id}">${g.nombre}</option>`).join('')}
                        </select>
                        <div class="relative flex-1">
                            <input type="text" placeholder="Escribe para buscar (ej: Sentadilla)..." class="viking-input py-2 text-[11px] h-10 w-full search-exercise-input" oninput="showExerciseResults(this, '${dayId}')">
                            <div class="exercise-results-list hidden absolute top-full left-0 w-full bg-[#0a0a0a] border border-red-600/30 rounded-2xl mt-2 z-50 max-h-60 overflow-y-auto custom-scrollbar shadow-2xl"></div>
                        </div>
                    </div>
                </div>

                <div class="exercises-list space-y-4">
                    <div class="exercise-grid gap-3 px-4 text-[10px] font-black text-gray-500 uppercase italic tracking-widest">
                        <span>Ejercicio Seleccionado</span>
                        <span class="text-center">Series</span>
                        <span class="text-center">Reps</span>
                        <span class="text-center">Peso</span>
                        <span class="text-center">Descanso</span>
                        <span></span>
                    </div>
                    <div class="day-exercises-container space-y-3"></div>
                </div>
            `;
            container.appendChild(dayCard);
            
            if (ejercicios.length > 0) {
                ejercicios.forEach(e => addExerciseToDay(dayId, e));
            }
            lucide.createIcons();
        }

        function showExerciseResults(input, dayId) {
            const query = input.value.toLowerCase();
            const groupFilter = input.closest('.flex').querySelector('.search-group-filter').value;
            const resultsDiv = input.nextElementSibling;

            if (query.length < 2 && groupFilter === "all") {
                resultsDiv.classList.add('hidden');
                return;
            }

            const filtered = state.ejerciciosLibreria.filter(ex => {
                const matchSearch = ex.nombre.toLowerCase().includes(query);
                const matchGroup = groupFilter === "all" || ex.grupo_muscular_id == groupFilter;
                return matchSearch && matchGroup;
            });

            if (filtered.length === 0) {
                resultsDiv.innerHTML = '<div class="p-4 text-[11px] text-gray-500 italic">No se encontraron resultados</div>';
            } else {
                resultsDiv.innerHTML = filtered.map(ex => `
                    <div class="p-4 border-b border-white/5 text-[11px] font-black uppercase italic transition-colors" onclick="selectExerciseForDay('${dayId}', ${ex.id}, '${ex.nombre}')">
                        ${ex.nombre}
                    </div>
                `).join('');
            }
            resultsDiv.classList.remove('hidden');
        }

        function selectExerciseForDay(dayId, exerciseId, exerciseName) {
            const container = document.querySelector(`[data-day-id="${dayId}"]`);
            const searchInput = container.querySelector('.search-exercise-input');
            const resultsDiv = container.querySelector('.exercise-results-list');
            
            addExerciseToDay(dayId, { ejercicio_id: exerciseId, exercise_name: exerciseName });
            
            searchInput.value = "";
            resultsDiv.classList.add('hidden');
            showVikingToast("Añadido: " + exerciseName);
        }

			function addExerciseToDay(dayId, data = null) {
				// 1. Configuración: Series por defecto en 0
				const SERIES_POR_DEFECTO = 0; 

				const container = document.querySelector(`[data-day-id="${dayId}"] .day-exercises-container`);
				const div = document.createElement('div');
				const exerciseUniqueId = 'ex-' + Math.random().toString(36).substr(2, 9);
				
				// CAMBIO VISUAL 1: Quitamos 'bg-white/5 p-4 rounded-2xl border' para eliminar el "recuadro".
				// Usamos solo 'border-b' para separar ejercicios en filas limpias.
				div.className = "exercise-row border-b border-white/10 pb-4 mb-4";
				div.dataset.exerciseRowId = exerciseUniqueId;

				let exName = data?.exercise_name || "";
				if (!exName && data?.ejercicio_id) {
					const found = state.ejerciciosLibreria.find(e => e.id == data.ejercicio_id);
					exName = found ? found.nombre : "Ejercicio";
				}

				const initialNumSeries = (data && data.series) ? data.series.length : SERIES_POR_DEFECTO;

				div.innerHTML = `
					<div class="flex justify-between items-center mb-3">
						<div class="flex flex-col text-left">
							<input type="hidden" class="exercise-id" value="${data?.ejercicio_id}">
							<!-- Nombre del ejercicio un poco más grande y limpio -->
							<span class="text-[13px] font-black uppercase italic text-white tracking-wide">${exName}</span>
						</div>
						<div class="flex items-center gap-3">
							<div class="flex items-center gap-2 bg-white/5 px-2 py-1 rounded-lg">
								<label class="text-[9px] font-black text-gray-500 uppercase">Sets</label>
								<select class="viking-input !py-0 !px-1 w-10 h-6 text-[11px] text-center font-black bg-[#1a1a1a] text-white border border-white/20 series-select cursor-pointer focus:border-red-600 rounded" 
										onchange="updateSeriesCount('${exerciseUniqueId}', this.value)">
									${[0,1,2,3,4,5,6,7,8,9,10].map(n => 
										`<option value="${n}" class="bg-black text-white font-bold" ${n === initialNumSeries ? 'selected' : ''}>${n}</option>`
									).join('')}
								</select>
							</div>
							<button type="button" onclick="this.closest('.exercise-row').remove()" class="text-gray-500 hover:text-red-500 transition-colors">
								<i data-lucide="trash-2" class="w-4 h-4"></i>
							</button>
						</div>
					</div>

					<!-- CAMBIO VISUAL 2: Cabecera de columnas para dar aspecto de tabla ordenada -->
					<div class="grid grid-cols-4 gap-2 mb-1 px-1">
						<span class="text-[8px] font-bold uppercase text-red-600 tracking-wider">Serie</span>
						<span class="text-[8px] font-bold uppercase text-gray-500 text-center tracking-wider">Reps</span>
						<span class="text-[8px] font-bold uppercase text-gray-500 text-center tracking-wider">Peso</span>
						<span class="text-[8px] font-bold uppercase text-gray-500 text-center tracking-wider">Pausa</span>
					</div>

					<div id="series-container-${exerciseUniqueId}" class="space-y-1 mb-3"></div>
					
					<div class="mt-2 text-left pl-1">
						<input type="text" placeholder="Añadir nota técnica o comentario..." 
							value="${data?.comentario || ''}"
							class="w-full bg-transparent text-[10px] text-gray-400 border-b border-dashed border-white/10 focus:border-red-600 focus:outline-none py-1 italic placeholder-gray-700 transition-colors exercise-comment">
					</div>
				`;
				container.appendChild(div);
				
				generateSeriesRows(exerciseUniqueId, initialNumSeries, data ? data.series : null);
				if(window.lucide) lucide.createIcons();
			}
        function updateSeriesCount(containerId, newCount) {
            const container = document.getElementById(`series-container-${containerId}`);
            const currentRows = container.querySelectorAll('.serie-row');
            let savedData = [];
            
            currentRows.forEach(row => {
                savedData.push({
                    repeticiones: row.querySelector('.serie-reps').value,
                    peso: row.querySelector('.serie-weight').value,
                    descanso: row.querySelector('.serie-rest').value
                });
            });

            generateSeriesRows(containerId, newCount, savedData);
        }

        function generateSeriesRows(containerId, numSeries, existingData = null) {
			const container = document.getElementById(`series-container-${containerId}`); 
			if (!container) return; 
			container.innerHTML = "";
			
			for (let i = 1; i <= numSeries; i++) {
				const rowData = (existingData && existingData[i - 1]) ? existingData[i - 1] : null;
				
				container.innerHTML += `
					<div class="grid grid-cols-4 gap-2 items-center serie-row px-1 py-1 hover:bg-white/5 rounded transition-colors" data-serie-num="${i}">
						<!-- Número de serie alineado a la izquierda -->
						<span class="text-[10px] font-black text-white uppercase italic">#${i}</span>
						
						<!-- Inputs estilo "línea" (border-b) en lugar de caja completa -->
						<input type="text" placeholder="0" value="${rowData?.repeticiones || ''}" 
							class="bg-transparent border-b border-white/10 text-center text-[11px] text-white focus:border-red-600 focus:outline-none py-1 w-full font-bold serie-reps">
						
						<input type="text" placeholder="0" value="${rowData?.peso || ''}" 
							class="bg-transparent border-b border-white/10 text-center text-[11px] text-white focus:border-red-600 focus:outline-none py-1 w-full font-bold serie-weight">
						
						<input type="text" placeholder="90s" value="${rowData?.descanso || '90s'}" 
							class="bg-transparent border-b border-white/10 text-center text-[10px] text-gray-400 focus:border-red-600 focus:outline-none py-1 w-full italic serie-rest">
					</div>`;
			}
		}

        async function apiFetch(endpoint, method = 'GET', body = null) {
            const options = { method, headers: { 'Content-Type': 'application/json' } };
            if (body) options.body = JSON.stringify(body);
            try {
                const res = await fetch(`${API_BASE}${endpoint}`, options);
                if (!res.ok) return { error: await res.text() };
                return await res.json();
            } catch (e) { return { error: "Error de conexión" }; }
        }

        function calculateIMC() {
            const peso = parseFloat(document.getElementById('al-peso').value);
            const alturaCm = parseFloat(document.getElementById('al-altura').value);
            if (peso > 5 && alturaCm > 50) {
                const alturaM = alturaCm / 100;
                document.getElementById('al-imc').value = (peso / (alturaM * alturaM)).toFixed(2);
            } else document.getElementById('al-imc').value = "";
        }

        function calculateIMCProfile() {
            const peso = parseFloat(document.getElementById('prof-input-peso').value);
            const alturaCm = parseFloat(document.getElementById('prof-input-altura').value);
            if (peso > 5 && alturaCm > 50) {
                const alturaM = alturaCm / 100;
                document.getElementById('prof-input-imc').value = (peso / (alturaM * alturaM)).toFixed(2);
            } else document.getElementById('prof-input-imc').value = "";
        }

        function autoCalculateExpiry() {
            const planId = document.getElementById('al-plan').value;
            const renovDate = document.getElementById('al-fecha-renovacion').value;
            if(!planId || !renovDate) return;
            const plan = state.planes.find(p => p.id == planId);
            let months = 1;
            if (plan) {
                const n = plan.nombre.toLowerCase();
                if (n.includes('trimestral')) months = 3;
                else if (n.includes('semestral')) months = 6;
                else if (n.includes('anual')) months = 12;
            }
            let d = new Date(renovDate + 'T00:00:00');
            d.setMonth(d.getMonth() + months);
            document.getElementById('al-fecha-vencimiento').value = d.toISOString().split('T')[0];
        }

        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('sidebar-collapsed'); lucide.createIcons(); }
        function toggleSub(id) { document.getElementById(id).classList.toggle('hidden'); }
        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { 
            document.getElementById(id).style.display = 'none'; 
            const f = document.querySelector(`#${id} form`); 
            if (f) {
                f.reset();
                if(id === 'modal-clase') {
                    document.querySelectorAll('input[name="cl-dias-check"]').forEach(c => c.checked = false);
                    document.getElementById('cl-schedule-slots').innerHTML = '<p class="text-[10px] text-gray-600 italic">Selecciona días arriba para asignar horarios</p>';
                }
            }
        }

        function switchView(view) {
            document.querySelectorAll('.view-content').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-btn, .nav-item').forEach(b => b.classList.remove('active'));
            document.getElementById('view-' + view).classList.add('active');
            const n = document.getElementById('nav-' + view); if (n) n.classList.add('active');
            document.getElementById('view-title').innerText = view.replace('-', ' ').toUpperCase();
            
            if(view === 'calendario') renderCalendar();
            if(view === 'cobrar') renderCobrar();
            if(view === 'rutinas') renderRutinas();
            if(view === 'dashboard' && state.user?.rol_nombre === "Alumno") renderStudentDashboard();
			if(view === 'acceso-virtual') renderAccesos();
            
            if(view === 'perfil' && state.user) {
                const u = state.user;
                document.getElementById('prof-name').innerText = u.nombre_completo || "Usuario Vikingo";
                document.getElementById('prof-role').innerText = u.rol_nombre || "Staff";
                const initials = u.nombre_completo ? u.nombre_completo.split(' ').filter(n => n).map(n => n[0]).join('').toUpperCase() : "??";
                document.getElementById('user-initials').innerText = initials;
                document.getElementById('prof-initials-view').innerText = initials;
                document.getElementById('prof-input-name').value = u.nombre_completo || "";
                document.getElementById('prof-input-dni').value = u.dni || "";
                document.getElementById('prof-input-email').value = u.email || "";
                
                if (u.rol_nombre === "Alumno") {
                    document.getElementById('perfil-datos-fisicos').classList.remove('hidden');
                    document.getElementById('perfil-datos-fisicos').style.display = 'grid';
                    document.getElementById('prof-input-peso').value = u.peso || "";
                    document.getElementById('prof-input-altura').value = u.altura || "";
                    document.getElementById('prof-input-imc').value = u.imc || "";
                    document.getElementById('plan-alumno-info').classList.remove('hidden');
                    document.getElementById('perfil-plan-nombre').innerText = u.plan?.nombre || "SIN PLAN";
                    document.getElementById('perfil-vencimiento').innerText = "Vence: " + (u.fecha_vencimiento || "-");
                } else {
                    document.getElementById('perfil-datos-fisicos').classList.add('hidden');
                    document.getElementById('perfil-datos-fisicos').style.display = 'none';
                    document.getElementById('plan-alumno-info').classList.add('hidden');
                }
            }
            
            applyPermissions();
            lucide.createIcons();
        }

        async function handleLogin(e) {
		// 1. Detener el refresco automático
		if(e && e.preventDefault) e.preventDefault();
		
		const dniInput = document.getElementById('login-dni');
		const passInput = document.getElementById('login-pass');
		
		if (!dniInput || !passInput) return; // Seguridad extra

		const data = { 
			dni: dniInput.value, 
			password: passInput.value 
		};
		
		const res = await apiFetch('/login', 'POST', data);
		
		if (res && !res.error) {
			state.user = res;
			
			// 2. Ocultar Login y mostrar App
			document.getElementById('login-overlay').style.display = 'none';
			document.getElementById('sidebar').classList.remove('hidden');
			document.getElementById('main-content').classList.remove('hidden');
			
			// 3. Cargar datos del usuario en sidebar
			const elName = document.getElementById('side-user-name');
			if(elName) elName.innerText = res.nombre_completo || "Usuario";

			const elRole = document.getElementById('side-user-role');
			if(elRole) elRole.innerText = res.rol_nombre || 'Staff';

			// --- FIX INICIALES (Punto 1 de Mejoras Visuales) ---
			// Calculamos las iniciales apenas recibimos los datos del servidor
			const name = res.nombre_completo || "Usuario Vikingo";
			const initials = name.split(' ')
								 .filter(n => n)
								 .map(n => n[0])
								 .join('')
								 .toUpperCase()
								 .substring(0, 2);
			
			const elInitials = document.getElementById('user-initials');
			if(elInitials) elInitials.innerText = initials;
			// ---------------------------------------------------

			// 4. IMPORTANTE: Cargar Profesores para que los selectores funcionen
			await loadProfesores();
			
			// 5. Iniciar resto de la app
			if (typeof initApp === 'function') {
				await initApp(); 
			} else {
				loadClases(); 
			}

			switchView('dashboard');
		} else {
			const errorDiv = document.getElementById('login-error');
			if(errorDiv) errorDiv.classList.remove('hidden');
		}
	}

        async function initApp() {
            await Promise.all([fetchAlumnos(), loadStaff(), loadPlanes(), loadStock(), loadClases(), fetchReservas(), loadDashboard(), loadMusculacionMetadata()]);
        }

        async function loadDashboard() {
            const res = await apiFetch('/caja/resumen');
            if(!res.error) document.getElementById('dash-ingresos').innerText = `$ ${res.ingresos.toLocaleString()}`;
            document.getElementById('dash-checkins').innerHTML = [{n: "GONZALO L.", t: "14:22"}, {n: "LAGERTHA S.", t: "14:05"}].map(c => `<div class="flex items-center justify-between p-4 bg-white/5 rounded-2xl border border-white/5"><span class="text-[11px] font-black italic">${c.n}</span><span class="text-[10px] text-red-600 font-bold italic">${c.t} HS</span></div>`).join('');
            document.getElementById('dash-top-clases').innerHTML = [{n: "CROSSFIT", r: 45}, {n: "HIIT", r: 28}].map((c, i) => `<div class="flex items-center justify-between p-3 bg-white/5 rounded-xl border border-white/5"><span class="text-[11px] font-black italic">${i+1}. ${c.n}</span><span class="text-[10px] text-red-600 font-bold">${c.r} RES.</span></div>`).join('');
        }

        async function fetchAlumnos() {
			const d = await apiFetch('/alumnos');
			state.alumnos = Array.isArray(d) ? d : [];

			// 1. TRANSFORMACIÓN VISUAL DEL DASHBOARD (Mini Lista)
			// Buscamos la tabla original para reemplazarla por nuestro nuevo diseño de filas
			const dashTable = document.querySelector('#admin-dashboard-layout table');
			const dashListId = 'dash-alumnos-list-view';
			let dashContainer = document.getElementById(dashListId);

			// Si todavía existe la tabla (primera carga), la reemplazamos por un DIV contenedor
			if (!dashContainer && dashTable) {
				dashContainer = document.createElement('div');
				dashContainer.id = dashListId;
				dashContainer.className = "flex flex-col gap-2"; // Espacio entre filas
				// Reemplazamos la tabla entera (y sus cabeceras) por nuestra lista limpia
				if (dashTable.parentNode) dashTable.parentNode.replaceChild(dashContainer, dashTable);
			}

			if (dashContainer) {
				const topAlumnos = state.alumnos.slice(0, 5); // Solo mostramos los 5 recientes en dashboard
				if (topAlumnos.length === 0) {
					dashContainer.innerHTML = '<p class="text-center text-gray-500 italic text-[11px] py-4">No hay alumnos recientes.</p>';
				} else {
					dashContainer.innerHTML = topAlumnos.map(a => createAlumnoRow(a, 'dashboard')).join('');
				}
			}

			// 2. TRANSFORMACIÓN VISUAL DE LA SECCIÓN ALUMNOS (Lista Completa)
			const fullTable = document.querySelector('#view-alumnos table');
			const fullListId = 'full-alumnos-list-view';
			let fullContainer = document.getElementById(fullListId);

			if (!fullContainer && fullTable) {
				fullContainer = document.createElement('div');
				fullContainer.id = fullListId;
				fullContainer.className = "flex flex-col gap-3"; // Más espacio en la vista completa
				if (fullTable.parentNode) fullTable.parentNode.replaceChild(fullContainer, fullTable);
			}

			if (fullContainer) {
				if (state.alumnos.length === 0) {
					fullContainer.innerHTML = '<div class="text-center py-10"><i data-lucide="users" class="w-12 h-12 text-gray-600 mx-auto mb-4"></i><p class="text-gray-500 italic">No hay alumnos registrados.</p></div>';
				} else {
					fullContainer.innerHTML = state.alumnos.map(a => createAlumnoRow(a, 'full')).join('');
				}
			}

			if (window.lucide) lucide.createIcons();
			applyPermissions(); // Re-aplicamos permisos para ocultar botones de editar a quien no corresponda
		}

		// --- REEMPLAZA TU FUNCIÓN loadStaff POR ESTA NUEVA VERSIÓN VISUAL ---
		async function loadStaff() {
			// 1. Obtener datos
			const [p, a] = await Promise.all([
				apiFetch('/profesores'),
				apiFetch('/administrativos')
			]);
			state.profesores = Array.isArray(p) ? p : [];
			state.administrativos = Array.isArray(a) ? a : [];

			// 2. TRANSFORMACIÓN VISUAL: PROFESORES
			const profTable = document.querySelector('#view-profesores table');
			const profListId = 'profesores-list-view';
			let profContainer = document.getElementById(profListId);

			// Si existe la tabla antigua, la reemplazamos por el contenedor de tarjetas
			if (!profContainer && profTable) {
				profContainer = document.createElement('div');
				profContainer.id = profListId;
				profContainer.className = "flex flex-col gap-3";
				if (profTable.parentNode) profTable.parentNode.replaceChild(profContainer, profTable);
			}

			if (profContainer) {
				if (state.profesores.length === 0) {
					profContainer.innerHTML = '<div class="text-center py-10"><i data-lucide="user-x" class="w-12 h-12 text-gray-600 mx-auto mb-4"></i><p class="text-gray-500 italic">No hay profesores registrados.</p></div>';
				} else {
					profContainer.innerHTML = state.profesores.map(u => createStaffRow(u, 'Profesor')).join('');
				}
			}

			// 3. TRANSFORMACIÓN VISUAL: ADMINISTRATIVOS
			const admTable = document.querySelector('#view-administrativos table');
			const admListId = 'administrativos-list-view';
			let admContainer = document.getElementById(admListId);

			if (!admContainer && admTable) {
				admContainer = document.createElement('div');
				admContainer.id = admListId;
				admContainer.className = "flex flex-col gap-3";
				if (admTable.parentNode) admTable.parentNode.replaceChild(admContainer, admTable);
			}

			if (admContainer) {
				if (state.administrativos.length === 0) {
					admContainer.innerHTML = '<div class="text-center py-10"><i data-lucide="shield-alert" class="w-12 h-12 text-gray-600 mx-auto mb-4"></i><p class="text-gray-500 italic">No hay administrativos registrados.</p></div>';
				} else {
					admContainer.innerHTML = state.administrativos.map(u => createStaffRow(u, 'Administracion')).join('');
				}
			}

			// Actualizar selectores en modales (como en crear clase)
			const coachSelect = document.getElementById('cl-coach-select');
			if (coachSelect) {
				coachSelect.innerHTML = '<option value="">Seleccionar Coach</option>' + 
					state.profesores.map(x => `<option value="${x.nombre_completo}">${x.nombre_completo}</option>`).join('');
			}

			if (window.lucide) lucide.createIcons();
			applyPermissions(); // Asegurar que solo Admin/Supervisor vea los botones de editar
		}

			// --- NUEVA FUNCIÓN AUXILIAR PARA CREAR TARJETAS DE STAFF ---
			function createStaffRow(u, type) {
				const initials = u.nombre_completo ? u.nombre_completo.split(' ').map(n=>n[0]).join('').substring(0,2).toUpperCase() : "??";
				const roleLabel = type === 'Profesor' ? 'Coach / Especialidad' : 'Cargo / Función';
				const roleValue = u.especialidad || (type === 'Profesor' ? 'Entrenador General' : 'Administrativo');
				
				// Icono según tipo
				const icon = type === 'Profesor' ? 'dumbbell' : 'shield-check';

				return `
				<div class="glass-card p-4 rounded-3xl border-white/5 flex flex-col md:flex-row md:items-center gap-4 hover:border-red-600/20 transition-all group relative overflow-hidden">
					<!-- Barra lateral decorativa -->
					<div class="absolute left-0 top-0 bottom-0 w-1 bg-red-600 opacity-30 group-hover:opacity-100 transition-opacity"></div>
					
					<!-- Info Principal -->
					<div class="flex items-center gap-4 flex-1">
						<div class="w-12 h-12 rounded-2xl bg-white/5 border border-white/10 flex items-center justify-center font-black text-white text-sm italic shadow-lg group-hover:bg-red-600 group-hover:text-black transition-colors">
							${initials}
						</div>
						<div>
							<h4 class="text-sm font-black uppercase italic text-white group-hover:text-red-500 transition-colors">${u.nombre_completo}</h4>
							<div class="flex flex-wrap gap-x-4 gap-y-1 mt-1">
								<p class="text-[10px] text-gray-500 font-bold flex items-center gap-1"><i data-lucide="id-card" class="w-3 h-3"></i> ${u.dni}</p>
								${u.email ? `<p class="text-[10px] text-gray-500 font-bold flex items-center gap-1"><i data-lucide="mail" class="w-3 h-3"></i> ${u.email}</p>` : ''}
							</div>
						</div>
					</div>

					<!-- Rol / Especialidad -->
					<div class="flex flex-wrap items-center gap-6 md:justify-center border-t md:border-t-0 md:border-l border-white/5 pt-3 md:pt-0 md:pl-6">
						<div class="min-w-[150px]">
							<p class="text-[9px] text-gray-500 font-black uppercase tracking-widest mb-1 flex items-center gap-1">
								<i data-lucide="${icon}" class="w-3 h-3 text-red-600"></i> ${roleLabel}
							</p>
							<p class="text-[11px] font-black uppercase italic text-white truncate max-w-[200px]">${roleValue}</p>
						</div>
					</div>

					<!-- Acciones -->
					<div class="flex items-center justify-end border-t md:border-t-0 md:border-l border-white/5 pt-3 md:pt-0 md:pl-6 min-w-[100px]">
						<button onclick="openEditStaff(${u.id}, '${type}')" class="px-5 py-2.5 bg-white/5 text-white rounded-xl text-[10px] font-black uppercase italic hover:bg-white/10 hover:text-red-500 transition-all flex items-center gap-2 shadow-lg action-col">
							<i data-lucide="settings-2" class="w-3.5 h-3.5"></i>
							<span>Editar</span>
						</button>
					</div>
				</div>`;
			}
		
		/**
		 * GESTIÓN AVANZADA DE ALUMNOS (PUNTO 5)
		 * Incluye: Buscador, Filtros de Estado y Paginación (20 por hoja)
		 */

		// 1. Variables de control en el estado global (Asegúrate de tenerlas)
		state.alumnosPage = 1;
		state.alumnosLimit = 20;
		state.alumnosSearch = "";
		state.alumnosStatusFilter = "todos"; // todos, activos, vencidos

		/**
		 * RENDERIZADO DE LA LISTA DE ALUMNOS CON FILTROS Y PAGINACIÓN
		 */
		function renderAlumnos() {
			const container = document.getElementById('alumnos-list-view');
			if (!container) return;

			const hoy = new Date().toISOString().split('T')[0];

			// --- PASO A: FILTRADO ---
			let filtrados = state.alumnos.filter(a => {
				const matchesSearch = a.nombre_completo.toLowerCase().includes(state.alumnosSearch.toLowerCase()) || 
									  a.dni.includes(state.alumnosSearch);
				
				const isActive = a.fecha_vencimiento && a.fecha_vencimiento >= hoy;
				
				let matchesStatus = true;
				if (state.alumnosStatusFilter === "activos") matchesStatus = isActive;
				if (state.alumnosStatusFilter === "vencidos") matchesStatus = !isActive;

				return matchesSearch && matchesStatus;
			});

			// --- PASO B: CÁLCULO DE PAGINACIÓN ---
			const totalItems = filtrados.length;
			const totalPages = Math.ceil(totalItems / state.alumnosLimit) || 1;
			
			// Ajustar página actual si queda fuera de rango tras filtrar
			if (state.alumnosPage > totalPages) state.alumnosPage = totalPages;

			const inicio = (state.alumnosPage - 1) * state.alumnosLimit;
			const fin = inicio + state.alumnosLimit;
			const paginados = filtrados.slice(inicio, fin);

			// --- PASO C: RENDERIZADO DE FILAS ---
			if (paginados.length === 0) {
				container.innerHTML = `
					<div class="col-span-full p-20 text-center opacity-30">
						<i data-lucide="search-x" class="w-16 h-16 mx-auto mb-4"></i>
						<p class="font-black uppercase italic tracking-widest">No se encontraron guerreros</p>
					</div>
				`;
			} else {
				container.innerHTML = paginados.map(a => createAlumnoRow(a, 'listado')).join('');
			}

			// --- PASO D: RENDERIZADO DE CONTROLES DE PAGINACIÓN ---
			renderPaginationControls(totalPages, totalItems);

			if (window.lucide) lucide.createIcons();
		}

		/**
		 * CONTROLES DE PAGINACIÓN ESTÉTICOS
		 */
		function renderPaginationControls(totalPages, totalItems) {
			let paginationContainer = document.getElementById('alumnos-pagination');
			
			// Si no existe el contenedor en el HTML, lo creamos dinámicamente al final de la vista
			if (!paginationContainer) {
				const view = document.getElementById('view-alumnos');
				paginationContainer = document.createElement('div');
				paginationContainer.id = 'alumnos-pagination';
				paginationContainer.className = "flex items-center justify-between mt-8 px-6 py-4 glass-card rounded-2xl border-white/5";
				view.appendChild(paginationContainer);
			}

			const inicioMostrado = totalItems === 0 ? 0 : (state.alumnosPage - 1) * state.alumnosLimit + 1;
			const finMostrado = Math.min(state.alumnosPage * state.alumnosLimit, totalItems);

			paginationContainer.innerHTML = `
				<p class="text-[10px] font-black text-gray-500 uppercase italic">
					Mostrando <span class="text-white">${inicioMostrado}-${finMostrado}</span> de <span class="text-white">${totalItems}</span> Guerreros
				</p>
				
				<div class="flex items-center gap-2">
					<button onclick="changeAlumnosPage(${state.alumnosPage - 1})" 
							${state.alumnosPage === 1 ? 'disabled' : ''} 
							class="p-2 rounded-xl bg-white/5 hover:bg-red-600 hover:text-black transition-all disabled:opacity-10 disabled:pointer-events-none">
						<i data-lucide="chevron-left" class="w-4 h-4"></i>
					</button>
					
					<div class="flex items-center gap-1">
						${generatePageButtons(totalPages, state.alumnosPage)}
					</div>

					<button onclick="changeAlumnosPage(${state.alumnosPage + 1})" 
							${state.alumnosPage === totalPages ? 'disabled' : ''} 
							class="p-2 rounded-xl bg-white/5 hover:bg-red-600 hover:text-black transition-all disabled:opacity-10 disabled:pointer-events-none">
						<i data-lucide="chevron-right" class="w-4 h-4"></i>
					</button>
				</div>
			`;
			if (window.lucide) lucide.createIcons();
		}

		function generatePageButtons(total, current) {
			let html = "";
			// Solo mostramos hasta 5 páginas para no romper el diseño
			for (let i = 1; i <= total; i++) {
				if (total > 5 && (i > 2 && i < total - 1 && Math.abs(i - current) > 1)) {
					if (i === 3 || i === total - 1) html += `<span class="text-gray-700 px-1">...</span>`;
					continue;
				}
				html += `
					<button onclick="changeAlumnosPage(${i})" 
						class="w-8 h-8 rounded-lg text-[10px] font-black transition-all ${i === current ? 'viking-bg-red text-black' : 'bg-white/5 text-gray-400 hover:bg-white/10'}">
						${i}
					</button>`;
			}
			return html;
		}

		function changeAlumnosPage(p) {
			state.alumnosPage = p;
			renderAlumnos();
			// Scroll suave hacia arriba de la lista
			document.getElementById('view-alumnos').scrollIntoView({ behavior: 'smooth' });
		}

		/**
		 * FUNCIONES DE FILTRADO (Vincular a los inputs)
		 */
		function handleAlumnosSearch(val) {
			state.alumnosSearch = val;
			state.alumnosPage = 1; // Reiniciar a página 1 al buscar
			renderAlumnos();
		}

		function handleAlumnosStatusFilter(val) {
			state.alumnosStatusFilter = val;
			state.alumnosPage = 1;
			renderAlumnos();
		}

		/**
		 * LA FUNCIÓN DE FILA SE MANTIENE PERO CON EL DISEÑO MEJORADO DEL PUNTO 4
		 */
		function createAlumnoRow(a, type) {
			const initials = a.nombre_completo ? a.nombre_completo.split(' ').map(n=>n[0]).join('').substring(0,2).toUpperCase() : "??";
			const planName = a.plan?.nombre || 'SIN PLAN ACTIVO';
			const hoy = new Date().toISOString().split('T')[0];
			const isActive = a.fecha_vencimiento && a.fecha_vencimiento >= hoy;
			const statusColor = isActive ? 'text-green-500' : 'text-red-500';
			const statusText = isActive ? 'ACTIVO' : 'VENCIDO';
			const statusBg = isActive ? 'bg-green-500/10 border-green-500/20' : 'bg-red-500/10 border-red-500/20';

			if (type === 'dashboard') {
				return `
				<div class="glass-card p-3 rounded-2xl border-white/5 flex items-center justify-between hover:bg-white/5 transition-colors group">
					<div class="flex items-center gap-3">
						<div class="w-8 h-8 rounded-lg viking-bg-red flex items-center justify-center font-black text-black text-[10px] italic shadow-md">${initials}</div>
						<div class="flex flex-col">
							<h4 class="text-[10px] font-black uppercase italic text-white group-hover:text-red-500 transition-colors leading-none mb-1">${a.nombre_completo}</h4>
							<div class="flex items-center gap-2">
								 <span class="text-[8px] text-gray-500 font-bold">${a.dni}</span>
								 <span class="text-[7px] px-1.5 py-0.5 rounded ${statusBg} ${statusColor} font-black uppercase tracking-wider">${statusText}</span>
							</div>
						</div>
					</div>
					<button onclick="openEditAlumno(${a.id})" class="w-7 h-7 flex items-center justify-center bg-white/5 text-gray-400 rounded-lg hover:bg-white/10 hover:text-white transition-colors action-col">
						<i data-lucide="edit-2" class="w-3.5 h-3.5"></i>
					</button>
				</div>`;
			} else {
				return `
				<div class="glass-card p-6 rounded-[2.5rem] border-white/5 flex flex-col lg:flex-row lg:items-center gap-6 hover:border-red-600/30 transition-all group relative overflow-hidden mb-3">
					<div class="absolute left-0 top-0 bottom-0 w-1.5 ${isActive ? 'bg-green-500' : 'bg-red-500'} opacity-40 group-hover:opacity-100 transition-opacity"></div>
					
					<div class="flex items-center gap-5 flex-[1.2]">
						<div class="w-14 h-14 rounded-2xl viking-bg-red flex items-center justify-center font-black text-black text-lg italic shadow-xl group-hover:scale-110 transition-transform duration-300">${initials}</div>
						<div class="min-w-0">
							<h4 class="text-base font-black uppercase italic text-white group-hover:text-red-500 transition-colors truncate">${a.nombre_completo}</h4>
							<div class="flex flex-wrap gap-x-4 gap-y-1 mt-1">
								<p class="text-[10px] text-gray-500 font-bold flex items-center gap-1.5"><i data-lucide="id-card" class="w-3.5 h-3.5 text-red-600"></i> ${a.dni}</p>
							</div>
						</div>
					</div>

					<div class="flex flex-wrap items-center gap-8 lg:justify-start border-t lg:border-t-0 lg:border-l border-white/10 pt-4 lg:pt-0 lg:pl-8 flex-[1.8]">
						<div class="flex-1 min-w-[200px]">
							<p class="text-[9px] text-gray-500 font-black uppercase tracking-[0.2em] mb-1.5">Plan de Batalla</p>
							<p class="text-[13px] font-black uppercase italic text-white leading-tight">${planName}</p>
						</div>
						<div class="min-w-[90px]">
							<p class="text-[9px] text-gray-500 font-black uppercase tracking-[0.2em] mb-1.5">Estado</p>
							<span class="text-[10px] px-3 py-1.5 rounded-xl ${statusBg} ${statusColor} font-black uppercase tracking-widest border border-white/5 shadow-inner">${statusText}</span>
						</div>
					</div>

					<div class="flex items-center gap-6 justify-between lg:justify-end border-t lg:border-t-0 lg:border-l border-white/10 pt-4 lg:pt-0 lg:pl-8 flex-1">
						<div class="text-right space-y-1.5">
							<div class="flex flex-col">
								<span class="text-[8px] text-gray-500 font-black uppercase">Vencimiento</span>
								<span class="text-[12px] font-black text-white italic tracking-wide">${a.fecha_vencimiento || '-- / -- / --'}</span>
							</div>
						</div>
						<button onclick="openEditAlumno(${a.id})" class="p-4 bg-white/5 text-white rounded-2xl hover:bg-red-600 hover:text-black transition-all shadow-xl action-col border border-white/5">
							<i data-lucide="settings-2" class="w-5 h-5 group-hover:rotate-90 transition-transform duration-500"></i>
						</button>
					</div>
				</div>`;
			}
		}

        async function loadPlanes() {
            const p = await apiFetch('/planes'); const t = await apiFetch('/tipos-planes');
            state.planes = Array.isArray(p) ? p : []; state.tiposPlanes = Array.isArray(t) ? t : [];
            const filterContainer = document.getElementById('planes-filter-container'); filterContainer.innerHTML = ''; 
            state.tiposPlanes.forEach((t, idx) => { filterContainer.innerHTML += `<button onclick="filterPlanes(${t.id}, this)" class="filter-btn ${idx === 0 ? 'active' : ''}">${t.nombre}</button>`; });
            if (state.tiposPlanes.length > 0) filterPlanes(state.tiposPlanes[0].id, filterContainer.children[0]);
            document.getElementById('al-plan').innerHTML = '<option value="">Seleccionar Plan</option>' + state.planes.map(p => `<option value="${p.id}">${p.nombre}</option>`).join('');
            document.getElementById('plan-tipo').innerHTML = state.tiposPlanes.map(t => `<option value="${t.id}">${t.nombre}</option>`).join('');
        }

        function filterPlanes(tipoId, btn) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active');
            const filtered = state.planes.filter(p => p.tipo_plan_id === tipoId);
            const hideEdit = (state.user?.rol_nombre === "Profesor" || state.user?.rol_nombre === "Alumno" || state.user?.rol_nombre === "Administracion");
            document.getElementById('planes-container').innerHTML = filtered.map(p => `<div class="glass-card p-8 rounded-[2.5rem] flex flex-col border-red-600/10 relative text-left">${hideEdit ? '' : `<button onclick="openEditPlan(${p.id})" class="absolute top-4 right-4 text-gray-600 hover:text-red-600"><i data-lucide="edit-3" class="w-4 h-4"></i></button>`}<span class="text-[10px] font-black viking-red uppercase italic tracking-widest mb-2">${p.tipo?.nombre || 'PLAN'}</span><h4 class="text-lg font-black uppercase italic mb-6 leading-tight">${p.nombre}</h4><p class="text-3xl font-black italic mb-8">$ ${p.precio.toLocaleString()}</p></div>`).join('');
            lucide.createIcons();
            applyPermissions();
        }

        async function loadStock() {
            const data = await apiFetch('/stock'); state.stock = Array.isArray(data) ? data : [];
            const hideEdit = (state.user?.rol_nombre === "Profesor");
            document.getElementById('stock-container').innerHTML = state.stock.map(s => `<div class="glass-card p-6 rounded-[2rem] relative group text-left">${hideEdit ? '' : `<button onclick="openEditStock(${s.id})" class="absolute top-4 right-4 text-gray-600 hover:text-red-600"><i data-lucide="edit-2" class="w-3 h-3"></i></button>`}<h4 class="text-sm font-black uppercase italic mb-4">${s.nombre_producto}</h4><p class="text-2xl font-black italic">$ ${s.precio_venta.toLocaleString()}</p><div class="mt-4 border-t border-white/5 pt-4"><span class="text-[10px] font-black text-gray-600 uppercase">Stock: ${s.stock_actual}</span></div></div>`).join('');
            lucide.createIcons();
            applyPermissions();
        }

        async function loadClases() {
			// 1. Pedir datos al servidor
			const data = await apiFetch('/clases'); 
			state.clases = Array.isArray(data) ? data : [];

			// 2. Localizar el contenedor en el HTML
			const container = document.getElementById('clases-container');
			if (!container) return;

			// 3. Si no hay clases, mostrar mensaje de vacío
			if (state.clases.length === 0) {
				container.innerHTML = `
					<div class="col-span-3 p-16 border border-dashed border-white/10 rounded-[3rem] text-center bg-white/2">
						<p class="text-[12px] text-gray-600 font-black uppercase italic tracking-[0.2em]">No hay clases configuradas</p>
						<p class="text-[10px] text-gray-700 mt-2 font-bold">Usa el botón "Alta de Clase" para comenzar.</p>
					</div>`;
			} else {
				// 4. Dibujar las tarjetas (Solo con info técnica y botón de editar)
				const canEdit = (state.user?.rol_nombre === "Administrador" || state.user?.rol_nombre === "Supervisor");
				
				container.innerHTML = state.clases.map(c => `
					<div class="glass-card p-6 rounded-[2.5rem] border-white/5 flex flex-col justify-between hover:border-red-600/20 transition-all group">
						<div>
							<div class="flex items-center gap-4 mb-6">
								<!-- Icono con el color de la clase -->
								<div class="w-12 h-12 rounded-2xl flex items-center justify-center font-black text-black text-sm italic shadow-lg" style="background-color: ${c.color || '#FF0000'}">
									${c.nombre ? c.nombre[0].toUpperCase() : '?'}
								</div>
								<div>
									<h4 class="text-sm font-black uppercase italic text-white group-hover:text-red-500 transition-colors">${c.nombre}</h4>
									<p class="text-[10px] text-gray-500 font-bold uppercase tracking-wider flex items-center gap-1">
										<i data-lucide="user" class="w-3 h-3"></i> ${c.coach || 'Sin Coach'}
									</p>
								</div>
							</div>
						</div>

						<!-- Botón de edición: Solo aparece para Admin/Supervisor -->
						${canEdit ? `
						<button onclick="openEditClase(${c.id})" class="w-full py-4 bg-white/5 text-white rounded-2xl text-[10px] font-black uppercase italic hover:bg-white/10 hover:text-red-600 transition-all flex items-center justify-center gap-2 border border-white/5">
							<i data-lucide="settings-2" class="w-3.5 h-3.5"></i>
							Configuración Técnica
						</button>
						` : '<p class="text-[9px] text-gray-700 italic text-center">Solo lectura</p>'}
					</div>
				`).join('');
			}

			// 5. Refrescar iconos y otros componentes
			lucide.createIcons();
			if(document.getElementById('view-calendario')?.classList.contains('active')) renderCalendar();
			applyPermissions();
		}
		
		async function loadProfesores() {
			// Esta función llena la memoria con los profesores para usarlos en el select de turnos
			const res = await apiFetch('/profesores');
			state.profesores = (!res.error && Array.isArray(res)) ? res : [];
		}

        function openModalAlumno() { document.getElementById('modal-alumno-title').innerText = "Nuevo Alumno"; document.getElementById('al-id').value = ""; document.getElementById('al-fecha-renovacion').value = new Date().toISOString().split('T')[0]; openModal('modal-alumno'); }
        function openEditAlumno(id) {
            const al = state.alumnos.find(x => x.id == id); if(!al) return;
            document.getElementById('modal-alumno-title').innerText = "Editar Alumno";
            document.getElementById('al-id').value = al.id; document.getElementById('al-nombre').value = al.nombre_completo; document.getElementById('al-dni').value = al.dni;
            document.getElementById('al-email').value = al.email || ""; document.getElementById('al-plan').value = al.plan_id || ""; document.getElementById('al-peso').value = al.peso || "";
            document.getElementById('al-altura').value = al.altura || ""; document.getElementById('al-imc').value = al.imc || ""; document.getElementById('al-fecha-renovacion').value = al.fecha_ultima_renovacion || "";
            document.getElementById('al-fecha-vencimiento').value = al.fecha_vencimiento || "";
            const delBtn = document.getElementById('btn-delete-alumno'); if(state.user.rol_nombre === "Administrador" || state.user.rol_nombre === "Supervisor") delBtn.classList.remove('hidden');
            delBtn.onclick = () => deleteRecord('alumnos', id, 'modal-alumno', fetchAlumnos);
            openModal('modal-alumno');
        }

        document.getElementById('form-alumno').onsubmit = async (e) => {
            e.preventDefault(); const id = document.getElementById('al-id').value;
            const data = { nombre_completo: document.getElementById('al-nombre').value, dni: document.getElementById('al-dni').value, email: document.getElementById('al-email').value, plan_id: parseInt(document.getElementById('al-plan').value) || null, peso: parseFloat(document.getElementById('al-peso').value) || null, altura: parseFloat(document.getElementById('al-altura').value) || null, imc: parseFloat(document.getElementById('al-imc').value) || null, fecha_ultima_renovacion: document.getElementById('al-fecha-renovacion').value, fecha_vencimiento: document.getElementById('al-fecha-vencimiento').value };
            const pass = document.getElementById('al-pass').value; if(pass) data.password = pass;
            const res = await apiFetch(id ? `/alumnos/${id}` : '/alumnos', id ? 'PUT' : 'POST', data);
            if(!res.error) { closeModal('modal-alumno'); fetchAlumnos(); showVikingToast("Alumno Guardado"); }
        };

        function openModalStaff(rol) { document.getElementById('modal-staff-title').innerText = "Alta " + rol; document.getElementById('stf-id').value = ""; document.getElementById('stf-rol').value = rol; openModal('modal-staff'); }
        function openEditStaff(id, rol) {
            const user = (rol === 'Profesor' ? state.profesores : state.administrativos).find(x => x.id == id); if(!user) return;
            document.getElementById('modal-staff-title').innerText = "Editar " + rol;
            document.getElementById('stf-id').value = user.id; document.getElementById('stf-rol').value = rol;
            document.getElementById('stf-nombre').value = user.nombre_completo; document.getElementById('stf-dni').value = user.dni; document.getElementById('stf-esp').value = user.especialidad || "";
            const delBtn = document.getElementById('btn-delete-staff'); if(state.user.rol_nombre === "Administrador" || state.user.rol_nombre === "Supervisor") delBtn.classList.remove('hidden');
            delBtn.onclick = () => deleteRecord('staff', id, 'modal-staff', loadStaff);
            openModal('modal-staff');
        }

        document.getElementById('form-staff').onsubmit = async (e) => {
            e.preventDefault(); const id = document.getElementById('stf-id').value; const rol = document.getElementById('stf-rol').value;
            const data = { nombre_completo: document.getElementById('stf-nombre').value, dni: document.getElementById('stf-dni').value, especialidad: document.getElementById('stf-esp').value, perfil_nombre: rol };
            const pass = document.getElementById('stf-pass').value; if(pass) data.password = pass;
            const res = await apiFetch(id ? `/staff/${id}` : '/staff', id ? 'PUT' : 'POST', data);
            if(!res.error) { closeModal('modal-staff'); loadStaff(); showVikingToast("Staff Actualizado"); }
        };

        function openModalPlan() { document.getElementById('plan-id').value = ""; document.getElementById('modal-plan-title').innerText = "Nuevo Plan"; openModal('modal-plan'); }
        function openEditPlan(id) {
            const p = state.planes.find(x => x.id == id); if(!p) return;
            document.getElementById('plan-id').value = p.id; document.getElementById('plan-nombre').value = p.nombre; document.getElementById('plan-tipo').value = p.tipo_plan_id; document.getElementById('plan-precio').value = p.precio;
            const delBtn = document.getElementById('btn-delete-plan'); if(state.user.rol_nombre === "Administrador" || state.user.rol_nombre === "Supervisor") delBtn.classList.remove('hidden');
            delBtn.onclick = () => deleteRecord('planes', p.id, 'modal-plan', loadPlanes);
            openModal('modal-plan');
        }

        document.getElementById('form-plan').onsubmit = async (e) => {
            e.preventDefault(); const id = document.getElementById('plan-id').value;
            const data = { nombre: document.getElementById('plan-nombre').value, precio: parseFloat(document.getElementById('plan-precio').value), tipo_plan_id: parseInt(document.getElementById('plan-tipo').value) };
            const res = await apiFetch(id ? `/planes/${id}` : '/planes', id ? 'PUT' : 'POST', data);
            if(!res.error) { closeModal('modal-plan'); loadPlanes(); showVikingToast("Plan Guardado"); }
        };

        function openModalStock() { document.getElementById('stock-id').value = ""; openModal('modal-stock'); }
        function openEditStock(id) {
            const s = state.stock.find(x => x.id == id); if(!s) return;
            document.getElementById('stock-id').value = s.id; document.getElementById('stock-nombre').value = s.nombre_producto; document.getElementById('stock-cant').value = s.stock_actual; document.getElementById('stock-precio').value = s.precio_venta;
            const delBtn = document.getElementById('btn-delete-stock'); if(state.user.rol_nombre === "Administrador" || state.user.rol_nombre === "Supervisor") delBtn.classList.remove('hidden');
            delBtn.onclick = () => deleteRecord('stock', s.id, 'modal-stock', loadStock);
            openModal('modal-stock');
        }

        document.getElementById('form-stock').onsubmit = async (e) => {
            e.preventDefault(); const id = document.getElementById('stock-id').value;
            const data = { nombre_producto: document.getElementById('stock-nombre').value, stock_actual: parseInt(document.getElementById('stock-cant').value), precio_venta: parseFloat(document.getElementById('stock-precio').value) };
            const res = await apiFetch(id ? `/stock/${id}` : '/stock', id ? 'PUT' : 'POST', data);
            if(!res.error) { closeModal('modal-stock'); loadStock(); showVikingToast("Stock Actualizado"); }
        };

        function openModalClase() { 
            document.getElementById('cl-id').value = ""; 
            document.getElementById('modal-clase-title').innerText = "Alta de Clase";
            openModal('modal-clase'); 
        }

		// --- 1. GENERAR FILA: DÍA + HORA + PROFESOR ---
		function addNewScheduleSlot(data = { dia: 1, horario: 7, coach: "" }) {
			const container = document.getElementById('cl-schedule-slots');
			if (!container) return;

			// Limpiar mensaje de "vacío" si existe
			if (container.querySelector('p.italic')) container.innerHTML = "";

			const row = document.createElement('div');
			// Diseño tipo tarjeta para cada turno
			row.className = "schedule-slot-row flex flex-col gap-2 bg-white/5 p-3 rounded-xl border border-white/5 mb-3 group hover:border-red-600/30 transition-all";
			
			const diasMap = {1: 'Lunes', 2: 'Martes', 3: 'Miércoles', 4: 'Jueves', 5: 'Viernes', 6: 'Sábado'};
			
			// 1. Selector de Días
			let diasOptions = "";
			for(let d=1; d<=6; d++) {
				diasOptions += `<option value="${d}" ${data.dia == d ? 'selected' : ''}>${diasMap[d]}</option>`;
			}

			// 2. Selector de Horas
			let horasOptions = "";
			for(let i=7; i<=21.5; i+=0.5) {
				const label = i % 1 === 0 ? `${i}:00` : `${Math.floor(i)}:30`;
				horasOptions += `<option value="${i}" ${data.horario == i ? 'selected' : ''}>${label} HS</option>`;
			}

			// 3. Selector de Profesores (Usando state.profesores cargado previamente)
			let coachOptions = `<option value="">Asignar Profesor...</option>`;
			if (state.profesores && state.profesores.length > 0) {
				coachOptions += state.profesores.map(p => 
					`<option value="${p.nombre_completo}" ${data.coach === p.nombre_completo ? 'selected' : ''}>${p.nombre_completo}</option>`
				).join('');
			} else {
				coachOptions += `<option value="Staff">Staff General</option>`;
			}

			row.innerHTML = `
				<div class="flex items-center justify-between">
					<span class="text-[9px] font-black text-red-600 uppercase italic tracking-widest">Turno</span>
					<button type="button" onclick="this.closest('.schedule-slot-row').remove()" class="text-gray-500 hover:text-red-500 transition-all">
						<i data-lucide="x" class="w-4 h-4"></i>
					</button>
				</div>
				<div class="grid grid-cols-2 gap-2">
					<select class="viking-input py-1 h-9 text-[10px] slot-dia bg-black/40 border-white/10">${diasOptions}</select>
					<select class="viking-input py-1 h-9 text-[10px] slot-hora bg-black/40 border-white/10">${horasOptions}</select>
				</div>
				<div class="w-full">
					<select class="viking-input py-1 h-9 text-[10px] w-full slot-coach bg-black/40 border-white/10 text-gray-300">
						${coachOptions}
					</select>
				</div>
			`;
			container.appendChild(row);
			if(window.lucide) lucide.createIcons();
		}

		// --- ABRIR EDICIÓN (Cargar slots con sus profes) ---
		function openEditClase(id) {
			const c = state.clases.find(x => x.id == id); 
			if(!c) return;

			document.getElementById('cl-id').value = c.id; 
			document.getElementById('modal-clase-title').innerText = "Editar: " + c.nombre;
			document.getElementById('cl-nombre').value = c.nombre; 
			document.getElementById('cl-cupo').value = c.capacidad_max;
			document.getElementById('cl-color').value = c.color || "#FF0000";
			
			// Limpiar y cargar horarios
			const slotsContainer = document.getElementById('cl-schedule-slots');
			slotsContainer.innerHTML = "";

			const horarios = Array.isArray(c.horarios_detalle) ? c.horarios_detalle : [];
			
			if (horarios.length > 0) {
				horarios.forEach(h => addNewScheduleSlot(h));
			} else {
				// Compatibilidad: si es clase vieja, usamos el coach general
				addNewScheduleSlot({ dia: 1, horario: 7, coach: c.coach || "" });
			}

			// Mostrar botón eliminar solo a admin
			const isAdmin = (state.user?.rol_nombre === "Administrador" || state.user?.rol_nombre === "Supervisor");
			const delBtn = document.getElementById('btn-delete-clase'); 
			if(delBtn) {
				delBtn.classList.toggle('hidden', !isAdmin);
				delBtn.onclick = () => deleteRecord('clases', c.id, 'modal-clase', loadClases);
			}

			openModal('modal-clase');
		}

		// --- 3. FUNCIÓN PARA PREPARAR EL MODAL AL CREAR NUEVA ---
		function openNewClase() {
			document.getElementById('form-clase').reset();
			document.getElementById('cl-id').value = "";
			document.getElementById('cl-schedule-slots').innerHTML = "";
			document.getElementById('modal-clase-title').innerText = "Nueva Clase Vikinga";
			
			// Añadimos el primer slot vacío
			addNewScheduleSlot();
			openModal('modal-clase');
		}

// --- NUEVA FUNCIÓN PARA CARGAR PROFESORES REALES ---
async function loadProfesores() {
    const res = await apiFetch('/profesores');
    if (!res.error) {
        state.profesores = res; // Guardamos en el estado global
    }
}

		// --- GUARDAR CLASE CON MÚLTIPLES PROFESORES ---
		async function saveClaseVikinga(e) {
			if(e) e.preventDefault();
			
			const id = document.getElementById('cl-id').value;
			const slotRows = document.querySelectorAll('.schedule-slot-row');
			
			// Recolectar datos de cada tarjeta de turno
			const horarios_detalle = [];
			slotRows.forEach(row => {
				const diaEl = row.querySelector('.slot-dia');
				const horaEl = row.querySelector('.slot-hora');
				const coachEl = row.querySelector('.slot-coach'); // Nuevo campo
				
				if(diaEl && horaEl) {
					horarios_detalle.push({
						dia: parseInt(diaEl.value),
						horario: parseFloat(horaEl.value),
						coach: coachEl ? coachEl.value : "Staff" // Guardamos el profe específico
					});
				}
			});

			if(horarios_detalle.length === 0) {
				return showVikingToast("Añade al menos un horario", true);
			}

			// Usamos el coach del primer turno como "coach principal" para compatibilidad en tablas viejas
			const mainCoach = horarios_detalle[0].coach || "Staff";

			const payload = {
				nombre: document.getElementById('cl-nombre').value,
				coach: mainCoach, 
				color: document.getElementById('cl-color').value,
				capacidad_max: parseInt(document.getElementById('cl-cupo').value),
				horarios_detalle: horarios_detalle
			};

			const method = id ? 'PUT' : 'POST';
			const endpoint = id ? `/clases/${id}` : '/clases';
			const res = await apiFetch(endpoint, method, payload);
			
			if(!res.error) {
				showVikingToast(id ? "Clase Actualizada" : "Clase Creada");
				closeModal('modal-clase');
				loadClases();
			} else {
				showVikingToast("Error: " + res.error, true);
			}
		}

		// --- 5. VINCULACIÓN DE EVENTOS AL CARGAR LA PÁGINA ---
		window.onload = () => {
			// Vincular el submit del formulario
			const formClase = document.getElementById('form-clase');
			if(formClase) {
				formClase.onsubmit = saveClaseVikinga;
			}
			
			// Cargar iconos de Lucide
			if(window.lucide) lucide.createIcons();
		};
    

        async function handleDrop(e, dia, horario) { e.preventDefault(); const id = e.dataTransfer.getData("clase_id"); if (!id) return; const res = await apiFetch(`/clases/${id}/move`, 'PUT', { dia, horario }); if (!res.error) { loadClases(); showVikingToast("Clase Reubicada"); } }
        
        async function deleteRecord(entity, id, modalId, callback) { if(!confirm("¿Deseas eliminar este registro?")) return; const res = await apiFetch(`/${entity}/${id}`, 'DELETE'); if(!res.error) { closeModal(modalId); callback(); showVikingToast("Registro Eliminado", true); } }
        
        async function handleProfileUpdate(e) { 
            e.preventDefault(); 
            const pass = document.getElementById('prof-input-pass').value; 
            const isAlumno = state.user.rol_nombre === 'Alumno';
            
            let data = { 
                nombre_completo: document.getElementById('prof-input-name').value, 
                dni: String(document.getElementById('prof-input-dni').value), 
                email: document.getElementById('prof-input-email').value
            }; 

            if(pass) data.password = pass; 
            let endpoint = "";

            if (isAlumno) {
                endpoint = `/alumnos/${state.user.id}`;
                data.plan_id = state.user.plan_id || state.user.plan?.id;
                data.peso = parseFloat(document.getElementById('prof-input-peso').value) || null;
                data.altura = parseFloat(document.getElementById('prof-input-altura').value) || null;
                data.imc = parseFloat(document.getElementById('prof-input-imc').value) || null;
            } else {
                endpoint = `/staff/${state.user.id}`;
                data.perfil_nombre = state.user.rol_nombre;
            }

            const res = await apiFetch(endpoint, 'PUT', data); 
            if(!res.error) { 
                state.user.nombre_completo = data.nombre_completo; 
                state.user.email = data.email;
                if (isAlumno) {
                    state.user.peso = data.peso;
                    state.user.altura = data.altura;
                    state.user.imc = data.imc;
                }

                document.getElementById('side-user-name').innerText = data.nombre_completo; 
                document.getElementById('prof-name').innerText = data.nombre_completo;
                const initials = data.nombre_completo.split(' ').filter(n => n).map(n => n[0]).join('').toUpperCase();
                document.getElementById('user-initials').innerText = initials;
                document.getElementById('prof-initials-view').innerText = initials;
                
                showVikingToast("Perfil Vikingo Actualizado"); 
                if(isAlumno) renderStudentDashboard();
            } else {
                showVikingToast("Error: " + res.error, true);
            }
        }

        document.getElementById('form-rutina-editor').onsubmit = async (e) => {
            e.preventDefault();
            
            const elAlumnoId = document.getElementById('rutina-editor-alumno-id') || document.getElementById('edit-rutina-user-id');
            const elObjetivo = document.getElementById('rutina-objetivo') || document.getElementById('edit-rutina-objetivo');
            const elVencimiento = document.getElementById('rutina-vencimiento') || document.getElementById('edit-rutina-vencimiento');
            const elNombreGrupo = document.getElementById('rutina-nombre-grupo');
            const elDescripcion = document.getElementById('rutina-descripcion');

            if (!elAlumnoId) {
                console.error("No se encontró el input del ID del alumno. Revisa que el ID en el HTML sea 'rutina-editor-alumno-id'");
                showVikingToast("Error técnico: Campo de ID no encontrado en el HTML", true);
                return;
            }

            const alumnoId = parseInt(elAlumnoId.value);
            
            if (isNaN(alumnoId)) {
                showVikingToast("Error: Debes seleccionar un alumno de la lista", true);
                return;
            }

            const payload = {
                usuario_id: alumnoId,
                nombre_grupo: elNombreGrupo ? elNombreGrupo.value : "Rutina Nueva",
                descripcion: elDescripcion ? elDescripcion.value : "",
                objetivo: elObjetivo ? elObjetivo.value : "Mejora general",
                fecha_vencimiento: elVencimiento ? elVencimiento.value : null,
                dias: []
            };

            const dayCards = document.querySelectorAll('.rutina-dia-card') || document.querySelectorAll('.day-block');
            let hasValidationError = false;

            payload.dias = Array.from(dayCards).map(card => {
                const inputNombreDia = card.querySelector('.day-title');
                const nombre_dia = inputNombreDia ? inputNombreDia.value : "Día";
                
                const exercisesRows = card.querySelectorAll('.exercise-row');
                
                const ejercicios = Array.from(exercisesRows).map(row => {
                    const inputExId = row.querySelector('.exercise-id');
                    const exId = parseInt(inputExId.value);

                    const rowsDeSeries = row.querySelectorAll('.serie-row');
                    const seriesData = Array.from(rowsDeSeries).map(sRow => {
                        return {
                            numero_serie: parseInt(sRow.dataset.serieNum),
                            repeticiones: sRow.querySelector('.serie-reps').value || "0",
                            peso: sRow.querySelector('.serie-weight').value || "0",
                            descanso: sRow.querySelector('.serie-rest').value || "0"
                        };
                    });

                    return {
                        ejercicio_id: exId,
                        series: seriesData, 
                        comentario: row.querySelector('.exercise-comment')?.value || ""
                    };
                });
                
                return { nombre_dia, ejercicios };
            });

            if (hasValidationError) {
                showVikingToast("Error: Tienes ejercicios sin seleccionar en la lista", true);
                return;
            }

            if (payload.dias.length === 0 || payload.dias.every(d => d.ejercicios.length === 0)) {
                showVikingToast("Error: La rutina debe tener al menos un ejercicio", true);
                return;
            }

            const res = await apiFetch('/rutinas/plan', 'POST', payload);
            
            if (!res.error) {
                closeModal('modal-rutina-editor');
                showVikingToast("¡Plan de Rutina Vikingo Guardado!");
                if (typeof renderRutinas === 'function') renderRutinas();
            } else {
                let msg = res.error;
                try { 
                    const parsed = JSON.parse(res.error);
                    if (parsed.detail) msg = parsed.detail;
                } catch(e) {}
                showVikingToast("Error Vikingo: " + msg, true);
            }
        };

        function openModalNewExercise() {
            openModal('modal-nuevo-ejercicio');
        }
		
		// Renderiza la lista de ingresos con estilo de filas/tarjetas
			function renderAccesos() {
				const container = document.getElementById('acceso-list-view');
				if (!container) return;

				if (state.accesos.length === 0) {
					container.innerHTML = '<p class="text-center text-gray-600 italic py-10">No hay registros de ingreso hoy.</p>';
					return;
				}

				container.innerHTML = state.accesos.map(acc => {
					const isDenied = acc.estado.includes('DENEGADO');
					const statusColor = isDenied ? 'text-red-500' : 'text-green-500';
					const statusBg = isDenied ? 'bg-red-500/10' : 'bg-green-500/10';

					return `
					<div class="glass-card p-4 rounded-2xl border-white/5 flex items-center justify-between hover:bg-white/5 transition-colors group relative overflow-hidden">
						<!-- Barra lateral indicadora -->
						<div class="absolute left-0 top-0 bottom-0 w-1 ${isDenied ? 'bg-red-600' : 'bg-green-600'} opacity-30 group-hover:opacity-100 transition-opacity"></div>
						
						<div class="grid grid-cols-5 gap-4 w-full items-center px-2">
							<!-- Guerrero -->
							<div class="flex items-center gap-3">
								<div class="w-8 h-8 rounded-lg ${isDenied ? 'bg-red-600/20 text-red-500' : 'viking-bg-red text-black'} flex items-center justify-center font-black text-[10px] italic">
									${acc.nombre ? acc.nombre[0].toUpperCase() : '?'}
								</div>
								<span class="text-[11px] font-black uppercase italic text-white group-hover:text-red-500 transition-colors">${acc.nombre}</span>
							</div>
							
							<!-- DNI -->
							<span class="text-[10px] text-gray-500 font-bold tracking-widest">${acc.dni}</span>
							
							<!-- Fecha/Hora -->
							<span class="text-[10px] text-gray-400 font-medium">${acc.fecha}</span>
							
							<!-- Método -->
							<div class="flex items-center gap-2">
								<i data-lucide="${acc.metodo.includes('QR') ? 'qr-code' : 'door-closed'}" class="w-3.5 h-3.5 text-gray-600"></i>
								<span class="text-[9px] font-black uppercase text-gray-600">${acc.metodo}</span>
							</div>
							
							<!-- Estado -->
							<div class="text-right">
								<span class="text-[9px] px-3 py-1 rounded-full ${statusBg} ${statusColor} font-black uppercase tracking-wider border border-white/5">
									${acc.estado}
								</span>
							</div>
						</div>
					</div>
					`;
				}).join('');
				
				if (window.lucide) lucide.createIcons();
			}
			
			// Función para simular ingresos (puedes conectarla luego a tu backend o QR)
			function simularAcceso() {
				const nombres = ["Ragnar Lothbrok", "Lagertha", "Bjorn Ironside", "Ivar the Boneless", "Ubbe"];
				const metodos = ["QR SCAN", "MOLINETE", "MANUAL"];
				
				const nuevoIngreso = {
					nombre: nombres[Math.floor(Math.random() * nombres.length)],
					dni: Math.floor(Math.random() * 10000000 + 30000000).toString(),
					fecha: new Date().toLocaleTimeString(), // Solo hora para la simulación rápida
					metodo: metodos[Math.floor(Math.random() * metodos.length)],
					estado: Math.random() > 0.2 ? "AUTORIZADO" : "DENEGADO (Vencido)"
				};

				state.accesos.unshift(nuevoIngreso); // Agregar al inicio
				if (state.accesos.length > 50) state.accesos.pop(); // Limitar historial visual
				
				renderAccesos();
				showVikingToast("Nuevo ingreso detectado");
			}

        document.getElementById('form-nuevo-ejercicio-lib').onsubmit = async (e) => {
            e.preventDefault();
            const nombre = document.getElementById('lib-ex-nombre').value;
            const grupo_id = parseInt(document.getElementById('lib-ex-grupo').value);
            
            const res = await apiFetch('/rutinas/ejercicios', 'POST', { nombre, grupo_muscular_id: grupo_id });
            if (!res.error) {
                showVikingToast("Ejercicio creado en librería");
                closeModal('modal-nuevo-ejercicio');
                await loadMusculacionMetadata();
            } else {
                showVikingToast("Error al crear: " + res.error, true);
            }
        };
		
		document.getElementById('form-clase').onsubmit = saveClaseVikinga;

        window.onclick = function(event) {
            if (event.target.classList.contains('search-exercise-input')) return;
            document.querySelectorAll('.exercise-results-list').forEach(list => list.classList.add('hidden'));
        };
        
        window.onload = () => {
			const formClase = document.getElementById('form-clase');
			if(formClase) {
				formClase.onsubmit = saveClaseVikinga;
			}
			if(window.lucide) lucide.createIcons();
		};
		
    </script>
</body>
</html>