<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
	<script src="https://unpkg.com/jsqr@1.4.0/dist/jsQR.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <title>GF Strength Hub</title>
		<style>
    /* =================================================================
    ESTILOS ORIGINALES (MANTENIDOS AL 100%)
    ================================================================= */
    body {
        font-family: 'Inter', sans-serif;
        background-color: #000000;
        background-image: linear-gradient(rgba(0, 0, 0, 0.94), rgba(0, 0, 0, 0.94)), url('https://images.unsplash.com/photo-1534438327276-14e5300c3a48?q=80&w=2070&auto=format&fit=crop');
        background-size: cover;
        background-position: center;
        background-attachment: fixed;
        color: #ffffff;
        overflow: hidden; /* Se sobreescribe en móvil más abajo */
    }
    
    .viking-red { color: #FF0000; }
    .viking-bg-red { background-color: #FF0000; }
    .glass-sidebar {
        background: rgba(8, 8, 8, 0.98);
        backdrop-filter: blur(40px);
        border-right: 1px solid rgba(255, 0, 0, 0.15);
        transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1), left 0.4s ease;
    }
    .glass-card {
        background: rgba(255, 255, 255, 0.03);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.06);
        transition: all 0.3s ease;
    }
    .glass-card:hover { border-color: rgba(255, 0, 0, 0.3); background: rgba(255, 255, 255, 0.05); }

    .logo-viking-glow {
        filter: drop-shadow(0 0 15px rgba(255, 0, 0, 0.6));
        animation: pulse-glow 3s infinite alternate;
    }
    @keyframes pulse-glow {
        from { filter: drop-shadow(0 0 5px rgba(255, 0, 0, 0.4)); transform: scale(1); }
        to { filter: drop-shadow(0 0 25px rgba(255, 0, 0, 0.8)); transform: scale(1.05); }
    }

    .nav-item { 
        display: flex !important;
        align-items: center !important;
        gap: 1.25rem !important; 
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
        position: relative; 
        white-space: nowrap; 
        text-align: left !important;
    }
    .nav-item:hover, .nav-item.active { 
        color: #FF0000; 
        background: linear-gradient(90deg, rgba(255, 0, 0, 0.1) 0%, transparent 100%);
    }
    .nav-item.active::before {
        content: ''; position: absolute; left: 0; top: 25%; height: 50%; width: 4px;
        background: #FF0000; box-shadow: 0 0 15px #FF0000;
    }

    .view-content { display: none; flex-direction: column; height: 100%; }
    .view-content.active { display: flex; }

    #login-overlay {
        position: fixed; inset: 0; z-index: 1000;
        background: black; display: flex; align-items: center; justify-content: center;
        background-image: linear-gradient(rgba(0,0,0,0.85), rgba(0,0,0,0.85)), url('https://images.unsplash.com/photo-1534438327276-14e5300c3a48?q=80&w=2070&auto=format&fit=crop');
        background-size: cover;
    }

    .custom-scrollbar::-webkit-scrollbar { width: 4px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #FF0000; border-radius: 10px; }

    .viking-table-row { border-bottom: 1px solid rgba(255, 255, 255, 0.03); transition: background 0.2s; }
    .viking-table-row:hover { background: rgba(255, 0, 0, 0.02); }

    .calendar-container {
        display: grid; grid-template-columns: 50px repeat(6, 1fr);
        background: rgba(255, 255, 255, 0.02); border-radius: 24px; overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .cal-header { 
        background: rgba(255,0,0,0.15); 
        padding: 12px 4px; 
        text-align: center; 
        font-weight: 900; 
        font-size: 13px; 
        border-right: 1px solid rgba(255,255,255,0.1); 
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    .cal-cell { 
        border-right: 1px solid rgba(255,255,255,0.1); 
        border-bottom: 1px solid rgba(255,255,255,0.1); 
        height: 50px; 
        position: relative; 
    }
    .cal-cell-closed {
        background: repeating-linear-gradient(45deg, rgba(255,255,255,0.02), rgba(255,255,255,0.02) 10px, rgba(255,255,255,0.05) 10px, rgba(255,255,255,0.05) 20px);
        opacity: 0.5;
    }

    /* Lógica Sidebar Colapsada PC */
    .sidebar-collapsed { width: 80px !important; }
    .sidebar-collapsed .brand-text, 
    .sidebar-collapsed .user-details, 
    .sidebar-collapsed .nav-text, 
    .sidebar-collapsed .nav-section-title,
    .sidebar-collapsed .chevron-icon { display: none; }
    .sidebar-collapsed .nav-item { justify-content: center !important; padding-left: 0; padding-right: 0; gap: 0 !important; }
    
    .viking-input {
        background: rgba(0, 0, 0, 0.5);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 1rem;
        padding: 0.85rem 1.25rem;
        width: 100%;
        outline: none;
        font-weight: 700;
        font-size: 0.95rem;
        color: white;
        transition: all 0.2s;
    }
    .viking-input:focus { border-color: #FF0000; box-shadow: 0 0 10px rgba(255, 0, 0, 0.1); }
    select.viking-input option { background: #0a0a0a; color: white; }

    .viking-modal {
        position: fixed; inset: 0; z-index: 1000;
        background: rgba(0,0,0,0.9); backdrop-filter: blur(15px);
        display: none; align-items: center; justify-content: center;
        padding: 20px;
    }

    .class-badge {
        color: black; 
        font-weight: 900;
        padding: 4px; 
        text-transform: uppercase; 
        font-style: italic;
        cursor: pointer;
        display: flex; 
        flex-direction: column; 
        justify-content: center; 
        align-items: center;
        text-align: center; 
        height: calc(200% + 1px); 
        width: calc(100% - 4px);
        margin: 2px;
        border-radius: 14px;
        border: 1px solid rgba(255,255,255,0.3);
        box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        position: absolute;
        top: 0; 
        left: 0; 
        z-index: 20;
        transition: all 0.2s;
    }
    .class-badge:hover { transform: scale(0.97); z-index: 20; }

    .filter-btn {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #999;
        padding: 8px 16px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 900;
        text-transform: uppercase;
        font-style: italic;
        transition: all 0.3s;
    }
    .filter-btn.active { background: #FF0000; color: #000; border-color: #FF0000; }

    .payment-method-btn {
        border: 1px solid rgba(255, 255, 255, 0.05);
        background: rgba(255, 255, 255, 0.02);
        transition: all 0.2s;
    }
    .payment-method-btn.active {
        border-color: #FF0000;
        background: rgba(255, 0, 0, 0.1);
        color: #FF0000;
    }

    .cobrar-tab {
        padding: 12px 24px;
        font-weight: 900;
        font-size: 11px;
        text-transform: uppercase;
        font-style: italic;
        border-bottom: 2px solid transparent;
        color: #666;
        transition: all 0.3s;
    }
    .cobrar-tab.active { border-bottom-color: #FF0000; color: #FF0000; }

    .notification-toast {
        position: fixed; bottom: 30px; right: 30px;
        background: #FF0000; color: black;
        padding: 20px 40px; border-radius: 20px;
        font-weight: 900; text-transform: uppercase; font-style: italic;
        z-index: 2000; transform: translateY(150%);
        transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        box-shadow: 0 10px 40px rgba(255, 0, 0, 0.4);
    }
    .notification-toast.show { transform: translateY(0); }

    .multi-select-container {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        background: rgba(255,255,255,0.05);
        padding: 15px;
        border-radius: 15px;
        max-height: 150px;
        overflow-y: auto;
    }
    .multi-option {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 10px;
        font-weight: 900;
        text-transform: uppercase;
        cursor: pointer;
        padding: 8px;
        border-radius: 8px;
        background: rgba(0,0,0,0.3);
        border: 1px solid rgba(255,255,255,0.05);
    }
    .multi-option input { display: none; }
    .multi-option:has(input:checked) {
        border-color: #FF0000;
        background: rgba(255,0,0,0.1);
        color: #FF0000;
    }

    .rutina-dia-card {
        background: rgba(255,255,255,0.02);
        border: 1px solid rgba(255,255,255,0.05);
        padding: 1.5rem;
        border-radius: 1.5rem;
        position: relative;
    }
    .exercise-grid {
        display: grid;
        grid-template-columns: 2.5fr 0.8fr 0.8fr 0.8fr 1fr 40px;
        gap: 12px;
        align-items: center;
    }

    .scanner-mask { box-shadow: 0 0 0 9999px rgb(0, 0, 0); }
    @keyframes scan-line {
        0% { top: 0%; opacity: 0; }
        10% { opacity: 1; }
        90% { opacity: 1; }
        100% { top: 100%; opacity: 0; }
    }
    .animate-scan-line { animation: scan-line 2.5s linear infinite; }

    /* =================================================================
    PARCHE DE ADAPTABILIDAD MOBILE (PRIORIDAD 2)
    ================================================================= */
    @media (max-width: 1024px) {
        body {
            overflow-y: auto !important; /* Habilitar scroll en móvil */
        }

        /* Sidebar: De lateral fijo a Menú Desplegable (Drawer) */
        #sidebar {
            position: fixed;
            left: -100%; /* Oculto por defecto */
            top: 0;
            bottom: 0;
            z-index: 100;
            width: 280px !important;
            display: flex !important;
            transition: left 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #sidebar.mobile-open {
            left: 0;
            box-shadow: 20px 0 50px rgba(0,0,0,0.9);
        }

        /* Overlay oscuro para cerrar el menú */
        .sidebar-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(4px);
            z-index: 90;
        }
        .sidebar-overlay.active { display: block; }

        /* Contenido Principal: Ocupa todo el ancho */
        main {
            margin-left: 0 !important;
            width: 100% !important;
            padding-bottom: 100px;
        }

        /* Header Mobile: Corregimos padding y visibilidad del botón */
        header {
            padding-left: 1rem !important; 
            padding-right: 1rem !important;
            height: 80px !important;
            justify-content: flex-start !important; /* Alineación para botón de menú */
            gap: 12px;
        }

        /* Grillas: De múltiples columnas a 1 columna (Vertical) */
        .grid-cols-2, .grid-cols-3, .grid-cols-4, .exercise-grid {
            grid-template-columns: 1fr !important;
            gap: 1rem !important;
        }

        /* El calendario en móvil se convierte en lista vertical infinita */
        .calendar-container {
            grid-template-columns: 1fr !important;
            height: auto !important;
            overflow: visible !important;
        }

        .cal-header {
            position: sticky;
            top: 79px; /* Justo debajo del header */
            z-index: 30;
            border-right: none !important;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .cal-cell {
            height: auto !important;
            min-height: 80px;
            border-right: none !important;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        /* Badge de clase en móvil: Se estira al ancho de la celda */
        .class-badge {
            position: relative;
            height: auto !important;
            min-height: 60px;
            width: calc(100% - 16px);
            margin: 8px;
        }

        /* Tablas: Se vuelven bloques legibles tipo tarjeta */
        .viking-table-row {
            display: flex;
            flex-direction: column;
            padding: 1.25rem;
            gap: 0.5rem;
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 1rem;
            margin-bottom: 0.75rem;
        }

        /* Modales: Ajuste de ancho y redondeo para pantallas chicas */
        .viking-modal > div {
            width: 95% !important;
            max-width: 95% !important;
            margin: 10px;
            border-radius: 2rem !important;
            padding: 1.5rem !important;
        }

        /* Botones: Área táctil aumentada (Ley de Fitts para móviles) */
        button, .nav-item, .filter-btn, .payment-method-btn {
            min-height: 48px;
        }

        /* Esconder sidebar si se intenta colapsar en móvil */
        .sidebar-collapsed { width: 0 !important; overflow: hidden; }

        /* Botón Disparador del Menú (Aseguramos que se vea) */
        .mobile-menu-trigger {
            display: flex !important;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 50px;
            background: rgba(255, 0, 0, 0.1);
            border: 1px solid rgba(255, 0, 0, 0.3);
            border-radius: 14px;
            color: #FF0000;
            cursor: pointer;
            z-index: 50;
            flex-shrink: 0;
        }
        .mobile-menu-trigger i { width: 22px; height: 22px; }
    }

    /* Ocultar disparador en resoluciones de computadora */
    @media (min-width: 1025px) {
        .mobile-menu-trigger { display: none !important; }
    }
</style>
</head>
<body class="flex h-screen w-screen overflow-hidden text-left">

    <div id="viking-toast" class="notification-toast">¡Acción Completada!</div>

    <div id="login-overlay">
        <div class="glass-card p-12 rounded-[3rem] w-full max-w-md border-red-600/20 text-center mx-4 relative overflow-hidden">
            <div class="w-32 h-32 mx-auto mb-8 logo-viking-glow bg-black rounded-full flex items-center justify-center overflow-hidden">
                <img src="https://github.com/vikingo-44/Software-Gym/blob/main/logo.png?raw=true" alt="Vikingo Logo" class="w-full h-full object-cover" onerror="this.src='https://via.placeholder.com/150/FF0000/000000?text=VIKINGO'">
            </div>

            <!-- FORMULARIO DE LOGIN -->
            <div id="login-form-container">
                <h1 class="text-4xl font-black italic uppercase mb-2">GF <span class="viking-red">Hub</span></h1>
                <p class="text-[11px] tracking-[0.5em] text-gray-500 uppercase mb-10">Acceso al Sistema</p>
                
                <form onsubmit="handleLogin(event)" class="space-y-4">
                    <input type="text" id="login-dni" placeholder="DNI" required class="viking-input">
                    <input type="password" id="login-pass" placeholder="Contraseña" required class="viking-input">
                    <button type="submit" id="login-button" class="w-full viking-bg-red text-black py-5 rounded-2xl font-black uppercase italic tracking-widest hover:scale-[1.02] active:scale-95 transition-all shadow-[0_0_20px_rgba(255,0,0,0.3)]">Entrar al Valhalla</button>
                </form>
                <button onclick="toggleResetPass(true)" class="mt-6 text-[10px] font-black uppercase italic text-gray-500 hover:text-red-600 transition-colors tracking-widest">¿Olvidaste tu contraseña?</button>
            </div>

            <!-- FORMULARIO DE RESET (OCULTO POR DEFECTO) -->
            <div id="reset-form-container" class="hidden">
                <h1 class="text-2xl font-black italic uppercase mb-2">Reset <span class="viking-red">Pass</span></h1>
                <p class="text-[10px] tracking-[0.2em] text-gray-500 uppercase mb-8">Recupera tu acceso</p>
                
                <form onsubmit="handleResetPassword(event)" class="space-y-4">
                    <input type="text" id="reset-dni" placeholder="INGRESA TU DNI" required class="viking-input">
                    <input type="password" id="reset-pass-new" placeholder="NUEVA CONTRASEÑA" required class="viking-input">
                    <input type="password" id="reset-pass-confirm" placeholder="REPETIR CONTRASEÑA" required class="viking-input">
                    <button type="submit" id="reset-button" class="w-full bg-white text-black py-4 rounded-2xl font-black uppercase italic tracking-widest hover:scale-[1.02] active:scale-95 transition-all">Cambiar Contraseña</button>
                </form>
                <button onclick="toggleResetPass(false)" class="mt-6 text-[10px] font-black uppercase italic text-gray-500 hover:text-white transition-colors">Volver al Login</button>
            </div>

            <div id="login-error" class="mt-4 text-[12px] text-red-600 font-bold uppercase hidden">Error en credenciales</div>
        </div>
    </div>

    <aside id="sidebar" class="w-72 h-full glass-sidebar flex flex-col hidden z-50">
        <div class="p-8 flex items-center gap-4">
            <img src="https://github.com/vikingo-44/Software-Gym/blob/main/logo.png?raw=true" alt="Vikingo Hub" class="w-10 h-10 object-contain logo-viking-glow brand-text" onerror="this.style.display='none'">
            <h1 class="brand-text text-xl font-black italic uppercase leading-none">
                GF<br><span class="viking-red text-xs tracking-[0.4em] font-bold">STRENGTH HUB</span>
            </h1>
            <!-- <button onclick="toggleSidebar()" class="p-2 hover:bg-white/5 rounded-lg transition-colors ml-auto">
                <i data-lucide="menu" class="w-5 h-5 viking-red"></i>
            </button> -->
        </div>

        <div class="px-6 mb-8">
            <div class="glass-card p-4 rounded-3xl flex items-center gap-4">
                <div class="w-12 h-12 rounded-2xl viking-bg-red flex items-center justify-center font-black text-black text-xl italic shadow-lg shrink-0" id="user-initials">??</div>
                <div class="user-details text-left overflow-hidden">
                    <p class="text-[12px] font-black uppercase truncate" id="side-user-name">Usuario Vikingo</p>
                    <p class="text-[9px] text-red-600 font-bold uppercase tracking-widest" id="side-user-role">Cargando...</p>
                </div>
            </div>
        </div>

        <nav class="flex-1 px-4 space-y-1 overflow-y-auto custom-scrollbar pb-10">
		<!-- SECCIÓN ADMINISTRACIÓN -->
		<div id="nav-section-admin">
			<p class="nav-section-title text-[10px] font-black text-gray-600 uppercase tracking-widest px-6 mb-2 mt-4">
				<span class="nav-text">Administración</span>
			</p>
			
			<button onclick="switchView('dashboard')" id="nav-dashboard" class="nav-btn w-full nav-item active px-6 py-4 rounded-2xl font-black uppercase text-[11px] italic flex items-center gap-3">
				<i data-lucide="layout-grid" class="w-4 h-4"></i> 
				<span class="nav-text">Dashboard</span>
			</button>
			
			<button onclick="switchView('perfil')" id="nav-perfil" class="nav-btn w-full nav-item px-6 py-4 rounded-2xl font-black uppercase text-[11px] italic flex items-center gap-3">
				<i data-lucide="user-cog" class="w-4 h-4"></i> 
				<span class="nav-text">Mi Perfil</span>
			</button>
			
			<button onclick="switchView('alumnos')" id="nav-alumnos" class="nav-btn w-full nav-item px-6 py-4 rounded-2xl font-black uppercase text-[11px] italic flex items-center gap-3">
				<i data-lucide="users" class="w-4 h-4"></i> 
				<span class="nav-text">Alumnos</span>
			</button>

			<!-- STAFF -->
			<div id="nav-section-staff" class="relative">
				<button onclick="toggleSub('sub-staff')" class="nav-btn w-full flex items-center justify-between px-6 py-4 rounded-2xl font-black uppercase text-[11px] italic group">
					<div class="flex items-center gap-3">
						<i data-lucide="shield-check" class="w-4 h-4"></i> 
						<span class="nav-text">Staff</span>
					</div>
					<span class="nav-text">
						<i data-lucide="chevron-down" class="w-3 h-3 chevron-icon opacity-50"></i>
					</span>
				</button>
				<div id="sub-staff" class="hidden pl-12 space-y-3 pb-4 mt-1">
					<button onclick="switchView('profesores')" id="nav-profesores" class="block w-full text-left text-[10px] font-black uppercase text-gray-500 hover:text-red-600 transition-colors tracking-widest">• Profesores</button>
					<button onclick="switchView('administrativos')" id="nav-administrativos" class="block w-full text-left text-[10px] font-black uppercase text-gray-500 hover:text-red-600 transition-colors tracking-widest">• Administrativos</button>
				</div>
			</div>
		</div>

		<!-- SECCIÓN OPERATIVA -->
		<div id="nav-section-operativa">
			<p class="nav-section-title text-[10px] font-black text-gray-600 uppercase tracking-widest px-6 mb-2 mt-8">
				<span class="nav-text">Operativa</span>
			</p>
			
			<div class="relative">
				<button id="btn-facturacion" onclick="toggleSub('sub-facturacion')" class="nav-btn w-full flex items-center justify-between px-6 py-4 rounded-2xl font-black uppercase text-[11px] italic group">
					<div class="flex items-center gap-3">
						<i data-lucide="wallet" class="w-4 h-4"></i> 
						<span class="nav-text">Facturación</span>
					</div>
					<span class="nav-text">
						<i data-lucide="chevron-down" class="w-3 h-3 chevron-icon opacity-50"></i>
					</span>
				</button>
				<div id="sub-facturacion" class="hidden pl-12 space-y-3 pb-4 mt-1">
					<button onclick="switchView('cobrar')" id="nav-cobrar" class="block w-full text-left text-[10px] font-black uppercase text-gray-500 hover:text-red-600 transition-colors tracking-widest">• Cobrar</button>
					<button onclick="switchView('caja')" id="nav-caja" class="block w-full text-left text-[10px] font-black uppercase text-gray-500 hover:text-red-600 transition-colors tracking-widest">• Caja</button>
					<button onclick="switchView('stock')" id="nav-stock" class="block w-full text-left text-[10px] font-black uppercase text-gray-500 hover:text-red-600 transition-colors tracking-widest">• Stock</button>
				</div>
			</div>
		</div>

		<!-- SECCIÓN GESTIÓN -->
		<div id="nav-section-gestion">
			<p class="nav-section-title text-[10px] font-black text-gray-600 uppercase tracking-widest px-6 mb-2 mt-8">
				<span class="nav-text">Gestión</span>
			</p>
			<button onclick="switchView('planes')" id="nav-planes" class="nav-btn w-full nav-item px-6 py-4 rounded-2xl font-black uppercase text-[11px] italic flex items-center gap-3">
				<i data-lucide="clipboard-list" class="w-4 h-4"></i> <span class="nav-text">Planes</span>
			</button>
			<button onclick="switchView('clases')" id="nav-clases" class="nav-btn w-full nav-item px-6 py-4 rounded-2xl font-black uppercase text-[11px] italic flex items-center gap-3">
				<i data-lucide="presentation" class="w-4 h-4"></i> <span class="nav-text">Clases</span>
			</button>
			<button onclick="switchView('calendario')" id="nav-calendario" class="nav-btn w-full nav-item px-6 py-4 rounded-2xl font-black uppercase text-[11px] italic flex items-center gap-3">
				<i data-lucide="calendar" class="w-4 h-4"></i> <span class="nav-text">Calendario</span>
			</button>
			<button id="nav-rutinas" onclick="switchView('rutinas')" class="nav-btn w-full nav-item px-6 py-4 rounded-2xl font-black uppercase text-[11px] italic flex items-center gap-3">
				<i data-lucide="dumbbell" class="w-4 h-4"></i> <span class="nav-text">Rutinas Musc.</span>
			</button>
		</div>

		<!-- SECCIÓN SEGURIDAD -->
		<div id="nav-section-virtual">
			<p class="nav-section-title text-[10px] font-black text-gray-600 uppercase tracking-widest px-6 mb-2 mt-8">
				<span class="nav-text">Seguridad</span>
			</p>
			<button onclick="switchView('acceso-virtual')" id="nav-acceso-virtual" class="nav-btn w-full nav-item px-6 py-4 rounded-2xl font-black uppercase text-[11px] italic flex items-center gap-3">
				<i data-lucide="qr-code" class="w-4 h-4"></i> 
				<span class="nav-text">Acceso Virtual</span>
			</button>
		</div>
	</nav>

        <div class="p-8">
            <button onclick="location.reload()" class="w-full flex items-center justify-center gap-3 py-4 border border-white/5 rounded-2xl text-gray-600 hover:text-red-600 transition-all font-black uppercase text-[11px] italic">
                <i data-lucide="log-out" class="w-4 h-4"></i> <span class="nav-text">Salir</span>
            </button>
        </div>
    </aside>

    <main id="main-content" class="flex-1 h-full overflow-y-auto hidden relative">
        <header class="h-24 border-b border-white/5 px-12 flex items-center justify-between sticky top-0 bg-black/70 backdrop-blur-2xl z-40">
			<button class="mobile-menu-trigger" onclick="toggleMobileMenu()">
				<i data-lucide="menu"></i>
			</button>
            <div>
                <p id="breadcrumb" class="text-[10px] font-black text-red-600 uppercase tracking-[0.4em] italic">GF Strength Hub</p>
                <h2 id="view-title" class="text-2xl font-black uppercase italic tracking-tighter">Dashboard</h2>
            </div>
            <div class="flex items-center gap-6">
                <div id="sync-status" class="flex items-center gap-3 bg-red-600/10 px-4 py-2 rounded-xl border border-red-600/20 text-white">
                    <span class="w-2 h-2 rounded-full bg-red-600 animate-pulse"></span>
                    <span class="text-[10px] font-black uppercase tracking-widest italic">Hub Sincronizado</span>
                </div>
            </div>
        </header>

        <div id="views-container" class="p-10">
            <!-- DASHBOARD -->
            <div id="view-dashboard" class="view-content active">
				<div id="admin-dashboard-layout">
				<!-- HEADER DEL DASHBOARD CON BOTÓN QR -->
				<div class="flex justify-between items-end mb-8">
					<div>
					<h2 class="text-4xl font-black italic text-white uppercase tracking-tighter">Panel de Control</h2>
					<p class="text-xs text-gray-500 font-bold uppercase tracking-widest mt-1">Resumen Operativo</p>
					</div>
					<!-- BOTÓN NUEVO: VER MI QR -->
					<button onclick="showMyQR()" class="bg-white/5 hover:bg-white/10 border border-white/10 text-white px-5 py-3 rounded-2xl flex items-center gap-3 transition-all hover:scale-105 group">
						<div class="bg-white text-black p-1.5 rounded-lg group-hover:bg-red-600 group-hover:text-white transition-colors">
							<i data-lucide="qr-code" class="w-5 h-5"></i>
						</div>
						<div class="text-left hidden sm:block">
							<p class="text-[9px] text-gray-400 font-bold uppercase">Mi Acceso</p>
							<p class="text-[11px] font-black italic uppercase">Ver Mi QR</p>
						</div>
					</button>
				</div>

				<!-- FILA SUPERIOR: ACCESOS Y ALERTAS -->
				<div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
    
				<!-- PANEL 1: ACCESOS RECIENTES (ALUMNOS / GENERAL) -->
				<div class="glass-card p-8 rounded-[2.5rem] border-blue-500/10 flex flex-col h-[450px]">
					<div class="flex justify-between items-center mb-6 border-b border-white/5 pb-4">
						<div>
							<h4 class="text-sm font-black uppercase italic text-blue-500 tracking-widest">
								<i data-lucide="history" class="w-4 h-4 inline mr-2"></i>Accesos Recientes
							</h4>
							<p class="text-[9px] text-gray-500 font-bold uppercase mt-1">Historial de Alumnos</p>
						</div>
						<button onclick="startScanner()" class="text-[9px] bg-blue-500/10 text-blue-400 hover:bg-blue-500 hover:text-black px-3 py-1 rounded-lg transition-colors font-black uppercase italic border border-blue-500/20">
							<i data-lucide="camera" class="w-3 h-3 inline mr-1"></i> Abrir Scanner
						</button>
					</div>
					<div id="dash-last-access" class="flex-1 overflow-y-auto custom-scrollbar space-y-3 pr-2">
						<p class="text-center text-gray-600 italic text-[10px] py-10">Esperando lecturas de QR...</p>
					</div>
				</div>

				<!-- PANEL 2: CONTROL DE INGRESO (SOLO STAFF) -->
				<div class="glass-card p-8 rounded-[2.5rem] border-red-600/20 bg-red-600/[0.02] flex flex-col h-[450px]">
					<div class="flex justify-between items-center mb-6 border-b border-white/5 pb-4">
						<div>
							<h4 class="text-sm font-black uppercase italic text-red-600 tracking-widest">
								<i data-lucide="shield-check" class="w-4 h-4 inline mr-2"></i>Control Staff
							</h4>
							<p class="text-[9px] text-gray-500 font-bold uppercase mt-1">Profesores y Administrativos</p>
						</div>
						<span class="text-[9px] bg-red-600/20 text-red-500 px-2 py-1 rounded-full font-bold uppercase tracking-tighter">Presencia</span>
					</div>
					<div id="dash-staff-access" class="flex-1 overflow-y-auto custom-scrollbar space-y-3 pr-2">
						<p class="text-center text-gray-600 italic text-[10px] py-10">Buscando registros de personal...</p>
					</div>
				</div>

				<!-- PANEL 3: ALERTAS DE STOCK -->
				<div class="glass-card p-8 rounded-[2.5rem] border-orange-500/10 flex flex-col h-[450px]">
					<div class="flex justify-between items-center mb-6 border-b border-white/5 pb-4">
						<div>
							<h4 class="text-sm font-black uppercase italic text-orange-500 tracking-widest">
								<i data-lucide="alert-triangle" class="w-4 h-4 inline mr-2"></i>Alertas Stock
							</h4>
							<p class="text-[9px] text-gray-500 font-bold uppercase mt-1">Provisiones bajas</p>
						</div>
						<!-- Corregido: Restablecida la lógica original de switchView('stock') -->
						<button onclick="switchView('stock')" class="text-[9px] bg-white/5 hover:bg-white/10 px-3 py-1 rounded-lg transition-colors font-black uppercase italic border border-white/10">Reponer</button>
					</div>
					<div id="dash-low-stock" class="flex-1 overflow-y-auto custom-scrollbar space-y-3 pr-2">
						<p class="text-center text-gray-600 italic text-[10px] py-10">Analizando inventario...</p>
					</div>
				</div>
			</div>

			<!-- FILA INFERIOR: ESTADÍSTICAS -->
			<div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-10">
				<!-- FRECUENCIA HORARIA -->
				<div class="glass-card p-8 rounded-[2.5rem] lg:col-span-2 flex flex-col">
					<h4 class="text-sm font-black uppercase italic text-white mb-2 tracking-widest border-l-4 border-red-600 pl-4">Frecuencia Horaria</h4>
					<p class="text-[9px] text-gray-500 font-bold uppercase mb-6 pl-5">Reservas activas por hora</p>
					
					<div class="flex-1 min-h-[250px] relative pt-4 pl-8 border-l border-white/10 border-b flex items-end justify-between pr-4 gap-2" id="dash-chart-container">
						<!-- Gráfico se llena con JS -->
					</div>
					<div id="dash-chart-labels" class="flex justify-between pl-8 pr-4 mt-2 text-[8px] text-gray-500 font-black uppercase"></div>
				</div>

				<!-- TOP 5 CLASES -->
				<div class="glass-card p-8 rounded-[2.5rem] flex flex-col">
					<h4 class="text-sm font-black uppercase italic text-white mb-6 tracking-widest border-l-4 border-red-600 pl-4">Top 5 Clases</h4>
					<div id="dash-top-clases" class="space-y-4 flex-1"></div>
				</div>
			</div>
			</div>

			<div id="alumno-dashboard-layout" class="hidden">
					<!-- SECCIÓN SUPERIOR: DATOS Y MÉTRICAS -->
					<div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
						
						<!-- TARJETA PRINCIPAL: DATOS PERSONALES -->
						<div class="glass-card p-8 rounded-[3rem] lg:col-span-2">
							<div class="flex items-center gap-6 mb-8">
								<div class="w-20 h-20 rounded-[1.5rem] viking-bg-red flex items-center justify-center font-black text-black text-3xl italic shadow-2xl" id="al-dash-initials">??</div>
								<div>
									<h3 class="text-3xl font-black uppercase italic leading-none" id="al-dash-name">-</h3>
									<p class="text-red-600 text-[11px] font-black uppercase tracking-widest mt-1">Guerrero Vikingo en Formación</p>
								</div>
								<div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-6 mb-8">
									<!-- BOTÓN MyQR ESTILO PREMIUM -->
									<button onclick="showMyQR()" class="w-full md:w-auto bg-white/5 hover:bg-white/10 border border-white/10 text-white px-5 py-3 rounded-2xl flex items-center justify-center gap-3 transition-all hover:scale-105 group">
										<div class="bg-white text-black p-1.5 rounded-lg group-hover:bg-red-600 group-hover:text-white transition-colors">
											<i data-lucide="qr-code" class="w-5 h-5"></i>
										</div>
										<div class="text-left">
											<p class="text-[9px] text-gray-400 font-bold uppercase">Entrada</p>
											<p class="text-[11px] font-black italic uppercase">Ver Mi QR</p>
										</div>
									</button>
								</div>
														</div>
							<div class="grid grid-cols-2 md:grid-cols-4 gap-6">
								<div class="bg-white/5 p-4 rounded-2xl border border-white/5">
									<p class="text-[9px] text-gray-500 font-black uppercase italic mb-1">DNI / Usuario</p>
									<p class="text-xs font-black italic" id="al-dash-dni">-</p>
								</div>
								<div class="bg-white/5 p-4 rounded-2xl border border-white/5">
									<p class="text-[9px] text-gray-500 font-black uppercase italic mb-1">Email</p>
									<p class="text-xs font-black italic truncate" id="al-dash-email">-</p>
								</div>
								<div class="bg-white/5 p-4 rounded-2xl border border-white/5">
									<p class="text-[9px] text-gray-500 font-black uppercase italic mb-1">Plan Actual</p>
									<p class="text-xs font-black italic viking-red uppercase" id="al-dash-plan">-</p>
								</div>
								<div class="bg-white/5 p-4 rounded-2xl border border-white/5">
									<p class="text-[9px] text-gray-500 font-black uppercase italic mb-1">Vencimiento</p>
									<p class="text-xs font-black italic" id="al-dash-vencimiento">-</p>
								</div>
								<!-- Agregamos Renovación que estaba en tu código original -->
								<div class="bg-white/5 p-4 rounded-2xl border border-white/5 md:col-span-4 lg:col-span-4 xl:col-span-4">
									<p class="text-[9px] text-gray-500 font-black uppercase italic mb-1">Última Renovación</p>
									<p class="text-xs font-black italic" id="al-dash-renovacion">-</p>
								</div>
							</div>
						</div>

						<!-- TARJETA LATERAL: ESTADÍSTICAS FÍSICAS Y MEMBRESÍA -->
						<div class="glass-card p-8 rounded-[3rem] flex flex-col justify-center">
							<!-- Físico -->
							<h4 class="text-[11px] font-black uppercase italic text-red-600 mb-6 tracking-widest border-b border-white/5 pb-4">Métricas Físicas</h4>
							<div class="grid grid-cols-3 gap-2 text-center mb-6">
								<div>
									<p class="text-2xl font-black italic mb-1" id="al-dash-peso">0</p>
									<p class="text-[9px] text-gray-500 font-black uppercase">Peso (kg)</p>
								</div>
								<div>
									<p class="text-2xl font-black italic mb-1" id="al-dash-altura">0</p>
									<p class="text-[9px] text-gray-500 font-black uppercase">Altura (m)</p>
								</div>
								<div>
									<p class="text-2xl font-black italic mb-1 viking-red" id="al-dash-imc">0</p>
									<p class="text-[9px] text-gray-500 font-black uppercase">IMC</p>
								</div>
							</div>

							<!-- Membresía (AGREGADO PARA QUE FUNCIONE EL JS DE CRÉDITOS) -->
							<h4 class="text-[11px] font-black uppercase italic text-red-600 mb-6 tracking-widest border-b border-white/5 pb-4 pt-2">Estado Membresía</h4>
							<div class="grid grid-cols-2 gap-4 text-center">
								<div>
									<p class="text-2xl font-black italic mb-1" id="al-dash-usadas">-</p>
									<p class="text-[9px] text-gray-500 font-black uppercase">Usadas</p>
								</div>
								<div>
									<p class="text-2xl font-black italic mb-1 text-white" id="al-dash-creditos">-</p>
									<p class="text-[9px] text-gray-500 font-black uppercase">Créditos</p>
								</div>
							</div>
						</div>
					</div>
					
					<!-- SECCIÓN INTERMEDIA: RUTINA (AGREGADO PARA QUE FUNCIONE EL RESUMEN DE RUTINA) -->
					<div id="al-dash-rutina-summary" class="glass-card p-6 rounded-[2rem] mb-8 hidden border-l-4 border-red-600 flex items-center justify-between">
						<div class="flex items-center gap-6">
							<div class="p-4 bg-red-600/20 rounded-2xl text-red-500"><i data-lucide="notebook-pen" class="w-6 h-6"></i></div>
							<div id="al-dash-rutina-content"></div>
						</div>
						<button onclick="switchView('rutinas')" class="px-6 py-3 bg-white/5 rounded-xl text-[10px] font-black uppercase hover:bg-white/10 transition italic">Ver Rutina</button>
					</div>

					<!-- SECCIÓN INFERIOR: CLASES E HISTORIAL -->
					<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
						<div class="glass-card p-10 rounded-[3rem]">
							<h3 class="text-sm font-black uppercase italic border-l-4 border-red-600 pl-4 tracking-widest mb-8">Mis Próximas Clases</h3>
							<div id="al-dash-upcoming" class="space-y-4">
								<p class="text-gray-500 italic text-[11px]">No tienes reservas próximas. ¡Ve al calendario!</p>
							</div>
						</div>
						<div class="glass-card p-10 rounded-[3rem]">
							<h3 class="text-sm font-black uppercase italic border-l-4 border-gray-600 pl-4 tracking-widest mb-8 text-gray-500">Historial</h3>
							<div id="al-dash-history" class="space-y-4 opacity-60">
								<p class="text-gray-500 italic text-[11px]">Sin historial registrado.</p>
							</div>
						</div>
					</div>
				</div>
            </div>

			<!-- DASHBOARD PROFESOR CORREGIDO -->
			<div id="view-professor-dashboard" class="view-content hidden p-10">
				<div class="flex justify-between items-end mb-8">
					<div>
						<h2 class="text-4xl font-black italic text-white uppercase tracking-tighter">Mi Desempeño</h2>
						<p class="text-xs text-gray-500 font-bold uppercase tracking-widest mt-1">Análisis de Clases y Convocatoria</p>
					</div>
					<button onclick="showMyQR()" class="bg-white/5 hover:bg-white/10 border border-white/10 text-white px-5 py-3 rounded-2xl flex items-center gap-3 transition-all hover:scale-105 group">
						<div class="bg-white text-black p-1.5 rounded-lg group-hover:bg-red-600 group-hover:text-white transition-colors"><i data-lucide="qr-code" class="w-5 h-5"></i></div>
						<div class="text-left">
							<p class="text-[9px] text-gray-400 font-bold uppercase">Mi Acceso</p>
							<p class="text-[11px] font-black italic uppercase">Ver Mi QR</p>
						</div>
					</button>
				</div>

				<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
					<!-- CONVOCATORIA (ID corregido) -->
					<div class="glass-card p-8 rounded-[2.5rem] border-red-600/10 flex flex-col h-[400px]">
						<h4 class="text-sm font-black uppercase italic text-red-600 mb-6 tracking-widest border-b border-white/5 pb-4">Convocatoria Total</h4>
						<div class="flex-1 flex flex-col items-center justify-center">
							<span class="text-6xl font-black italic text-white" id="prof-dash-total-students">0</span>
							<p class="text-[10px] text-gray-500 font-black uppercase mt-2 tracking-widest">Alumnos totales</p>
						</div>
					</div>

					<!-- CLASES HOY (ID corregido para que coincida con JS) -->
					<div class="glass-card p-8 rounded-[2.5rem] border-white/5 flex flex-col h-[400px]">
						<h4 class="text-sm font-black uppercase italic text-white mb-6 tracking-widest border-b border-white/5 pb-4">Mis Clases</h4>
						<div id="prof-dash-today-classes" class="space-y-4 overflow-y-auto custom-scrollbar flex-1 pr-2">
							<p class="text-center text-gray-600 italic text-[10px] py-10">Cargando clases...</p>
						</div>
					</div>

					<!-- RANKING -->
					<div class="glass-card p-8 rounded-[2.5rem] border-white/5 flex flex-col h-[400px]">
						<h4 class="text-sm font-black uppercase italic text-gray-400 mb-6 tracking-widest border-b border-white/5 pb-4">Top 5 Alumnos</h4>
						<div id="prof-dash-top-students" class="space-y-3 overflow-y-auto custom-scrollbar flex-1 pr-2">
							<!-- Inyectado por JS -->
						</div>
					</div>
				</div>
			</div>

            <div id="view-cobrar" class="view-content hidden">
			<div class="grid grid-cols-1 lg:grid-cols-3 gap-10 h-full">
				<!-- COLUMNA IZQUIERDA: BUSCADOR Y LISTA -->
				<div class="lg:col-span-2 space-y-6">
					<div class="flex justify-between items-center mb-4">
						<div class="flex border-b border-white/5">
							<button onclick="setCobrarTab('mercaderia')" id="tab-mercaderia" class="cobrar-tab active px-6 py-2 text-sm font-bold uppercase transition-colors hover:text-red-500 border-b-2 border-transparent">Mercadería</button>
							<button onclick="setCobrarTab('planes')" id="tab-planes" class="cobrar-tab px-6 py-2 text-sm font-bold uppercase transition-colors hover:text-red-500 border-b-2 border-transparent">Planes</button>
						</div>
						<div class="relative w-64">
							<i data-lucide="search" class="absolute left-4 top-3.5 w-4 h-4 text-gray-500"></i>
							<!-- Agregado oninput para filtrar -->
							<input type="text" 
								   placeholder="Buscar..." 
								   class="viking-input pl-12 py-3 w-full bg-white/5 border border-white/10 rounded-xl text-xs text-white placeholder-gray-500 focus:outline-none focus:border-red-600 transition-colors" 
								   id="cobrar-search"
								   oninput="filterCobroItems(this.value)">
						</div>
					</div>
					
					<div id="cobrar-display-area">
						<div class="grid grid-cols-2 md:grid-cols-4 gap-4 overflow-y-auto max-h-[600px] pr-2 custom-scrollbar" id="cobrar-catalogo">
							<!-- Aquí se inyectan los productos/planes vía JS -->
						</div>
					</div>
				</div>

				<!-- COLUMNA DERECHA: CARRITO Y PAGO -->
				<div class="glass-card p-10 rounded-[3rem] border border-red-600/10 flex flex-col h-fit bg-black/40 backdrop-blur-md">
					<h4 class="text-xs font-black uppercase italic text-red-600 mb-6 tracking-widest border-b border-white/5 pb-4">Carrito de Cobro</h4>
					
					<div class="flex-1 space-y-4 mb-8 overflow-y-auto max-h-64 custom-scrollbar" id="cobrar-lista-carrito">
						<p class="text-center text-gray-500 text-[11px] italic py-10">Sin ítems seleccionados</p>
					</div>

					<div class="space-y-4 border-t border-white/5 pt-6 mb-8">
						<div class="flex justify-between text-[11px] font-black italic">
							<span class="text-gray-500">SUBTOTAL</span>
							<span id="cobrar-subtotal">$ 0</span>
						</div>
						<div class="flex justify-between text-xl font-black italic">
							<span>TOTAL</span>
							<span class="viking-red" id="cobrar-total">$ 0</span>
						</div>
					</div>

					<!-- SECCIÓN DE MÉTODOS DE PAGO CORREGIDA -->
					<div class="space-y-4">
						<p class="text-[10px] font-black uppercase text-gray-500 italic mb-2 tracking-widest">Método de Pago</p>
						<div class="grid grid-cols-2 gap-3">
							<!-- MercadoPago -->
							<button onclick="setPaymentMethod('MercadoPago')" 
									data-method="MercadoPago"
									class="btn-pago w-full py-3 rounded-xl text-[10px] font-black uppercase italic transition-all bg-white/5 text-gray-400 hover:text-white border border-transparent hover:border-red-600/30">
								MercadoPago
							</button>
							
							<!-- Transferencia -->
							<button onclick="setPaymentMethod('Transferencia')" 
									data-method="Transferencia"
									class="btn-pago w-full py-3 rounded-xl text-[10px] font-black uppercase italic transition-all bg-white/5 text-gray-400 hover:text-white border border-transparent hover:border-red-600/30">
								Transf.
							</button>
							
							<!-- Efectivo (Seleccionado por defecto visualmente) -->
							<button onclick="setPaymentMethod('Efectivo')" 
									data-method="Efectivo"
									class="btn-pago w-full py-3 rounded-xl text-[10px] font-black uppercase italic transition-all bg-red-600 text-black shadow-lg shadow-red-600/20 transform scale-105">
								Efectivo
							</button>
							
							<!-- Tarjeta -->
							<button onclick="setPaymentMethod('Tarjeta')" 
									data-method="Tarjeta"
									class="btn-pago w-full py-3 rounded-xl text-[10px] font-black uppercase italic transition-all bg-white/5 text-gray-400 hover:text-white border border-transparent hover:border-red-600/30">
								Tarjeta
							</button>
						</div>
						
						<!-- SELECT OCULTO IMPORTANTE PARA LA LÓGICA -->
						<select id="metodo-pago" class="hidden">
							<option value="MercadoPago">MercadoPago</option>
							<option value="Transferencia">Transferencia</option>
							<option value="Efectivo" selected>Efectivo</option>
							<option value="Tarjeta">Tarjeta</option>
						</select>
					</div>
					<button id="btn-finalizar-pago" onclick="finalizarVentaMercaderia()" class="w-full mt-8 viking-bg-red text-black py-5 rounded-2xl font-black uppercase italic tracking-widest hover:scale-[1.02] active:scale-95 transition-all shadow-xl shadow-red-900/20">
						Procesar Pago
					</button>
				</div>
			</div>
		</div>

            <div id="view-perfil" class="view-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-10">
                    <div class="glass-card p-10 rounded-[3rem] flex flex-col items-center">
                        <div class="w-32 h-32 rounded-[2.5rem] viking-bg-red flex items-center justify-center font-black text-black text-4xl italic shadow-2xl mb-6" id="prof-initials-view">??</div>
                        <h3 class="text-xl font-black uppercase italic text-center" id="prof-name">Cargando...</h3>
                        <p class="text-red-600 text-xs font-black uppercase tracking-widest mb-8" id="prof-role">Rol</p>
						<p id="prof-display-email" class="text-gray-500 font-medium text-[10px] mt-1 italic">email@ejemplo.com</p>
                        <div id="plan-alumno-info" class="w-full space-y-2 mt-4 hidden">
                            <p class="text-[10px] font-black uppercase text-gray-500 italic text-center">Plan Actual</p>
                            <div class="bg-white/5 p-4 rounded-2xl border border-white/5 text-center">
                                <p class="text-sm font-black viking-red uppercase" id="perfil-plan-nombre">-</p>
                                <p class="text-[10px] text-gray-500 font-bold" id="perfil-vencimiento">Vence: -</p>
                            </div>
                        </div>
                    </div>
                    <div class="lg:col-span-2 glass-card p-10 rounded-[3rem]">
                        <h3 class="text-sm font-black uppercase italic border-l-4 border-red-600 pl-4 tracking-widest mb-10">Mis Datos</h3>
                        <form id="form-perfil" onsubmit="handleProfileUpdate(event)" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-2">
                                <label class="text-[10px] font-black uppercase text-gray-500 italic">Nombre Completo</label>
                                <input type="text" id="prof-input-name" class="viking-input" required>
                            </div>
                            <div class="space-y-2">
                                <label class="text-[10px] font-black uppercase text-gray-500 italic">DNI / Usuario</label>
                                <input type="text" id="prof-input-dni" readonly class="viking-input opacity-50">
                            </div>
                            <div class="space-y-2">
                                <label class="text-[10px] font-black uppercase text-gray-500 italic">Correo Electrónico</label>
                                <input type="email" id="prof-input-email" class="viking-input">
                            </div>
                            
                            <div id="perfil-datos-fisicos" class="md:col-span-2 grid grid-cols-3 gap-4 border-t border-white/5 pt-6 mt-4 hidden">
                                <div class="space-y-2">
                                    <label class="text-[10px] font-black uppercase text-gray-500 italic">Peso (kg)</label>
                                    <input type="number" step="0.1" id="prof-input-peso" class="viking-input" oninput="calculateIMCProfile()">
                                </div>
                                <div class="space-y-2">
                                    <label class="text-[10px] font-black uppercase text-gray-500 italic">Altura (cm)</label>
                                    <input type="number" step="0.1" id="prof-input-altura" class="viking-input" oninput="calculateIMCProfile()">
                                </div>
                                <div class="space-y-2">
                                    <label class="text-[10px] font-black uppercase text-red-600 italic">IMC</label>
                                    <input type="text" id="prof-input-imc" readonly class="viking-input opacity-50">
                                </div>
                            </div>

                            <div class="space-y-2 md:col-span-2">
                                <label class="text-[10px] font-black uppercase text-gray-500 italic">Nueva Contraseña</label>
                                <input type="password" id="prof-input-pass" placeholder="Dejar vacío para no cambiar" class="viking-input">
                            </div>
                            <div class="md:col-span-2 pt-6 text-left">
                                <button type="submit" id="btn-save-profile" class="px-10 py-4 viking-bg-red text-black rounded-2xl font-black uppercase italic tracking-widest hover:scale-105 transition-transform shadow-lg shadow-red-600/20">Guardar Cambios</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

			<div id="view-alumnos" class="view-content">
			<!-- CABECERA PRINCIPAL -->
			<div class="flex justify-between items-center mb-8">
				<div>
					<h3 class="text-3xl font-black italic uppercase">Gestión de Alumnos</h3>
					<p class="text-[10px] text-gray-500 font-bold uppercase tracking-[0.2em] mt-1 italic">Control de accesos y membresías del Valhalla</p>
				</div>
				<button id="btn-nuevo-alumno" onclick="openModalAlumno()" class="viking-bg-red text-black px-8 py-4 rounded-2xl font-black uppercase italic text-[12px] shadow-xl flex items-center gap-3 hover:scale-105 transition-all">
					<i data-lucide="user-plus" class="w-4 h-4"></i> Nuevo Alumno
				</button>
			</div>

			<!-- BARRA DE HERRAMIENTAS (BUSCADOR Y FILTROS) -->
			<div class="flex flex-col md:flex-row gap-4 mb-4">
					<!-- BUSCADOR -->
					<div class="flex-1 relative">
						<i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-500"></i>
						<input type="text" 
							placeholder="Buscar Guerrero por nombre o DNI..." 
							oninput="searchAlumno(this.value)"
							class="viking-input pl-12 bg-white/5 border-white/10 text-white rounded-2xl focus:border-red-600 transition-all">
					</div>

					<!-- FILTRO DE ESTADO VIKINGO -->
					<div class="flex bg-white/5 p-1 rounded-2xl border border-white/5 h-[52px]">
						<button onclick="filterAlumnos('todos')" id="filter-todos" class="filter-btn px-6 rounded-xl text-[10px] font-black uppercase italic transition-all bg-red-600 text-black">Todos</button>
						<button onclick="filterAlumnos('activos')" id="filter-activos" class="filter-btn px-6 rounded-xl text-[10px] font-black uppercase italic transition-all text-gray-500 hover:text-white">Activos</button>
						<button onclick="filterAlumnos('inactivos')" id="filter-inactivos" class="filter-btn px-6 rounded-xl text-[10px] font-black uppercase italic transition-all text-gray-500 hover:text-white">Vencidos</button>
					</div>
				</div>

				<!-- LISTADO DE ALUMNOS (CONTENEDOR DONDE EL JS INYECTARÁ LOS DATOS) -->
				<!-- Nota: Le puse space-y-3 para separar las tarjetas igual que en Staff -->
				<div id="lista-alumnos-container" class="space-y-3 min-h-[400px] overflow-y-auto custom-scrollbar flex-1 pr-2 pb-10">
					<!-- El JS llenará esto -->
				</div>
			</div>

            <div id="view-profesores" class="view-content">
                <div class="flex justify-between items-center mb-8">
                    <h3 class="text-3xl font-black italic uppercase">Personal de Profesores</h3>
                    <button id="btn-nuevo-prof" onclick="openModalStaff('Profesor')" class="viking-bg-red text-black px-8 py-4 rounded-2xl font-black uppercase italic text-[12px] shadow-xl flex items-center gap-3">
                        <i data-lucide="user-plus" class="w-4 h-4"></i> Alta Profesor
                    </button>
                </div>
                <div class="glass-card p-10 rounded-[3rem]">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="text-[10px] font-black uppercase text-gray-500 italic border-b border-white/5">
                                    <th class="pb-5">Nombre</th>
                                    <th class="pb-5">DNI (Usuario)</th>
                                    <th class="pb-5">Especialidad</th>
                                    <th class="pb-5 text-right action-col">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="table-profesores" class="text-[11px] font-black uppercase italic"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-administrativos" class="view-content">
                <div class="flex justify-between items-center mb-8">
                    <h3 class="text-3xl font-black italic uppercase">Personal Administrativo</h3>
                    <button id="btn-nuevo-adm" onclick="openModalStaff('Administracion')" class="viking-bg-red text-black px-8 py-4 rounded-2xl font-black uppercase italic text-[12px] shadow-xl flex items-center gap-3">
                        <i data-lucide="shield-plus" class="w-4 h-4"></i> Alta Administrativo
                    </button>
                </div>
                <div class="glass-card p-10 rounded-[3rem]">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="text-[10px] font-black uppercase text-gray-500 italic border-b border-white/5">
                                    <th class="pb-5">Nombre</th>
                                    <th class="pb-5">DNI (Usuario)</th>
                                    <th class="pb-5">Email</th>
                                    <th class="pb-5 text-right action-col">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="table-administrativos" class="text-[11px] font-black uppercase italic"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-caja" class="view-content">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-10">
                    <div class="glass-card p-8 rounded-[2.5rem] border-green-500/20">
                        <p class="text-[11px] font-black text-gray-500 uppercase italic mb-2">Total Ingresos</p>
                        <h4 class="text-3xl font-black italic text-green-500" id="caja-ingresos">$ 0,00</h4>
                    </div>
                    <div class="glass-card p-8 rounded-[2.5rem] border-red-500/20">
                        <p class="text-[11px] font-black text-gray-500 uppercase italic mb-2">Total Gastos</p>
                        <h4 class="text-3xl font-black italic text-red-500" id="caja-gastos">$ 0,00</h4>
                    </div>
                    <div class="glass-card p-8 rounded-[2.5rem] border-viking-red/20">
                        <p class="text-[11px] font-black text-red-600 uppercase italic mb-2">Balance Neto</p>
                        <h4 class="text-3xl font-black italic" id="caja-balance">$ 0,00</h4>
                    </div>
                </div>
                <div class="glass-card p-10 rounded-[3rem]">
                    <div class="flex justify-between items-center mb-8">
                        <h3 class="text-sm font-black uppercase italic border-l-4 border-red-600 pl-4 tracking-widest">Flujo Diario de Caja</h3>
                        <button onclick="document.getElementById('modal-gasto').classList.remove('hidden')" 
								class="px-3 py-1.5 bg-red-600 hover:bg-red-700 rounded text-[10px] font-bold uppercase transition-colors text-white">
							+ Nuevo Movimiento
						</button>
                    </div>
                    <table class="w-full text-left">
                        <thead>
                            <tr class="text-[10px] font-black uppercase text-gray-500 italic border-b border-white/5">
                                <th class="pb-5">Tipo</th>
                                <th class="pb-5">Descripción</th>
                                <th class="pb-5 text-right">Monto</th>
                            </tr>
                        </thead>
                        <tbody id="table-caja" class="text-[12px] font-black italic uppercase"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-stock" class="view-content">
                <div class="flex justify-between items-center mb-8">
                    <h3 class="text-3xl font-black italic uppercase">Control de Stock</h3>
                    <button id="btn-nuevo-stock" onclick="openModalStock()" class="viking-bg-red text-black px-8 py-4 rounded-2xl font-black uppercase italic text-[12px] shadow-xl flex items-center gap-3">
                        <i data-lucide="package-plus" class="w-4 h-4"></i> Crear Mercadería
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-8" id="stock-container"></div>
            </div>

            <div id="view-planes" class="view-content">
                <div class="flex justify-between items-center mb-8">
                    <h3 class="text-3xl font-black italic uppercase">Planes de Entrenamiento</h3>
                    <button id="btn-nuevo-plan" onclick="openModalPlan()" class="viking-bg-red text-black px-8 py-4 rounded-2xl font-black uppercase italic text-[12px] shadow-xl flex items-center gap-3">
                        <i data-lucide="plus" class="w-4 h-4"></i> Alta de Plan
                    </button>
                </div>
                <div class="flex gap-2 mb-10 overflow-x-auto pb-2 custom-scrollbar" id="planes-filter-container"></div>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-8" id="planes-container"></div>
            </div>

            <div id="view-clases" class="view-content">
                <div class="flex justify-between items-center mb-8">
                    <h3 class="text-3xl font-black italic uppercase">Gestión de Clases</h3>
                    <button id="btn-nueva-clase" onclick="openModalClase()" class="viking-bg-red text-black px-8 py-4 rounded-2xl font-black uppercase italic text-[12px] shadow-xl flex items-center gap-3">
                        <i data-lucide="presentation" class="w-4 h-4"></i> Alta de Clase
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8" id="clases-container"></div>
            </div>

            <div id="view-calendario" class="view-content">
				<div class="flex justify-between items-center mb-10">
					<h3 class="text-3xl font-black italic uppercase text-left">Agenda Vikinga</h3>
					<div class="flex gap-4">
						<div class="flex bg-white/5 p-1 rounded-2xl border border-white/5">
							<button onclick="renderCalendar()" class="px-6 py-2 bg-red-600 text-black rounded-xl text-[11px] font-black uppercase italic hover:scale-105 transition-transform">Semana Actual</button>
						</div>
					</div>
				</div>
				
				<!-- GRILLA DEL CALENDARIO (Agregadas clases grid para columnas) -->
				<div class="calendar-container h-[700px] overflow-y-auto custom-scrollbar grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4 pb-10" id="calendar-grid">
					<!-- El JS inyectará las columnas con fechas aquí -->
				</div>
			</div>

            <div id="view-rutinas" class="view-content">
			<!-- HEADER -->
			<div class="flex justify-between items-center mb-8">
				<div>
					<h3 class="text-3xl font-black italic uppercase" id="rutina-title">Rutinas de Alumnos</h3>
					<p class="text-[10px] text-gray-500 font-bold uppercase tracking-[0.2em] mt-1 italic">Diseño y Seguimiento de Entrenamientos</p>
				</div>
				<!-- Aquí podrías poner un buscador futuro si quisieras -->
			</div>

			<!-- VISTA ALUMNO (Se mantiene igual, dentro de una tarjeta para que destaque) -->
			<div id="musculacion-student-view" class="hidden glass-card p-10 rounded-[3rem] border-red-600/10 mb-6 space-y-8">
				<div class="bg-red-600/10 p-6 rounded-3xl border border-red-600/20" id="student-plan-header">
					<h4 class="text-xl font-black italic uppercase mb-2">MI RUTINA DEL VALHALLA</h4>
					<p class="text-[11px] text-gray-400 font-bold uppercase tracking-widest" id="al-rutina-objetivo">Cargando objetivo...</p>
				</div>
				<div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="student-routine-exercises">
				</div>
			</div>

			<!-- VISTA PROFESOR: LISTA (Estilo idéntico a Alumnos) -->
			<div id="rutinas-lista" class="space-y-3 min-h-[400px] overflow-y-auto custom-scrollbar flex-1 pr-2 pb-10 hidden">
				<!-- El JS inyectará las tarjetas aquí -->
			</div>
		</div>

			<!-- Vista de Acceso Virtual -->
			<div id="view-acceso-virtual" class="view-content">
				<div class="flex justify-between items-center mb-8">
					<div>
						<h3 class="text-3xl font-black italic uppercase">Accesos al Valhalla</h3>
						<p class="text-[10px] text-gray-500 font-bold uppercase tracking-widest mt-1 italic">Control de Molinetes y QR en Tiempo Real</p>
					</div>
					<button onclick="startScanner()" class="viking-bg-red text-black px-6 py-3 rounded-xl font-black uppercase italic text-[11px] shadow-lg hover:scale-105 transition-transform flex items-center gap-2">
						<i data-lucide="camera" class="w-4 h-4"></i> Abrir Ojos de Odín
					</button>
				</div>

				<div class="glass-card p-6 rounded-[2.5rem] border-white/5">
					<!-- Cabecera de columnas -->
					<div class="grid grid-cols-5 gap-4 px-6 mb-4 opacity-50 text-[10px] font-black uppercase italic tracking-widest">
						<span>Guerrero / Alumno</span>
						<span>DNI / Usuario</span>
						<span>Fecha y Hora</span>
						<span>Método</span>
						<span class="text-right">Estado</span>
					</div>
					<!-- Lista dinámica de ingresos -->
					<div id="acceso-list-view" class="flex flex-col gap-2 max-h-[600px] overflow-y-auto custom-scrollbar pr-2">
						<p class="text-center text-gray-600 italic py-10">Esperando registros de entrada...</p>
					</div>
				</div>
			</div>
        </div>
    </main>

    <!-- MODAL EDITAR RUTINA (OPTIMIZADO CON BUSCADOR Y ALINEACIÓN) -->
    <div id="modal-rutina-editor" class="viking-modal">
        <div class="glass-card p-10 rounded-[3rem] w-full max-w-5xl text-left overflow-y-auto max-h-[95vh] custom-scrollbar">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h3 class="text-2xl font-black uppercase italic mb-1">Gestionar Rutina de Musculación</h3>
                    <p id="rutina-editor-alumno" class="text-red-600 font-black uppercase italic text-sm"></p>
                </div>
                <button onclick="openModalNewExercise()" class="viking-bg-red text-black px-4 py-2 rounded-xl font-black uppercase italic text-[10px] shadow-lg">+ Crear Nuevo Ejercicio</button>
            </div>
            
            <form id="form-rutina-editor" class="space-y-6">
                <input type="hidden" id="rutina-editor-alumno-id">
                
                <div class="grid grid-cols-2 gap-6 mb-8">
                    <div class="space-y-1">
                        <label class="text-[10px] font-black uppercase text-gray-500 italic">Objetivo del Plan</label>
                        <input type="text" id="rutina-objetivo" placeholder="Ej: Hipertrofia, Fuerza, Definición" class="viking-input" required>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-black uppercase text-gray-500 italic">Vencimiento de Rutina</label>
                        <input type="date" id="rutina-vencimiento" class="viking-input" required>
                    </div>
                </div>

                <div id="rutina-editor-container" class="space-y-10">
                    <!-- Los días se agregan aquí dinámicamente -->
                </div>
                
                <button type="button" onclick="addRoutineDay()" class="w-full py-4 border border-dashed border-white/20 rounded-2xl text-gray-500 hover:text-red-600 hover:border-red-600 transition-all font-black uppercase italic text-[12px]">
                    + Agregar Día de Entrenamiento (A, B, C...)
                </button>

                <div class="flex gap-4 pt-6 border-t border-white/5">
                    <button type="button" onclick="closeModal('modal-rutina-editor')" class="flex-1 py-4 bg-white/5 rounded-2xl font-black uppercase italic text-[11px]">Cancelar</button>
                    <button type="submit" class="flex-1 py-4 viking-bg-red text-black rounded-2xl font-black uppercase italic text-[11px] shadow-xl">Guardar Plan Completo</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL PARA CREAR NUEVO EJERCICIO EN LIBRERÍA -->
    <div id="modal-nuevo-ejercicio" class="viking-modal">
        <div class="glass-card p-10 rounded-[3rem] w-full max-w-md text-left">
            <h3 class="text-xl font-black uppercase italic mb-6">Nuevo Ejercicio en Librería</h3>
            <form id="form-nuevo-ejercicio-lib" class="space-y-4">
                <input type="text" id="lib-ex-nombre" placeholder="Nombre del Ejercicio (ej: Sentadilla)" required class="viking-input">
                <select id="lib-ex-grupo" required class="viking-input">
                    <option value="">Seleccionar Grupo Muscular</option>
                </select>
                <div class="flex gap-4 pt-4">
                    <button type="button" onclick="closeModal('modal-nuevo-ejercicio')" class="flex-1 py-3 bg-white/5 rounded-xl font-black uppercase italic text-[10px]">Cancelar</button>
                    <button type="submit" class="flex-1 py-3 viking-bg-red text-black rounded-xl font-black uppercase italic text-[10px]">Crear Ejercicio</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL CLASE -->
	<div id="modal-clase" class="viking-modal">
		<div class="glass-card p-10 rounded-[3rem] w-full max-w-lg border-red-600/30">
			<h3 id="modal-clase-title" class="text-2xl font-black italic uppercase mb-6">Configurar Clase</h3>
			<form id="form-clase" class="space-y-4">
				<input type="hidden" id="cl-id">
				<div class="w-full">
					<input type="text" id="cl-nombre" placeholder="Nombre de Clase" class="viking-input" required>
					<!-- El selector de coach global se elimina visualmente porque elegiremos coach por turno -->
					<input type="hidden" id="cl-coach-select" value="Staff"> 
				</div>
				<div class="grid grid-cols-2 gap-4">
					<input type="number" id="cl-cupo" placeholder="Cupo Máximo" class="viking-input" required>
					<input type="color" id="cl-color" value="#FF0000" class="viking-input h-[52px] cursor-pointer p-1">
				</div>

				<div class="mt-6">
					<div class="flex items-center justify-between mb-2">
						<p class="text-[10px] font-black text-gray-500 uppercase tracking-widest italic">Configuración de Turnos</p>
						<button type="button" onclick="addNewScheduleSlot()" class="text-[9px] font-black text-red-500 uppercase border border-red-500/30 px-3 py-1 rounded-full hover:bg-red-500 hover:text-black transition-all">
							+ Añadir Turno
						</button>
					</div>
					<!-- Contenedor dinámico donde se inyectarán los días y horas -->
					<div id="cl-schedule-slots" class="max-h-60 overflow-y-auto custom-scrollbar space-y-2 pr-2 border-t border-white/5 pt-4">
						<p class="text-[9px] text-gray-600 italic py-4 text-center">No hay horarios definidos</p>
					</div>
				</div>

				<div class="flex gap-4 pt-6">
					<button type="button" onclick="closeModal('modal-clase')" class="flex-1 py-4 border border-white/10 rounded-2xl font-black uppercase italic text-[11px] hover:bg-white/5 transition-all">Cancelar</button>
					<button type="submit" class="flex-1 py-4 viking-bg-red text-black rounded-2xl font-black uppercase italic text-[11px] shadow-lg">Guardar Configuración</button>
				</div>
				<button type="button" id="btn-delete-clase" class="w-full text-[10px] text-red-600 font-bold uppercase mt-4 hidden">Eliminar Clase Permanentemente</button>
			</form>
		</div>
	</div>

    <!-- Otros Modales -->
    <!-- MODAL: FICHA TÉCNICA -->
    <div id="modal-ficha-tecnica" class="viking-modal hidden fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
        <div class="glass-card p-10 rounded-[3rem] w-full max-w-2xl text-left overflow-y-auto max-h-[90vh] custom-scrollbar bg-zinc-950 border border-white/5 shadow-2xl">
            <!-- Encabezado y Datos de Membresía -->
            <div class="flex justify-between items-start mb-8">
                <div>
                    <h3 class="text-2xl font-black uppercase italic" id="ficha-nombre">-</h3>
                    <p class="text-[11px] viking-red font-black uppercase" id="ficha-dni">DNI: -</p>
                </div>
                <div class="text-right">
                    <p class="text-[10px] text-gray-500 font-black uppercase italic" id="ficha-plan">Plan: -</p>
                    <p class="text-[10px] text-gray-500 font-black uppercase italic" id="ficha-cuenta">Estado: -</p>
                </div>
            </div>
            
            <!-- Grid de Datos Antropométricos -->
            <div class="grid grid-cols-3 gap-4 mb-8">
                <div class="bg-white/5 p-4 rounded-2xl border border-white/5 text-center">
                    <p class="text-[9px] text-gray-500 font-black uppercase italic mb-1">Peso</p>
                    <p class="text-lg font-black italic" id="ficha-peso">0 kg</p>
                </div>
                <div class="bg-white/5 p-4 rounded-2xl border border-white/5 text-center">
                    <p class="text-[9px] text-gray-500 font-black uppercase italic mb-1">Altura</p>
                    <p class="text-lg font-black italic" id="ficha-altura">0 cm</p>
                </div>
                <div class="bg-white/5 p-4 rounded-2xl border border-white/5 text-center">
                    <p class="text-[9px] text-gray-500 font-black uppercase italic mb-1">IMC</p>
                    <p class="text-lg font-black italic viking-red" id="ficha-imc">0</p>
                </div>
            </div>

            <!-- Sección de Rutina Personalizada -->
            <div class="space-y-4">
                <div class="flex items-center justify-between border-l-4 border-red-600 pl-4 mb-2">
                    <h4 class="text-sm font-black uppercase italic tracking-widest">Plan de Entrenamiento</h4>
                </div>
                
                <!-- Este es el contenedor donde se inyecta la rutina agrupada y los días desplegables -->
                <div id="ficha-rutina-container" class="flex flex-col gap-2">
                    <p class="text-[10px] text-gray-600 italic text-center py-4">Cargando rutina...</p>
                </div>
            </div>

            <!-- Botón de Cierre -->
            <div class="flex gap-4 pt-10">
                <button onclick="closeModal('modal-ficha-tecnica')" class="w-full py-4 viking-bg-red text-black rounded-2xl font-black uppercase italic text-[12px] shadow-lg hover:scale-[1.02] transition-transform">
                    Cerrar Ficha del Guerrero
                </button>
            </div>
        </div>
    </div>

    <div id="modal-alumno" class="viking-modal">
        <div class="glass-card p-10 rounded-[3rem] w-full max-w-lg text-left">
            <h3 class="text-2xl font-black uppercase italic mb-8" id="modal-alumno-title">Alumno</h3>
            <form id="form-alumno" class="space-y-4">
                <input type="hidden" id="al-id">
                <input type="text" id="al-nombre" placeholder="Nombre Completo" required class="viking-input">
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="al-dni" placeholder="DNI / Usuario" required class="viking-input">
                    <input type="email" id="al-email" placeholder="Email" required class="viking-input">
                </div>
                <div class="grid grid-cols-3 gap-4">
                    <div class="space-y-1">
                        <label class="text-[9px] font-black text-gray-500 uppercase italic">Peso (kg)</label>
                        <input type="number" step="0.01" id="al-peso" placeholder="0.00" class="viking-input" oninput="calculateIMC()">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[9px] font-black text-gray-500 uppercase italic">Altura (cm)</label>
                        <input type="number" step="0.01" id="al-altura" placeholder="0.00" class="viking-input" oninput="calculateIMC()">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[9px] font-black text-red-600 uppercase italic">IMC</label>
                        <input type="text" id="al-imc" placeholder="-" readonly class="viking-input opacity-60">
                    </div>
                </div>
				
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-[9px] font-black text-gray-500 uppercase italic">Fecha Renovación</label>
                        <input type="date" id="al-fecha-renovacion" class="viking-input" onchange="autoCalculateExpiry()">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[9px] font-black text-gray-500 uppercase italic">Fecha Vencimiento</label>
                        <input type="date" id="al-fecha-vencimiento" class="viking-input">
                    </div>
                </div>
				<!-- NUEVA SECCIÓN: SALUD Y EDAD -->
				<div class="grid grid-cols-2 gap-4 border-t border-white/5 pt-4 mt-2">
					<div class="space-y-1">
						<label class="text-[9px] font-black text-red-600 uppercase italic">Fecha de Nacimiento</label>
						<input type="date" id="al-fecha-nacimiento" class="viking-input">
					</div>
					<div class="space-y-1">
						<label class="text-[9px] font-black text-gray-500 uppercase italic">Certificado Médico (Fecha)</label>
						<input type="date" id="al-fecha-certificado" class="viking-input">
					</div>
				</div>
				<div class="flex items-center gap-3 bg-white/5 p-3 rounded-xl border border-white/5 mt-2">
					<input type="checkbox" id="al-certificado-entregado" class="w-4 h-4 accent-red-600">
					<label for="al-certificado-entregado" class="text-[10px] font-black uppercase italic text-gray-300">¿Certificado Físico Entregado?</label>
				</div>
                <div class="grid grid-cols-2 gap-4">
                    <select id="al-plan" class="viking-input" required onchange="autoCalculateExpiry()"></select>
                    <input type="password" id="al-pass" placeholder="Contraseña de Acceso" class="viking-input">
                </div>
                <div class="flex gap-4 pt-4">
                    <button type="button" onclick="closeModal('modal-alumno')" class="flex-1 py-4 bg-white/5 rounded-2xl font-black uppercase italic text-[11px]">Cancelar</button>
                    <button type="button" id="btn-delete-alumno" class="hidden py-4 px-4 bg-red-900/40 rounded-2xl font-black uppercase italic text-[11px] text-red-500">Eliminar</button>
                    <button type="submit" id="btn-save-alumno-modal" class="flex-1 py-4 viking-bg-red text-black rounded-2xl font-black uppercase italic text-[11px]">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 2. EL MODAL NUEVO (Reemplaza al viejo 'modal-movimiento') -->
		<div id="modal-gasto" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center z-50 backdrop-blur-sm animate-fade-in">
		<div class="glass-panel p-6 rounded-xl w-full max-w-sm mx-4 relative border border-white/10 shadow-2xl">
			
			<!-- Botón Cerrar (X) -->
			<button type="button" onclick="document.getElementById('modal-gasto').classList.add('hidden')" 
					class="absolute top-4 right-4 text-gray-500 hover:text-white transition-colors">
				<i data-lucide="x" class="w-5 h-5"></i>
			</button>

			<h3 class="text-xl font-black italic text-white mb-6 tracking-tight">
				NUEVO <span class="text-red-600">MOVIMIENTO</span>
			</h3>
			
			<!-- FORMULARIO -->
			<form onsubmit="guardarMovimiento(event)">
				<div class="space-y-4">
					
					<!-- Selector Tipo (AHORA INGRESO ES EL PRIMERO Y DEFAULT) -->
					<div>
						<label class="block text-[10px] font-bold uppercase text-gray-400 mb-1">Tipo de Movimiento</label>
						<select id="input-tipo-movimiento" class="viking-input w-full p-3 rounded text-xs font-bold text-white bg-black/50 border border-white/10 focus:border-red-600 transition-colors">
							<option value="Ingreso" selected>INGRESO (Venta, Cuota, etc.)</option>
							<option value="Gasto">EGRESO (Pago, Gasto, Compra)</option>
						</select>
					</div>

					<!-- Input Descripción -->
					<div>
						<label class="block text-[10px] font-bold uppercase text-gray-400 mb-1">Descripción</label>
						<input type="text" id="input-desc-gasto" 
							   class="viking-input w-full p-3 rounded text-xs font-bold text-white bg-black/50 border border-white/10 focus:border-red-600 transition-colors" 
							   placeholder="Ej: Gatorade, Cuota Mensual..." required>
					</div>

					<!-- Input Monto -->
					<div>
						<label class="block text-[10px] font-bold uppercase text-gray-400 mb-1">Monto ($)</label>
						<input type="number" id="input-monto-gasto" 
							   class="viking-input w-full p-3 rounded text-xs font-bold text-white bg-black/50 border border-white/10 focus:border-red-600 transition-colors" 
							   placeholder="0.00" required step="0.01">
					</div>

					<!-- Botón Guardar -->
					<button type="submit" 
							class="w-full bg-red-600 hover:bg-red-700 text-white font-black uppercase py-3 rounded text-xs tracking-widest mt-4 border border-red-500 shadow-lg shadow-red-900/20 transition-all hover:scale-[1.02]">
						Confirmar Movimiento
					</button>
				</div>
			</form>
		</div>
	</div>

    <div id="modal-staff" class="viking-modal">
        <div class="glass-card p-10 rounded-[3rem] w-full max-w-lg text-left">
            <h3 class="text-2xl font-black uppercase italic mb-4" id="modal-staff-title">Personal</h3>
            <form id="form-staff" class="space-y-4">
                <input type="hidden" id="stf-id">
                <input type="hidden" id="stf-rol">
                <input type="text" id="stf-nombre" placeholder="Nombre Completo" required class="viking-input">
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="stf-dni" placeholder="DNI / Usuario" required class="viking-input">
                    <input type="text" id="stf-esp" placeholder="Especialidad / Cargo" class="viking-input">
                </div>
                <div class="space-y-4">
                    <label class="text-[10px] font-black text-red-600 uppercase italic">Seguridad</label>
                    <input type="password" id="stf-pass" placeholder="Nueva Contraseña" class="viking-input">
                </div>
                <div class="flex gap-4 pt-6">
                    <button type="button" onclick="closeModal('modal-staff')" class="flex-1 py-4 bg-white/5 rounded-2xl font-black uppercase italic text-[11px]">Cancelar</button>
                    <button type="button" id="btn-delete-staff" class="hidden py-4 px-4 bg-red-900/40 rounded-2xl font-black uppercase italic text-[11px] text-red-500">Eliminar</button>
                    <button type="submit" id="btn-save-staff-modal" class="flex-1 py-4 viking-bg-red text-black rounded-2xl font-black uppercase italic text-[11px]">Guardar Staff</button>
                </div>
            </form>
        </div>
    </div>

		<div id="modal-stock" class="viking-modal">
			<div class="glass-card p-10 rounded-[3rem] w-full max-w-lg text-left border border-white/5">
				<h3 class="text-2xl font-black uppercase italic mb-8" id="modal-stock-title">Mercadería</h3>
				
				<form id="form-stock" class="space-y-4">
					<input type="hidden" id="stock-id">

					<div class="space-y-1">
						<p class="text-[9px] font-black text-gray-500 uppercase px-2">Nombre del Producto</p>
						<input type="text" id="stock-nombre" placeholder="Ej: Agua Mineral 500ml" required class="viking-input">
					</div>

					<div class="grid grid-cols-2 gap-4">
						<div class="space-y-1">
							<p class="text-[9px] font-black text-gray-500 uppercase px-2">Stock</p>
							<input type="number" id="stock-cant" placeholder="0" required class="viking-input">
						</div>
						<div class="space-y-1">
							<p class="text-[9px] font-black text-gray-500 uppercase px-2">Precio ($)</p>
							<input type="number" id="stock-precio" placeholder="0" required class="viking-input">
						</div>
					</div>

					<!-- CARGA DE IMAGEN DESDE ORDENADOR -->
					<div class="space-y-1">
						<p class="text-[9px] font-black text-red-600 uppercase px-2 italic">Imagen del Producto</p>
						<div class="flex flex-col gap-3">
							<!-- Vista previa -->
							<div id="stock-img-preview-container" class="w-full h-32 rounded-2xl bg-white/5 border border-dashed border-white/10 flex items-center justify-center overflow-hidden">
								<img id="stock-img-preview" src="" class="hidden w-full h-full object-cover">
								<div id="stock-img-placeholder" class="text-gray-600 flex flex-col items-center">
									<i data-lucide="image-plus" class="w-8 h-8 mb-1"></i>
									<span class="text-[8px] font-black uppercase">Sin Imagen</span>
								</div>
							</div>
							
							<!-- Botón oculto y label estético -->
							<label for="stock-file-input" class="w-full py-3 bg-white/5 border border-white/10 rounded-xl text-[10px] font-black uppercase italic text-center cursor-pointer hover:bg-white/10 transition-all flex items-center justify-center gap-2">
								<i data-lucide="upload-cloud" class="w-4 h-4"></i>
								Seleccionar desde ordenador
							</label>
							<input type="file" id="stock-file-input" accept="image/*" class="hidden" onchange="previewStockImage(event)">
							
							<!-- Campo oculto para guardar el Base64 -->
							<input type="hidden" id="stock-imagen-base64">
						</div>
					</div>

					<div class="flex gap-4 pt-6">
						<button type="button" onclick="closeModal('modal-stock')" class="flex-1 py-4 bg-white/5 rounded-2xl font-black uppercase italic text-[11px]">Cancelar</button>
						<button type="button" id="btn-delete-stock" class="hidden py-4 px-4 bg-red-900/40 rounded-2xl font-black uppercase italic text-[11px] text-red-500">Eliminar</button>
						<button type="submit" class="flex-1 py-4 viking-bg-red text-black rounded-2xl font-black uppercase italic text-[11px] shadow-xl">Guardar</button>
					</div>
				</form>
			</div>
		</div>

    <div id="modal-plan" class="viking-modal">
        <div class="glass-card p-10 rounded-[3rem] w-full max-w-lg text-left">
            <h3 class="text-2xl font-black uppercase italic mb-8" id="modal-plan-title">Plan</h3>
            <form id="form-plan" class="space-y-4">
                <input type="hidden" id="plan-id">
                <input type="text" id="plan-nombre" placeholder="Nombre del Plan" required class="viking-input">
                <div class="grid grid-cols-2 gap-4">
                    <select id="plan-tipo" class="viking-input" required></select>
                    <input type="number" id="plan-precio" placeholder="Precio ($)" required class="viking-input">
                </div>
                <div class="flex gap-4 pt-4">
                    <button type="button" onclick="closeModal('modal-plan')" class="flex-1 py-4 bg-white/5 rounded-2xl font-black uppercase italic text-[11px]">Cancelar</button>
                    <button type="button" id="btn-delete-plan" class="hidden py-4 px-4 bg-red-900/40 rounded-2xl font-black uppercase italic text-[11px] text-red-500">Eliminar</button>
                    <button type="submit" id="btn-save-plan-modal" class="flex-1 py-4 viking-bg-red text-black rounded-2xl font-black uppercase italic text-[11px]">Guardar Plan</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-inscriptos" class="viking-modal">
        <div class="glass-card p-10 rounded-[3rem] w-full max-w-lg text-left">
            <h3 class="text-2xl font-black uppercase italic mb-6">Alumnos Inscriptos</h3>
            <div id="inscriptos-lista" class="space-y-3 max-h-96 overflow-y-auto custom-scrollbar mb-8"></div>
            <button onclick="closeModal('modal-inscriptos')" class="w-full py-4 viking-bg-red text-black rounded-2xl font-black uppercase italic text-[11px]">Cerrar</button>
        </div>
    </div>

		<!-- ========================================== -->
		<!-- MÓDULO: LOS OJOS DE ODÍN (SCANNER QR)      -->
		<!-- Versión Conectada a API de Validación      -->
		<!-- ========================================== -->

		<div id="modal-scanner-live" class="fixed inset-0 z-[2000] hidden bg-black flex-col items-center justify-center overflow-hidden">
    
			<!-- 1. Header: Información del Sistema (Se mantiene tu diseño original) -->
			<div class="absolute top-0 left-0 w-full p-6 flex justify-between items-center bg-gradient-to-b from-black/90 to-transparent z-50">
				<div>
					<h3 class="text-xl font-black italic uppercase text-white tracking-widest flex items-center">
						<i data-lucide="scan" class="w-5 h-5 mr-2 text-red-600 animate-pulse"></i>Acceso Vikingo
					</h3>
					<p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">Sistema de Reconocimiento Visual</p>
				</div>
				<button onclick="stopScanner()" class="w-10 h-10 rounded-full bg-white/10 hover:bg-red-600 text-white flex items-center justify-center transition-all backdrop-blur-md border border-white/10">
					<i data-lucide="x" class="w-5 h-5"></i>
				</button>
			</div>

			<!-- 2. Contenedor Principal de Video y HUD -->
			<div class="relative w-full h-full flex items-center justify-center">
				<!-- Video de fondo: Ahora ocupa todo el espacio -->
				<video id="scanner-video" class="absolute inset-0 w-full h-full object-cover pointer-events-none opacity-60" autoplay playsinline muted></video>

				<!-- RECUADRO DE ENFOQUE (Agrandado y con máscara negra) -->
				<div id="scanner-hud" class="relative z-10 w-80 h-80 sm:w-96 sm:h-96 border-2 border-red-600/30 rounded-3xl scanner-mask flex items-center justify-center pointer-events-none">
					
					<!-- Esquinas Reforzadas Vikingas -->
					<div class="absolute -top-1 -left-1 w-10 h-10 border-t-4 border-l-4 border-red-600 rounded-tl-3xl"></div>
					<div class="absolute -top-1 -right-1 w-10 h-10 border-t-4 border-r-4 border-red-600 rounded-tr-3xl"></div>
					<div class="absolute -bottom-1 -left-1 w-10 h-10 border-b-4 border-l-4 border-red-600 rounded-bl-3xl"></div>
					<div class="absolute -bottom-1 -right-1 w-10 h-10 border-b-4 border-r-4 border-red-600 rounded-br-3xl"></div>

					<!-- Línea Láser Animada -->
					<div class="absolute left-4 right-4 h-1 bg-red-600 shadow-[0_0_15px_rgba(255,0,0,0.8)] animate-scan-line z-20"></div>
					
					<!-- Texto de Guía (Debajo del cuadro) -->
					<div class="absolute -bottom-16 left-0 right-0 text-center">
						<p class="text-white text-[10px] font-black uppercase tracking-[0.3em] bg-black/60 py-2 px-6 rounded-full inline-block animate-pulse border border-white/10">
							Encuadre el Código QR
						</p>
					</div>
				</div>

				<!-- 3. Mensaje de Error (Se mantiene tu lógica) -->
				<div id="scanner-error-msg" class="absolute inset-0 z-40 hidden flex-col items-center justify-center bg-black/95 p-10 text-center backdrop-blur-sm">
					<i data-lucide="video-off" class="w-16 h-16 text-gray-600 mb-4"></i>
					<h3 class="text-xl font-black text-white mb-2 uppercase italic">Cámara no disponible</h3>
					<p id="scanner-error-text" class="text-sm text-gray-400 max-w-md">Verificá los permisos de tu navegador o la conexión HTTPS.</p>
					<button onclick="stopScanner()" class="mt-6 px-8 py-3 bg-white/10 hover:bg-red-600 rounded-xl text-[10px] font-black uppercase italic transition-all border border-white/10">Cerrar</button>
				</div>

				<!-- 4. FEEDBACK OVERLAY (Resultados de escaneo: Check/X) -->
				<div id="scanner-feedback-overlay" class="absolute inset-0 z-[60] hidden flex-col items-center justify-center bg-black/95 backdrop-blur-xl transition-all duration-300">
					<div id="scanner-icon-container" class="mb-6 transform scale-150 transition-transform">
						<!-- Icono inyectado por JS -->
					</div>
					<h2 id="scanner-status-text" class="text-4xl font-black uppercase italic text-white mb-2 tracking-wide text-center"></h2>
					<p id="scanner-user-name" class="text-2xl font-bold text-white uppercase tracking-widest mb-1"></p>
					<p id="scanner-msg" class="text-sm font-medium text-gray-400 italic"></p>
					
					<!-- Barra de progreso de reinicio -->
					<div class="mt-10 w-48 h-1 bg-white/10 rounded-full overflow-hidden">
						<div class="h-full bg-red-600 animate-[width_4s_linear]"></div>
					</div>
				</div>
			</div>
		</div>

				<div id="modal-mi-qr" class="fixed inset-0 z-[1500] bg-black/90 hidden flex-col items-center justify-center backdrop-blur-sm" onclick="closeMyQR()">
					<div class="glass-card p-10 rounded-[3rem] border-white/10 flex flex-col items-center text-center max-w-sm mx-4 transform transition-all scale-95 animate-in fade-in zoom-in duration-300" onclick="event.stopPropagation()">
						<h3 class="text-2xl font-black italic uppercase text-white mb-2">Mi Pase Vikingo</h3>
						<p class="text-[10px] text-red-600 font-bold uppercase mb-8 tracking-widest">Escanea en la entrada</p>
						
						<div class="p-4 bg-white rounded-3xl shadow-[0_0_50px_rgba(255,0,0,0.2)] mb-6">
							<img id="img-mi-qr" src="" alt="QR" class="w-48 h-48 object-contain">
						</div>
						
						<p id="qr-user-dni" class="text-xl font-black text-white tracking-widest mb-1">------</p>
						<p id="qr-user-name" class="text-xs text-gray-500 font-bold uppercase italic">------</p>
						
						<button onclick="closeMyQR()" class="mt-8 px-8 py-3 bg-white/5 hover:bg-white/10 rounded-xl text-[10px] font-black uppercase text-gray-400 hover:text-white transition-colors">Cerrar Pase</button>
					</div>
				</div>

    <script>
        // ==========================================
		// 1. CONFIGURACIÓN MAESTRA (PEGAR AL INICIO DE TU SCRIPT)
		// ==========================================

		// Detectamos automáticamente si estás en tu PC o en la Nube
		const IS_LOCALHOST = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';

		// Definimos la URL Maestra (Para compatibilidad con código antiguo y nuevo)
		const API_URL = IS_LOCALHOST ? "http://localhost:8000/api" : "/api";
		const API_BASE = API_URL; 

		// Seguridad y Estado Global
		const SECRET_KEY = "Vikingo_Security_Strong_Key_2025"; 
		
		console.log("⚔️ Vikingo System Online ⚔️");
		console.log("Modo:", IS_LOCALHOST ? "LOCAL (Desarrollo)" : "PRODUCCIÓN (Nube)");
		console.log("Conectando a:", API_URL);

		// ==========================================
		// 2. CORRECCIÓN DE SEGURIDAD (LOGIN)
		// ==========================================
		// Si tu login está en un formulario, esto evita que la página se refresque si hay error
		document.addEventListener('DOMContentLoaded', () => {
			const loginForm = document.getElementById('login-form'); // Asegúrate que tu form tenga este ID o el que uses
			if (loginForm) {
				loginForm.onsubmit = async (e) => {
					e.preventDefault(); // ¡ESTO ES CRUCIAL! Evita el refresco
					if (typeof login === 'function') {
						login(); // Llama a tu función de login original
					} else {
						console.error("No encuentro la función login()");
					}
				};
			}
		});

        let state = { 
			alumnos: [], 
			planes: [], 
			stock: [], 
			clases: [], 
			user: null, 
			profesores: [], 
			administrativos: [], 
			tiposPlanes: [],
			reservas: [], 
			cart: [], 
			currentPaymentMethod: '',
			cobrarTab: 'mercaderia',
			gruposMusculares: [], 
			ejerciciosLibreria: [],
			accesos: []
		};

        function showVikingToast(msg, error = false) {
            const toast = document.getElementById('viking-toast');
            toast.innerText = msg;
            toast.style.background = error ? '#660000' : '#FF0000';
            toast.style.color = error ? '#FF0000' : 'black';
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

		function applyPermissions() {
			if (!state.user) return;
			const rol = (state.user.rol_nombre || "").toLowerCase();
			
			// 1. CONTENEDORES (Los que tienen el título: Operación, Seguridad, etc.)
			// Estos DEBEN ser 'block' para que el título quede arriba de los botones.
			const contenedoresSeccion = {
				staff: document.getElementById('nav-section-staff'),
				operativa: document.getElementById('nav-section-operativa'),
				virtual: document.getElementById('nav-section-virtual')
			};

			// 2. ITEMS INDIVIDUALES (Los botones con icono + texto)
			// Estos DEBEN ser 'flex' para que el icono y el texto estén en la misma línea.
			const itemsMenu = {
				alumnos: document.getElementById('nav-alumnos'),
				planes: document.getElementById('nav-planes'),
				clases: document.getElementById('nav-clases'),
				facturacion: document.getElementById('nav-cobrar'),
				acceso: document.getElementById('nav-acceso-virtual')
			};

			// RESET: Contenedores a BLOCK
			Object.values(contenedoresSeccion).forEach(el => {
				if (el) el.style.setProperty('display', 'block', 'important');
			});

			// RESET: Items a FLEX
			Object.values(itemsMenu).forEach(el => {
				if (el) el.style.setProperty('display', 'flex', 'important');
			});

			// --- LÓGICA POR ROL ---

			// A. Alumnos y Profesores (Ocultan casi todo)
			if (rol === "alumno" || rol === "profesor") {
				Object.values(contenedoresSeccion).forEach(el => { if(el) el.style.setProperty('display', 'none', 'important'); });
				Object.values(itemsMenu).forEach(el => { if(el) el.style.setProperty('display', 'none', 'important'); });
			}

			// B. Administrativo (Oculta solo Staff y Control Staff en dashboard)
			else if (rol === "administracion" || rol === "administrativo") {
				if (contenedoresSeccion.staff) contenedoresSeccion.staff.style.setProperty('display', 'none', 'important');
				
				// Ocultar el panel de "Control Staff" del Dashboard
				const staffDashboardPanel = document.getElementById('dash-staff-access');
				if (staffDashboardPanel) {
					const card = staffDashboardPanel.closest('.glass-card');
					if (card) card.style.setProperty('display', 'none', 'important');
				}
			}

			if (window.lucide) lucide.createIcons();
		}

		async function renderStudentDashboard() {
			const u = state.user; if (!u) return;
			
			// 1. Cargar Datos básicos (Tu código original intacto)
			document.getElementById('al-dash-name').innerText = u.nombre_completo;
			document.getElementById('al-dash-dni').innerText = u.dni;
			document.getElementById('al-dash-plan').innerText = u.plan?.nombre || 'SIN PLAN';
			document.getElementById('al-dash-vencimiento').innerText = u.fecha_vencimiento || '-';
			document.getElementById('al-dash-renovacion').innerText = u.fecha_ultima_renovacion || '-';
			document.getElementById('al-dash-email').innerText = u.email || '-';
			
			const initials = u.nombre_completo ? u.nombre_completo.split(' ').filter(n=>n).map(n=>n[0]).join('').toUpperCase() : "??";
			document.getElementById('al-dash-initials').innerText = initials;
			
			// Mantenemos Peso, Altura e IMC (Como pediste)
			document.getElementById('al-dash-peso').innerText = u.peso || '0';
			document.getElementById('al-dash-altura').innerText = u.altura || '0';
			document.getElementById('al-dash-imc').innerText = u.imc || '0';

			// Lógica de vigencia del certificado (365 días)
			if (u.fecha_certificado) {
				const fCert = new Date(u.fecha_certificado);
				const hoy = new Date();
				const diff = (hoy - fCert) / (1000 * 60 * 60 * 24);
				const vencido = diff > 365;
				
				// Podrías mostrar un aviso en el dashboard
				const statusCert = document.getElementById('al-dash-plan'); // O cualquier otro label
				if (vencido) statusCert.innerHTML += ` <span class="text-[8px] bg-red-600 text-black px-1 rounded ml-2">CERTIF. VENCIDO</span>`;
			}

			// --- NUEVA LÓGICA: CRÉDITOS MENSUALES ---
			const limite = u.plan?.clases_mensuales || 0;
			const esFull = limite > 100; // Si es más de 100, asumimos ilimitado (Plan Full)

			// Recargamos reservas para asegurar el conteo exacto al momento
			const allReservas = await apiFetch('/reservas');
			if (!allReservas.error && Array.isArray(allReservas)) {
				state.reservas = allReservas; 
			}
			
			// Filtramos reservas de ESTE ALUMNO en ESTE MES
			const hoy = new Date();
			const reservasMes = state.reservas.filter(r => {
				// Aseguramos compatibilidad de fechas
				const fecha = new Date(r.fecha_clase || r.fecha_reserva || r.fecha); 
				return (r.alumno_dni === u.dni || r.usuario_id === u.id) && 
					   fecha.getMonth() === hoy.getMonth() &&
					   fecha.getFullYear() === hoy.getFullYear();
			});

			const usadas = reservasMes.length;
			const restantes = esFull ? "∞" : Math.max(0, limite - usadas);

			// Actualizamos los elementos de Créditos (Solo si agregaste el HTML nuevo, si no, no rompe nada)
			const elUsadas = document.getElementById('al-dash-usadas');
			if(elUsadas) elUsadas.innerText = usadas;
			
			const elCreditos = document.getElementById('al-dash-creditos');
			if(elCreditos) {
				elCreditos.innerHTML = esFull ? 
				`<span class="text-2xl">∞</span>` : 
				`<span class="${restantes <= 2 ? 'text-red-500' : 'text-white'}">${restantes}</span>`;
			}
			// ----------------------------------------

			// Resumen de Rutina (Tu código original)
			let res = await apiFetch(`/rutinas/usuario/${u.id}`);
			let rutina = null;
			if (Array.isArray(res) && res.length > 0) rutina = res[0]; 
			else if (res && !res.error && res.id) rutina = res;

			const summaryContainer = document.getElementById('al-dash-rutina-summary'); 
			const contentContainer = document.getElementById('al-dash-rutina-content');

			if (summaryContainer && contentContainer) {
				if (rutina) {
					summaryContainer.classList.remove('hidden');
					contentContainer.innerHTML = `
						<p class="text-[12px] font-black italic text-white mb-1">${rutina.objetivo || 'Rutina Personalizada'}</p>
						<p class="text-[10px] text-gray-500 uppercase font-bold">${(rutina.dias||[]).length} Días de Entrenamiento</p>
					`;
				} else {
					summaryContainer.classList.add('hidden');
				}
			}
			
			// Próximas Clases (Tu código original, mejorado el filtro)
			const upcoming = document.getElementById('al-dash-upcoming');
			const misR = state.reservas.filter(r => r.alumno_dni === u.dni || r.usuario_id === u.id);
			
			// Ordenar por fecha para mostrar las más cercanas primero
			misR.sort((a, b) => new Date(a.fecha_clase) - new Date(b.fecha_clase));

			if (upcoming) {
				upcoming.innerHTML = misR.length ? misR.map(r => `
					<div class="flex items-center justify-between p-3 bg-white/5 rounded-xl border border-red-600/10 mb-2">
						<div>
							<p class="text-[10px] font-black uppercase italic text-white">${r.clase_nombre}</p>
							<p class="text-[9px] text-gray-500 font-bold">${r.dia_nombre || 'Fecha'} - ${r.horario || ''}hs</p>
						</div>
						<button onclick="cancelBooking(${r.id})" class="text-[9px] text-red-500 hover:text-white">X</button>
					</div>
				`).join('') : '<p class="text-gray-500 italic text-[11px]">Sin reservas próximas.</p>';
			}
		}
		
		// 1. Dibuja una fila de horario (Día + Hora + Coach)
			function addNewScheduleSlot(data = { dia: 1, horario: 7, coach: "" }) {
				const container = document.getElementById('cl-schedule-slots');
				if (container.querySelector('p.italic')) container.innerHTML = "";

				const row = document.createElement('div');
				row.className = "schedule-slot-row flex flex-col gap-2 bg-white/5 p-3 rounded-2xl border border-white/5 mb-2";
				
				const diasMap = {1: 'Lunes', 2: 'Martes', 3: 'Miércoles', 4: 'Jueves', 5: 'Viernes', 6: 'Sábado'};
				
				// Opciones de Días
				let diasOptions = "";
				for(let d=1; d<=6; d++) diasOptions += `<option value="${d}" ${data.dia == d ? 'selected' : ''}>${diasMap[d]}</option>`;

				// Opciones de Horas
				let horasOptions = "";
				for(let i=7; i<=21.5; i+=0.5) {
					const label = i % 1 === 0 ? `${i}:00` : `${Math.floor(i)}:30`;
					horasOptions += `<option value="${i}" ${data.horario == i ? 'selected' : ''}>${label} HS</option>`;
				}

				row.innerHTML = `
					<div class="flex items-center justify-between gap-2">
						<select class="viking-input py-1 h-9 text-[10px] flex-1 slot-dia">${diasOptions}</select>
						<select class="viking-input py-1 h-9 text-[10px] flex-1 slot-hora">${horasOptions}</select>
						<button type="button" onclick="this.closest('.schedule-slot-row').remove()" class="text-red-500 p-1">
							<i data-lucide="x" class="w-4 h-4"></i>
						</button>
					</div>
				`;
				container.appendChild(row);
				if(window.lucide) lucide.createIcons();
			}

			// 2. Reemplaza tu función de guardado de clase
			async function saveClaseVikinga(e) {
				if(e) e.preventDefault();
				const id = document.getElementById('cl-id').value;
				const slotRows = document.querySelectorAll('.schedule-slot-row');
				
				const horarios_detalle = [];
				slotRows.forEach(row => {
					horarios_detalle.push({
						dia: parseInt(row.querySelector('.slot-dia').value),
						horario: parseFloat(row.querySelector('.slot-hora').value)
					});
				});

				const payload = {
					nombre: document.getElementById('cl-nombre').value,
					coach: document.getElementById('cl-coach-select').value,
					color: document.getElementById('cl-color').value,
					capacidad_max: parseInt(document.getElementById('cl-cupo').value),
					horarios_detalle: horarios_detalle
				};

				const method = id ? 'PUT' : 'POST';
				const res = await apiFetch(id ? `/clases/${id}` : '/clases', method, payload);
				if(!res.error) {
					closeModal('modal-clase');
					loadClases();
					showVikingToast("Operación exitosa");
				}
			}

        async function fetchReservas() {
			const data = await apiFetch('/reservas');
			if (!data.error) {
				// Guardamos las reservas en el estado global para que el calendario las vea
				state.reservas = Array.isArray(data) ? data : [];
				return state.reservas;
			} else {
				console.error("Error cargando reservas:", data.error);
				return [];
			}
		}

        async function bookClass(claseId) {
            if (state.user.rol_nombre !== "Alumno") return;
            const clase = state.clases.find(c => c.id === claseId);
            if (!clase) return;

            const cupoMax = clase.capacidad_max || 40; 
            const cupoActual = state.reservas.filter(r => r.clase_id === claseId).length;

            if (cupoActual >= cupoMax) {
                showVikingToast("¡Clase Llena! No hay más cupos.", true);
                return;
            }

            const yaReservado = state.reservas.find(r => r.clase_id === claseId && r.alumno_dni === state.user.dni);
            if (yaReservado) {
                showVikingToast("Ya estás anotado en esta clase.", true);
                return;
            }

            const data = { usuario_id: parseInt(state.user.id), clase_id: parseInt(clase.id) };
            const res = await apiFetch('/reservas', 'POST', data);
            if (!res.error) {
                showVikingToast("¡Reserva confirmada!");
                await fetchReservas();
                renderCalendar();
                renderStudentDashboard();
            } else {
                showVikingToast("Error al reservar: " + res.error, true);
            }
        }

        async function cancelBooking(id) {
            const res = await apiFetch(`/reservas/${id}`, 'DELETE');
            if (!res.error) {
                showVikingToast("Reserva Cancelada.");
                await fetchReservas();
                renderCalendar();
                renderStudentDashboard();
            }
        }

        function openInscriptos(claseId) {
            const inscriptos = state.reservas.filter(r => r.clase_id === claseId);
            const listaDiv = document.getElementById('inscriptos-lista');
            listaDiv.innerHTML = inscriptos.length ? inscriptos.map(r => {
                return `
                <div class="flex items-center justify-between p-4 bg-white/5 rounded-2xl border border-white/5">
                    <div>
                        <p class="text-[12px] font-black uppercase italic text-left">${r.alumno_dni}</p>
                        <p class="text-[9px] text-gray-500 font-bold">Reserva #${r.id}</p>
                    </div>
                    <button onclick="deleteBookingAdmin(${r.id}, ${claseId})" class="text-red-600 hover:text-white"><i data-lucide="user-minus" class="w-4 h-4"></i></button>
                </div>`;
            }).join('') : '<p class="text-center text-gray-500 italic py-10">No hay alumnos anotados aún.</p>';
            lucide.createIcons();
            openModal('modal-inscriptos');
        }

        async function deleteBookingAdmin(reservaId, claseId) {
            if(!confirm("¿Quitar alumno de la clase?")) return;
            const res = await apiFetch(`/reservas/${reservaId}`, 'DELETE');
            if(!res.error) {
                await fetchReservas();
                openInscriptos(claseId);
                renderCalendar();
                showVikingToast("Alumno removido del cupo.");
            }
        }

		/**
		 * RENDERIZADO DEL CALENDARIO VIKINGO (VERSIÓN FINAL)
		 * Incluye: Drag & Drop funcional, Contador de Cupos Real y Estética de 1 Hora.
		 */
		async function renderCalendar() {
			const cal = document.getElementById('calendar-grid'); 
			if (!cal) return;

			// Configuración del Grid
			cal.className = "calendar-container h-[700px] overflow-y-auto custom-scrollbar grid grid-cols-[50px_repeat(6,1fr)] auto-rows-max gap-[1px] bg-white/5 p-1 rounded-3xl";

			if (!state.clases || state.clases.length === 0) {
				state.clases = await apiFetch('/clases');
			}

			// RESTRICCIÓN: Solo Admin y Supervisor tienen permisos de edición (Drag & Drop)
			const isAdmin = (state.user?.rol_nombre === "Administrador" || state.user?.rol_nombre === "Supervisor");
			const esAlumno = (state.user?.rol_nombre === "Alumno");

			// --- 1. CÁLCULO DE FECHAS ---
			const hoy = new Date();
			const diaSemanaActual = hoy.getDay(); 
			const diffParaLunes = diaSemanaActual === 0 ? 6 : diaSemanaActual - 1;
			const fechaLunes = new Date(hoy);
			fechaLunes.setDate(hoy.getDate() - diffParaLunes);

			// --- 2. CABECERAS ---
			const diasNombres = ["LUNES", "MARTES", "MIÉRCOLES", "JUEVES", "VIERNES", "SÁBADO"];
			
			let headersHTML = `
				<div class="cal-header sticky top-0 z-20 bg-[#1a1a1a] flex items-center justify-center font-black italic text-[9px] text-white/30 p-2 border-b border-white/10 rounded-tl-2xl">
					HORA
				</div>
			`;

			diasNombres.forEach((nombreDia, index) => {
				const fecha = new Date(fechaLunes);
				fecha.setDate(fechaLunes.getDate() + index);
				const numeroDia = fecha.getDate();
				const mesNombre = fecha.toLocaleString('es-ES', { month: 'short' }).toUpperCase().replace('.', '');
				const esHoy = fecha.getDate() === hoy.getDate() && fecha.getMonth() === hoy.getMonth();

				const bgClass = esHoy ? "bg-red-600 text-black shadow-lg shadow-red-600/20" : "bg-[#1a1a1a] text-gray-400";
				const textClass = esHoy ? "text-black" : "text-white";
				const subTextClass = esHoy ? "text-black/70" : "text-gray-500";
				const roundedClass = index === 5 ? "rounded-tr-2xl" : ""; 

				headersHTML += `
					<div class="cal-header sticky top-0 z-20 ${bgClass} ${roundedClass} p-2 flex flex-col items-center justify-center border-b border-white/10 transition-colors">
						<span class="text-[8px] font-black uppercase tracking-widest leading-none mb-0.5 ${subTextClass}">${mesNombre}</span>
						<h4 class="text-xl font-black italic leading-none mb-0.5 ${textClass}">${numeroDia}</h4>
						<span class="text-[9px] font-bold uppercase ${subTextClass}">${nombreDia}</span>
					</div>
				`;
			});

			cal.innerHTML = headersHTML;

			// --- 3. GRILLA ---
			for(let h=7; h<=21.5; h+=0.5) {
				const label = h % 1 === 0 ? `${h}:00` : `${Math.floor(h)}:30`;
				const hourLabel = document.createElement('div');
				hourLabel.className = "cal-cell flex items-center justify-center font-black text-[9px] text-white/40 bg-white/5 border-r border-white/20 min-h-[50px]";
				hourLabel.innerText = label;
				cal.appendChild(hourLabel);
				
				for(let d=1; d<=6; d++) {
					const isSat = d === 6; 
					const isClosed = isSat && (h < 10 || h > 13);
					const cellId = `cell-${d}-${h.toString().replace('.','_')}`;
					
					const cell = document.createElement('div');
					cell.id = cellId;
					cell.className = `cal-cell relative min-h-[50px] border-b border-r border-white/5 hover:bg-white/5 transition-colors ${isClosed ? 'bg-stripes-gray opacity-30 pointer-events-none' : ''}`;
					
					if (isAdmin && !isClosed) {
						cell.ondragover = (e) => {
							e.preventDefault(); 
							e.dataTransfer.dropEffect = "move";
							cell.classList.add('bg-red-600/10');
						};
						cell.ondragleave = () => cell.classList.remove('bg-red-600/10');
						cell.ondrop = async (e) => {
							e.preventDefault();
							cell.classList.remove('bg-red-600/10');
							const claseId = e.dataTransfer.getData("claseId");
							const oldDia = e.dataTransfer.getData("oldDia");
							const oldHorario = e.dataTransfer.getData("oldHorario");
							if (!claseId) return;
							const parts = cell.id.split('-');
							const newDia = parseInt(parts[1]);
							const newHorario = parseFloat(parts[2].replace('_', '.'));
							if (oldDia == newDia && oldHorario == newHorario) return;

							const res = await apiFetch(`/clases/${claseId}/move`, 'PUT', {
								old_dia: parseInt(oldDia),
								old_horario: parseFloat(oldHorario),
								new_dia: newDia,
								new_horario: newHorario
							});
							if (!res.error) {
								showVikingToast("¡Turno Reubicado!");
								state.clases = await apiFetch('/clases');
								renderCalendar(); 
							} else {
								showVikingToast("Error al mover: " + res.error, true);
							}
						};
					}
					cal.appendChild(cell);
				}
			}

			// --- 4. RENDERIZADO DE CLASES CON CONTRASTE ---
			if(state.clases && Array.isArray(state.clases)){
				state.clases.forEach(c => {
					const horarios = Array.isArray(c.horarios_detalle) ? c.horarios_detalle : [];
					
					const getTextColorClass = (hexColor) => {
						if (!hexColor) return { text: 'text-white', sub: 'text-white/70', bg: 'bg-white/20' };
						const r = parseInt(hexColor.substr(1, 2), 16);
						const g = parseInt(hexColor.substr(3, 2), 16);
						const b = parseInt(hexColor.substr(5, 2), 16);
						const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
						return (yiq >= 128) 
							? { text: 'text-black', sub: 'text-black/60', bg: 'bg-black/10' } 
							: { text: 'text-white', sub: 'text-white/80', bg: 'bg-white/20' };
					};

					const colores = getTextColorClass(c.color || '#FF0000');

					horarios.forEach(slot => {
						const hKey = slot.horario.toString().replace('.', '_');
						const cell = document.getElementById(`cell-${slot.dia}-${hKey}`);
						
						if (cell) {
							const reservasArray = Array.isArray(state.reservas) ? state.reservas : [];
							const cupoMax = c.capacidad_max || 40;
							const cupoActual = reservasArray.filter(r => 
								String(r.clase_id) === String(c.id) && 
								Number(r.dia_semana) === Number(slot.dia) && 
								Number(r.horario) === Number(slot.horario)
							).length;
							const estaLleno = cupoActual >= cupoMax;

							const badge = document.createElement('div');
							badge.className = "absolute inset-1 rounded-xl shadow-lg transition-all hover:scale-[1.02] active:scale-95 cursor-pointer flex flex-col items-center justify-center p-1 group z-10 class-badge border border-black/5"; 
							badge.style.backgroundColor = c.color || '#FF0000';
							
							if (isAdmin) {
								badge.draggable = true; 
								badge.ondragstart = (e) => {
									e.dataTransfer.setData("claseId", c.id);
									e.dataTransfer.setData("oldDia", slot.dia);
									e.dataTransfer.setData("oldHorario", slot.horario);
									badge.classList.add('opacity-40');
								};
								badge.ondragend = () => badge.classList.remove('opacity-40');
							}

							badge.innerHTML = `
								<div class="flex flex-col items-center justify-center h-full w-full px-1">
									<span class="text-[10px] leading-tight mb-0.5 font-black uppercase italic ${colores.text} text-center truncate w-full drop-shadow-sm">
										${c.nombre}
									</span>
									<span class="text-[8px] font-extrabold ${colores.sub} mb-0.5 lowercase italic leading-none truncate w-full text-center">
										${slot.coach || 'staff'}
									</span>
									<div class="${colores.bg} px-1.5 py-px rounded-full text-[8px] font-black leading-none ${estaLleno ? (colores.text === 'text-white' ? 'text-red-300 animate-pulse' : 'text-red-700 animate-pulse') : colores.text}">
										${cupoActual}/${cupoMax}
									</div>
								</div>
							`;
							
							badge.onclick = (e) => {
								e.stopPropagation();
								if (esAlumno) {
									if (estaLleno) showVikingToast("Cupo lleno para este turno", true);
									else if(typeof confirmarReservaVikinga === 'function') confirmarReservaVikinga(c, slot.dia, slot.horario);
								} else {
									if (typeof openInscriptos === 'function') openInscriptos(c.id, slot.dia, slot.horario);
								}
							};

							cell.appendChild(badge);
						}
					});
				});
			}

			if (window.lucide) lucide.createIcons();
		}
		
		/**
		 * FUNCIÓN DE RESERVA CORREGIDA
		 * Evita el error de "Vanhala" manejando fallos internos sin crashear.
		 */
		async function confirmarReservaVikinga(clase, dia, horario) {
			const diasMap = {1: 'Lunes', 2: 'Martes', 3: 'Miércoles', 4: 'Jueves', 5: 'Viernes', 6: 'Sábado'};
			const horaLabel = horario % 1 === 0 ? `${horario}:00` : `${Math.floor(horario)}:30`;
			
			showVikingToast(`Procesando reserva...`);

			const payload = {
				usuario_id: state.user.id,
				clase_id: clase.id,
				dia_semana: dia,
				horario: horario
			};

			try {
				const res = await apiFetch('/reservas', 'POST', payload);
				
				if (!res.error) {
					showVikingToast(`¡Reserva confirmada! ${diasMap[dia]} ${horaLabel}hs`);
					
					// INTENTO DE ACTUALIZACIÓN PROTEGIDO:
					// Si una función falla, no queremos que salte al 'catch' de conexión.
					try {
						// 1. Refrescar reservas (Intentamos con el nombre que tengas)
						if (typeof fetchReservas === 'function') {
							await fetchReservas(); 
						} else if (typeof loadReservas === 'function') {
							await loadReservas();
						} else {
							// Si no hay función, pedimos los datos manualmente para actualizar el estado
							const manualData = await apiFetch('/reservas');
							if (!manualData.error) state.reservas = manualData;
						}

						// 2. Redibujar calendario
						renderCalendar(); 
						
						// 3. Redibujar dashboard
						if (typeof renderStudentDashboard === 'function') {
							renderStudentDashboard();
						}
					} catch (innerError) {
						console.warn("Reserva exitosa pero fallo el refresco visual:", innerError);
					}

				} else {
					// Error del servidor (ej: sin créditos)
					let errorMsg = res.error || "No se pudo procesar";
					if (typeof res.error === 'string' && res.error.startsWith('{')) {
						try { errorMsg = JSON.parse(res.error).detail || errorMsg; } catch(e){}
					}
					showVikingToast(errorMsg, true);
				}
			} catch (err) {
				console.error("Error crítico en Reserva:", err);
				showVikingToast("Error de sincronización con el Valhalla", true);
			}
		}

		/**
		 * PROCESO DE RESERVA
		 * Separada de renderCalendar para evitar errores de scope y cierres.
		 */
		async function confirmarReservaVikinga(clase, dia, horario) {
			const diasMap = {1: 'Lunes', 2: 'Martes', 3: 'Miércoles', 4: 'Jueves', 5: 'Viernes', 6: 'Sábado'};
			const horaLabel = horario % 1 === 0 ? `${horario}:00` : `${Math.floor(horario)}:30`;
			
			showVikingToast(`Procesando reserva para ${clase.nombre}...`);

			const payload = {
				usuario_id: state.user.id,
				clase_id: clase.id,
				dia_semana: dia,
				horario: horario
			};

			try {
				const res = await apiFetch('/reservas', 'POST', payload);
				
				if (!res.error) {
					showVikingToast(`¡Victoria! Reserva confirmada: ${diasMap[dia]} ${horaLabel}hs`);
					
					// Sincronización completa de datos
					await fetchReservas(); // El nombre correcto según tu código
					
					// Actualización visual inmediata
					renderCalendar(); 
					if (typeof renderStudentDashboard === 'function') {
						renderStudentDashboard();
					}
				} else {
					let errorMsg = res.error || "No se pudo procesar la reserva";
					// Si el error viene como JSON string, lo parseamos
					if (typeof res.error === 'string' && res.error.startsWith('{')) {
						try { errorMsg = JSON.parse(res.error).detail || errorMsg; } catch(e){}
					}
					showVikingToast(errorMsg, true);
				}
			} catch (err) {
				console.error("Error en Reserva:", err);
				showVikingToast("Error de sincronización con el Valhalla", true);
			}
		}

        function setCobrarTab(tab) {
            state.cobrarTab = tab;
            document.querySelectorAll('.cobrar-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
            renderCobrar();
        }
		
		

        function renderCobrar() {
            const displayArea = document.getElementById('cobrar-display-area');
            const searchVal = document.getElementById('cobrar-search').value.toLowerCase();
            if (state.cobrarTab === 'mercaderia') {
                const filtered = state.stock.filter(s => s.nombre_producto.toLowerCase().includes(searchVal));
                displayArea.innerHTML = `<div class="grid grid-cols-2 md:grid-cols-4 gap-4 overflow-y-auto max-h-[600px] pr-2 custom-scrollbar" id="cobrar-catalogo"></div>`;
                const catalog = document.getElementById('cobrar-catalogo');
                catalog.innerHTML = filtered.map(s => `
                    <div class="glass-card p-4 rounded-3xl relative group cursor-pointer hover:border-red-600/50" onclick="addToCart(${s.id}, 'stock')">
                        <div class="w-full h-20 viking-bg-red/10 rounded-2xl mb-3 flex items-center justify-center"><i data-lucide="package" class="w-6 h-6 opacity-20 text-white"></i></div>
                        <h4 class="text-[10px] font-black uppercase italic mb-1 truncate">${s.nombre_producto}</h4>
                        <div class="flex items-center justify-between"><p class="text-[12px] font-black italic">$ ${s.precio_venta.toLocaleString()}</p><span class="text-[9px] font-bold ${s.stock_actual < 5 ? 'text-red-500' : 'text-gray-500'}">S: ${s.stock_actual}</span></div>
                    </div>`).join('');
            } else {
				const hoy = new Date().toISOString().split('T')[0];
				const filteredAl = state.alumnos.filter(a => 
					a.nombre_completo.toLowerCase().includes(searchVal) || a.dni.includes(searchVal)
				);

				displayArea.innerHTML = `
					<div class="glass-card p-8 rounded-[2.5rem] h-[800px] flex flex-col border-white/5">
						<h4 class="text-[11px] font-black uppercase italic text-red-600 mb-6 tracking-widest border-b border-white/5 pb-4">
							Guerreros para Renovación
						</h4>
						<div class="overflow-y-auto custom-scrollbar flex-1 space-y-3 pr-2">
							${filteredAl.map(a => {
								const isActive = a.fecha_vencimiento && a.fecha_vencimiento >= hoy;
								const statusColor = isActive ? 'text-green-500' : 'text-red-500';
								const statusBg = isActive ? 'bg-green-500/10' : 'bg-red-500/10';
								const statusText = isActive ? 'Al día' : 'Vencido';

								return `
								<div class="flex flex-col gap-3 p-5 bg-white/2 rounded-[2rem] border border-white/5 hover:border-red-600/30 transition-all text-left group">
									<div class="flex justify-between items-center">
										<div class="flex items-center gap-3">
											<div class="w-10 h-10 rounded-xl viking-bg-red flex items-center justify-center font-black text-black text-xs italic shadow-lg">
												${a.nombre_completo[0].toUpperCase()}
											</div>
											<div>
												<p class="text-[13px] font-black italic uppercase leading-tight text-white group-hover:text-red-500 transition-colors">${a.nombre_completo}</p>
												<p class="text-[9px] text-gray-500 font-bold uppercase tracking-widest mt-1">DNI: ${a.dni}</p>
											</div>
										</div>
										<span class="text-[8px] px-3 py-1 rounded-full ${statusBg} ${statusColor} font-black uppercase italic border border-white/5">
											${statusText}
										</span>
									</div>

									<div class="flex gap-2 items-center mt-2 pt-3 border-t border-white/5">
										<div class="flex-1">
											<p class="text-[8px] text-gray-600 font-black uppercase italic mb-1 px-2">Seleccionar Plan</p>
											<select id="plan-select-${a.id}" class="viking-input !py-2 !text-[10px] h-10 bg-black/60 border-white/10">
												${state.planes.map(p => `
													<option value="${p.id}" ${p.id === a.plan_id ? 'selected' : ''}>
														${p.nombre} — $${p.precio.toLocaleString()}
													</option>
												`).join('')}
											</select>
										</div>
										<button onclick="preparePlanCharge(${a.id})" class="mt-4 px-6 h-10 rounded-xl text-[10px] font-black italic bg-green-600/20 text-green-500 border border-green-500/20 hover:bg-green-600 hover:text-black transition-all flex items-center gap-2 shadow-lg">
											<i data-lucide="shopping-cart" class="w-3 h-3"></i> COBRAR
										</button>
									</div>
								</div>`;
							}).join('')}
						</div>
					</div>`;
			}
            lucide.createIcons();
            updateCartUI();
        }

        document.getElementById('cobrar-search').oninput = renderCobrar;

		/**
		/**
		 * =========================================================
		 * 2. FUNCIONES DE CAJA Y CARRITO (LÓGICA VISUAL)
		 * =========================================================
		 */

		/**
		 * FUNCIÓN 1: AGREGAR MERCADERÍA
		 */
		function addToCart(productId) {
			// Protección: Aseguramos que el estado exista
			if (!state || !state.stock) return;

			const item = state.stock.find(s => s.id == productId);
			
			if (!item) {
				console.error("Producto no encontrado ID:", productId);
				return;
			}

			if (item.stock_actual <= 0) {
				return showVikingToast(`¡Sin stock de ${item.nombre_producto}!`, true);
			}

			// Verificar si ya existe en el carrito
			const existing = state.cart.find(c => c.producto_id == productId && c.tipo === 'Mercaderia');

			if (existing) {
				if (existing.cantidad < item.stock_actual) {
					existing.cantidad++;
					showVikingToast(`+1 ${item.nombre_producto}`);
				} else {
					return showVikingToast("Stock insuficiente para agregar más", true);
				}
			} else {
				// Estructura estandarizada para el carrito
				state.cart.push({
					tipo: 'Mercaderia',
					producto_id: productId,
					alumno_id: null,
					nombre: item.nombre_producto,
					precio: item.precio_venta, 
					cantidad: 1,
					url_imagen: item.url_imagen 
				});
				showVikingToast(`${item.nombre_producto} añadido`);
			}

			if (typeof updateCartUI === 'function') updateCartUI();
		}

		/**
		 * FUNCIÓN 2: ACTUALIZAR UI (VISUAL)
		 */
		function updateCartUI() {
			const list = document.getElementById('cobrar-lista-carrito');
			if (!list) return; 
			
			if (state.cart.length === 0) {
				list.innerHTML = '<p class="text-center text-gray-500 text-[11px] italic py-10">Sin ítems seleccionados</p>';
				updateTotales(0);
				return;
			}

			list.innerHTML = state.cart.map((c, idx) => `
				<div class="flex items-center justify-between bg-white/5 p-3 rounded-xl border border-white/5">
					<div class="overflow-hidden text-left">
						<p class="text-[11px] font-black uppercase italic truncate text-white">${c.nombre}</p>
						<div class="flex gap-2">
							<p class="text-[10px] text-gray-500 font-bold">VALOR: $ ${c.precio.toLocaleString()}</p>
							<p class="text-[10px] text-red-500 font-bold">CANT: ${c.cantidad}</p>
						</div>
					</div>
					<button onclick="removeFromCart(${idx})" class="text-red-600 hover:text-white">
						<i data-lucide="trash-2" class="w-3 h-3"></i>
					</button>
				</div>
			`).join('');

			const total = state.cart.reduce((acc, c) => acc + (c.cantidad * c.precio), 0);
			updateTotales(total);
			
			if (window.lucide) lucide.createIcons();
		}

		function updateTotales(monto) {
			const elSub = document.getElementById('cobrar-subtotal');
			const elTot = document.getElementById('cobrar-total');
			if (elSub) elSub.innerText = `$ ${monto.toLocaleString()}`;
			if (elTot) elTot.innerText = `$ ${monto.toLocaleString()}`;
		}

		function removeFromCart(i) { 
			state.cart.splice(i, 1); 
			updateCartUI(); 
		}

		function setPaymentMethod(metodo) {
			const select = document.getElementById('metodo-pago');
			if (select) select.value = metodo;

			document.querySelectorAll('.btn-pago').forEach(btn => {
				const btnMethod = btn.getAttribute('data-method');
				const isActive = btnMethod === metodo;
				btn.className = isActive 
					? "btn-pago w-full py-3 rounded-xl text-[10px] font-black uppercase italic transition-all bg-red-600 text-black shadow-lg shadow-red-600/20 transform scale-105"
					: "btn-pago w-full py-3 rounded-xl text-[10px] font-black uppercase italic transition-all bg-white/5 text-gray-400 hover:text-white border border-transparent hover:border-red-600/30";
			});
		}

		/**
		 * =========================================================
		 * 3. NUEVA LÓGICA DE COBRO (MODULARIZADA Y CONECTADA)
		 * =========================================================
		 */

		/**
		 * CORE: FUNCIÓN PRINCIPAL DE PAGO
		 * Usa API_BASE definida arriba para evitar errores de conexión.
		 */
		async function procesarPagoVikingo(payload, actualizarUI = true) {
			if(actualizarUI) showVikingToast("Sincronizando con la Tesorería...");

			try {
				const response = await fetch(`${API_BASE}/cobros/procesar`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify(payload)
				});

				const res = await response.json();

				if (response.ok) {
					if(actualizarUI) showVikingToast("¡Victoria! Cobro registrado y Stock actualizado");
					
					if (actualizarUI) {
						// Recargamos datos de forma segura
						const promises = [];
						if (typeof loadStock === 'function') promises.push(loadStock());
						if (typeof loadAlumnos === 'function') promises.push(loadAlumnos());
						if (typeof loadCaja === 'function') promises.push(loadCaja());
						
						await Promise.all(promises);

						// Limpiar si es mercancía
						if (payload.tipo === 'Mercaderia') {
							state.cart = [];
							updateCartUI();
						}
						
						// Refrescar vista
						if (typeof renderCobrar === 'function') renderCobrar();
					}
					return true; 
				} else {
					showVikingToast("Error: " + (res.detail || "Error desconocido"), true);
					return false;
				}
			} catch (err) {
				console.error(err);
				showVikingToast("Error de conexión con el Valhalla", true);
				return false;
			}
		}

		/**
		 * PREPARAR CARGA DE PLAN (Al Carrito)
		 * En lugar de cobrar directo, lo mete al carrito para elegir el pago ahí.
		 */
		async function preparePlanCharge(alumnoId) {
			const alumno = state.alumnos.find(a => a.id === alumnoId);
			if (!alumno) return;

			const planSelect = document.getElementById(`plan-select-${alumnoId}`);
			const planId = parseInt(planSelect.value);
			const plan = state.planes.find(p => p.id === planId);

			if (!plan) return showVikingToast("Selecciona un plan válido", true);

			// Verificamos si ya hay un plan para este alumno en el carrito
			const existe = state.cart.find(c => c.alumno_id === alumnoId && c.tipo === 'Plan');
			if(existe) return showVikingToast("Este alumno ya tiene un plan en el carrito", true);

			// Lo sumamos al estado del carrito
			state.cart.push({
				tipo: 'Plan',
				producto_id: planId, // ID del Plan
				alumno_id: alumnoId,  // ID del Alumno (Crucial para el vencimiento)
				nombre: `${plan.nombre} (${alumno.nombre_completo})`,
				precio: plan.precio,
				cantidad: 1
			});

			showVikingToast("Plan sumado al carrito");
			updateCartUI(); // Actualizamos la lista visual
		}

		/**
		 * FINALIZAR COBRO DEL CARRITO (Mercadería + Planes)
		 * Procesa cada ítem y actualiza stock o vencimientos según corresponda.
		 */
		async function finalizarVentaMercaderia() {
			if (state.cart.length === 0) return showVikingToast("El carrito está vacío", true);

			const total = state.cart.reduce((acc, item) => acc + (item.precio * item.cantidad), 0);
			const metodoEl = document.getElementById('metodo-pago');
			const metodoPago = metodoEl ? metodoEl.value : "Efectivo";

			if (confirm(`¿Finalizar cobro total de $${total.toLocaleString()} con ${metodoPago}?`)) {
				
				showVikingToast("Procesando en la Tesorería...");
				let errores = 0;

				// Recorremos el carrito (pueden ser 3 aguas y 1 Plan de Musculación)
				for (const item of state.cart) {
					const exito = await procesarPagoVikingo({
						tipo: item.tipo, // 'Mercaderia' o 'Plan'
						monto: item.precio * item.cantidad,
						descripcion: item.tipo === 'Plan' ? item.nombre : `Venta: ${item.nombre} (x${item.cantidad})`,
						metodo_pago: metodoPago,
						producto_id: item.producto_id, // ID del producto o ID del Plan
						alumno_id: item.alumno_id,     // Si es Plan, esto viaja al servidor
						cantidad: item.cantidad
					}, false); // false para que no tire mil toasts seguidos

					if (!exito) errores++;
				}

				if (errores === 0) {
					showVikingToast("¡Cobro exitoso! Vencimientos actualizados.");
					state.cart = []; 
					updateCartUI();
					
					// Recargamos todo para ver los cambios reflejados
					await Promise.all([loadStock(), loadCaja(), fetchAlumnos()]);
					renderCobrar();
				} else {
					showVikingToast(`Hubo ${errores} errores en el proceso.`, true);
				}
			}
		}

		// --- REEMPLAZA TU FUNCIÓN openFichaTecnica POR ESTA VERSIÓN CON DISEÑO DE FILAS ---
		async function openFichaTecnica(alumnoId) {
			const rutinaContainer = document.getElementById('ficha-rutina-container');

			// Estado de carga visual
			rutinaContainer.innerHTML = `
				<div class="col-span-2 py-10 flex flex-col items-center justify-center space-y-4">
					<div class="w-8 h-8 border-4 border-red-600 border-t-transparent rounded-full animate-spin"></div>
					<p class="text-[10px] text-gray-500 italic uppercase tracking-widest animate-pulse text-center">Cargando datos del alumno...</p>
				</div>
			`;

			// 1. Obtener datos del alumno
			const res = await apiFetch(`/alumnos/${alumnoId}/ficha`);
			if (res.error) {
				showVikingToast("Error al conectar con el servidor", true);
				return;
			}

			// Llenar cabecera del modal
			if (document.getElementById('ficha-nombre')) document.getElementById('ficha-nombre').innerText = res.nombre_completo || 'Sin Nombre';
			if (document.getElementById('ficha-dni')) document.getElementById('ficha-dni').innerText = "DNI: " + (res.dni || '---');
			if (document.getElementById('ficha-plan')) document.getElementById('ficha-plan').innerText = "Plan: " + (res.plan || 'Sin Plan Activo');
			if (document.getElementById('ficha-cuenta')) document.getElementById('ficha-cuenta').innerText = "Estado: " + (res.estado_cuenta || 'Inactivo');
			if (document.getElementById('ficha-peso')) document.getElementById('ficha-peso').innerText = (res.peso || 0) + " kg";
			if (document.getElementById('ficha-altura')) document.getElementById('ficha-altura').innerText = (res.altura || 0) + " cm";
			if (document.getElementById('ficha-imc')) document.getElementById('ficha-imc').innerText = res.imc || 0;

			// 2. Obtener Rutina
			let rutinaData = await apiFetch(`/rutinas/usuario/${alumnoId}`);
			const rutinas = Array.isArray(rutinaData) ? rutinaData : (rutinaData && !rutinaData.error ? [rutinaData] : []);

			if (rutinas.length > 0) {
				const hoy = new Date();
				hoy.setHours(0, 0, 0, 0);

				const mainHTML = rutinas.map((rutina, rIdx) => {
					const objetivoId = `obj-group-${rIdx}`;
					const fechaVenc = rutina.fecha_vencimiento ? new Date(rutina.fecha_vencimiento + 'T23:59:59') : null;
					const esActiva = fechaVenc ? hoy <= fechaVenc : true;

					const statusBadge = esActiva 
						? `<span class="bg-green-600/20 text-green-500 border border-green-500/30 px-3 py-1 rounded-full text-[8px] font-black uppercase tracking-widest animate-pulse">Activa</span>`
						: `<span class="bg-red-600/20 text-red-500 border border-red-500/30 px-3 py-1 rounded-full text-[8px] font-black uppercase tracking-widest">Vencida</span>`;

					const diasHTML = (rutina.dias || []).map((d, dIdx) => {
						const diaId = `ficha-dia-${rIdx}-${dIdx}`;
						return `
						<div class="glass-card rounded-2xl border-white/5 overflow-hidden mb-2 transition-all">
							<!-- Cabecera del Día (Acordeón) -->
							<button onclick="toggleFichaElement('${diaId}')" class="w-full flex items-center justify-between p-4 bg-white/2 hover:bg-white/5 transition-colors group text-left">
								<div class="flex items-center gap-3">
									<div class="w-2 h-2 rounded-full ${esActiva ? 'bg-green-600 shadow-[0_0_8px_#16a34a]' : 'bg-red-600 shadow-[0_0_8px_#dc2626]'}"></div>
									<span class="text-[11px] font-black italic uppercase tracking-wider text-gray-300 group-hover:text-red-500 transition-colors">${d.nombre_dia}</span>
								</div>
								<i data-lucide="chevron-down" class="w-4 h-4 text-gray-600 transition-transform duration-500" id="icon-${diaId}"></i>
							</button>
							
							<!-- Contenido de Ejercicios del Día -->
							<div id="${diaId}" class="hidden p-4 space-y-4 bg-black/20 border-t border-white/5">
								${(d.ejercicios || d.ejercicios_list || []).map(ex => {
									const nombreEjercicio = ex.ejercicio_obj?.nombre || ex.nombre || ex.ejercicio?.nombre || "Ejercicio Sin Nombre";
									const series = ex.series_detalle || ex.series || [];
									
									return `
										<div class="flex flex-col border-l-2 border-red-600/40 pl-4 py-1.5 hover:bg-white/5 rounded-r-xl transition-all mb-4">
											<p class="text-[11px] font-black uppercase italic text-white tracking-tight mb-3">${nombreEjercicio}</p>
											
											<!-- CAMBIO CLAVE: Cabecera de columnas para las series -->
											<div class="grid grid-cols-4 gap-2 mb-2 px-2 opacity-50">
												<span class="text-[8px] font-bold uppercase text-red-600 tracking-wider">Serie</span>
												<span class="text-[8px] font-bold uppercase text-gray-400 text-center tracking-wider">Reps</span>
												<span class="text-[8px] font-bold uppercase text-gray-400 text-center tracking-wider">Peso</span>
												<span class="text-[8px] font-bold uppercase text-gray-400 text-right tracking-wider">Pausa</span>
											</div>

											<!-- CAMBIO CLAVE: Lista de Series en Filas (Rows) -->
											<div class="flex flex-col gap-1">
												${series
													.sort((a, b) => (a.numero_serie || 0) - (b.numero_serie || 0))
													.map(s => `
														<div class="grid grid-cols-4 items-center bg-white/5 px-3 py-2 rounded-lg border border-white/5 hover:border-red-600/30 transition-colors">
															<!-- Nro Serie -->
															<span class="text-[9px] font-black text-white uppercase">#${s.numero_serie}</span>
															
															<!-- Reps -->
															<div class="text-center">
																<span class="text-[11px] font-black text-white">${s.repeticiones}</span>
															</div>
															
															<!-- Peso -->
															<div class="text-center">
																<span class="text-[11px] font-black text-white">${s.peso}</span> <span class="text-[8px] text-gray-500">kg</span>
															</div>
															
															<!-- Descanso -->
															<div class="text-right">
																<span class="text-[9px] text-gray-400 italic">${s.descanso || '-'}</span>
															</div>
														</div>
													`).join('')}
											</div>

											${ex.comentario ? `
												<div class="mt-3 bg-black/40 p-2 rounded-lg border border-white/5 flex gap-2">
													<i data-lucide="info" class="w-2.5 h-2.5 text-red-600 mt-0.5 shrink-0"></i>
													<p class="text-[8px] text-gray-400 italic font-medium leading-tight">${ex.comentario}</p>
												</div>
											` : ''}
										</div>
									`;
								}).join('')}
							</div>
						</div>
						`;
					}).join('');

					// Estructura general de la tarjeta de rutina
					return `
					<div class="col-span-2 mb-4">
						<div class="bg-white/5 border border-white/10 rounded-[2rem] overflow-hidden shadow-xl">
							<button onclick="toggleFichaElement('${objetivoId}')" class="w-full flex items-center justify-between p-6 hover:bg-white/5 transition-all text-left">
								<div class="flex items-center gap-4">
									<div class="w-1 h-10 bg-red-600 rounded-full"></div>
									<div>
										<p class="text-[8px] text-gray-500 font-black uppercase tracking-[0.3em] mb-1">Plan de Entrenamiento</p>
										<h5 class="text-lg font-black italic uppercase viking-red leading-none">${rutina.objetivo || 'Rutina de Musculación'}</h5>
										<p class="text-[9px] text-gray-400 font-bold italic mt-1 flex items-center gap-1">
											<i data-lucide="calendar" class="w-3 h-3"></i> Vence: ${rutina.fecha_vencimiento || 'Indefinido'}
										</p>
									</div>
								</div>
								<div class="flex items-center gap-4">
									${statusBadge}
									<i data-lucide="chevron-down" class="w-6 h-6 text-red-600 transition-transform duration-500" id="icon-${objetivoId}"></i>
								</div>
							</button>
							<div id="${objetivoId}" class="hidden p-4 bg-black/30 border-t border-white/5">
								${diasHTML}
							</div>
						</div>
					</div>
					`;
				}).join('');

				rutinaContainer.innerHTML = mainHTML;
			} else {
				rutinaContainer.innerHTML = `
					<div class="col-span-2 p-16 border border-dashed border-white/10 rounded-[3rem] text-center bg-white/2">
						<div class="w-16 h-16 viking-bg-red/10 rounded-full flex items-center justify-center mx-auto mb-6">
							<i data-lucide="skull" class="w-8 h-8 opacity-40 text-red-600"></i>
						</div>
						<p class="text-[12px] text-gray-600 font-black uppercase italic tracking-[0.2em]">No se ha detectado un plan de batalla activo</p>
						<p class="text-[10px] text-gray-700 mt-2 font-bold">Asigna una rutina desde el gestor para ver los datos aquí.</p>
					</div>
				`;
			}

			if (window.lucide) lucide.createIcons();
			openModal('modal-ficha-tecnica');
		}

        function toggleFichaElement(id) {
            const content = document.getElementById(id);
            const icon = document.getElementById('icon-' + id);
            if (!content) return;

            const isHidden = content.classList.contains('hidden');
            
            if (isHidden) {
                content.classList.remove('hidden');
                content.classList.add('animate-in', 'fade-in', 'slide-in-from-top-2');
                if (icon) {
                    icon.style.transform = 'rotate(180deg)';
                    icon.style.color = '#FF0000'; 
                }
            } else {
                content.classList.add('hidden');
                if (icon) {
                    icon.style.transform = 'rotate(0deg)';
                    icon.style.color = id.startsWith('obj-group') ? '#dc2626' : '#6b7280';
                }
            }
        }

		async function renderRutinas() {
			const rol = state.user?.rol_nombre;
			const list = document.getElementById('rutinas-lista'); // Contenedor lista profes
			const studentView = document.getElementById('musculacion-student-view'); // Vista detalle alumno
			
			// 1. CONFIGURACIÓN DE VISTAS SEGÚN ROL
			if (rol === "Alumno") {
				// --- MODO ALUMNO ---
				if(list) list.classList.add('hidden');
				if(studentView) studentView.classList.remove('hidden');
				document.getElementById('rutina-title').innerText = "Mi Rutina Musculación";
				
				// Lógica de carga de rutina de alumno (INTACTA)
				let res = await apiFetch(`/rutinas/usuario/${state.user.id}`);
				let rutina = null;
				if (Array.isArray(res) && res.length > 0) {
					const hoy = new Date(); hoy.setHours(0,0,0,0);
					rutina = res.find(r => !r.fecha_vencimiento || new Date(r.fecha_vencimiento + 'T23:59:59') >= hoy) || res[0];
				} else if (res && !res.error && res.id) {
					rutina = res;
				}

				if (rutina) {
					document.getElementById('al-rutina-objetivo').innerText = "OBJETIVO: " + (rutina.objetivo || "Entrenamiento").toUpperCase();
					document.getElementById('student-routine-exercises').innerHTML = (rutina.dias || []).map(d => `
						<div class="glass-card p-6 rounded-2xl border-red-600/10">
							<h5 class="font-black italic uppercase viking-red mb-4 border-b border-white/5 pb-2">${d.nombre_dia}</h5>
							<div class="space-y-4">
								${(d.ejercicios || []).map(e => {
									const exName = e.ejercicio_obj?.nombre || e.exercise_name || "Ejercicio";
									return `
									<div class="bg-white/5 p-4 rounded-xl border border-white/5">
										<p class="text-[12px] font-black uppercase italic mb-2 text-white">${exName}</p>
										<div class="space-y-1">
											${(e.series_detalle || e.series || []).sort((a,b)=>a.numero_serie-b.numero_serie).map(s => `
												<div class="flex justify-between items-center text-[10px] bg-black/20 p-2 rounded border border-white/5">
													<span class="text-red-600 font-bold">Serie ${s.numero_serie}</span>
													<span class="text-white font-bold">${s.repeticiones} Reps</span>
													<span class="text-gray-400">${s.peso} Kg</span>
													<span class="text-gray-500 italic text-[9px]">${s.descanso || '-'}</span>
												</div>
											`).join('')}
										</div>
										${e.comentario ? `<p class="text-[10px] text-gray-500 italic mt-2 border-t border-white/5 pt-1">* ${e.comentario}</p>` : ''}
									</div>`;
								}).join('')}
							</div>
						</div>
					`).join('');
				} else {
					document.getElementById('al-rutina-objetivo').innerText = "SIN ASIGNAR";
					document.getElementById('student-routine-exercises').innerHTML = '<div class="col-span-2 text-center py-10"><p class="text-gray-500 italic">No tienes una rutina de musculación activa.</p></div>';
				}

			} else {
				// --- MODO PROFESOR (AQUÍ ESTÁ EL CAMBIO VISUAL) ---
				if(studentView) studentView.classList.add('hidden');
				if(list) {
					list.classList.remove('hidden');
					// Aseguramos estilo lista vertical
					list.className = "space-y-3 min-h-[400px] overflow-y-auto custom-scrollbar flex-1 pr-2 pb-10"; 
				}
				document.getElementById('rutina-title').innerText = "Rutinas de Alumnos";
				
				// Filtro (Logica intacta)
				const alRutinas = state.alumnos.filter(a => {
					const planNombre = (a.plan?.nombre || "").toLowerCase();
					const normalized = planNombre.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
					return normalized.includes('musculacion') || normalized.includes('completo') || normalized.includes('personalizado');
				});

				if (alRutinas.length === 0) {
					list.innerHTML = '<div class="p-10 glass-card rounded-3xl text-center"><i data-lucide="clipboard-x" class="w-12 h-12 text-gray-600 mx-auto mb-4"></i><p class="text-gray-500 italic">No se encontraron alumnos con planes de musculación.</p></div>';
				} else {
					const hoy = new Date().toISOString().split('T')[0];

					list.innerHTML = alRutinas.map(a => {
						// Lógica Visual de Estado (Igual a Alumnos)
						const estaVencido = !a.fecha_vencimiento || a.fecha_vencimiento < hoy;
						const colorEstado = estaVencido ? 'bg-red-600' : 'bg-green-600';
						const textoEstado = estaVencido ? 'VENCIDO' : 'AL DÍA';
						const colorBadge = estaVencido ? 'text-red-500 bg-red-500/10 border-red-500/20' : 'text-green-500 bg-green-500/10 border-green-500/20';

						const initials = a.nombre_completo ? a.nombre_completo.substring(0,2).toUpperCase() : "??";
						const planNombre = a.plan ? a.plan.nombre : 'Sin Plan';

						// --- TARJETA NUEVA (VISUAL ALUMNOS) ---
						return `
						<div class="glass-card p-5 rounded-3xl border-white/5 flex flex-col md:flex-row md:items-center gap-6 hover:border-red-600/20 transition-all group relative overflow-hidden">
							<!-- Barra lateral estado -->
							<div class="absolute left-0 top-0 bottom-0 w-1.5 ${colorEstado} opacity-40 group-hover:opacity-100 transition-opacity"></div>
							
							<!-- COL 1: Identidad -->
							<div class="flex items-center gap-4 w-full md:w-1/3">
								<div class="w-14 h-14 rounded-2xl bg-white/5 border border-white/10 flex items-center justify-center font-black text-white text-lg italic shadow-lg group-hover:bg-red-600 group-hover:text-black transition-colors shrink-0">
									${initials}
								</div>
								<div class="overflow-hidden">
									<h4 class="text-sm font-black uppercase italic text-white group-hover:text-red-500 transition-colors truncate">${a.nombre_completo}</h4>
									<p class="text-[10px] text-gray-500 font-bold flex items-center gap-1.5 mt-1">
										<i data-lucide="id-card" class="w-3 h-3"></i> DNI: ${a.dni}
									</p>
								</div>
							</div>

							<!-- COL 2: Info Plan -->
							<div class="flex-1 border-t md:border-t-0 md:border-l border-white/5 pt-4 md:pt-0 md:pl-8">
								<div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-center">
									<div>
										<p class="text-[9px] text-gray-500 font-black uppercase tracking-widest mb-1 flex items-center gap-1.5">
											<i data-lucide="ticket" class="w-3 h-3 text-red-600"></i> Plan Actual
										</p>
										<p class="text-sm font-black uppercase italic text-white truncate">${planNombre}</p>
									</div>
									<div class="flex flex-row md:flex-col items-center md:items-start justify-between gap-2">
										<div class="flex items-center gap-2">
											<span class="px-3 py-1 rounded-lg text-[9px] font-black uppercase border ${colorBadge}">
												${textoEstado}
											</span>
										</div>
									</div>
								</div>
							</div>

							<!-- COL 3: Acciones (BOTONES ESPECÍFICOS DE RUTINA) -->
							<div class="flex items-center justify-end min-w-[100px] border-t md:border-t-0 border-white/5 pt-3 md:pt-0 gap-2">
								<button onclick="openFichaTecnica(${a.id})" class="px-4 py-3 border border-white/10 text-white rounded-xl text-[9px] font-black uppercase italic hover:bg-white/10 transition-colors flex items-center gap-2">
									<i data-lucide="clipboard-list" class="w-3.5 h-3.5"></i> 
									<span class="hidden lg:inline">Ficha</span>
								</button>
								<button onclick="openRoutineEditor(${a.id})" class="px-4 py-3 bg-red-600 text-black rounded-xl text-[9px] font-black uppercase italic hover:scale-105 transition-transform shadow-lg flex items-center gap-2">
									<i data-lucide="dumbbell" class="w-3.5 h-3.5"></i>
									<span>Gestionar</span>
								</button>
							</div>
						</div>
						`;
					}).join('');
				}
			}
			if(window.lucide) lucide.createIcons();
		}

        async function loadMusculacionMetadata() {
            const grupos = await apiFetch('/rutinas/grupos-musculares');
            const ejercicios = await apiFetch('/rutinas/ejercicios');
            state.gruposMusculares = Array.isArray(grupos) ? grupos : [];
            state.ejerciciosLibreria = Array.isArray(ejercicios) ? ejercicios : [];
            
            const selectLib = document.getElementById('lib-ex-grupo');
            if(selectLib) {
                selectLib.innerHTML = '<option value="">Seleccionar Grupo Muscular</option>' + 
                    state.gruposMusculares.map(g => `<option value="${g.id}">${g.nombre}</option>`).join('');
            }
        }

        async function openRoutineEditor(alumnoId) {
		// 1. Validar que state y alumnos existan
		if (!state || !state.alumnos) {
			console.error("Error: state.alumnos no está definido");
			return;
		}

		const al = state.alumnos.find(a => a.id === alumnoId);
		if (!al) return;
		
		// 2. Cargar metadatos asegurando que la función exista
		if(typeof loadMusculacionMetadata === 'function') {
			await loadMusculacionMetadata();
		}
		
		// 3. Preparar DOM (Usando tus IDs originales)
		const lblAlumno = document.getElementById('rutina-editor-alumno');
		if(lblAlumno) lblAlumno.innerText = "Alumno: " + al.nombre_completo;

		const inputId = document.getElementById('rutina-editor-alumno-id');
		if(inputId) inputId.value = alumnoId;

		const container = document.getElementById('rutina-editor-container');
		if(container) container.innerHTML = "";

		try {
			const rutinaRes = await apiFetch(`/rutinas/usuario/${alumnoId}`);
			
			// CORRECCIÓN CLAVE: Verificamos que rutinaRes exista antes de leer .error
			// Si rutinaRes es null/undefined, entramos al ELSE (Nueva Rutina)
			if (rutinaRes && !rutinaRes.error && rutinaRes.id) {
				// --- MODO EDICIÓN (Cargar existente) ---
				const txtObj = document.getElementById('rutina-objetivo');
				if(txtObj) txtObj.value = rutinaRes.objetivo || '';

				const txtVenc = document.getElementById('rutina-vencimiento');
				if(txtVenc) txtVenc.value = rutinaRes.fecha_vencimiento || '';
				
				if (rutinaRes.dias && Array.isArray(rutinaRes.dias)) {
					rutinaRes.dias.forEach(d => {
						const ejerciciosFormateados = d.ejercicios.map(e => {
							return {
								ejercicio_id: e.ejercicio_id,
								exercise_name: e.ejercicio_obj?.nombre || "Ejercicio",
								series: e.series_detalle || [], // Backend usa series_detalle
								comentario: e.comentario
							};
						});
						// Llamamos a tu función addRoutineDay
						if(typeof addRoutineDay === 'function') {
							addRoutineDay(d.nombre_dia, ejerciciosFormateados);
						}
					});
				}
			} else {
				// --- MODO CREACIÓN (Nueva Rutina) ---
				// Esto se ejecuta si no hay rutina o si el backend devuelve error (ej: "No hay rutina activa")
				const txtObj = document.getElementById('rutina-objetivo');
				if(txtObj) txtObj.value = "";

				const defaultDate = new Date();
				defaultDate.setDate(defaultDate.getDate() + 30);
				
				const txtVenc = document.getElementById('rutina-vencimiento');
				if(txtVenc) txtVenc.value = defaultDate.toISOString().split('T')[0];
				
				if(typeof addRoutineDay === 'function') {
					addRoutineDay("Día 1", []); 
				}
			}

			// 4. Abrir Modal (Tu ID original)
			if(typeof openModal === 'function') {
				openModal('modal-rutina-editor');
			} else {
				// Fallback por si openModal no es global
				const m = document.getElementById('modal-rutina-editor');
				if(m) m.classList.remove('hidden');
			}

		} catch (e) {
			console.error("Error crítico en openRoutineEditor:", e);
			alert("Hubo un error al intentar abrir el editor.");
		}
	}

        function addRoutineDay(nombre = "", ejercicios = []) {
            const container = document.getElementById('rutina-editor-container');
            const dayId = 'day-' + Math.random().toString(36).substr(2, 9);
            const dayCard = document.createElement('div');
            dayCard.className = "rutina-dia-card space-y-6";
            dayCard.dataset.dayId = dayId;
            
            dayCard.innerHTML = `
                <div class="flex justify-between items-center gap-4 border-b border-white/5 pb-4">
                    <div class="flex-1">
                        <p class="text-[9px] font-black text-gray-500 uppercase italic mb-1 tracking-widest">Nombre del Entrenamiento</p>
                        <input type="text" placeholder="Ej: Rutina A - Piernas" value="${nombre}" class="viking-input py-2 text-[14px] day-title" required>
                    </div>
                    <button type="button" onclick="this.closest('.rutina-dia-card').remove()" class="text-red-900 hover:text-red-600 transition-colors mt-4"><i data-lucide="trash-2" class="w-6 h-6"></i></button>
                </div>
                
                <div class="bg-black/40 p-5 rounded-[1.5rem] border border-red-600/10 shadow-inner">
                    <p class="text-[10px] font-black text-red-600 uppercase italic mb-3 tracking-[0.2em]">Buscar y Añadir Ejercicio</p>
                    <div class="flex gap-3">
                        <select class="viking-input py-2 text-[11px] h-10 w-1/3 search-group-filter">
                            <option value="all">Filtrar Grupo Muscular...</option>
                            ${state.gruposMusculares.map(g => `<option value="${g.id}">${g.nombre}</option>`).join('')}
                        </select>
                        <div class="relative flex-1">
                            <input type="text" placeholder="Escribe para buscar (ej: Sentadilla)..." class="viking-input py-2 text-[11px] h-10 w-full search-exercise-input" oninput="showExerciseResults(this, '${dayId}')">
                            <div class="exercise-results-list hidden absolute top-full left-0 w-full bg-[#0a0a0a] border border-red-600/30 rounded-2xl mt-2 z-50 max-h-60 overflow-y-auto custom-scrollbar shadow-2xl"></div>
                        </div>
                    </div>
                </div>

                <div class="exercises-list space-y-4">
                    <div class="exercise-grid gap-3 px-4 text-[10px] font-black text-gray-500 uppercase italic tracking-widest">
                        <span>Ejercicio Seleccionado</span>
                        <span class="text-center">Series</span>
                        <span class="text-center">Reps</span>
                        <span class="text-center">Peso</span>
                        <span class="text-center">Descanso</span>
                        <span></span>
                    </div>
                    <div class="day-exercises-container space-y-3"></div>
                </div>
            `;
            container.appendChild(dayCard);
            
            if (ejercicios.length > 0) {
                ejercicios.forEach(e => addExerciseToDay(dayId, e));
            }
            lucide.createIcons();
        }

        function showExerciseResults(input, dayId) {
            const query = input.value.toLowerCase();
            const groupFilter = input.closest('.flex').querySelector('.search-group-filter').value;
            const resultsDiv = input.nextElementSibling;

            if (query.length < 2 && groupFilter === "all") {
                resultsDiv.classList.add('hidden');
                return;
            }

            const filtered = state.ejerciciosLibreria.filter(ex => {
                const matchSearch = ex.nombre.toLowerCase().includes(query);
                const matchGroup = groupFilter === "all" || ex.grupo_muscular_id == groupFilter;
                return matchSearch && matchGroup;
            });

            if (filtered.length === 0) {
                resultsDiv.innerHTML = '<div class="p-4 text-[11px] text-gray-500 italic">No se encontraron resultados</div>';
            } else {
                resultsDiv.innerHTML = filtered.map(ex => `
                    <div class="p-4 border-b border-white/5 text-[11px] font-black uppercase italic transition-colors" onclick="selectExerciseForDay('${dayId}', ${ex.id}, '${ex.nombre}')">
                        ${ex.nombre}
                    </div>
                `).join('');
            }
            resultsDiv.classList.remove('hidden');
        }

        function selectExerciseForDay(dayId, exerciseId, exerciseName) {
            const container = document.querySelector(`[data-day-id="${dayId}"]`);
            const searchInput = container.querySelector('.search-exercise-input');
            const resultsDiv = container.querySelector('.exercise-results-list');
            
            addExerciseToDay(dayId, { ejercicio_id: exerciseId, exercise_name: exerciseName });
            
            searchInput.value = "";
            resultsDiv.classList.add('hidden');
            showVikingToast("Añadido: " + exerciseName);
        }

			function addExerciseToDay(dayId, data = null) {
				// 1. Configuración: Series por defecto en 0
				const SERIES_POR_DEFECTO = 0; 

				const container = document.querySelector(`[data-day-id="${dayId}"] .day-exercises-container`);
				const div = document.createElement('div');
				const exerciseUniqueId = 'ex-' + Math.random().toString(36).substr(2, 9);
				
				// CAMBIO VISUAL 1: Quitamos 'bg-white/5 p-4 rounded-2xl border' para eliminar el "recuadro".
				// Usamos solo 'border-b' para separar ejercicios en filas limpias.
				div.className = "exercise-row border-b border-white/10 pb-4 mb-4";
				div.dataset.exerciseRowId = exerciseUniqueId;

				let exName = data?.exercise_name || "";
				if (!exName && data?.ejercicio_id) {
					const found = state.ejerciciosLibreria.find(e => e.id == data.ejercicio_id);
					exName = found ? found.nombre : "Ejercicio";
				}

				const initialNumSeries = (data && data.series) ? data.series.length : SERIES_POR_DEFECTO;

				div.innerHTML = `
					<div class="flex justify-between items-center mb-3">
						<div class="flex flex-col text-left">
							<input type="hidden" class="exercise-id" value="${data?.ejercicio_id}">
							<!-- Nombre del ejercicio un poco más grande y limpio -->
							<span class="text-[13px] font-black uppercase italic text-white tracking-wide">${exName}</span>
						</div>
						<div class="flex items-center gap-3">
							<div class="flex items-center gap-2 bg-white/5 px-2 py-1 rounded-lg">
								<label class="text-[9px] font-black text-gray-500 uppercase">Sets</label>
								<select class="viking-input !py-0 !px-1 w-10 h-6 text-[11px] text-center font-black bg-[#1a1a1a] text-white border border-white/20 series-select cursor-pointer focus:border-red-600 rounded" 
										onchange="updateSeriesCount('${exerciseUniqueId}', this.value)">
									${[0,1,2,3,4,5,6,7,8,9,10].map(n => 
										`<option value="${n}" class="bg-black text-white font-bold" ${n === initialNumSeries ? 'selected' : ''}>${n}</option>`
									).join('')}
								</select>
							</div>
							<button type="button" onclick="this.closest('.exercise-row').remove()" class="text-gray-500 hover:text-red-500 transition-colors">
								<i data-lucide="trash-2" class="w-4 h-4"></i>
							</button>
						</div>
					</div>

					<!-- CAMBIO VISUAL 2: Cabecera de columnas para dar aspecto de tabla ordenada -->
					<div class="grid grid-cols-4 gap-2 mb-1 px-1">
						<span class="text-[8px] font-bold uppercase text-red-600 tracking-wider">Serie</span>
						<span class="text-[8px] font-bold uppercase text-gray-500 text-center tracking-wider">Reps</span>
						<span class="text-[8px] font-bold uppercase text-gray-500 text-center tracking-wider">Peso</span>
						<span class="text-[8px] font-bold uppercase text-gray-500 text-center tracking-wider">Pausa</span>
					</div>

					<div id="series-container-${exerciseUniqueId}" class="space-y-1 mb-3"></div>
					
					<div class="mt-2 text-left pl-1">
						<input type="text" placeholder="Añadir nota técnica o comentario..." 
							value="${data?.comentario || ''}"
							class="w-full bg-transparent text-[10px] text-gray-400 border-b border-dashed border-white/10 focus:border-red-600 focus:outline-none py-1 italic placeholder-gray-700 transition-colors exercise-comment">
					</div>
				`;
				container.appendChild(div);
				
				generateSeriesRows(exerciseUniqueId, initialNumSeries, data ? data.series : null);
				if(window.lucide) lucide.createIcons();
			}
        function updateSeriesCount(containerId, newCount) {
            const container = document.getElementById(`series-container-${containerId}`);
            const currentRows = container.querySelectorAll('.serie-row');
            let savedData = [];
            
            currentRows.forEach(row => {
                savedData.push({
                    repeticiones: row.querySelector('.serie-reps').value,
                    peso: row.querySelector('.serie-weight').value,
                    descanso: row.querySelector('.serie-rest').value
                });
            });

            generateSeriesRows(containerId, newCount, savedData);
        }

        function generateSeriesRows(containerId, numSeries, existingData = null) {
			const container = document.getElementById(`series-container-${containerId}`); 
			if (!container) return; 
			container.innerHTML = "";
			
			for (let i = 1; i <= numSeries; i++) {
				const rowData = (existingData && existingData[i - 1]) ? existingData[i - 1] : null;
				
				container.innerHTML += `
					<div class="grid grid-cols-4 gap-2 items-center serie-row px-1 py-1 hover:bg-white/5 rounded transition-colors" data-serie-num="${i}">
						<!-- Número de serie alineado a la izquierda -->
						<span class="text-[10px] font-black text-white uppercase italic">#${i}</span>
						
						<!-- Inputs estilo "línea" (border-b) en lugar de caja completa -->
						<input type="text" placeholder="0" value="${rowData?.repeticiones || ''}" 
							class="bg-transparent border-b border-white/10 text-center text-[11px] text-white focus:border-red-600 focus:outline-none py-1 w-full font-bold serie-reps">
						
						<input type="text" placeholder="0" value="${rowData?.peso || ''}" 
							class="bg-transparent border-b border-white/10 text-center text-[11px] text-white focus:border-red-600 focus:outline-none py-1 w-full font-bold serie-weight">
						
						<input type="text" placeholder="90s" value="${rowData?.descanso || '90s'}" 
							class="bg-transparent border-b border-white/10 text-center text-[10px] text-gray-400 focus:border-red-600 focus:outline-none py-1 w-full italic serie-rest">
					</div>`;
			}
		}

        async function apiFetch(endpoint, method = 'GET', body = null) {
			const token = localStorage.getItem('viking_token');
			const headers = { 'Content-Type': 'application/json' };
			
			if (token) {
				headers['Authorization'] = `Bearer ${token}`;
			}

			const options = { method, headers };
			if (body) options.body = JSON.stringify(body);
			
			try {
				const res = await fetch(`${API_BASE}${endpoint}`, options);
				
				// 1. Manejo de sesión expirada
				if (res.status === 401) {
					localStorage.removeItem('viking_token');
					location.reload();
					return { error: "Sesión expirada" };
				}

				// 2. LEER EL CUERPO UNA SOLA VEZ
				const responseText = await res.text();
				
				// 3. Intentar parsear como JSON
				let responseData;
				try {
					responseData = JSON.parse(responseText);
				} catch (e) {
					// Si no es JSON, devolvemos el texto plano (útil para errores 500 crudos)
					responseData = { error: responseText || "Error desconocido del servidor" };
				}

				if (!res.ok) {
					return { error: responseData.detail || responseData.error || "Error en la petición" };
				}

				return responseData;
			} catch (e) { 
				console.error("Error Fetch:", e);
				return { error: "Error de conexión con el Valhalla" }; 
			}
		}

        function calculateIMC() {
            const peso = parseFloat(document.getElementById('al-peso').value);
            const alturaCm = parseFloat(document.getElementById('al-altura').value);
            if (peso > 5 && alturaCm > 50) {
                const alturaM = alturaCm / 100;
                document.getElementById('al-imc').value = (peso / (alturaM * alturaM)).toFixed(2);
            } else document.getElementById('al-imc').value = "";
        }

        function calculateIMCProfile() {
            const peso = parseFloat(document.getElementById('prof-input-peso').value);
            const alturaCm = parseFloat(document.getElementById('prof-input-altura').value);
            if (peso > 5 && alturaCm > 50) {
                const alturaM = alturaCm / 100;
                document.getElementById('prof-input-imc').value = (peso / (alturaM * alturaM)).toFixed(2);
            } else document.getElementById('prof-input-imc').value = "";
        }

        function autoCalculateExpiry() {
            const planId = document.getElementById('al-plan').value;
            const renovDate = document.getElementById('al-fecha-renovacion').value;
            if(!planId || !renovDate) return;
            const plan = state.planes.find(p => p.id == planId);
            let months = 1;
            if (plan) {
                const n = plan.nombre.toLowerCase();
                if (n.includes('trimestral')) months = 3;
                else if (n.includes('semestral')) months = 6;
                else if (n.includes('anual')) months = 12;
            }
            let d = new Date(renovDate + 'T00:00:00');
            d.setMonth(d.getMonth() + months);
            document.getElementById('al-fecha-vencimiento').value = d.toISOString().split('T')[0];
        }

        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('sidebar-collapsed'); lucide.createIcons(); }
        function toggleSub(id) { document.getElementById(id).classList.toggle('hidden'); }
        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) {
			const modal = document.getElementById(id);
			if (modal) {
				modal.style.display = 'none'; // ELIMINA EL BLOQUEO INLINE
				modal.classList.add('hidden');
				modal.classList.remove('flex');
				
				// Reset de formularios si existen dentro
				const form = modal.querySelector('form');
				if (form) form.reset();
			}
		}

        function switchView(view) {
			// 1. Ocultar todas las vistas de contenido
			document.querySelectorAll('.view-content').forEach(v => {
				v.classList.remove('active');
				v.classList.add('hidden');
				v.style.setProperty('display', 'none', 'important'); 
			});

			// 2. Ocultar layouts internos de Dashboard
			const layouts = ['admin-dashboard-layout', 'alumno-dashboard-layout', 'view-professor-dashboard'];
			layouts.forEach(id => {
				const l = document.getElementById(id);
				if (l) {
					l.classList.add('hidden');
					l.style.setProperty('display', 'none', 'important');
				}
			});

			// 3. Desactivar botones de navegación
			document.querySelectorAll('.nav-btn, .nav-item').forEach(b => b.classList.remove('active'));

			// 4. Lógica de selección de Dashboard por ROL
			let targetId = 'view-' + view;
			const rol = (state.user?.rol_nombre || "").toLowerCase();

			if (view === 'dashboard') {
				if (rol === "alumno") {
					targetId = 'view-dashboard';
					const aluLayout = document.getElementById('alumno-dashboard-layout');
					if (aluLayout) aluLayout.style.setProperty('display', 'block', 'important');
					if (typeof renderStudentDashboard === 'function') renderStudentDashboard();
				} 
				else if (rol === "profesor") {
					targetId = 'view-professor-dashboard'; 
					const profView = document.getElementById('view-professor-dashboard');
					if (profView) profView.style.setProperty('display', 'block', 'important');
					if (typeof loadProfessorDashboard === 'function') loadProfessorDashboard();
				} 
				else {
					targetId = 'view-dashboard';
					const adminLayout = document.getElementById('admin-dashboard-layout');
					if (adminLayout) adminLayout.style.setProperty('display', 'block', 'important');
					if (typeof loadDashboard === 'function') loadDashboard();
				}
			}

			// 5. Mostrar la vista final
			const targetView = document.getElementById(targetId);
			if (targetView) {
				targetView.classList.add('active');
				targetView.classList.remove('hidden');
				targetView.style.setProperty('display', (view === 'dashboard' ? 'block' : 'flex'), 'important'); 
			}

			// 6. Activar botón de menú
			const n = document.getElementById('nav-' + view); 
			if (n) n.classList.add('active');
			
			// 7. Cambiar título
			const titleEl = document.getElementById('view-title');
			if (titleEl) titleEl.innerText = view.replace('-', ' ').toUpperCase();

			// 8. CORRECCIÓN: Carga de datos en "Mi Perfil"
			if (view === 'perfil' && state.user) {
				const u = state.user;
				const initials = u.nombre_completo ? u.nombre_completo.split(' ').filter(n => n).map(n => n[0]).join('').toUpperCase() : "??";
				
				// Textos de cabecera
				const nameHeader = document.getElementById('prof-name');
				const roleHeader = document.getElementById('prof-role');
				if (nameHeader) nameHeader.innerText = u.nombre_completo || "Usuario Vikingo";
				if (roleHeader) roleHeader.innerText = u.rol_nombre || "Staff";
				
				// Iniciales
				const elInitials = document.getElementById('user-initials');
				const elInitialsView = document.getElementById('prof-initials-view');
				if (elInitials) elInitials.innerText = initials;
				if (elInitialsView) elInitialsView.innerText = initials;
				
				// Rellenar Inputs del formulario
				const inputName = document.getElementById('prof-input-name');
				const inputDni = document.getElementById('prof-input-dni');
				const inputEmail = document.getElementById('prof-input-email');
				if (inputName) inputName.value = u.nombre_completo || "";
				if (inputDni) inputDni.value = u.dni || "";
				if (inputEmail) inputEmail.value = u.email || "";

				// Datos físicos (solo si es Alumno)
				const fisicos = document.getElementById('perfil-datos-fisicos');
				if (fisicos) {
					if (rol === "alumno") {
						fisicos.classList.remove('hidden');
						fisicos.style.display = 'grid';
						document.getElementById('prof-input-peso').value = u.peso || "";
						document.getElementById('prof-input-altura').value = u.altura || "";
						document.getElementById('prof-input-imc').value = u.imc || "";
					} else {
						fisicos.classList.add('hidden');
						fisicos.style.display = 'none';
					}
				}
			}

			// 9. Cargas de datos adicionales según sección
			if (view === 'calendario') renderCalendar();
			if (view === 'cobrar') renderCobrar();
			if (view === 'rutinas') renderRutinas();
			if (view === 'acceso-virtual') renderAccesos();
			if (view === 'alumnos') {
				if (typeof renderAlumnosSection === 'function') renderAlumnosSection();
			}

			// 10. Aplicar permisos de visibilidad final
			applyPermissions();
			
			if (window.lucide) lucide.createIcons();
		}

		async function handleLogin(e) {
			// 1. Detener el refresco automático del formulario
			if (e && e.preventDefault) e.preventDefault();

			const dniInput = document.getElementById('login-dni');
			const passInput = document.getElementById('login-pass');
			const errorDiv = document.getElementById('login-error');
			const loginBtn = document.getElementById('login-button');

			if (!dniInput || !passInput) return;

			// Feedback visual de carga
			if (loginBtn) {
				loginBtn.disabled = true;
				loginBtn.innerText = "VERIFICANDO...";
			}

			const data = {
				dni: dniInput.value,
				password: passInput.value
			};

			try {
				const res = await apiFetch('/login', 'POST', data);

				if (res && !res.error) {
					// --- NUEVO: GUARDAR TOKEN JWT ---
					if (res.access_token) {
						localStorage.setItem('viking_token', res.access_token);
					}

					// Guardamos al usuario en el estado global
					state.user = res;

					// 2. Ocultar Login y mostrar App
					document.getElementById('login-overlay').style.display = 'none';
					document.getElementById('sidebar').classList.remove('hidden');
					document.getElementById('main-content').classList.remove('hidden');

					// 3. Cargar datos del usuario en la barra lateral
					const elName = document.getElementById('side-user-name');
					if (elName) elName.innerText = res.nombre_completo || "Usuario";

					const elRole = document.getElementById('side-user-role');
					if (elRole) elRole.innerText = res.rol_nombre || 'Staff';

					// --- LÓGICA DE INICIALES ---
					const name = res.nombre_completo || "Usuario Vikingo";
					const initials = name.split(' ')
						.filter(n => n)
						.map(n => n[0])
						.join('')
						.toUpperCase()
						.substring(0, 2);

					const elInitials = document.getElementById('user-initials');
					if (elInitials) elInitials.innerText = initials;

					// 4. Cargar datos maestros (Profesores, Clases, etc.)
					await loadProfesores();

					if (typeof initApp === 'function') {
						await initApp();
					} else {
						if (typeof loadClases === 'function') loadClases();
						if (typeof loadStock === 'function') loadStock();
					}

					// 5. Cambiar a la vista principal
					switchView('dashboard');

					// --- Renderizar Dashboard específico si es Alumno ---
					if (res.rol_nombre === "Alumno" && typeof renderStudentDashboard === 'function') {
						await renderStudentDashboard();
					}
					
					// --- MEJORA: Precarga de datos si es Profesor ---
					if (res.rol_nombre === "Profesor" && typeof loadProfessorDashboard === 'function') {
						await loadProfessorDashboard();
					}

					// Refrescar iconos
					if (window.lucide) lucide.createIcons();

					showVikingToast(`¡Bienvenido al Valhalla, ${res.nombre_completo.split(' ')[0]}!`);

				} else {
					// Mostrar error si las credenciales fallan
					if (errorDiv) {
						errorDiv.innerText = res.error || "Credenciales incorrectas";
						errorDiv.classList.remove('hidden');
					}
					if (loginBtn) {
						loginBtn.disabled = false;
						loginBtn.innerText = "Entrar al Valhalla";
					}
				}
			} catch (err) {
				console.error("Error en el proceso de login:", err);
				showVikingToast("Error de conexión con el servidor", true);
				if (loginBtn) {
					loginBtn.disabled = false;
					loginBtn.innerText = "Entrar al Valhalla";
				}
			}
		}


	async function loadCaja() {
		const movs = await apiFetch('/caja/movimientos');
		
		let calcIngresos = 0;
		let calcGastos = 0;

		// 1. Encabezados Forzados (Flujo | Tipo | Descripcion | Monto)
		const thead = document.querySelector('#view-caja table thead tr');
		if(thead) {
			thead.innerHTML = `
				<th class="pb-5 pl-2 text-left">Flujo</th>
				<th class="pb-5 text-left">Tipo</th>
				<th class="pb-5 text-left">Descripción</th>
				<th class="pb-5 text-right pr-2">Monto</th>
			`;
		}

		if (Array.isArray(movs)) {
			movs.forEach(m => {
				const tipo = (m.tipo || '').toLowerCase();
				const desc = (m.descripcion || '').toLowerCase();
				const monto = Math.abs(parseFloat(m.monto)); // Leemos siempre positivo para calcular

				// LÓGICA BLINDADA: 
				// Si dice mercaderia, plan, venta o cobro -> ES INGRESO (Verde)
				// Solo es Gasto si NO es lo anterior y explícitamente dice gasto/egreso
				const esPositivo = tipo.includes('mercaderia') || tipo.includes('mercadería') || tipo.includes('plan') || tipo.includes('venta') || tipo.includes('cobro') || tipo.includes('ingreso');
				const esEgreso = !esPositivo && (tipo === 'gasto' || tipo === 'egreso' || tipo === 'salida');

				if (esEgreso) {
					calcGastos += monto;
				} else {
					calcIngresos += monto;
				}
			});
		}

		const calcBalance = calcIngresos - calcGastos;

		// Actualizar tarjetas
		if(document.getElementById('caja-ingresos')) 
			document.getElementById('caja-ingresos').innerText = `$ ${calcIngresos.toLocaleString()}`;
		
		if(document.getElementById('caja-gastos')) 
			document.getElementById('caja-gastos').innerText = `$ ${calcGastos.toLocaleString()}`;
		
		if(document.getElementById('caja-balance')) {
			const elBalance = document.getElementById('caja-balance');
			elBalance.innerText = `$ ${calcBalance.toLocaleString()}`;
			elBalance.className = `text-3xl font-black ${calcBalance >= 0 ? 'text-white' : 'text-red-500'}`;
		}

		// Renderizar Tabla
		const table = document.getElementById('table-caja');
		if(table) {
			if(Array.isArray(movs) && movs.length > 0) {
				table.innerHTML = movs.map(m => {
					const tipoRaw = (m.tipo || '').toLowerCase();
					const monto = Math.abs(parseFloat(m.monto));

					// Misma lógica de detección visual
					const esPositivo = tipoRaw.includes('mercaderia') || tipoRaw.includes('mercadería') || tipoRaw.includes('plan') || tipoRaw.includes('venta') || tipoRaw.includes('cobro') || tipoRaw.includes('ingreso');
					const esEgreso = !esPositivo && (tipoRaw === 'gasto' || tipoRaw === 'egreso' || tipoRaw === 'salida');
					
					const flujoTexto = esEgreso ? 'EGRESO' : 'INGRESO';
					const flujoColor = esEgreso 
						? 'bg-red-500/10 text-red-500 border-red-500/20' 
						: 'bg-green-500/10 text-green-500 border-green-500/20';

					// Icono según tipo real
					let icono = 'tag';
					if(tipoRaw.includes('plan')) icono = 'users';
					if(tipoRaw.includes('mercaderia')) icono = 'shopping-bag';
					if(esEgreso) icono = 'arrow-down-circle';

					return `
					<tr class="viking-table-row border-b border-white/5 hover:bg-white/5 transition-colors">
						<!-- COL 1: FLUJO -->
						<td class="py-4 px-2">
							<span class="px-3 py-1 rounded border text-[9px] font-black uppercase tracking-wider ${flujoColor}">
								${flujoTexto}
							</span>
						</td>

						<!-- COL 2: TIPO -->
						<td class="py-4 px-2">
							<span class="text-white text-[10px] font-black uppercase italic opacity-70">
								<i data-lucide="${icono}" class="w-3 h-3 inline mr-1 opacity-50"></i>${m.tipo}
							</span>
						</td>

						<!-- COL 3: DESCRIPCIÓN -->
						<td class="py-4 px-2">
							<p class="text-[11px] font-bold text-white uppercase">${m.descripcion}</p>
							<p class="text-[9px] text-gray-500">${new Date(m.fecha).toLocaleDateString()} - ${m.metodo_pago || 'Efectivo'}</p>
						</td>

						<!-- COL 4: MONTO -->
						<td class="py-4 px-2 text-right font-black italic text-white tracking-wide pr-2">
							$ ${monto.toLocaleString()}
						</td>
					</tr>
				`}).join('');
				
				if(window.lucide) lucide.createIcons();
				
			} else {
				table.innerHTML = '<tr><td colspan="4" class="text-center py-6 text-gray-500 italic text-[10px]">Sin movimientos registrados</td></tr>';
			}
		}
	}

		// REEMPLAZA TU FUNCIÓN guardarMovimiento POR ESTA:
		async function guardarMovimiento(event) {
			event.preventDefault(); // Evita recarga

			// 1. Capturar Inputs
			const descInput = document.getElementById('input-desc-gasto');
			const montoInput = document.getElementById('input-monto-gasto');
			const tipoInput = document.getElementById('input-tipo-movimiento');

			const descripcion = descInput?.value || 'Varios';
			const monto = parseFloat(montoInput?.value) || 0;
			const tipo = tipoInput ? tipoInput.value : 'Ingreso';

			if(monto <= 0) return alert("El monto debe ser mayor a 0");

			// 2. Enviar al Backend
			try {
				const res = await apiFetch('/caja/movimientos', 'POST', {
					tipo: tipo, 
					descripcion: descripcion,
					monto: monto,
					metodo_pago: 'Efectivo' 
				});

				if(!res.error) {
					// 3. LIMPIEZA BLINDADA (Aquí borramos lo escrito)
					if(descInput) descInput.value = "";
					if(montoInput) montoInput.value = "";
					
					// Cerrar modal y recargar
					document.getElementById('modal-gasto').classList.add('hidden');
					await loadCaja(); 
					
					if(typeof showVikingToast === 'function') showVikingToast('Movimiento registrado correctamente');
				} else {
					// Si el error persiste (ej: backend no actualizado), avisa
					alert("Error del servidor: " + (res.detail || res.error || "Revisa el main.py"));
				}
			} catch (e) {
				console.error(e);
				alert("Error de conexión al guardar.");
			}
		}

        async function initApp() {
            await Promise.all([fetchAlumnos(), loadStaff(), loadPlanes(), loadStock(), loadClases(), fetchReservas(), loadDashboard(), loadMusculacionMetadata(), loadCaja()]);
        }

		async function loadDashboard() {
            console.log("⚔️ Sincronizando Central de Mando...");

            // 1. Cargar datos necesarios del servidor
            // Traemos Stock, Reservas e Historial de Acceso real
            // IMPORTANTE: Respetamos tus strings de apiFetch tal cual los tenías
            const [stockData, reservasData, accesoData] = await Promise.all([
                apiFetch('/stock'),
                apiFetch('/reservas'),
                apiFetch('/acceso/historial')
            ]);

            const stock = Array.isArray(stockData) ? stockData : [];
            const reservas = Array.isArray(reservasData) ? reservasData : [];
            const historialAcceso = Array.isArray(accesoData) ? accesoData : [];

            // Guardamos en el estado global por si otras funciones lo necesitan
            state.stock = stock;
            state.reservas = reservas;
            state.accesos = historialAcceso;

            // --- A. ÚLTIMOS ACCESOS (GENERAL / ALUMNOS) ---
            const accessContainer = document.getElementById('dash-last-access');
            if (accessContainer) {
                // Filtramos por rol "alumno" respetando tu lógica de separacion
                const alumnosLog = historialAcceso.filter(acc => (acc.rol || '').toLowerCase() === 'alumno');

                accessContainer.innerHTML = alumnosLog.length ? alumnosLog.slice(0, 10).map(acc => {
                    // Sincronizamos con el campo 'estado' que el main.py devuelve (que viene de 'accion' en la DB)
                    const isDenied = acc.estado === 'DENIED' || acc.estado === 'DENEGADO';
                    const colorClass = isDenied ? 'text-red-500 bg-red-500/10 border-red-500/20' : 'text-blue-500 bg-blue-500/10 border-blue-500/20';
                    const hora = acc.fecha ? acc.fecha.split(' - ')[0] : 'Ahora';

                    return `
                        <div class="flex justify-between items-center p-3 bg-white/5 rounded-2xl border border-white/5 hover:bg-white/10 transition-colors group">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-lg ${isDenied ? 'bg-red-500/20 text-red-500' : 'bg-blue-500/20 text-blue-500'} flex items-center justify-center">
                                    <i data-lucide="user-check" class="w-4 h-4"></i>
                                </div>
                                <div>
                                    <p class="text-[10px] font-black uppercase italic text-white group-hover:text-blue-400 truncate max-w-[120px]">${acc.nombre}</p>
                                    <p class="text-[8px] text-gray-500 font-bold">${hora} • ${acc.metodo || 'QR'}</p>
                                </div>
                            </div>
                            <span class="text-[9px] px-2 py-1 rounded-md font-black uppercase italic ${colorClass}">${isDenied ? 'DENEGADO' : 'PERMITIDO'}</span>
                        </div>
                    `;
                }).join('') : '<p class="text-center text-gray-600 italic text-[10px] py-10">Esperando lecturas de QR...</p>';
            }

            // --- B. CONTROL DE STAFF (SOLO PROFESORES / ADMIN) ---
            const staffContainer = document.getElementById('dash-staff-access');
            if (staffContainer) {
                // Filtramos el historial para mostrar solo a los que NO son alumnos (Staff/Admin)
                const staffLog = historialAcceso.filter(acc => {
                    const rol = (acc.rol || '').toLowerCase();
                    return rol !== "alumno" && rol !== "" && rol !== "n/a";
                });

                staffContainer.innerHTML = staffLog.length ? staffLog.slice(0, 10).map(acc => {
                    const hora = acc.fecha ? acc.fecha.split(' - ')[0] : 'Ahora';
                    return `
                        <div class="flex items-center justify-between p-3 bg-red-600/[0.05] rounded-2xl border border-red-600/10 hover:border-red-600/30 transition-all">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-red-600 flex items-center justify-center text-[10px] font-black italic text-black">
                                    ${(acc.nombre || '??').substring(0,2).toUpperCase()}
                                </div>
                                <div>
                                    <p class="text-[10px] font-black uppercase italic text-white leading-none mb-1">${acc.nombre}</p>
                                    <p class="text-[8px] text-red-500/70 font-bold uppercase">${acc.rol || 'STAFF'}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-[9px] font-black text-white">${hora}</p>
                                <p class="text-[8px] font-bold text-gray-500 uppercase tracking-tighter">PRESENTE</p>
                            </div>
                        </div>
                    `;
                }).join('') : '<p class="text-center text-gray-600 italic text-[10px] py-10">Sin personal registrado hoy.</p>';
            }

            // --- C. ALERTAS DE STOCK (SINCRONIZADO) ---
            const stockContainer = document.getElementById('dash-low-stock');
            if (stockContainer) {
                const lowStock = stock.filter(s => s.stock_actual <= 5).sort((a,b) => a.stock_actual - b.stock_actual);
                if (lowStock.length === 0) {
                    stockContainer.innerHTML = '<div class="flex flex-col items-center justify-center h-full opacity-30"><i data-lucide="check-circle" class="w-12 h-12 mb-2 text-green-500"></i><p class="text-[10px] font-black italic">Stock Saludable</p></div>';
                } else {
                    stockContainer.innerHTML = lowStock.map(s => `
                        <div class="flex justify-between items-center p-3 bg-white/[0.03] rounded-2xl border border-white/5 hover:border-orange-500/30 transition-all">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-lg bg-orange-600/20 text-orange-500 flex items-center justify-center font-bold text-xs">
                                    ${s.stock_actual}
                                </div>
                                <div>
                                    <p class="text-[10px] font-black uppercase italic text-white">${s.nombre_producto}</p>
                                    <p class="text-[8px] text-red-500 font-bold uppercase">Reposición Urgente</p>
                                </div>
                            </div>
                            <button onclick="switchView('stock')" class="text-[9px] border border-white/10 text-gray-400 px-2 py-1 rounded hover:bg-white/10 transition-colors italic font-black uppercase">Ver</button>
                        </div>
                    `).join('');
                }
            }

            // --- D. TOP 5 CLASES (MANTENIDO) ---
            const topClassesContainer = document.getElementById('dash-top-clases');
            if (topClassesContainer) {
                const classCounts = {};
                reservas.forEach(r => {
                    const name = r.clase_nombre || "Clase";
                    classCounts[name] = (classCounts[name] || 0) + 1;
                });

                const sortedClasses = Object.entries(classCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);

                if (sortedClasses.length === 0) {
                    topClassesContainer.innerHTML = '<p class="text-center text-gray-500 italic text-[10px] py-10">No hay reservas registradas.</p>';
                } else {
                    topClassesContainer.innerHTML = sortedClasses.map(([name, count], index) => {
                        const colors = ["text-yellow-400", "text-gray-300", "text-amber-600", "text-gray-600", "text-gray-700"];
                        return `
                        <div class="flex items-center justify-between p-3 bg-white/5 rounded-2xl border border-white/5">
                            <div class="flex items-center gap-3">
                                <i data-lucide="medal" class="w-4 h-4 ${colors[index]}"></i>
                                <span class="text-[10px] font-black italic uppercase text-white">${index + 1}. ${name}</span>
                            </div>
                            <span class="text-[9px] font-black text-red-600 bg-red-600/10 px-2 py-0.5 rounded border border-red-600/20">${count} RES.</span>
                        </div>
                    `}).join('');
                }
            }

            // --- E. FRECUENCIA HORARIA (GRÁFICO MANTENIDO) ---
            const chartContainer = document.getElementById('dash-chart-container');
            const labelsContainer = document.getElementById('dash-chart-labels');
            
            if (chartContainer && labelsContainer) {
                const hoursMap = {};
                for(let i=7; i<=22; i++) hoursMap[i] = 0;

                reservas.forEach(r => {
                    if(r.horario) {
                        const h = Math.floor(parseFloat(r.horario));
                        if(hoursMap[h] !== undefined) hoursMap[h]++;
                    }
                });

                const maxVal = Math.max(...Object.values(hoursMap));
                const safeMax = maxVal === 0 ? 10 : maxVal;

                chartContainer.innerHTML = `
                    <div class="absolute left-0 top-0 bottom-0 w-8 flex flex-col justify-between text-[8px] text-gray-600 font-bold py-2 pointer-events-none">
                        <span>${safeMax}</span>
                        <span>${Math.round(safeMax/2)}</span>
                        <span>0</span>
                    </div>`;
                
                labelsContainer.innerHTML = "";

                Object.keys(hoursMap).forEach(h => {
                    const count = hoursMap[h];
                    const heightPercent = (count / safeMax) * 100;
                    const bar = document.createElement('div');
                    bar.className = "flex-1 mx-0.5 rounded-t-sm transition-all duration-500 hover:bg-red-500 relative group";
                    bar.style.height = `${Math.max(5, heightPercent)}%`;
                    bar.style.backgroundColor = `rgba(220, 38, 38, ${Math.max(0.2, count/safeMax)})`;
                    bar.innerHTML = `<div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-1 bg-black text-white text-[8px] font-bold px-1 rounded opacity-0 group-hover:opacity-100 whitespace-nowrap">${count}</div>`;
                    chartContainer.appendChild(bar);

                    if (h % 2 === 0 || h == 7) { 
                        const lbl = document.createElement('div');
                        lbl.innerText = `${h}h`;
                        lbl.className = "flex-1 text-center";
                        labelsContainer.appendChild(lbl);
                    } else {
                        labelsContainer.appendChild(document.createElement('div'));
                    }
                });
            }

            if (window.lucide) lucide.createIcons();
        }

        async function fetchAlumnos() {
			const d = await apiFetch('/alumnos');
			state.alumnos = Array.isArray(d) ? d : [];

			// 1. TRANSFORMACIÓN VISUAL DEL DASHBOARD (Mini Lista)
			// Buscamos la tabla original para reemplazarla por nuestro nuevo diseño de filas
			const dashTable = document.querySelector('#admin-dashboard-layout table');
			const dashListId = 'dash-alumnos-list-view';
			let dashContainer = document.getElementById(dashListId);

			// Si todavía existe la tabla (primera carga), la reemplazamos por un DIV contenedor
			if (!dashContainer && dashTable) {
				dashContainer = document.createElement('div');
				dashContainer.id = dashListId;
				dashContainer.className = "flex flex-col gap-2"; // Espacio entre filas
				// Reemplazamos la tabla entera (y sus cabeceras) por nuestra lista limpia
				if (dashTable.parentNode) dashTable.parentNode.replaceChild(dashContainer, dashTable);
			}

			if (dashContainer) {
				const topAlumnos = state.alumnos.slice(0, 5); // Solo mostramos los 5 recientes en dashboard
				if (topAlumnos.length === 0) {
					dashContainer.innerHTML = '<p class="text-center text-gray-500 italic text-[11px] py-4">No hay alumnos recientes.</p>';
				} else {
					dashContainer.innerHTML = topAlumnos.map(a => createAlumnoRow(a, 'dashboard')).join('');
				}
			}

			// 2. TRANSFORMACIÓN VISUAL DE LA SECCIÓN ALUMNOS (Lista Completa)
			const fullTable = document.querySelector('#view-alumnos table');
			const fullListId = 'full-alumnos-list-view';
			let fullContainer = document.getElementById(fullListId);

			if (!fullContainer && fullTable) {
				fullContainer = document.createElement('div');
				fullContainer.id = fullListId;
				fullContainer.className = "flex flex-col gap-3"; // Más espacio en la vista completa
				if (fullTable.parentNode) fullTable.parentNode.replaceChild(fullContainer, fullTable);
			}

			if (fullContainer) {
				if (state.alumnos.length === 0) {
					fullContainer.innerHTML = '<div class="text-center py-10"><i data-lucide="users" class="w-12 h-12 text-gray-600 mx-auto mb-4"></i><p class="text-gray-500 italic">No hay alumnos registrados.</p></div>';
				} else {
					fullContainer.innerHTML = state.alumnos.map(a => createAlumnoRow(a, 'full')).join('');
				}
			}

			if (window.lucide) lucide.createIcons();
			applyPermissions(); // Re-aplicamos permisos para ocultar botones de editar a quien no corresponda
		}

		// --- REEMPLAZA TU FUNCIÓN loadStaff POR ESTA NUEVA VERSIÓN VISUAL ---
		async function loadStaff() {
			// 1. Obtener datos
			const [p, a] = await Promise.all([
				apiFetch('/profesores'),
				apiFetch('/administrativos')
			]);
			state.profesores = Array.isArray(p) ? p : [];
			state.administrativos = Array.isArray(a) ? a : [];

			// 2. TRANSFORMACIÓN VISUAL: PROFESORES
			const profTable = document.querySelector('#view-profesores table');
			const profListId = 'profesores-list-view';
			let profContainer = document.getElementById(profListId);

			// Si existe la tabla antigua, la reemplazamos por el contenedor de tarjetas
			if (!profContainer && profTable) {
				profContainer = document.createElement('div');
				profContainer.id = profListId;
				profContainer.className = "flex flex-col gap-3";
				if (profTable.parentNode) profTable.parentNode.replaceChild(profContainer, profTable);
			}

			if (profContainer) {
				if (state.profesores.length === 0) {
					profContainer.innerHTML = '<div class="text-center py-10"><i data-lucide="user-x" class="w-12 h-12 text-gray-600 mx-auto mb-4"></i><p class="text-gray-500 italic">No hay profesores registrados.</p></div>';
				} else {
					profContainer.innerHTML = state.profesores.map(u => createStaffRow(u, 'Profesor')).join('');
				}
			}

			// 3. TRANSFORMACIÓN VISUAL: ADMINISTRATIVOS
			const admTable = document.querySelector('#view-administrativos table');
			const admListId = 'administrativos-list-view';
			let admContainer = document.getElementById(admListId);

			if (!admContainer && admTable) {
				admContainer = document.createElement('div');
				admContainer.id = admListId;
				admContainer.className = "flex flex-col gap-3";
				if (admTable.parentNode) admTable.parentNode.replaceChild(admContainer, admTable);
			}

			if (admContainer) {
				if (state.administrativos.length === 0) {
					admContainer.innerHTML = '<div class="text-center py-10"><i data-lucide="shield-alert" class="w-12 h-12 text-gray-600 mx-auto mb-4"></i><p class="text-gray-500 italic">No hay administrativos registrados.</p></div>';
				} else {
					admContainer.innerHTML = state.administrativos.map(u => createStaffRow(u, 'Administracion')).join('');
				}
			}

			// Actualizar selectores en modales (como en crear clase)
			const coachSelect = document.getElementById('cl-coach-select');
			if (coachSelect) {
				coachSelect.innerHTML = '<option value="">Seleccionar Coach</option>' + 
					state.profesores.map(x => `<option value="${x.nombre_completo}">${x.nombre_completo}</option>`).join('');
			}

			if (window.lucide) lucide.createIcons();
			applyPermissions(); // Asegurar que solo Admin/Supervisor vea los botones de editar
		}

			// --- NUEVA FUNCIÓN AUXILIAR PARA CREAR TARJETAS DE STAFF ---
			function createStaffRow(u, type) {
				const initials = u.nombre_completo ? u.nombre_completo.split(' ').map(n=>n[0]).join('').substring(0,2).toUpperCase() : "??";
				const roleLabel = type === 'Profesor' ? 'Coach / Especialidad' : 'Cargo / Función';
				const roleValue = u.especialidad || (type === 'Profesor' ? 'Entrenador General' : 'Administrativo');
				
				// Icono según tipo
				const icon = type === 'Profesor' ? 'dumbbell' : 'shield-check';

				return `
				<div class="glass-card p-4 rounded-3xl border-white/5 flex flex-col md:flex-row md:items-center gap-4 hover:border-red-600/20 transition-all group relative overflow-hidden">
					<!-- Barra lateral decorativa -->
					<div class="absolute left-0 top-0 bottom-0 w-1 bg-red-600 opacity-30 group-hover:opacity-100 transition-opacity"></div>
					
					<!-- Info Principal -->
					<div class="flex items-center gap-4 flex-1">
						<div class="w-12 h-12 rounded-2xl bg-white/5 border border-white/10 flex items-center justify-center font-black text-white text-sm italic shadow-lg group-hover:bg-red-600 group-hover:text-black transition-colors">
							${initials}
						</div>
						<div>
							<h4 class="text-sm font-black uppercase italic text-white group-hover:text-red-500 transition-colors">${u.nombre_completo}</h4>
							<div class="flex flex-wrap gap-x-4 gap-y-1 mt-1">
								<p class="text-[10px] text-gray-500 font-bold flex items-center gap-1"><i data-lucide="id-card" class="w-3 h-3"></i> ${u.dni}</p>
								${u.email ? `<p class="text-[10px] text-gray-500 font-bold flex items-center gap-1"><i data-lucide="mail" class="w-3 h-3"></i> ${u.email}</p>` : ''}
							</div>
						</div>
					</div>

					<!-- Rol / Especialidad -->
					<div class="flex flex-wrap items-center gap-6 md:justify-center border-t md:border-t-0 md:border-l border-white/5 pt-3 md:pt-0 md:pl-6">
						<div class="min-w-[150px]">
							<p class="text-[9px] text-gray-500 font-black uppercase tracking-widest mb-1 flex items-center gap-1">
								<i data-lucide="${icon}" class="w-3 h-3 text-red-600"></i> ${roleLabel}
							</p>
							<p class="text-[11px] font-black uppercase italic text-white truncate max-w-[200px]">${roleValue}</p>
						</div>
					</div>

					<!-- Acciones -->
					<div class="flex items-center justify-end border-t md:border-t-0 md:border-l border-white/5 pt-3 md:pt-0 md:pl-6 min-w-[100px]">
						<button onclick="openEditStaff(${u.id}, '${type}')" class="px-5 py-2.5 bg-white/5 text-white rounded-xl text-[10px] font-black uppercase italic hover:bg-white/10 hover:text-red-500 transition-all flex items-center gap-2 shadow-lg action-col">
							<i data-lucide="settings-2" class="w-3.5 h-3.5"></i>
							<span>Editar</span>
						</button>
					</div>
				</div>`;
			}
		
		/**
		 * GESTIÓN AVANZADA DE ALUMNOS (PUNTO 5)
		 * Incluye: Buscador, Filtros de Estado y Paginación (20 por hoja)
		 */

		// 1. Inicialización de variables de estado (asegurar que existan)
		if (!state.alumnosPage) state.alumnosPage = 1;
		if (!state.alumnosLimit) state.alumnosLimit = 20;
		if (!state.alumnosSearch) state.alumnosSearch = "";
		if (!state.alumnosStatusFilter) state.alumnosStatusFilter = "todos";

		/**
		 * Función Principal de Renderizado
		 */
		function renderAlumnos() {
			const container = document.getElementById('alumnos-list-view');
			if (!container) return;

			const hoy = new Date().toISOString().split('T')[0];

			// --- PASO A: FILTRADO ---
			let filtrados = state.alumnos.filter(a => {
				const matchesSearch = (a.nombre_completo || "").toLowerCase().includes(state.alumnosSearch.toLowerCase()) || 
									  String(a.dni || "").includes(state.alumnosSearch);
				
				const isActive = a.fecha_vencimiento && a.fecha_vencimiento >= hoy;
				
				let matchesStatus = true;
				if (state.alumnosStatusFilter === "activos") matchesStatus = isActive;
				if (state.alumnosStatusFilter === "vencidos") matchesStatus = !isActive;

				return matchesSearch && matchesStatus;
			});

			// --- PASO B: PAGINACIÓN ---
			const totalItems = filtrados.length;
			const totalPages = Math.ceil(totalItems / state.alumnosLimit) || 1;
			if (state.alumnosPage > totalPages) state.alumnosPage = totalPages;

			const inicio = (state.alumnosPage - 1) * state.alumnosLimit;
			const paginados = filtrados.slice(inicio, inicio + state.alumnosLimit);

			// --- PASO C: UI DE FILTROS (FIX COLOR ROJO) ---
			document.querySelectorAll('.filter-btn').forEach(btn => {
				btn.classList.remove('bg-red-600', 'text-black');
				btn.classList.add('text-gray-500');
			});
			
			const activeFilterBtn = document.getElementById('filter-' + state.alumnosStatusFilter);
			if (activeFilterBtn) {
				activeFilterBtn.classList.remove('text-gray-500');
				activeFilterBtn.classList.add('bg-red-600', 'text-black');
			}

			// --- PASO D: RENDERIZADO DE CONTENIDO ---
			if (paginados.length === 0) {
				container.innerHTML = `
					<div class="py-20 text-center opacity-20">
						<i data-lucide="shield-off" class="w-16 h-16 mx-auto mb-4"></i>
						<p class="font-black uppercase italic tracking-widest">No se encontraron guerreros en esta categoría</p>
					</div>`;
			} else {
				container.innerHTML = paginados.map(a => createAlumnoRow(a, 'listado')).join('');
			}

			// --- PASO E: ACTUALIZAR PAGINACIÓN Y ICONOS ---
			updatePaginationUI(totalPages, totalItems);
			if (window.lucide) lucide.createIcons();
			
			// Aplicar permisos para ocultar botones de edición según el rol
			if (typeof applyPermissions === 'function') applyPermissions();
		}
		
		/**
		 * UI de Paginación Superior
		 */
		function updatePaginationUI(total, items) {
			const pagContainer = document.getElementById('alumnos-pagination');
			if (!pagContainer) return;

			const start = items === 0 ? 0 : (state.alumnosPage - 1) * state.alumnosLimit + 1;
			const end = Math.min(state.alumnosPage * state.alumnosLimit, items);

			pagContainer.innerHTML = `
				<p class="text-[10px] font-black text-gray-400 uppercase italic">
					Mostrando <span class="text-white">${start}-${end}</span> de <span class="text-red-500">${items}</span> guerreros
				</p>
				<div class="flex items-center gap-3">
					<button onclick="changeAlumnosPage(${state.alumnosPage - 1})" ${state.alumnosPage === 1 ? 'disabled' : ''} 
						class="p-2 rounded-xl bg-white/5 text-gray-400 hover:bg-red-600 hover:text-black transition-all disabled:opacity-5">
						<i data-lucide="chevron-left" class="w-4 h-4"></i>
					</button>
					
					<span class="text-[10px] font-black px-4 italic bg-white/5 py-2 rounded-lg border border-white/5">
						HOJA <span class="text-red-600">${state.alumnosPage}</span> / ${total}
					</span>
					
					<button onclick="changeAlumnosPage(${state.alumnosPage + 1})" ${state.alumnosPage === total ? 'disabled' : ''} 
						class="p-2 rounded-xl bg-white/5 text-gray-400 hover:bg-red-600 hover:text-black transition-all disabled:opacity-5">
						<i data-lucide="chevron-right" class="w-4 h-4"></i>
					</button>
				</div>
			`;
			if (window.lucide) lucide.createIcons();
		}

		/**
		 * CONTROLES DE PAGINACIÓN ESTÉTICOS
		 */
		function renderPaginationControls(totalPages, totalItems) {
			let paginationContainer = document.getElementById('alumnos-pagination');
			
			// Si no existe el contenedor en el HTML, lo creamos dinámicamente al final de la vista
			if (!paginationContainer) {
				const view = document.getElementById('view-alumnos');
				paginationContainer = document.createElement('div');
				paginationContainer.id = 'alumnos-pagination';
				paginationContainer.className = "flex items-center justify-between mt-8 px-6 py-4 glass-card rounded-2xl border-white/5";
				view.appendChild(paginationContainer);
			}

			const inicioMostrado = totalItems === 0 ? 0 : (state.alumnosPage - 1) * state.alumnosLimit + 1;
			const finMostrado = Math.min(state.alumnosPage * state.alumnosLimit, totalItems);

			paginationContainer.innerHTML = `
				<p class="text-[10px] font-black text-gray-500 uppercase italic">
					Mostrando <span class="text-white">${inicioMostrado}-${finMostrado}</span> de <span class="text-white">${totalItems}</span> Guerreros
				</p>
				
				<div class="flex items-center gap-2">
					<button onclick="changeAlumnosPage(${state.alumnosPage - 1})" 
							${state.alumnosPage === 1 ? 'disabled' : ''} 
							class="p-2 rounded-xl bg-white/5 hover:bg-red-600 hover:text-black transition-all disabled:opacity-10 disabled:pointer-events-none">
						<i data-lucide="chevron-left" class="w-4 h-4"></i>
					</button>
					
					<div class="flex items-center gap-1">
						${generatePageButtons(totalPages, state.alumnosPage)}
					</div>

					<button onclick="changeAlumnosPage(${state.alumnosPage + 1})" 
							${state.alumnosPage === totalPages ? 'disabled' : ''} 
							class="p-2 rounded-xl bg-white/5 hover:bg-red-600 hover:text-black transition-all disabled:opacity-10 disabled:pointer-events-none">
						<i data-lucide="chevron-right" class="w-4 h-4"></i>
					</button>
				</div>
			`;
			if (window.lucide) lucide.createIcons();
		}

		function generatePageButtons(total, current) {
			let html = "";
			// Solo mostramos hasta 5 páginas para no romper el diseño
			for (let i = 1; i <= total; i++) {
				if (total > 5 && (i > 2 && i < total - 1 && Math.abs(i - current) > 1)) {
					if (i === 3 || i === total - 1) html += `<span class="text-gray-700 px-1">...</span>`;
					continue;
				}
				html += `
					<button onclick="changeAlumnosPage(${i})" 
						class="w-8 h-8 rounded-lg text-[10px] font-black transition-all ${i === current ? 'viking-bg-red text-black' : 'bg-white/5 text-gray-400 hover:bg-white/10'}">
						${i}
					</button>`;
			}
			return html;
		}

		function changeAlumnosPage(p) {
			state.alumnosPage = p;
			renderAlumnos();
			const view = document.getElementById('view-alumnos');
			if (view) view.scrollIntoView({ behavior: 'smooth' });
		}

		/**
		 * FUNCIONES DE FILTRADO (Vincular a los inputs)
		 */
		function handleAlumnosSearch(val) {
			state.alumnosSearch = val;
			state.alumnosPage = 1; // Reiniciar a página 1 al buscar
			renderAlumnos();
		}

		function handleAlumnosStatusFilter(val) {
			state.alumnosStatusFilter = val;
			state.alumnosPage = 1;
			renderAlumnos();
		}

		/**
		 * Creación de Tarjeta de Alumno Premium
		 */
		function createAlumnoRow(a, type) {
			const initials = a.nombre_completo ? a.nombre_completo.split(' ').filter(n=>n).map(n=>n[0]).join('').substring(0,2).toUpperCase() : "??";
			const planName = a.plan?.nombre || 'SIN PLAN ACTIVO';
			const hoy = new Date().toISOString().split('T')[0];
			const isActive = a.fecha_vencimiento && a.fecha_vencimiento >= hoy;
			
			const statusColor = isActive ? 'text-green-500' : 'text-red-500';
			const statusText = isActive ? 'ACTIVO' : 'VENCIDO';
			const statusBg = isActive ? 'bg-green-500/10 border-green-500/20' : 'bg-red-500/10 border-red-500/20';

			if (type === 'dashboard') {
				return `
				<div class="glass-card p-3 rounded-2xl border-white/5 flex items-center justify-between hover:bg-white/5 transition-colors group">
					<div class="flex items-center gap-3">
						<div class="w-8 h-8 rounded-lg viking-bg-red flex items-center justify-center font-black text-black text-[10px] italic shadow-md">${initials}</div>
						<div class="flex flex-col">
							<h4 class="text-[10px] font-black uppercase italic text-white group-hover:text-red-500 leading-none mb-1">${a.nombre_completo}</h4>
							<span class="text-[7px] px-1.5 py-0.5 rounded w-fit ${statusBg} ${statusColor} font-black uppercase tracking-wider">${statusText}</span>
						</div>
					</div>
					<button onclick="openEditAlumno(${a.id})" class="w-7 h-7 flex items-center justify-center bg-white/5 text-gray-400 rounded-lg hover:bg-white/10 hover:text-white action-col">
						<i data-lucide="edit-2" class="w-3.5 h-3.5"></i>
					</button>
				</div>`;
			} else {
				return `
				<div class="glass-card p-6 rounded-[2.5rem] border-white/5 flex flex-col lg:flex-row lg:items-center gap-6 hover:border-red-600/30 transition-all group relative overflow-hidden mb-3">
					<!-- Barra de estado lateral -->
					<div class="absolute left-0 top-0 bottom-0 w-1.5 ${isActive ? 'bg-green-500' : 'bg-red-500'} opacity-40 group-hover:opacity-100 transition-opacity"></div>
					
					<!-- Info Identidad -->
					<div class="flex items-center gap-5 flex-[1.2]">
						<div class="w-14 h-14 rounded-2xl viking-bg-red flex items-center justify-center font-black text-black text-lg italic shadow-xl group-hover:scale-110 transition-transform">
							${initials}
						</div>
						<div class="min-w-0">
							<h4 class="text-base font-black uppercase italic text-white group-hover:text-red-500 truncate">${a.nombre_completo}</h4>
							<p class="text-[10px] text-gray-500 font-bold flex items-center gap-1.5 mt-1">
								<i data-lucide="id-card" class="w-3.5 h-3.5 text-red-600"></i> DNI: ${a.dni}
							</p>
						</div>
					</div>

					<!-- Info Plan (Ampliado) -->
					<div class="flex flex-wrap items-center gap-8 border-t lg:border-t-0 lg:border-l border-white/10 pt-4 lg:pt-0 lg:pl-8 flex-[1.6]">
						<div class="flex-1 min-w-[200px]">
							<p class="text-[9px] text-gray-500 font-black uppercase tracking-widest mb-1">Plan de Entrenamiento</p>
							<p class="text-[13px] font-black uppercase italic text-white leading-tight">${planName}</p>
						</div>
						<div class="min-w-[90px]">
							<p class="text-[9px] text-gray-500 font-black uppercase tracking-widest mb-1">Estado</p>
							<span class="text-[10px] px-3 py-1.5 rounded-xl ${statusBg} ${statusColor} font-black uppercase tracking-widest border border-white/5">${statusText}</span>
						</div>
					</div>

					<!-- Fechas Críticas -->
					<div class="flex items-center gap-6 justify-between lg:justify-end border-t lg:border-t-0 lg:border-l border-white/10 pt-4 lg:pt-0 lg:pl-8 flex-[1.2]">
						<div class="flex gap-6 text-right">
							<div class="flex flex-col">
								<span class="text-[8px] text-gray-600 font-black uppercase tracking-tighter">Activación</span>
								<span class="text-[11px] font-bold text-gray-400 italic">${a.fecha_ultima_renovacion || '--/--/--'}</span>
							</div>
							<div class="flex flex-col">
								<span class="text-[8px] text-red-600 font-black uppercase tracking-tighter">Vencimiento</span>
								<span class="text-[13px] font-black text-white italic tracking-wide">${a.fecha_vencimiento || '--/--/--'}</span>
							</div>
						</div>
						
						<!-- Botón Editar con icono edit-3 -->
						<button onclick="openEditAlumno(${a.id})" class="p-4 bg-white/5 text-white rounded-2xl hover:bg-red-600 hover:text-black transition-all action-col border border-white/5 shadow-xl">
							<i data-lucide="edit-3" class="w-5 h-5"></i>
						</button>
					</div>
				</div>`;
			}
		}

        async function loadPlanes() {
            const p = await apiFetch('/planes'); const t = await apiFetch('/tipos-planes');
            state.planes = Array.isArray(p) ? p : []; state.tiposPlanes = Array.isArray(t) ? t : [];
            const filterContainer = document.getElementById('planes-filter-container'); filterContainer.innerHTML = ''; 
            state.tiposPlanes.forEach((t, idx) => { filterContainer.innerHTML += `<button onclick="filterPlanes(${t.id}, this)" class="filter-btn ${idx === 0 ? 'active' : ''}">${t.nombre}</button>`; });
            if (state.tiposPlanes.length > 0) filterPlanes(state.tiposPlanes[0].id, filterContainer.children[0]);
            document.getElementById('al-plan').innerHTML = '<option value="">Seleccionar Plan</option>' + state.planes.map(p => `<option value="${p.id}">${p.nombre}</option>`).join('');
            document.getElementById('plan-tipo').innerHTML = state.tiposPlanes.map(t => `<option value="${t.id}">${t.nombre}</option>`).join('');
        }

        function filterPlanes(tipoId, btn) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active');
            const filtered = state.planes.filter(p => p.tipo_plan_id === tipoId);
            const hideEdit = (state.user?.rol_nombre === "Profesor" || state.user?.rol_nombre === "Alumno" || state.user?.rol_nombre === "Administracion");
            document.getElementById('planes-container').innerHTML = filtered.map(p => `<div class="glass-card p-8 rounded-[2.5rem] flex flex-col border-red-600/10 relative text-left">${hideEdit ? '' : `<button onclick="openEditPlan(${p.id})" class="absolute top-4 right-4 text-gray-600 hover:text-red-600"><i data-lucide="edit-3" class="w-4 h-4"></i></button>`}<span class="text-[10px] font-black viking-red uppercase italic tracking-widest mb-2">${p.tipo?.nombre || 'PLAN'}</span><h4 class="text-lg font-black uppercase italic mb-6 leading-tight">${p.nombre}</h4><p class="text-3xl font-black italic mb-8">$ ${p.precio.toLocaleString()}</p></div>`).join('');
            lucide.createIcons();
            applyPermissions();
        }

        /**
		 * RENDERIZADO DE STOCK CON IMÁGENES (PUNTO 5)
		 */
		async function loadStock() {
			const data = await apiFetch('/stock');
			state.stock = Array.isArray(data) ? data : [];

			const container = document.getElementById('stock-container');
			if (!container) return;

			if (state.stock.length === 0) {
				container.innerHTML = `
					<div class="col-span-full py-20 text-center opacity-20">
						<i data-lucide="package-x" class="w-16 h-16 mx-auto mb-4"></i>
						<p class="font-black uppercase italic tracking-widest">El Valhalla no tiene provisiones</p>
					</div>`;
			} else {
				container.innerHTML = state.stock.map(s => {
					const stockBajo = s.stock_actual <= 5;
					// Buscamos la imagen en ambos campos posibles
					const rawImg = s.url_imagen || s.imagen || "";
					const hasImg = rawImg && rawImg.length > 100; // Un Base64 real es largo
					const imgUrl = hasImg ? rawImg : 'https://images.unsplash.com/photo-1583417319070-4a69db38a482?q=80&w=400&auto=format&fit=crop';
					
					return `
					<div class="glass-card p-4 rounded-[2.5rem] border-white/5 flex flex-col gap-4 hover:border-red-600/30 transition-all group relative overflow-hidden shadow-xl">
						<!-- Foto del Producto -->
						<div class="w-full h-40 rounded-[1.8rem] overflow-hidden bg-black/40 relative">
							<img src="${imgUrl}" class="w-full h-full object-cover opacity-70 group-hover:opacity-100 transition-all duration-700"
								 onerror="this.src='https://images.unsplash.com/photo-1583417319070-4a69db38a482?q=80&w=400&auto=format&fit=crop'">
							<div class="absolute top-3 right-3 bg-black/70 backdrop-blur-xl px-3 py-1.5 rounded-xl border border-white/10 text-[11px] font-black text-white italic">
								$${s.precio_venta}
							</div>
						</div>

						<!-- Datos y Botón Editar -->
						<div class="px-2 pb-2">
							<h4 class="text-[13px] font-black uppercase italic text-white truncate mb-3 tracking-tight">${s.nombre_producto}</h4>
							<div class="flex items-center justify-between">
								<div class="flex flex-col">
									<span class="text-[8px] text-gray-500 font-black uppercase tracking-widest leading-none mb-1">Existencias</span>
									<span class="text-sm font-black italic ${stockBajo ? 'text-red-500 animate-pulse' : 'text-white'}">
										${s.stock_actual} <span class="text-[9px] opacity-40 uppercase">unid.</span>
									</span>
								</div>
								
								<!-- LÁPIZ CENTRADO (GRID + P-0) -->
								<button onclick="openEditStock(${s.id})" 
										class="w-10 h-10 grid place-items-center bg-white/5 rounded-xl border border-white/5 text-gray-400 hover:bg-red-600 hover:text-black hover:scale-110 transition-all action-col p-0">
									<i data-lucide="edit-3" class="w-5 h-5"></i>
								</button>
							</div>
						</div>
					</div>`;
				}).join('');
			}
			if (window.lucide) lucide.createIcons();
			if (typeof applyPermissions === 'function') applyPermissions();
		}
		
		// FUNCIÓN PARA PREVISUALIZAR Y CONVERTIR A BASE64
		function previewStockImage(event) {
			const file = event.target.files[0];
			if (!file) return;

			if (file.size > 2 * 1024 * 1024) { // Límite 2MB
				showVikingToast("La imagen es muy pesada (Máx 2MB)", true);
				return;
			}

			const reader = new FileReader();
			reader.onload = function(e) {
				const base64 = e.target.result;
				document.getElementById('stock-imagen-base64').value = base64;
				
				const preview = document.getElementById('stock-img-preview');
				preview.src = base64;
				preview.classList.remove('hidden');
				document.getElementById('stock-img-placeholder').classList.add('hidden');
			};
			reader.readAsDataURL(file);
		}

        async function loadClases() {
			// 1. Pedir datos al servidor
			const data = await apiFetch('/clases'); 
			state.clases = Array.isArray(data) ? data : [];

			// 2. Localizar el contenedor en el HTML
			const container = document.getElementById('clases-container');
			if (!container) return;

			// 3. Si no hay clases, mostrar mensaje de vacío
			if (state.clases.length === 0) {
				container.innerHTML = `
					<div class="col-span-3 p-16 border border-dashed border-white/10 rounded-[3rem] text-center bg-white/2">
						<p class="text-[12px] text-gray-600 font-black uppercase italic tracking-[0.2em]">No hay clases configuradas</p>
						<p class="text-[10px] text-gray-700 mt-2 font-bold">Usa el botón "Alta de Clase" para comenzar.</p>
					</div>`;
			} else {
				// 4. Dibujar las tarjetas (Solo con info técnica y botón de editar)
				const canEdit = (state.user?.rol_nombre === "Administrador" || state.user?.rol_nombre === "Supervisor");
				
				container.innerHTML = state.clases.map(c => `
					<div class="glass-card p-6 rounded-[2.5rem] border-white/5 flex flex-col justify-between hover:border-red-600/20 transition-all group">
						<div>
							<div class="flex items-center gap-4 mb-6">
								<!-- Icono con el color de la clase -->
								<div class="w-12 h-12 rounded-2xl flex items-center justify-center font-black text-black text-sm italic shadow-lg" style="background-color: ${c.color || '#FF0000'}">
									${c.nombre ? c.nombre[0].toUpperCase() : '?'}
								</div>
								<div>
									<h4 class="text-sm font-black uppercase italic text-white group-hover:text-red-500 transition-colors">${c.nombre}</h4>
									<p class="text-[10px] text-gray-500 font-bold uppercase tracking-wider flex items-center gap-1">
										<i data-lucide="user" class="w-3 h-3"></i> ${c.coach || 'Sin Coach'}
									</p>
								</div>
							</div>
						</div>

						<!-- Botón de edición: Solo aparece para Admin/Supervisor -->
						${canEdit ? `
						<button onclick="openEditClase(${c.id})" class="w-full py-4 bg-white/5 text-white rounded-2xl text-[10px] font-black uppercase italic hover:bg-white/10 hover:text-red-600 transition-all flex items-center justify-center gap-2 border border-white/5">
							<i data-lucide="settings-2" class="w-3.5 h-3.5"></i>
							Configuración Técnica
						</button>
						` : '<p class="text-[9px] text-gray-700 italic text-center">Solo lectura</p>'}
					</div>
				`).join('');
			}

			// 5. Refrescar iconos y otros componentes
			lucide.createIcons();
			if(document.getElementById('view-calendario')?.classList.contains('active')) renderCalendar();
			applyPermissions();
		}
		
		async function loadProfesores() {
			// Esta función llena la memoria con los profesores para usarlos en el select de turnos
			const res = await apiFetch('/profesores');
			state.profesores = (!res.error && Array.isArray(res)) ? res : [];
		}

        function openModalAlumno() { document.getElementById('modal-alumno-title').innerText = "Nuevo Alumno"; document.getElementById('al-id').value = ""; document.getElementById('al-fecha-renovacion').value = new Date().toISOString().split('T')[0]; openModal('modal-alumno'); }
        function openEditAlumno(id) {
            const al = state.alumnos.find(x => x.id == id); if(!al) return;
            document.getElementById('modal-alumno-title').innerText = "Editar Alumno";
            document.getElementById('al-id').value = al.id; document.getElementById('al-nombre').value = al.nombre_completo; document.getElementById('al-dni').value = al.dni;
            document.getElementById('al-email').value = al.email || ""; document.getElementById('al-plan').value = al.plan_id || ""; document.getElementById('al-peso').value = al.peso || "";
            document.getElementById('al-altura').value = al.altura || ""; document.getElementById('al-imc').value = al.imc || ""; document.getElementById('al-fecha-renovacion').value = al.fecha_ultima_renovacion || "";
            document.getElementById('al-fecha-vencimiento').value = al.fecha_vencimiento || "";
			// Carga de nuevos campos de salud
			document.getElementById('al-fecha-nacimiento').value = al.fecha_nacimiento || "";
			document.getElementById('al-fecha-certificado').value = al.fecha_certificado || "";
			document.getElementById('al-certificado-entregado').checked = al.certificado_entregado || false;
            const delBtn = document.getElementById('btn-delete-alumno'); if(state.user.rol_nombre === "Administrador" || state.user.rol_nombre === "Supervisor") delBtn.classList.remove('hidden');
            delBtn.onclick = () => deleteRecord('alumnos', id, 'modal-alumno', fetchAlumnos);
            openModal('modal-alumno');
        }

        document.getElementById('form-alumno').onsubmit = async (e) => {
            e.preventDefault(); const id = document.getElementById('al-id').value;
            const data = { nombre_completo: document.getElementById('al-nombre').value, dni: document.getElementById('al-dni').value, email: document.getElementById('al-email').value, plan_id: parseInt(document.getElementById('al-plan').value) || null, peso: parseFloat(document.getElementById('al-peso').value) || null, altura: parseFloat(document.getElementById('al-altura').value) || null, imc: parseFloat(document.getElementById('al-imc').value) || null, fecha_ultima_renovacion: document.getElementById('al-fecha-renovacion').value, fecha_vencimiento: document.getElementById('al-fecha-vencimiento').value, fecha_nacimiento: document.getElementById('al-fecha-nacimiento').value || null, fecha_certificado: document.getElementById('al-fecha-certificado').value || null, certificado_entregado: document.getElementById('al-certificado-entregado').checked };
            const pass = document.getElementById('al-pass').value; if(pass) data.password = pass;
            const res = await apiFetch(id ? `/alumnos/${id}` : '/alumnos', id ? 'PUT' : 'POST', data);
            if(!res.error) { closeModal('modal-alumno'); fetchAlumnos(); showVikingToast("Alumno Guardado"); }
        };

        function openModalStaff(rol) { document.getElementById('modal-staff-title').innerText = "Alta " + rol; document.getElementById('stf-id').value = ""; document.getElementById('stf-rol').value = rol; openModal('modal-staff'); }
        function openEditStaff(id, rol) {
            const user = (rol === 'Profesor' ? state.profesores : state.administrativos).find(x => x.id == id); if(!user) return;
            document.getElementById('modal-staff-title').innerText = "Editar " + rol;
            document.getElementById('stf-id').value = user.id; document.getElementById('stf-rol').value = rol;
            document.getElementById('stf-nombre').value = user.nombre_completo; document.getElementById('stf-dni').value = user.dni; document.getElementById('stf-esp').value = user.especialidad || "";
            const delBtn = document.getElementById('btn-delete-staff'); if(state.user.rol_nombre === "Administrador" || state.user.rol_nombre === "Supervisor") delBtn.classList.remove('hidden');
            delBtn.onclick = () => deleteRecord('staff', id, 'modal-staff', loadStaff);
            openModal('modal-staff');
        }

        document.getElementById('form-staff').onsubmit = async (e) => {
            e.preventDefault(); const id = document.getElementById('stf-id').value; const rol = document.getElementById('stf-rol').value;
            const data = { nombre_completo: document.getElementById('stf-nombre').value, dni: document.getElementById('stf-dni').value, especialidad: document.getElementById('stf-esp').value, perfil_nombre: rol };
            const pass = document.getElementById('stf-pass').value; if(pass) data.password = pass;
            const res = await apiFetch(id ? `/staff/${id}` : '/staff', id ? 'PUT' : 'POST', data);
            if(!res.error) { closeModal('modal-staff'); loadStaff(); showVikingToast("Staff Actualizado"); }
        };

        function openModalPlan() { document.getElementById('plan-id').value = ""; document.getElementById('modal-plan-title').innerText = "Nuevo Plan"; openModal('modal-plan'); }
        function openEditPlan(id) {
            const p = state.planes.find(x => x.id == id); if(!p) return;
            document.getElementById('plan-id').value = p.id; document.getElementById('plan-nombre').value = p.nombre; document.getElementById('plan-tipo').value = p.tipo_plan_id; document.getElementById('plan-precio').value = p.precio;
            const delBtn = document.getElementById('btn-delete-plan'); if(state.user.rol_nombre === "Administrador" || state.user.rol_nombre === "Supervisor") delBtn.classList.remove('hidden');
            delBtn.onclick = () => deleteRecord('planes', p.id, 'modal-plan', loadPlanes);
            openModal('modal-plan');
        }

        document.getElementById('form-plan').onsubmit = async (e) => {
            e.preventDefault(); const id = document.getElementById('plan-id').value;
            const data = { nombre: document.getElementById('plan-nombre').value, precio: parseFloat(document.getElementById('plan-precio').value), tipo_plan_id: parseInt(document.getElementById('plan-tipo').value) };
            const res = await apiFetch(id ? `/planes/${id}` : '/planes', id ? 'PUT' : 'POST', data);
            if(!res.error) { closeModal('modal-plan'); loadPlanes(); showVikingToast("Plan Guardado"); }
        };

        // ABRIR MODAL PARA NUEVO PRODUCTO
		function openModalStock() {
			const form = document.getElementById('form-stock');
			if(form) form.reset();
			
			document.getElementById('stock-id').value = "";
			document.getElementById('stock-imagen-base64').value = "";
			document.getElementById('stock-img-preview').classList.add('hidden');
			document.getElementById('stock-img-placeholder').classList.remove('hidden');
			document.getElementById('modal-stock-title').innerText = "Alta de Mercadería";
			
			const delBtn = document.getElementById('btn-delete-stock');
			if(delBtn) delBtn.classList.add('hidden');

			openModal('modal-stock');
		}
		
		function openEditStock(id) {
			const s = state.stock.find(x => x.id == id);
			if (!s) return;

			document.getElementById('stock-id').value = s.id;
			document.getElementById('stock-nombre').value = s.nombre_producto;
			document.getElementById('stock-cant').value = s.stock_actual;
			document.getElementById('stock-precio').value = s.precio_venta;
			
			const base64 = s.url_imagen || s.imagen || "";
			document.getElementById('stock-imagen-base64').value = base64;
			
			const preview = document.getElementById('stock-img-preview');
			if(base64 && base64.length > 100) {
				preview.src = base64;
				preview.classList.remove('hidden');
				document.getElementById('stock-img-placeholder').classList.add('hidden');
			} else {
				preview.classList.add('hidden');
				document.getElementById('stock-img-placeholder').classList.remove('hidden');
			}

			document.getElementById('modal-stock-title').innerText = "Editar Mercadería";
			const delBtn = document.getElementById('btn-delete-stock');
			if(delBtn) {
				delBtn.classList.remove('hidden');
				delBtn.onclick = () => deleteRecord('stock', s.id, 'modal-stock', loadStock);
			}

			openModal('modal-stock');
		}
		
		// 4. GUARDAR CAMBIOS (Vincular al onsubmit del form)
		async function saveStockVikingo(e) {
			if(e && e.preventDefault) e.preventDefault();
			
			const id = document.getElementById('stock-id').value;
			const payload = {
				nombre_producto: document.getElementById('stock-nombre').value,
				stock_actual: parseInt(document.getElementById('stock-cant').value),
				precio_venta: parseFloat(document.getElementById('stock-precio').value),
				url_imagen: document.getElementById('stock-imagen-base64').value 
			};

			// Validaciones básicas
			if(!payload.nombre_producto) return showVikingToast("Falta el nombre", true);

			const method = id ? 'PUT' : 'POST';
			const endpoint = id ? `/stock/${id}` : '/stock';

			showVikingToast("Sincronizando con el Valhalla...");
			const res = await apiFetch(endpoint, method, payload);
			
			if(!res.error) {
				showVikingToast(id ? "Producto Actualizado" : "Producto Registrado");
				closeModal('modal-stock');
				setTimeout(loadStock, 300); // Pequeño delay para asegurar que la DB escribió el Base64
			} else {
				showVikingToast("Error: " + res.error, true);
			}
		}

        document.getElementById('form-stock').onsubmit = async (e) => {
            e.preventDefault(); const id = document.getElementById('stock-id').value;
            const data = { nombre_producto: document.getElementById('stock-nombre').value, stock_actual: parseInt(document.getElementById('stock-cant').value), precio_venta: parseFloat(document.getElementById('stock-precio').value) };
            const res = await apiFetch(id ? `/stock/${id}` : '/stock', id ? 'PUT' : 'POST', data);
            if(!res.error) { closeModal('modal-stock'); loadStock(); showVikingToast("Stock Actualizado"); }
        };

        function openModalClase() { 
            document.getElementById('cl-id').value = ""; 
            document.getElementById('modal-clase-title').innerText = "Alta de Clase";
            openModal('modal-clase'); 
        }

		// --- 1. GENERAR FILA: DÍA + HORA + PROFESOR ---
		function addNewScheduleSlot(data = { dia: 1, horario: 7, coach: "" }) {
			const container = document.getElementById('cl-schedule-slots');
			if (!container) return;

			// Limpiar mensaje de "vacío" si existe
			if (container.querySelector('p.italic')) container.innerHTML = "";

			const row = document.createElement('div');
			// Diseño tipo tarjeta para cada turno
			row.className = "schedule-slot-row flex flex-col gap-2 bg-white/5 p-3 rounded-xl border border-white/5 mb-3 group hover:border-red-600/30 transition-all";
			
			const diasMap = {1: 'Lunes', 2: 'Martes', 3: 'Miércoles', 4: 'Jueves', 5: 'Viernes', 6: 'Sábado'};
			
			// 1. Selector de Días
			let diasOptions = "";
			for(let d=1; d<=6; d++) {
				diasOptions += `<option value="${d}" ${data.dia == d ? 'selected' : ''}>${diasMap[d]}</option>`;
			}

			// 2. Selector de Horas
			let horasOptions = "";
			for(let i=7; i<=21.5; i+=0.5) {
				const label = i % 1 === 0 ? `${i}:00` : `${Math.floor(i)}:30`;
				horasOptions += `<option value="${i}" ${data.horario == i ? 'selected' : ''}>${label} HS</option>`;
			}

			// 3. Selector de Profesores (Usando state.profesores cargado previamente)
			let coachOptions = `<option value="">Asignar Profesor...</option>`;
			if (state.profesores && state.profesores.length > 0) {
				coachOptions += state.profesores.map(p => 
					`<option value="${p.nombre_completo}" ${data.coach === p.nombre_completo ? 'selected' : ''}>${p.nombre_completo}</option>`
				).join('');
			} else {
				coachOptions += `<option value="Staff">Staff General</option>`;
			}

			row.innerHTML = `
				<div class="flex items-center justify-between">
					<span class="text-[9px] font-black text-red-600 uppercase italic tracking-widest">Turno</span>
					<button type="button" onclick="this.closest('.schedule-slot-row').remove()" class="text-gray-500 hover:text-red-500 transition-all">
						<i data-lucide="x" class="w-4 h-4"></i>
					</button>
				</div>
				<div class="grid grid-cols-2 gap-2">
					<select class="viking-input py-1 h-9 text-[10px] slot-dia bg-black/40 border-white/10">${diasOptions}</select>
					<select class="viking-input py-1 h-9 text-[10px] slot-hora bg-black/40 border-white/10">${horasOptions}</select>
				</div>
				<div class="w-full">
					<select class="viking-input py-1 h-9 text-[10px] w-full slot-coach bg-black/40 border-white/10 text-gray-300">
						${coachOptions}
					</select>
				</div>
			`;
			container.appendChild(row);
			if(window.lucide) lucide.createIcons();
		}

		// --- ABRIR EDICIÓN (Cargar slots con sus profes) ---
		function openEditClase(id) {
			const c = state.clases.find(x => x.id == id); 
			if(!c) return;

			document.getElementById('cl-id').value = c.id; 
			document.getElementById('modal-clase-title').innerText = "Editar: " + c.nombre;
			document.getElementById('cl-nombre').value = c.nombre; 
			document.getElementById('cl-cupo').value = c.capacidad_max;
			document.getElementById('cl-color').value = c.color || "#FF0000";
			
			// Limpiar y cargar horarios
			const slotsContainer = document.getElementById('cl-schedule-slots');
			slotsContainer.innerHTML = "";

			const horarios = Array.isArray(c.horarios_detalle) ? c.horarios_detalle : [];
			
			if (horarios.length > 0) {
				horarios.forEach(h => addNewScheduleSlot(h));
			} else {
				// Compatibilidad: si es clase vieja, usamos el coach general
				addNewScheduleSlot({ dia: 1, horario: 7, coach: c.coach || "" });
			}

			// Mostrar botón eliminar solo a admin
			const isAdmin = (state.user?.rol_nombre === "Administrador" || state.user?.rol_nombre === "Supervisor");
			const delBtn = document.getElementById('btn-delete-clase'); 
			if(delBtn) {
				delBtn.classList.toggle('hidden', !isAdmin);
				delBtn.onclick = () => deleteRecord('clases', c.id, 'modal-clase', loadClases);
			}

			openModal('modal-clase');
		}

		// --- 3. FUNCIÓN PARA PREPARAR EL MODAL AL CREAR NUEVA ---
		function openNewClase() {
			document.getElementById('form-clase').reset();
			document.getElementById('cl-id').value = "";
			document.getElementById('cl-schedule-slots').innerHTML = "";
			document.getElementById('modal-clase-title').innerText = "Nueva Clase Vikinga";
			
			// Añadimos el primer slot vacío
			addNewScheduleSlot();
			openModal('modal-clase');
		}

// --- NUEVA FUNCIÓN PARA CARGAR PROFESORES REALES ---
async function loadProfesores() {
    const res = await apiFetch('/profesores');
    if (!res.error) {
        state.profesores = res; // Guardamos en el estado global
    }
}

		// --- GUARDAR CLASE CON MÚLTIPLES PROFESORES ---
		async function saveClaseVikinga(e) {
			if(e) e.preventDefault();
			
			const id = document.getElementById('cl-id').value;
			const slotRows = document.querySelectorAll('.schedule-slot-row');
			
			// Recolectar datos de cada tarjeta de turno
			const horarios_detalle = [];
			slotRows.forEach(row => {
				const diaEl = row.querySelector('.slot-dia');
				const horaEl = row.querySelector('.slot-hora');
				const coachEl = row.querySelector('.slot-coach'); // Nuevo campo
				
				if(diaEl && horaEl) {
					horarios_detalle.push({
						dia: parseInt(diaEl.value),
						horario: parseFloat(horaEl.value),
						coach: coachEl ? coachEl.value : "Staff" // Guardamos el profe específico
					});
				}
			});

			if(horarios_detalle.length === 0) {
				return showVikingToast("Añade al menos un horario", true);
			}

			// Usamos el coach del primer turno como "coach principal" para compatibilidad en tablas viejas
			const mainCoach = horarios_detalle[0].coach || "Staff";

			const payload = {
				nombre: document.getElementById('cl-nombre').value,
				coach: mainCoach, 
				color: document.getElementById('cl-color').value,
				capacidad_max: parseInt(document.getElementById('cl-cupo').value),
				horarios_detalle: horarios_detalle
			};

			const method = id ? 'PUT' : 'POST';
			const endpoint = id ? `/clases/${id}` : '/clases';
			const res = await apiFetch(endpoint, method, payload);
			
			if(!res.error) {
				showVikingToast(id ? "Clase Actualizada" : "Clase Creada");
				closeModal('modal-clase');
				loadClases();
			} else {
				showVikingToast("Error: " + res.error, true);
			}
		}

		// --- 5. VINCULACIÓN DE EVENTOS AL CARGAR LA PÁGINA ---
		window.onload = () => {
			// Vincular el submit del formulario
			const formClase = document.getElementById('form-clase');
			if(formClase) {
				formClase.onsubmit = saveClaseVikinga;
			}
			
			// Cargar iconos de Lucide
			if(window.lucide) lucide.createIcons();
		};
    

        async function handleDrop(e, dia, horario) { e.preventDefault(); const id = e.dataTransfer.getData("clase_id"); if (!id) return; const res = await apiFetch(`/clases/${id}/move`, 'PUT', { dia, horario }); if (!res.error) { loadClases(); showVikingToast("Clase Reubicada"); } }
        
        async function deleteRecord(entity, id, modalId, callback) { if(!confirm("¿Deseas eliminar este registro?")) return; const res = await apiFetch(`/${entity}/${id}`, 'DELETE'); if(!res.error) { closeModal(modalId); callback(); showVikingToast("Registro Eliminado", true); } }
        
        async function handleProfileUpdate(e) { 
            e.preventDefault(); 
            const pass = document.getElementById('prof-input-pass').value; 
            const isAlumno = state.user.rol_nombre === 'Alumno';
            
            let data = { 
                nombre_completo: document.getElementById('prof-input-name').value, 
                dni: String(document.getElementById('prof-input-dni').value), 
                email: document.getElementById('prof-input-email').value
            }; 

            if(pass) data.password = pass; 
            let endpoint = "";

            if (isAlumno) {
                endpoint = `/alumnos/${state.user.id}`;
                data.plan_id = state.user.plan_id || state.user.plan?.id;
                data.peso = parseFloat(document.getElementById('prof-input-peso').value) || null;
                data.altura = parseFloat(document.getElementById('prof-input-altura').value) || null;
                data.imc = parseFloat(document.getElementById('prof-input-imc').value) || null;
            } else {
                endpoint = `/staff/${state.user.id}`;
                data.perfil_nombre = state.user.rol_nombre;
            }

            const res = await apiFetch(endpoint, 'PUT', data); 
            if(!res.error) { 
                state.user.nombre_completo = data.nombre_completo; 
                state.user.email = data.email;
                if (isAlumno) {
                    state.user.peso = data.peso;
                    state.user.altura = data.altura;
                    state.user.imc = data.imc;
                }

                document.getElementById('side-user-name').innerText = data.nombre_completo; 
                document.getElementById('prof-name').innerText = data.nombre_completo;
                const initials = data.nombre_completo.split(' ').filter(n => n).map(n => n[0]).join('').toUpperCase();
                document.getElementById('user-initials').innerText = initials;
                document.getElementById('prof-initials-view').innerText = initials;
                
                showVikingToast("Perfil Vikingo Actualizado"); 
                if(isAlumno) renderStudentDashboard();
            } else {
                showVikingToast("Error: " + res.error, true);
            }
        }

        document.getElementById('form-rutina-editor').onsubmit = async (e) => {
            e.preventDefault();
            
            const elAlumnoId = document.getElementById('rutina-editor-alumno-id') || document.getElementById('edit-rutina-user-id');
            const elObjetivo = document.getElementById('rutina-objetivo') || document.getElementById('edit-rutina-objetivo');
            const elVencimiento = document.getElementById('rutina-vencimiento') || document.getElementById('edit-rutina-vencimiento');
            const elNombreGrupo = document.getElementById('rutina-nombre-grupo');
            const elDescripcion = document.getElementById('rutina-descripcion');

            if (!elAlumnoId) {
                console.error("No se encontró el input del ID del alumno. Revisa que el ID en el HTML sea 'rutina-editor-alumno-id'");
                showVikingToast("Error técnico: Campo de ID no encontrado en el HTML", true);
                return;
            }

            const alumnoId = parseInt(elAlumnoId.value);
            
            if (isNaN(alumnoId)) {
                showVikingToast("Error: Debes seleccionar un alumno de la lista", true);
                return;
            }

            const payload = {
                usuario_id: alumnoId,
                nombre_grupo: elNombreGrupo ? elNombreGrupo.value : "Rutina Nueva",
                descripcion: elDescripcion ? elDescripcion.value : "",
                objetivo: elObjetivo ? elObjetivo.value : "Mejora general",
                fecha_vencimiento: elVencimiento ? elVencimiento.value : null,
                dias: []
            };

            const dayCards = document.querySelectorAll('.rutina-dia-card') || document.querySelectorAll('.day-block');
            let hasValidationError = false;

            payload.dias = Array.from(dayCards).map(card => {
                const inputNombreDia = card.querySelector('.day-title');
                const nombre_dia = inputNombreDia ? inputNombreDia.value : "Día";
                
                const exercisesRows = card.querySelectorAll('.exercise-row');
                
                const ejercicios = Array.from(exercisesRows).map(row => {
                    const inputExId = row.querySelector('.exercise-id');
                    const exId = parseInt(inputExId.value);

                    const rowsDeSeries = row.querySelectorAll('.serie-row');
                    const seriesData = Array.from(rowsDeSeries).map(sRow => {
                        return {
                            numero_serie: parseInt(sRow.dataset.serieNum),
                            repeticiones: sRow.querySelector('.serie-reps').value || "0",
                            peso: sRow.querySelector('.serie-weight').value || "0",
                            descanso: sRow.querySelector('.serie-rest').value || "0"
                        };
                    });

                    return {
                        ejercicio_id: exId,
                        series: seriesData, 
                        comentario: row.querySelector('.exercise-comment')?.value || ""
                    };
                });
                
                return { nombre_dia, ejercicios };
            });

            if (hasValidationError) {
                showVikingToast("Error: Tienes ejercicios sin seleccionar en la lista", true);
                return;
            }

            if (payload.dias.length === 0 || payload.dias.every(d => d.ejercicios.length === 0)) {
                showVikingToast("Error: La rutina debe tener al menos un ejercicio", true);
                return;
            }

            const res = await apiFetch('/rutinas/plan', 'POST', payload);
            
            if (!res.error) {
                closeModal('modal-rutina-editor');
                showVikingToast("¡Plan de Rutina Vikingo Guardado!");
                if (typeof renderRutinas === 'function') renderRutinas();
            } else {
                let msg = res.error;
                try { 
                    const parsed = JSON.parse(res.error);
                    if (parsed.detail) msg = parsed.detail;
                } catch(e) {}
                showVikingToast("Error Vikingo: " + msg, true);
            }
        };

		// 1. VARIABLES GLOBALES (Deben estar fuera de las funciones)
		let videoStream = null;
		let isScanning = false;
		let lastScannedData = null; // Para evitar lecturas duplicadas seguidas
		let scanCooldown = false;   // Bloqueo temporal tras una lectura exitosa
		let lastScannedDNI = null;

		// 1. Abrir Escáner y Encender Cámara
		async function startScanner() {
			const modal = document.getElementById('modal-scanner-live');
			const video = document.getElementById('scanner-video');
			const hud = document.getElementById('scanner-hud');
			
			// Limpiamos cualquier rastro de la lectura anterior en la UI
			hideFeedback();
			
			// Mostramos el modal
			if (modal) {
				modal.classList.remove('hidden');
				modal.classList.add('flex');
			}
			if (hud) hud.classList.remove('hidden');

			// VALIDACIÓN CRÍTICA: HTTPS (Obligatorio para cámaras en la mayoría de tablets)
			if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
				showCameraError("ERROR DE SEGURIDAD: La cámara requiere una conexión segura HTTPS. Verifica la URL.");
				return;
			}

			// Definimos una lista de intentos (Constraints) desde lo más ideal a lo más básico
			const attempts = [
				// Intento 1: Cámara frontal con resolución flexible
				{ 
					video: { 
						facingMode: "user", 
						width: { min: 320, ideal: 1280 }, 
						height: { min: 240, ideal: 720 },
						aspectRatio: { ideal: 1.7777777778 }
					} 
				},
				// Intento 2: Cámara frontal sin restricciones de resolución (para tablets viejas)
				{ 
					video: { facingMode: "user" } 
				},
				// Intento 3: Cualquier cámara disponible (último recurso)
				{ 
					video: true 
				}
			];

			let lastError = null;

			// Bucle de compatibilidad: Probamos cada configuración hasta que una funcione
			for (const config of attempts) {
				try {
					console.log("Intentando acceso con configuración:", config);
					videoStream = await navigator.mediaDevices.getUserMedia(config);
					if (videoStream) break; // Si tuvimos éxito, salimos del bucle
				} catch (err) {
					lastError = err;
					console.warn("Fallo un intento de cámara:", err.name);
					// Continuamos al siguiente intento...
				}
			}
			
			if (videoStream && video) {
				video.srcObject = videoStream;
				video.onloadedmetadata = () => {
					video.play();
					isScanning = true;
					lastScannedDNI = null; 
					console.log("🛡️ Ojo de Odín Activo: Buscando QR...");
					requestAnimationFrame(scanLoop); 
				};
			} else {
				console.error("No se pudo inicializar ninguna cámara después de varios intentos:", lastError);
				showCameraError("No hay acceso a la cámara. Asegúrate de usar Chrome y tener habilitados los permisos en la tablet.");
			}
		}

		/**
		 * 2. BUCLE DE DETECCIÓN (Detección Real Automática)
		 * Esta función corre analizando el video frame por frame.
		 */
		function scanLoop() {
			if (!isScanning) return; 

			const video = document.getElementById('scanner-video');
			let canvasElement = document.getElementById('scanner-canvas');
			
			// Si no existe el canvas auxiliar, lo creamos dinámicamente
			if (!canvasElement) {
				canvasElement = document.createElement('canvas');
				canvasElement.id = 'scanner-canvas';
				canvasElement.className = 'hidden';
				document.body.appendChild(canvasElement);
			}

			const canvas = canvasElement.getContext("2d", { willReadFrequently: true });

			if (video && video.readyState === video.HAVE_ENOUGH_DATA) {
				canvasElement.height = video.videoHeight;
				canvasElement.width = video.videoWidth;
				
				// Procesamos la imagen del video
				canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
				const imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
				
				// Intentamos detectar el QR con la librería jsQR
				const code = (typeof jsQR !== 'undefined') 
					? jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" }) 
					: null;

				// Si encontró un código y no estamos esperando (cooldown)
				if (code && code.data && !scanCooldown) {
					if (code.data !== lastScannedDNI) {
						console.log("🎯 QR Detectado:", code.data);
						lastScannedDNI = code.data;
						processAccess(code.data);
						return; // Pausamos el bucle hasta procesar
					}
				}
			}

			requestAnimationFrame(scanLoop);
		}

		/**
		 * 3. PROCESAR ACCESO (Comunicación con Backend)
		 */
		async function processAccess(qrData) {
			scanCooldown = true; 
			
			const nameDisplay = document.getElementById('scanner-user-name');
			if (nameDisplay) nameDisplay.innerText = "VERIFICANDO...";

			try {
				// Consultamos al servidor. 
				const response = await apiFetch('/acceso/validar', 'POST', { qr_data: qrData });
				
				if (response.error) {
					showFeedback({ 
						status: "DENIED", 
						message: response.error, 
						nombre: "SISTEMA" 
					});
				} else {
					showFeedback(response);
					
					// --- NUEVO: Refrescar datos globales ---
					// Llamamos a loadDashboard para que los paneles de "Accesos Recientes" se actualicen
					if (typeof loadDashboard === 'function') {
						console.log("🔄 Actualizando paneles del Dashboard...");
						loadDashboard(); 
					}
					
					// Si el usuario está en la vista de Acceso Virtual, refrescamos esa lista también
					if (typeof renderAccesos === 'function') {
						renderAccesos();
					}
				}

			} catch (e) {
				console.error("Error en la validación:", e);
				showFeedback({ 
					status: "DENIED", 
					message: "Error de red/servidor", 
					nombre: "SISTEMA" 
				});
			}

			// Esperamos 4 segundos para el feedback visual
			setTimeout(() => {
				if (isScanning) {
					hideFeedback();
					scanCooldown = false;
					lastScannedDNI = null; 
					requestAnimationFrame(scanLoop);
				}
			}, 4000);
		}

		/**
		 * 4. SIMULACIÓN (Para los botones del modal)
		 */
		async function simulateScan(type) {
			if (scanCooldown) return;
			
			let dniToTest = "00000000";
			
			if (type === 'ok') {
				// Buscar un alumno activo en el estado local para simular
				const hoy = new Date().toISOString().split('T')[0];
				const alumno = state.alumnos.find(a => a.fecha_vencimiento && a.fecha_vencimiento >= hoy);
				if (alumno) {
					dniToTest = alumno.dni;
				} else {
					showVikingToast("No hay alumnos activos para simular", true);
					return;
				}
			} else {
				dniToTest = "99999999"; // DNI que no existe o vencido
			}

			// Generar el hash para evitar el error de "formato no válido" si el backend lo requiere
			const hash = await generateVikingHash(dniToTest);
			const fullData = `${dniToTest}:${hash}`;
			
			processAccess(fullData);
		}

		/**
		 * UI: MOSTRAR RESULTADO BASADO EN EL COLOR DEL SERVIDOR
		 * Ahora con soporte para Verde (OK), Amarillo (Vence), Azul (Staff) y Rojo (Error).
		 */
		function showFeedback(data) {
			const overlay = document.getElementById('scanner-feedback-overlay');
			const icon = document.getElementById('scanner-icon-container');
			const status = document.getElementById('scanner-status-text');
			const name = document.getElementById('scanner-user-name');
			const msg = document.getElementById('scanner-msg');

			if (!overlay) return;

			// Reset total de estilos antes de pintar el nuevo estado
			overlay.classList.remove('hidden');
			overlay.classList.add('flex');
			overlay.style.boxShadow = "none";
			overlay.style.border = "none";
			overlay.style.backgroundColor = "rgba(0,0,0,0.95)";

			name.innerText = data.nombre || "DESCONOCIDO";
			msg.innerText = data.message || "";

			// Obtenemos el color que manda el Jefe (Backend)
			const colorServidor = data.color || "red";

			if (colorServidor === 'green') {
				// --- ESTADO VERDE: ALUMNO AL DÍA ---
				status.innerText = "ACCESO PERMITIDO";
				status.className = "text-5xl font-black uppercase italic text-green-500 mb-2 tracking-wide text-center drop-shadow-[0_0_10px_#22c55e]";
				overlay.style.boxShadow = "inset 0 0 150px rgba(34, 197, 94, 0.4)";
				overlay.style.border = "8px solid #22c55e";
				icon.innerHTML = `<div class="w-32 h-32 bg-green-500 rounded-full flex items-center justify-center shadow-[0_0_60px_#22c55e] animate-bounce"><i data-lucide="check" class="w-16 h-16 text-black"></i></div>`;
				playVikingSound('success');

			} else if (colorServidor === 'yellow') {
				// --- ESTADO AMARILLO: PRÓXIMO A VENCER ---
				status.innerText = "¡ATENCIÓN: VENCE PRONTO!";
				status.className = "text-4xl font-black uppercase italic text-yellow-500 mb-2 tracking-wide text-center drop-shadow-[0_0_15px_#eab308]";
				overlay.style.boxShadow = "inset 0 0 150px rgba(234, 179, 8, 0.5)";
				overlay.style.border = "8px solid #eab308";
				icon.innerHTML = `<div class="w-32 h-32 bg-yellow-500 rounded-full flex items-center justify-center shadow-[0_0_60px_#eab308]"><i data-lucide="alert-triangle" class="w-16 h-16 text-black"></i></div>`;
				playVikingSound('warning');

			} else if (colorServidor === 'blue') {
				// --- ESTADO AZUL: STAFF (Administrativo, Profes, etc) ---
				status.innerText = "ACCESO STAFF";
				status.className = "text-5xl font-black uppercase italic text-blue-500 mb-2 tracking-wide text-center drop-shadow-[0_0_15px_#3b82f6]";
				overlay.style.boxShadow = "inset 0 0 150px rgba(59, 130, 246, 0.4)";
				overlay.style.border = "8px solid #3b82f6";
				icon.innerHTML = `<div class="w-32 h-32 bg-blue-600 rounded-full flex items-center justify-center shadow-[0_0_60px_#3b82f6]"><i data-lucide="shield-check" class="w-16 h-16 text-white"></i></div>`;
				playVikingSound('success'); // El sonido de staff es el de éxito

			} else {
				// --- ESTADO ROJO: DENEGADO / ERROR ---
				status.innerText = "ACCESO DENEGADO";
				status.className = "text-5xl font-black uppercase italic text-red-600 mb-2 tracking-wide text-center drop-shadow-[0_0_10px_#dc2626]";
				overlay.style.boxShadow = "inset 0 0 150px rgba(220, 38, 38, 0.4)";
				overlay.style.border = "8px solid #dc2626";
				icon.innerHTML = `<div class="w-32 h-32 bg-red-600 rounded-full flex items-center justify-center shadow-[0_0_60px_#dc2626] animate-shake"><i data-lucide="x" class="w-16 h-16 text-white"></i></div>`;
				playVikingSound('error');
			}

			if (window.lucide) lucide.createIcons();
		}

		/**
		 * 6. LIMPIEZA Y CIERRE
		 */
		function hideFeedback() {
			const overlay = document.getElementById('scanner-feedback-overlay');
			if (overlay) {
				overlay.classList.add('hidden');
				overlay.classList.remove('flex');
			}
		}

		function stopScanner() {
			isScanning = false;
			const modal = document.getElementById('modal-scanner-live');
			const video = document.getElementById('scanner-video');

			if (videoStream) {
				videoStream.getTracks().forEach(track => track.stop());
				videoStream = null;
			}
			
			if (video) video.srcObject = null;
			if (modal) {
				modal.classList.add('hidden');
				modal.classList.remove('flex');
			}
		}

		/**
		 * 7. UTILIDADES
		 */
		async function generateVikingHash(dni) {
			const message = dni + SECRET_KEY;
			const encoder = new TextEncoder();
			const data = encoder.encode(message);
			const hashBuffer = await crypto.subtle.digest('SHA-256', data);
			const hashArray = Array.from(new Uint8Array(hashBuffer));
			return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
		}

		function showCameraError(msg) {
			const err = document.getElementById('scanner-error-msg');
			const txt = document.getElementById('scanner-error-text');
			if (txt) txt.innerText = msg;
			if (err) {
				err.classList.remove('hidden');
				err.classList.add('flex');
			}
		}

		// Vincular al botón de "Ver Molinetes" o crear uno nuevo en el Dashboard
		// Para probarlo, puedes llamar startScanner() desde la consola o añadir un botón.

        function openModalNewExercise() {
            openModal('modal-nuevo-ejercicio');
        }

		/**
		 * 1. OBTENER HISTORIAL DE ACCESOS DEL SERVIDOR
		 * Se llama al entrar a la vista o después de un escaneo.
		 */
		async function fetchAccesos() {
            console.log("🔄 Sincronizando historial con el Valhalla...");
            try {
                const res = await apiFetch('/acceso/historial'); 
                
                if (!res.error && Array.isArray(res)) {
                    state.accesos = res.map(acc => {
                        let fechaMostrar = acc.fecha;

                        try {
                            /**
                             * AJUSTE DE SEGURIDAD:
                             * Si el servidor (main.py) ya resta las 3 horas, aquí debe ser 0.
                             * Si ponemos -3 aquí también, se atrasa 6 horas en total.
                             */
                            const manualOffset = 0; 
                            
                            // Intentamos convertir el string del servidor a un objeto Date
                            // Reemplazamos el guion por barra para mejor compatibilidad en navegadores
                            let dateObj = new Date(acc.fecha.replace(/-/g, '/'));

                            // Si la fecha es inválida (formato custom), procesamos el string manualmente
                            if (isNaN(dateObj.getTime())) {
                                if (acc.fecha && acc.fecha.includes(' - ')) {
                                    let [horaCompleta, fechaCompleta] = acc.fecha.split(' - ');
                                    let [hh, mm] = horaCompleta.split(':');
                                    
                                    // Calculamos la nueva hora asegurando que sea positiva (0-23)
                                    let nuevaHH = (parseInt(hh) + manualOffset + 24) % 24;
                                    fechaMostrar = `${String(nuevaHH).padStart(2, '0')}:${mm} - ${fechaCompleta}`;
                                }
                            } else {
                                // Si es una fecha válida, restamos las horas directamente al objeto Date
                                dateObj.setHours(dateObj.getHours() + manualOffset);
                                
                                const h = String(dateObj.getHours()).padStart(2, '0');
                                const m = String(dateObj.getMinutes()).padStart(2, '0');
                                const day = String(dateObj.getDate()).padStart(2, '0');
                                const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                                const year = String(dateObj.getFullYear()).substring(2);
                                
                                fechaMostrar = `${h}:${m} - ${day}/${month}/${year}`;
                            }
                        } catch (e) {
                            console.warn("Error crítico procesando fecha, usando original:", e);
                            fechaMostrar = acc.fecha; // Fallback al original
                        }

                        return {
                            ...acc,
                            fecha_local: fechaMostrar
                        };
                    });
                    
                    // Gatillo de renderizado
                    if (typeof renderAccesos === 'function') {
                        renderAccesos();
                    }
                }
            } catch (error) {
                console.error("Error en sincronización automática:", error);
            }
        }

		// 2. EL INTEGRADOR DEL ESCÁNER (Llamar esto desde scanLoop en index.html)
		async function procesarEscaneoRealTime(codigoQR) {
			try {
				const response = await apiFetch('/acceso/validar', {
					method: 'POST',
					body: JSON.stringify({ qr_data: codigoQR })
				});

				if (typeof showScannerFeedback === 'function') {
					showScannerFeedback(response.status === "AUTHORIZED", response);
				}

				// ACTUALIZACIÓN FORZADA: Refrescamos la lista inmediatamente tras el escaneo
				console.log("⚡ Acceso detectado: Actualizando historial...");
				await fetchAccesos(); 

			} catch (error) {
				console.error("Error procesando escaneo:", error);
			}
		}

		// Renderiza la lista de ingresos con estilo de filas/tarjetas
			function renderAccesos() {
				const container = document.getElementById('acceso-list-view');
				if (!container) return;

				if (!state.accesos || state.accesos.length === 0) {
					container.innerHTML = `
						<div class="flex flex-col items-center justify-center py-20 opacity-20">
							<i data-lucide="database-zap" class="w-12 h-12 mb-4"></i>
							<p class="text-sm font-black uppercase italic tracking-widest">Esperando Guerreros...</p>
						</div>`;
					if(window.lucide) lucide.createIcons();
					return;
				}

				container.innerHTML = state.accesos.map(acc => {
					const isAuth = acc.estado === 'AUTHORIZED' || acc.estado === 'AUTORIZADO';
					const statusColor = isAuth ? 'text-green-500' : 'text-red-500';
					const bgColor = isAuth ? 'bg-green-500/10' : 'bg-red-500/10';
					const borderColor = isAuth ? 'border-green-500/20' : 'border-red-500/20';

					return `
						<div class="grid grid-cols-5 gap-4 px-6 py-4 ${bgColor} border ${borderColor} rounded-2xl items-center transition-all hover:scale-[1.01]">
							<div class="flex items-center gap-3">
								<div class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-[10px] font-black italic border border-white/10">
									${acc.nombre ? acc.nombre.substring(0,2).toUpperCase() : '??'}
								</div>
								<span class="text-[11px] font-black uppercase italic text-white truncate">${acc.nombre}</span>
							</div>

							<span class="text-[10px] font-bold text-gray-400">${acc.dni}</span>

							<div class="flex flex-col">
								<!-- Se muestra el texto directo del servidor -->
								<span class="text-[10px] font-black text-white/80">${acc.fecha_local}</span>
							</div>

							<div class="flex items-center gap-2">
								<i data-lucide="${acc.metodo && acc.metodo.includes('QR') ? 'qr-code' : 'hard-drive'}" class="w-3 h-3 text-red-600"></i>
								<span class="text-[9px] font-bold text-gray-500 uppercase">${acc.metodo || 'S/D'}</span>
							</div>

							<div class="text-right">
								<span class="px-3 py-1 rounded-full ${statusColor} text-[9px] font-black bg-black/40 border border-current uppercase italic">
									${isAuth ? 'Permitido' : 'Denegado'}
								</span>
							</div>
						</div>
					`;
				}).join('');

				if(window.lucide) lucide.createIcons();
			}

			async function procesarEscaneo(codigoQR) {
				try {
					const response = await apiFetch('/acceso/validar', {
						method: 'POST',
						body: JSON.stringify({ qr_data: codigoQR })
					});

					if (response.success) {
						if (typeof showScannerFeedback === 'function') {
							showScannerFeedback(true, response.usuario);
						}

						// Actualización inmediata al detectar un guerrero
						console.log("⚡ Guerrero detectado: Actualizando historial...");
						await fetchAccesos(); 
						
					} else {
						if (typeof showScannerFeedback === 'function') {
							showScannerFeedback(false, null, response.error);
						}
					}
				} catch (error) {
					console.error("Error en proceso de escaneo:", error);
				}
			}

			// 3. EL REFRESCO DE CORTESÍA (POLLING)
			let vikingoRefreshInterval = null;

			function iniciarRefrescoAutomatico() {
				if (vikingoRefreshInterval) clearInterval(vikingoRefreshInterval);

				console.log("🛡️ Centinela Vikingo activado (Refresco cada 15s)");
				
				vikingoRefreshInterval = setInterval(() => {
					if (!document.hidden) {
						fetchAccesos();
					}
				}, 15000); 
			}


			/**
			 * 3. REGISTRAR NUEVO ACCESO (LLAMADO DESDE EL ESCÁNER)
			 * Actualiza la lista en tiempo real sin recargar.
			 */
			function registerAccessLog(nombre, dni, metodo, estado) {
				const nuevoAcceso = {
					nombre: nombre,
					dni: dni,
					fecha: new Date().toLocaleTimeString(),
					metodo: metodo,
					estado: estado
				};

				if (!state.accesos) state.accesos = [];
				
				// Lo agregamos al principio del array
				state.accesos.unshift(nuevoAcceso);
				
				// Mantenemos solo los últimos 50 para no matar el navegador
				if (state.accesos.length > 50) state.accesos.pop();

				// Si estamos viendo la pantalla de accesos, refrescamos la lista
				const currentView = document.querySelector('.view-content.active')?.id;
				if (currentView === 'view-acceso-virtual') {
					renderAccesos();
				}
			}

			/**
			 * 4. ACTUALIZACIÓN DE SWITCHVIEW
			 * Asegúrate de que al cambiar a esta vista, traiga los datos.
			 */
			const originalSwitchView = window.switchView;

			window.switchView = function(view) {
				console.log(`🚀 Navegando a: ${view}`);

				// 2. Ejecutamos primero la función original de navegación
				if (typeof originalSwitchView === 'function') {
					originalSwitchView(view);
				} else {
					// Fallback en caso de que la función no esté definida globalmente pero se llame
					console.warn("⚠️ originalSwitchView no definida. Solo se ejecutará lógica de carga.");
				}
				
				// 3. Lógica específica por vista (Carga de datos)
				switch (view) {
					case 'dashboard':
						// Si entramos al Dashboard, actualizamos los 3 paneles (Accesos, Staff y Stock)
						if (typeof loadDashboard === 'function') {
							loadDashboard();
						} else {
							console.error("❌ Error: loadDashboard() no encontrada.");
						}
						break;

					case 'acceso-virtual':
						// Si entramos a la sección de Molinetes / Seguridad
						if (typeof fetchAccesos === 'function') {
							fetchAccesos();
						} else if (typeof renderAccesos === 'function') {
							// Si no existe el fetch, al menos intentamos renderizar lo que haya en estado
							renderAccesos();
						}
						break;

					case 'alumnos':
						// Aseguramos que la lista de alumnos esté fresca
						if (typeof fetchAlumnos === 'function') {
							fetchAlumnos();
						}
						break;

					case 'merca':
						// Si tienes una función para cargar inventario, podrías llamarla aquí
						if (typeof fetchStock === 'function') {
							fetchStock();
						}
						break;

					default:
						// No se requiere acción adicional para otras vistas
						break;
				}

				// 4. Refrescar iconos globales de Lucide si están presentes
				if (window.lucide) {
					setTimeout(() => lucide.createIcons(), 50);
				}
			};

			console.log("✅ Sistema de navegación extendido correctamente.");
			
			// FUNCIONES PARA EL MODAL DE MI QR
			async function showMyQR() {
				const user = state.user || JSON.parse(localStorage.getItem('user'));
				
				if (!user) {
					showVikingToast("Sesión no encontrada", true);
					return;
				}

				// Validación de plan SOLO para Alumnos
				if (user.rol_nombre === "Alumno") {
					const hoy = new Date().toISOString().split('T')[0];
					const vencimiento = user.fecha_vencimiento || "0000-00-00";
					if (vencimiento < hoy) {
						showVikingToast("ACCESO DENEGADO: Plan vencido.", true);
						return;
					}
				}

				const modal = document.getElementById('modal-mi-qr');
				const img = document.getElementById('img-mi-qr');
				const dniTxt = document.getElementById('qr-user-dni');
				const nameTxt = document.getElementById('qr-user-name');

				if (modal && img) {
					try {
						if (dniTxt) dniTxt.innerText = user.dni;
						if (nameTxt) nameTxt.innerText = user.nombre_completo;
						
						const hash = await generateVikingHash(user.dni);
						const qrData = `${user.dni}:${hash}`;
						
						img.src = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(qrData)}&color=000000&bgcolor=ffffff&margin=10`;

						// Quitamos 'hidden', agregamos 'flex' y forzamos display
						modal.classList.remove('hidden');
						modal.classList.add('flex');
						modal.style.setProperty('display', 'flex', 'important'); 

						if (window.lucide) lucide.createIcons();
					} catch (error) {
						console.error("Error QR:", error);
						showVikingToast("Error al generar acceso", true);
					}
				} else {
					console.error("No se encontró el modal 'modal-mi-qr' en el DOM.");
				}
			}


				function closeMyQR() {
					const modal = document.getElementById('modal-mi-qr');
					if (modal) {
						modal.classList.add('hidden');
						modal.classList.remove('flex');
						modal.style.display = 'none'; // ELIMINA EL BLOQUEO
					}
				}

				async function generateVikingHash(dni) {
					const message = dni + SECRET_KEY;
					const encoder = new TextEncoder();
					const data = encoder.encode(message);
					const hashBuffer = await crypto.subtle.digest('SHA-256', data);
					const hashArray = Array.from(new Uint8Array(hashBuffer));
					return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
				}

				// Alternar entre Login y Reset
        function toggleResetPass(showReset) {
            document.getElementById('login-form-container').classList.toggle('hidden', showReset);
            document.getElementById('reset-form-container').classList.toggle('hidden', !showReset);
            document.getElementById('login-error').classList.add('hidden');
        }

        // --- PUNTO 2: Reset de Contraseña ---
        async function handleResetPassword(e) {
            e.preventDefault();
            const dni = document.getElementById('reset-dni').value;
            const pass = document.getElementById('reset-pass-new').value;
            const confirm = document.getElementById('reset-pass-confirm').value;
            const btn = document.getElementById('reset-button');

            if (pass !== confirm) {
                showVikingToast("Las contraseñas no coinciden", true);
                return;
            }

            btn.disabled = true;
            btn.innerText = "PROCESANDO...";

            // Buscamos al usuario por DNI para obtener su ID (Necesario para el endpoint PUT /staff o /alumnos)
            // Primero intentamos buscarlo en la base de datos de usuarios general
            const res = await apiFetch(`/usuarios/reset-password`, 'PUT', { 
                dni: dni, 
                password: pass 
            });

            if (!res.error) {
                showVikingToast("¡Contraseña actualizada con éxito!");
                toggleResetPass(false); // Volver al login
            } else {
                showVikingToast("Error: " + res.error, true);
            }
            btn.disabled = false;
            btn.innerText = "Cambiar Contraseña";
        }

		/**
		 * MOTOR DE AUDIO VIKINGO
		 * Genera tonos sintéticos para feedback inmediato en el molinete.
		 */
		function playVikingSound(type) {
			const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
			const oscillator = audioCtx.createOscillator();
			const gainNode = audioCtx.createGain();

			oscillator.connect(gainNode);
			gainNode.connect(audioCtx.destination);

			switch(type) {
				case 'success': // VERDE: Tono agudo y corto
					oscillator.type = 'sine';
					oscillator.frequency.setValueAtTime(880, audioCtx.currentTime); // La5
					gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
					oscillator.start();
					oscillator.stop(audioCtx.currentTime + 0.2);
					break;
					
				case 'warning': // AMARILLO: Dos tonos (Aviso de vencimiento)
					oscillator.type = 'triangle';
					oscillator.frequency.setValueAtTime(440, audioCtx.currentTime); 
					gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
					oscillator.start();
					oscillator.frequency.exponentialRampToValueAtTime(660, audioCtx.currentTime + 0.3);
					oscillator.stop(audioCtx.currentTime + 0.4);
					break;

				case 'error': // ROJO: Tono grave y vibrante
					oscillator.type = 'sawtooth';
					oscillator.frequency.setValueAtTime(150, audioCtx.currentTime);
					gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
					oscillator.start();
					oscillator.stop(audioCtx.currentTime + 0.5);
					break;
			}
		}

        // --- PUNTO 3: Dashboard Específico Profesor ---
        async function loadProfessorDashboard() {
			if (!state.user || state.user.rol_nombre !== "Profesor") return;
			
			console.log("📊 Cargando métricas de Coach...");
			
			// Obtener datos frescos de la API
			const [clasesRaw, reservasRaw] = await Promise.all([
				apiFetch('/clases'),
				apiFetch('/reservas')
			]);

			// Validar que no haya errores en las respuestas
			const clases = Array.isArray(clasesRaw) ? clasesRaw : [];
			const reservas = Array.isArray(reservasRaw) ? reservasRaw : [];

			// 1. Filtrar clases asignadas a este profesor
			const misClases = clases.filter(c => c.coach === state.user.nombre_completo);
			const containerHoy = document.getElementById('prof-dash-today-classes');
			
			if (containerHoy) {
				if (misClases.length === 0) {
					containerHoy.innerHTML = '<p class="text-center text-gray-500 italic text-[10px] py-10">No tienes clases asignadas.</p>';
				} else {
					containerHoy.innerHTML = misClases.map(c => `
						<div class="flex justify-between items-center p-4 bg-white/5 rounded-2xl border border-white/5 hover:border-red-600/30 transition-all">
							<div>
								<p class="text-[11px] font-black uppercase italic text-white">${c.nombre}</p>
								<p class="text-[9px] text-gray-500 font-bold uppercase">Cupo: ${c.capacidad_max} Guerreros</p>
							</div>
							<div class="w-2 h-10 rounded-full shadow-[0_0_10px_rgba(255,0,0,0.2)]" style="background-color: ${c.color || '#FF0000'}"></div>
						</div>
					`).join('');
				}
			}

			// 2. Cálculo de convocatoria (Alumnos totales en sus clases)
			const misIds = misClases.map(c => c.id);
			const misReservas = reservas.filter(r => misIds.includes(r.clase_id));
			
			const elTotal = document.getElementById('prof-dash-total-students');
			if (elTotal) elTotal.innerText = misReservas.length;

			// 3. Ranking de alumnos más frecuentes
			const studentCounts = {};
			misReservas.forEach(r => {
				if (r.alumno_dni) {
					studentCounts[r.alumno_dni] = (studentCounts[r.alumno_dni] || 0) + 1;
				}
			});

			const topStudents = Object.entries(studentCounts)
				.sort((a, b) => b[1] - a[1])
				.slice(0, 5);

			const containerTop = document.getElementById('prof-dash-top-students');
			if (containerTop) {
				if (topStudents.length === 0) {
					containerTop.innerHTML = '<p class="text-center text-gray-600 italic text-[10px] py-4">Sin actividad registrada.</p>';
				} else {
					containerTop.innerHTML = topStudents.map(([dni, count]) => `
						<div class="flex justify-between items-center p-3 bg-white/5 rounded-xl border border-white/5">
							<div class="flex items-center gap-3">
								<div class="w-2 h-2 rounded-full bg-red-600 animate-pulse"></div>
								<span class="text-[10px] font-black italic uppercase text-white">${dni}</span>
							</div>
							<span class="text-[9px] font-black text-red-500 bg-red-500/10 px-2 py-1 rounded-lg">${count} ASISTENCIAS</span>
						</div>
					`).join('');
				}
			}

			if (window.lucide) lucide.createIcons();
		}


			// ==========================================
			// NUEVA LÓGICA DE ALUMNOS (FIX PANTALLA VACÍA)
			// ==========================================

			// 1. Función de Entrada
			function renderAlumnosSection() {
				filterAlumnos('todos');
			}

			function toggleMobileMenu() {
				const sidebar = document.getElementById('sidebar');
				const overlay = document.getElementById('mobile-overlay');
				
				// Alternamos la clase que creamos en el CSS
				sidebar.classList.toggle('mobile-open');
				overlay.classList.toggle('active');
			}

			// 2. Función de Filtrado
			window.filterAlumnos = function(filtro) {
				if(!state.alumnos) return;
				
				// Actualizar botones visualmente
				document.querySelectorAll('.filter-btn').forEach(btn => {
					btn.classList.remove('bg-red-600', 'text-black');
					btn.classList.add('text-gray-500', 'hover:text-white');
				});
				const activeBtn = document.getElementById('filter-' + filtro);
				if(activeBtn) {
					activeBtn.classList.remove('text-gray-500', 'hover:text-white');
					activeBtn.classList.add('bg-red-600', 'text-black');
				}

				const hoy = new Date().toISOString().split('T')[0];
				let filtrados = state.alumnos;
				
				if(filtro === 'activos') filtrados = state.alumnos.filter(a => a.fecha_vencimiento && a.fecha_vencimiento >= hoy);
				if(filtro === 'inactivos') filtrados = state.alumnos.filter(a => !a.fecha_vencimiento || a.fecha_vencimiento < hoy);
				
				renderAlumnosList(filtrados);
			}

			// 3. Función de Búsqueda
			window.searchAlumno = function(query) {
				if(!query) { filterAlumnos('todos'); return; }
				
				document.querySelectorAll('.filter-btn').forEach(btn => {
					btn.classList.remove('bg-red-600', 'text-black');
					btn.classList.add('text-gray-500');
				});

				const q = query.toLowerCase();
				const filtrados = state.alumnos.filter(a => a.nombre_completo.toLowerCase().includes(q) || a.dni.includes(q));
				renderAlumnosList(filtrados);
			}
			// 4. Renderizado de la Lista (AQUÍ ESTÁ EL CAMBIO DE DISEÑO "STAFF")
			window.renderAlumnosList = function(listaDatos) {
				const contenedor = document.getElementById('lista-alumnos-container');
				if(!contenedor) return;

				if(listaDatos.length === 0) {
					contenedor.innerHTML = `<div class="h-full flex flex-col items-center justify-center text-gray-600 opacity-50 py-10"><i data-lucide="users" class="w-12 h-12 mb-2"></i><p class="text-xs font-black uppercase italic">Sin resultados</p></div>`;
					if(window.lucide) lucide.createIcons();
					return;
				}

				const hoy = new Date().toISOString().split('T')[0];

				contenedor.innerHTML = listaDatos.map(a => {
					// Lógica de Estado
					const estaVencido = !a.fecha_vencimiento || a.fecha_vencimiento < hoy;
					const colorEstado = estaVencido ? 'bg-red-600' : 'bg-green-600'; 
					const textoEstado = estaVencido ? 'VENCIDO' : 'AL DÍA';
					const colorBadge = estaVencido ? 'text-red-500 bg-red-500/10 border-red-500/20' : 'text-green-500 bg-green-500/10 border-green-500/20';

					const initials = a.nombre_completo ? a.nombre_completo.substring(0,2).toUpperCase() : "??";
					const planNombre = a.plan ? a.plan.nombre : 'Sin Plan';

					return `
					<div class="glass-card p-5 rounded-3xl border-white/5 flex flex-col md:flex-row md:items-center gap-6 hover:border-red-600/20 transition-all group relative overflow-hidden">
						<!-- Barra lateral decorativa -->
						<div class="absolute left-0 top-0 bottom-0 w-1.5 ${colorEstado} opacity-40 group-hover:opacity-100 transition-opacity"></div>
						
						<!-- COLUMNA 1: IDENTIDAD (Ancho fijo para que no robe espacio a la info) -->
						<div class="flex items-center gap-4 w-full md:w-1/3">
							<div class="w-14 h-14 rounded-2xl bg-white/5 border border-white/10 flex items-center justify-center font-black text-white text-lg italic shadow-lg group-hover:bg-red-600 group-hover:text-black transition-colors shrink-0">
								${initials}
							</div>
							<div class="overflow-hidden">
								<h4 class="text-sm font-black uppercase italic text-white group-hover:text-red-500 transition-colors truncate">${a.nombre_completo}</h4>
								<div class="flex flex-col mt-1">
									<p class="text-[10px] text-gray-500 font-bold flex items-center gap-1.5"><i data-lucide="id-card" class="w-3 h-3"></i> ${a.dni}</p>
									${a.email ? `<p class="text-[10px] text-gray-500 font-bold flex items-center gap-1.5 truncate"><i data-lucide="mail" class="w-3 h-3"></i> ${a.email}</p>` : ''}
								</div>
							</div>
						</div>

						<!-- COLUMNA 2: PLAN Y ESTADO (EXPANDIDA: flex-1 para ocupar el resto) -->
						<div class="flex-1 border-t md:border-t-0 md:border-l border-white/5 pt-4 md:pt-0 md:pl-8">
							<div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-center">
								
								<!-- Info Plan (Más grande) -->
								<div>
									<p class="text-[9px] text-gray-500 font-black uppercase tracking-widest mb-1 flex items-center gap-1.5">
										<i data-lucide="ticket" class="w-3 h-3 text-red-600"></i> Plan Actual
									</p>
									<p class="text-sm font-black uppercase italic text-white truncate">${planNombre}</p>
								</div>

								<!-- Estado y Fechas (Alineado y destacado) -->
								<div class="flex flex-row md:flex-col items-center md:items-start justify-between gap-2">
									<div class="flex items-center gap-2">
										<span class="px-3 py-1 rounded-lg text-[9px] font-black uppercase border ${colorBadge}">
											${textoEstado}
										</span>
									</div>
									<p class="text-[10px] text-gray-400 font-bold italic flex items-center gap-1">
										Vence: <span class="text-white">${a.fecha_vencimiento || 'N/A'}</span>
									</p>
								</div>
							</div>
						</div>

						<!-- COLUMNA 3: ACCIONES (Botón Editar) -->
						<div class="flex items-center justify-end min-w-[100px] border-t md:border-t-0 border-white/5 pt-3 md:pt-0">
							<button onclick="openEditAlumno(${a.id})" class="px-6 py-3 bg-white/5 text-white rounded-xl text-[10px] font-black uppercase italic hover:bg-white/10 hover:text-red-500 transition-all flex items-center gap-2 shadow-lg w-full md:w-auto justify-center">
								<i data-lucide="settings-2" class="w-3.5 h-3.5"></i>
								<span>Editar</span>
							</button>
						</div>
					</div>
					`;
				}).join('');
				
				if(window.lucide) lucide.createIcons();
			}

        document.getElementById('form-nuevo-ejercicio-lib').onsubmit = async (e) => {
            e.preventDefault();
            const nombre = document.getElementById('lib-ex-nombre').value;
            const grupo_id = parseInt(document.getElementById('lib-ex-grupo').value);
            
            const res = await apiFetch('/rutinas/ejercicios', 'POST', { nombre, grupo_muscular_id: grupo_id });
            if (!res.error) {
                showVikingToast("Ejercicio creado en librería");
                closeModal('modal-nuevo-ejercicio');
                await loadMusculacionMetadata();
            } else {
                showVikingToast("Error al crear: " + res.error, true);
            }
        };
		
		document.getElementById('form-clase').onsubmit = saveClaseVikinga;

		/**
		 * =========================================================
		 * 4. PUENTES DE COMPATIBILIDAD (ALIAS MÁGICOS)
		 * =========================================================
		 * Esto permite que tu HTML viejo llame a funciones con nombres
		 * antiguos y sean redirigidos automáticamente a las nuevas.
		 */

		// Si el botón dice onclick="finalizarVenta()", ejecuta finalizarVentaMercaderia()
		window.finalizarVenta = finalizarVentaMercaderia; 

		// Si el botón dice onclick="confirmarCobroFinal()", ejecuta finalizarVentaMercaderia()
		window.confirmarCobroFinal = finalizarVentaMercaderia;

        window.onclick = function(event) {
            if (event.target.classList.contains('search-exercise-input')) return;
            document.querySelectorAll('.exercise-results-list').forEach(list => list.classList.add('hidden'));
        };
        
		window.addEventListener('load', () => {
			// 1. Lógica existente: Inicializar formulario de stock
			const f = document.getElementById('form-stock');
			if(f) f.onsubmit = saveStockVikingo;

			// 2. PRIORIDAD 1: Activar el motor de tiempo real para el historial
			// Verificamos que las funciones existan antes de llamarlas para evitar errores
			if (typeof fetchAccesos === 'function') {
				console.log("🚀 Iniciando carga de datos de acceso...");
				fetchAccesos(); // Carga inicial inmediata
			}

			if (typeof iniciarRefrescoAutomatico === 'function') {
				iniciarRefrescoAutomatico(); // Arranca el ciclo de actualización constante
			}
		});
		
        window.onload = () => {
			const formClase = document.getElementById('form-clase');
			if(formClase) {
				formClase.onsubmit = saveClaseVikinga;
			}
			if(window.lucide) lucide.createIcons();
		};				
    </script>

	<!-- Fondo oscuro para cerrar el menú al tocar afuera -->
		<div id="mobile-overlay" class="sidebar-overlay" onclick="toggleMobileMenu()"></div>

</body>
</html>